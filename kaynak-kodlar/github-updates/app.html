<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BestOfShop</title>
    <!-- Firebase SDK - async yükleme -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error('Global Hata:', msg, 'Satır:', line);
            var errDiv = document.getElementById('globalError');
            if (errDiv) errDiv.innerHTML = 'JS Hatası: ' + msg + ' (Satır: ' + line + ')';
            return false;
        };
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        var firebaseReady = false;
        var auth = null;
        var db = null;
        
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyAexeqO1niP2noYEL2VMSoXL4llPLHaiYg",
                authDomain: "cheatstore-515c1.firebaseapp.com",
                projectId: "cheatstore-515c1",
                storageBucket: "cheatstore-515c1.firebasestorage.app",
                messagingSenderId: "424756346612",
                appId: "1:424756346612:web:683b874f98daf48352e8a1"
            };
            
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                firebaseReady = true;
                console.log('✅ Firebase başlatıldı');
            } else {
                console.error('❌ Firebase SDK yüklenemedi');
            }
        } catch(e) {
            console.error('❌ Firebase başlatma hatası:', e);
        }
    </script>
</head>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        background: #0a0a12;
        min-height: 100vh; 
        color: #fff; 
        overflow-x: hidden;
        /* Safe area için padding */
        padding-top: env(safe-area-inset-top, 0px);
        padding-bottom: env(safe-area-inset-bottom, 0px);
        padding-left: env(safe-area-inset-left, 0px);
        padding-right: env(safe-area-inset-right, 0px);
    }
    
    /* 🏪 BestOfShop - Hile Mağazası Teması */
    .animated-bg {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: -1;
        overflow: hidden;
        background: linear-gradient(135deg, #0a0a0f 0%, #12121a 50%, #0a0a0f 100%);
    }
    
    /* Kayan BestOfShop Yazıları - Daha Belirgin */
    .text-banner {
        position: absolute;
        width: 200%;
        white-space: nowrap;
        font-family: 'Arial Black', sans-serif;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 15px;
        pointer-events: none;
    }
    
    .text-banner-1 {
        top: 5%;
        font-size: 90px;
        color: #4CAF50;
        opacity: 0.08;
        text-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
        animation: scrollText 20s linear infinite;
    }
    
    .text-banner-2 {
        top: 30%;
        font-size: 70px;
        color: #2196F3;
        opacity: 0.06;
        text-shadow: 0 0 25px rgba(33, 150, 243, 0.4);
        animation: scrollText 25s linear infinite reverse;
    }
    
    .text-banner-3 {
        top: 55%;
        font-size: 80px;
        color: #4CAF50;
        opacity: 0.07;
        text-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
        animation: scrollText 18s linear infinite;
    }
    
    .text-banner-4 {
        top: 80%;
        font-size: 60px;
        color: #2196F3;
        opacity: 0.05;
        text-shadow: 0 0 20px rgba(33, 150, 243, 0.3);
        animation: scrollText 28s linear infinite reverse;
    }
    
    @keyframes scrollText {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
    }
    
    /* Dikey Kayan Yazı - Daha Belirgin */
    .text-vertical {
        position: absolute;
        writing-mode: vertical-rl;
        text-orientation: mixed;
        font-family: 'Arial Black', sans-serif;
        font-weight: 900;
        font-size: 120px;
        text-transform: uppercase;
        letter-spacing: 10px;
        pointer-events: none;
    }
    
    .text-vertical-1 {
        left: 3%;
        color: #4CAF50;
        opacity: 0.04;
        text-shadow: 0 0 40px rgba(76, 175, 80, 0.4);
        animation: scrollVertical 35s linear infinite;
    }
    
    .text-vertical-2 {
        right: 5%;
        color: #2196F3;
        opacity: 0.035;
        text-shadow: 0 0 35px rgba(33, 150, 243, 0.35);
        animation: scrollVertical 30s linear infinite reverse;
    }
    
    @keyframes scrollVertical {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(100vh); }
    }
    
    /* Parlayan Köşeler */
    .corner-glow {
        position: absolute;
        width: 400px;
        height: 400px;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.5;
    }
    
    .corner-glow-1 {
        top: -150px;
        right: -150px;
        background: radial-gradient(circle, rgba(76, 175, 80, 0.4) 0%, transparent 70%);
        animation: glowPulse 4s ease-in-out infinite;
    }
    
    .corner-glow-2 {
        bottom: -150px;
        left: -150px;
        background: radial-gradient(circle, rgba(33, 150, 243, 0.35) 0%, transparent 70%);
        animation: glowPulse 5s ease-in-out infinite 1s;
    }
    
    .corner-glow-3 {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(76, 175, 80, 0.15) 0%, transparent 70%);
        animation: glowPulse 6s ease-in-out infinite 2s;
    }
    
    @keyframes glowPulse {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
    }
    
    /* Yatay Çizgiler - Mağaza Stili */
    .store-line {
        position: absolute;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.5), transparent);
        pointer-events: none;
    }
    
    .store-line-1 {
        top: 20%;
        left: 0;
        right: 0;
        animation: lineGlow 3s ease-in-out infinite;
    }
    
    .store-line-2 {
        top: 50%;
        left: 0;
        right: 0;
        background: linear-gradient(90deg, transparent, rgba(33, 150, 243, 0.4), transparent);
        animation: lineGlow 4s ease-in-out infinite 1s;
    }
    
    .store-line-3 {
        top: 80%;
        left: 0;
        right: 0;
        background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.35), transparent);
        animation: lineGlow 3.5s ease-in-out infinite 0.5s;
    }
    
    @keyframes lineGlow {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.8; }
    }
    
    /* Kayan Işık Çubukları */
    .light-bar {
        position: absolute;
        width: 150px;
        height: 2px;
        border-radius: 2px;
        will-change: transform;
    }
    
    .light-bar-1 {
        background: linear-gradient(90deg, transparent, #4CAF50, #4CAF50, transparent);
        top: 15%;
        left: -150px;
        box-shadow: 0 0 15px #4CAF50, 0 0 30px #4CAF50;
        animation: lightSlide 4s ease-in-out infinite;
    }
    
    .light-bar-2 {
        background: linear-gradient(90deg, transparent, #2196F3, #2196F3, transparent);
        top: 45%;
        right: -150px;
        box-shadow: 0 0 15px #2196F3, 0 0 30px #2196F3;
        animation: lightSlideReverse 5s ease-in-out infinite 1.5s;
    }
    
    .light-bar-3 {
        background: linear-gradient(90deg, transparent, #4CAF50, #4CAF50, transparent);
        top: 75%;
        left: -150px;
        box-shadow: 0 0 15px #4CAF50, 0 0 30px #4CAF50;
        animation: lightSlide 4.5s ease-in-out infinite 3s;
    }
    
    @keyframes lightSlide {
        0% { transform: translateX(0); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateX(calc(100vw + 200px)); opacity: 0; }
    }
    
    @keyframes lightSlideReverse {
        0% { transform: translateX(0); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateX(calc(-100vw - 200px)); opacity: 0; }
    }
    
    /* Parıltılar */
    .sparkle {
        position: absolute;
        width: 3px;
        height: 3px;
        background: #fff;
        border-radius: 50%;
    }
    
    .sparkle-1 { top: 10%; left: 30%; animation: sparkle 2s ease-in-out infinite; }
    .sparkle-2 { top: 25%; left: 70%; animation: sparkle 2.5s ease-in-out infinite 0.3s; }
    .sparkle-3 { top: 45%; left: 20%; animation: sparkle 1.8s ease-in-out infinite 0.6s; }
    .sparkle-4 { top: 60%; left: 85%; animation: sparkle 2.2s ease-in-out infinite 0.9s; }
    .sparkle-5 { top: 80%; left: 45%; animation: sparkle 2s ease-in-out infinite 1.2s; }
    .sparkle-6 { top: 35%; left: 55%; animation: sparkle 2.4s ease-in-out infinite 0.4s; }
    
    @keyframes sparkle {
        0%, 100% { transform: scale(0); opacity: 0; box-shadow: none; }
        50% { transform: scale(1); opacity: 1; box-shadow: 0 0 10px #4CAF50, 0 0 20px #4CAF50; }
    }
    
    /* Grid Overlay - Çok Hafif */
    .grid-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(rgba(76, 175, 80, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(76, 175, 80, 0.03) 1px, transparent 1px);
        background-size: 50px 50px;
        pointer-events: none;
    }
    
    /* Vignette Efekti */
    .vignette {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(ellipse at center, transparent 0%, rgba(0,0,0,0.4) 100%);
        pointer-events: none;
    }
    
    /* BestOfShop Logo - Lazer Animasyonu */
    .app-logo-container {
        width: 90px;
        height: 90px;
        margin: 0 auto 15px;
        position: relative;
    }
    
    .app-logo-svg {
        width: 90px;
        height: 90px;
        border-radius: 22px;
        background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
        border: 2px solid rgba(76, 175, 80, 0.3);
        box-shadow: 0 8px 30px rgba(0,0,0,0.4), 0 0 20px rgba(76, 175, 80, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
    }
    
    /* Lazer Çizgiler */
    .laser-g {
        position: absolute;
        height: 2px;
        top: 50%;
        left: 0;
        width: 0;
        background: linear-gradient(90deg, transparent, #4CAF50, #4CAF50);
        box-shadow: 0 0 8px #4CAF50, 0 0 15px #4CAF50;
        animation: laserG 0.8s ease-out forwards;
    }
    .laser-s {
        position: absolute;
        height: 2px;
        top: 50%;
        right: 0;
        width: 0;
        background: linear-gradient(-90deg, transparent, #2196F3, #2196F3);
        box-shadow: 0 0 8px #2196F3, 0 0 15px #2196F3;
        animation: laserS 0.8s ease-out forwards;
    }
    @keyframes laserG {
        0% { width: 0; left: 0; }
        50% { width: 45px; left: 0; }
        100% { width: 0; left: 45px; }
    }
    @keyframes laserS {
        0% { width: 0; right: 0; }
        50% { width: 45px; right: 0; }
        100% { width: 0; right: 45px; }
    }
    
    /* GS Harfleri */
    .logo-letter-g, .logo-letter-s {
        position: absolute;
        font-family: 'Arial Black', sans-serif;
        font-size: 32px;
        font-weight: 900;
        opacity: 0;
    }
    .logo-letter-g {
        left: 14px;
        color: #4CAF50;
        text-shadow: 0 0 15px #4CAF50;
        animation: revealLetter 0.5s ease-out 0.6s forwards;
    }
    .logo-letter-s {
        right: 14px;
        color: #2196F3;
        text-shadow: 0 0 15px #2196F3;
        animation: revealLetter 0.5s ease-out 0.6s forwards;
    }
    @keyframes revealLetter {
        0% { opacity: 0; transform: scale(0.5); }
        100% { opacity: 1; transform: scale(1); }
    }
    
    /* Çarpışma Efekti */
    .logo-impact {
        position: absolute;
        width: 15px;
        height: 15px;
        background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 70%);
        border-radius: 50%;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        opacity: 0;
        animation: impact 0.3s ease-out 0.7s forwards;
    }
    @keyframes impact {
        0% { opacity: 1; transform: translate(-50%, -50%) scale(0); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(2.5); }
    }

    .container { max-width: 500px; margin: 0 auto; padding: 20px; padding-top: 30px; padding-bottom: 100px; position: relative; z-index: 1; }
    
    /* HEADER */
    .header { text-align: center; margin-bottom: 25px; }
    .app-logo { width: 80px; height: 80px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .title { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
    .subtitle { color: #aaa; font-size: 13px; }
    .version { color: #666; font-size: 11px; margin-top: 5px; }
    
    /* BUTTONS */
    .btn { display: block; width: 100%; padding: 16px 20px; border: none; border-radius: 15px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 12px; transition: all 0.3s ease; text-align: center; text-decoration: none; }
    .btn:active { transform: scale(0.98); opacity: 0.9; }
    .btn-primary { background: linear-gradient(135deg, #4CAF50, #45a049); color: #fff; }
    .btn-secondary { background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; }
    .btn-warning { background: linear-gradient(135deg, #FF9800, #F57C00); color: #fff; }
    .btn-purple { background: linear-gradient(135deg, #9C27B0, #7B1FA2); color: #fff; }
    .btn-subtext { display: block; font-size: 11px; font-weight: normal; opacity: 0.8; margin-top: 4px; }
    .btn-small { padding: 12px 20px; font-size: 14px; }
    
    /* TELEGRAM CARD */
    .telegram-card { background: linear-gradient(135deg, #0088cc, #0077b5); border-radius: 20px; padding: 20px; margin-bottom: 25px; position: relative; overflow: hidden; }
    .telegram-card::before { content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); }
    .telegram-card-content { position: relative; z-index: 1; display: flex; align-items: center; gap: 15px; }
    .telegram-icon { font-size: 40px; }
    .telegram-info { flex: 1; }
    .telegram-title { font-size: 16px; font-weight: bold; }
    .telegram-subtitle { color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 3px; }
    .telegram-btn { background: #fff; color: #0088cc; border: none; padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer; white-space: nowrap; }
    
    /* SECTION */
    .section { margin-bottom: 25px; }
    .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    
    /* GAME CARDS */
    .game-grid { display: flex; flex-direction: column; gap: 15px; }
    .game-card { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 15px; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: all 0.3s ease; }
    .game-card:active { transform: scale(0.98); border-color: #4CAF50; }
    .game-icon { width: 70px; height: 70px; border-radius: 15px; object-fit: cover; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    .game-info { flex: 1; }
    .game-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
    .game-desc { color: #aaa; font-size: 12px; line-height: 1.4; }
    .game-badge { background: linear-gradient(135deg, #4CAF50, #45a049); padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; display: inline-block; margin-top: 8px; }
    .game-arrow { color: #666; font-size: 20px; }
    
    /* PAGE SYSTEM */
    .page { display: none; }
    .page.active { display: block; }
    
    /* BACK BUTTON */
    .back-btn { background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 10px 15px; border-radius: 10px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 20px; }
    .back-btn:active { opacity: 0.7; }
    
    /* SETUP STEPS */
    .setup-step { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; margin-bottom: 15px; }
    .setup-step-header { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
    .setup-step-number { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #4CAF50, #45a049); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; flex-shrink: 0; }
    .setup-step-title { font-size: 16px; font-weight: bold; }
    .setup-step-desc { color: #aaa; font-size: 13px; line-height: 1.5; margin-bottom: 15px; }
    .setup-step-action { display: flex; gap: 10px; flex-wrap: wrap; }
    .setup-step-action .btn { margin-bottom: 0; flex: 1; min-width: 140px; }
    
    /* DETAIL BUTTON */
    .detail-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; flex: 1; }
    
    /* MODAL */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
    .modal-overlay.show { display: flex; }
    .modal { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; max-width: 450px; width: 100%; max-height: 85vh; overflow-y: auto; border: 2px solid rgba(255,255,255,0.1); }
    .modal-header { background: linear-gradient(135deg, #4CAF50, #45a049); padding: 20px; border-radius: 18px 18px 0 0; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 10; }
    .modal-header.orange { background: linear-gradient(135deg, #FF9800, #F57C00); }
    .modal-title { font-size: 18px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
    .modal-close { background: rgba(255,255,255,0.2); border: none; color: #fff; width: 35px; height: 35px; border-radius: 50%; font-size: 20px; cursor: pointer; }
    .modal-body { padding: 20px; }
    
    /* SUCCESS MODAL */
    .success-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(8px); animation: fadeIn 0.3s ease; }
    .success-overlay.show { display: flex; }
    .success-content { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 25px; padding: 40px 30px; text-align: center; border: 2px solid rgba(76, 175, 80, 0.5); box-shadow: 0 0 50px rgba(76, 175, 80, 0.3); animation: scaleIn 0.4s ease; max-width: 350px; width: 100%; }
    .success-icon { font-size: 80px; margin-bottom: 20px; animation: bounce 0.6s ease; }
    .success-title { font-size: 24px; font-weight: bold; color: #4CAF50; margin-bottom: 10px; }
    .success-message { color: #aaa; font-size: 14px; line-height: 1.6; margin-bottom: 25px; }
    .success-btn { background: linear-gradient(135deg, #4CAF50, #45a049); border: none; color: #fff; padding: 15px 40px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; }
    @keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    
    /* VIDEO */
    .video-container { background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 15px; }
    .video-container video { width: 100%; display: block; }
    
    /* STEPS */
    .step-item { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; gap: 12px; }
    .step-num { width: 28px; height: 28px; border-radius: 50%; background: #4CAF50; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; flex-shrink: 0; }
    .step-content { flex: 1; }
    .step-content strong { display: block; margin-bottom: 5px; font-size: 14px; }
    .step-content p { color: #aaa; font-size: 12px; line-height: 1.4; margin: 0; }
    
    /* BOXES */
    .warning-box { background: rgba(255, 152, 0, 0.15); border: 1px solid #FF9800; border-radius: 12px; padding: 15px; margin: 15px 0; }
    .warning-box .boxtitle { color: #FF9800; font-weight: bold; margin-bottom: 8px; font-size: 14px; }
    .warning-box .content { color: #ddd; font-size: 13px; line-height: 1.5; }
    
    .success-box { background: rgba(76, 175, 80, 0.15); border: 1px solid #4CAF50; border-radius: 12px; padding: 15px; margin: 15px 0; }
    .success-box .boxtitle { color: #4CAF50; font-weight: bold; margin-bottom: 8px; font-size: 14px; }
    .success-box .content { color: #ddd; font-size: 13px; line-height: 1.5; }
    
    /* FEATURES */
    .features { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px; margin-top: 15px; }
    .features-title { font-size: 14px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .feature-item { color: #aaa; font-size: 13px; margin-bottom: 6px; padding-left: 5px; }
    .feature-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .feature-item-new { background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 10px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
    
    /* PRICE CARD - Dinamik Hileler İçin */
    .pricing-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .price-card { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.15); border-radius: 16px; padding: 18px 15px; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; min-height: 85px; }
    .price-card:hover { border-color: rgba(76, 175, 80, 0.5); background: rgba(76, 175, 80, 0.08); }
    .price-card:active, .price-card.selected { border-color: #4CAF50; background: rgba(76, 175, 80, 0.2); transform: scale(0.98); box-shadow: 0 0 15px rgba(76, 175, 80, 0.3); }
    .price-card.premium { grid-column: span 2; background: linear-gradient(135deg, rgba(255, 215, 0, 0.12), rgba(255, 193, 7, 0.06)); border-color: rgba(255, 215, 0, 0.4); }
    .price-card.premium:hover { border-color: rgba(255, 215, 0, 0.6); }
    .price-card.premium.selected { border-color: #FFD700; background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 193, 7, 0.2)); box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
    .price-card .price-label { font-size: 16px; font-weight: bold; color: #fff; }
    .price-card.premium .price-label { color: #FFD700; font-size: 18px; }
    .price-card .price-value { font-size: 18px; font-weight: bold; color: #4CAF50; }
    .price-card.premium .price-value { color: #FFD700; font-size: 20px; }
    .price-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; }
    .price-item.highlight { background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 193, 7, 0.1)); }
    .price-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 0 15px; }
    
    /* PRICE BUTTONS */
    .price-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 15px; padding: 10px; }
    .price-btn { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.15); border-radius: 16px; padding: 20px 15px; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; min-height: 90px; }
    .price-btn:hover { border-color: rgba(76, 175, 80, 0.5); background: rgba(76, 175, 80, 0.08); }
    .price-btn:active, .price-btn.selected { border-color: #4CAF50; background: rgba(76, 175, 80, 0.2); transform: scale(0.98); box-shadow: 0 0 15px rgba(76, 175, 80, 0.3); }
    .price-btn.premium { grid-column: span 2; background: linear-gradient(135deg, rgba(255, 215, 0, 0.12), rgba(255, 193, 7, 0.06)); border-color: rgba(255, 215, 0, 0.4); }
    .price-btn.premium:hover { border-color: rgba(255, 215, 0, 0.6); background: linear-gradient(135deg, rgba(255, 215, 0, 0.18), rgba(255, 193, 7, 0.1)); }
    .price-btn.premium.selected { border-color: #FFD700; background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 193, 7, 0.2)); box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
    .price-btn-label { font-size: 18px; font-weight: bold; color: #fff; }
    .price-btn.premium .price-btn-label { color: #FFD700; font-size: 20px; }
    .price-btn-sub { font-size: 12px; color: #999; }
    .price-btn-price { font-size: 16px; font-weight: bold; color: #4CAF50; margin-top: 4px; }
    .price-btn.premium .price-btn-price { color: #FFD700; font-size: 18px; }
    
    /* SELECTED PRICE CARD */
    .selected-price-card { background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(69, 160, 73, 0.1)); border: 2px solid #4CAF50; border-radius: 15px; padding: 15px; display: flex; align-items: center; justify-content: space-between; gap: 15px; animation: fadeIn 0.3s ease; }
    .selected-price-card.premium { background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 193, 7, 0.1)); border-color: #FFD700; }
    .selected-price-info { flex: 1; }
    .selected-price-label { font-size: 14px; color: #aaa; margin-bottom: 5px; }
    .selected-price-value { font-size: 28px; font-weight: bold; color: #4CAF50; }
    .selected-price-card.premium .selected-price-value { color: #FFD700; }
    .buy-telegram-btn { background: linear-gradient(135deg, #0088cc, #0077b5); border: none; color: #fff; padding: 15px 25px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; white-space: nowrap; }
    .buy-telegram-btn:active { transform: scale(0.98); opacity: 0.9; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideOutRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100px); } }

    .divider { height: 1px; background: rgba(255,255,255,0.1); margin: 25px 0; }
    
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #333; color: #fff; padding: 12px 25px; border-radius: 10px; z-index: 1100; transition: transform 0.3s ease; font-size: 13px; }
    .toast.show { transform: translateX(-50%) translateY(0); }
    
    /* AUTH STYLES */
    .auth-card { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; margin-bottom: 20px; }
    .auth-input { width: 100%; padding: 15px; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(255,255,255,0.05); color: #fff; font-size: 16px; margin-bottom: 12px; outline: none; }
    .auth-input:focus { border-color: #4CAF50; }
    .auth-input::placeholder { color: #666; }
    .auth-link { color: #4CAF50; cursor: pointer; text-decoration: underline; }
    .user-badge { background: linear-gradient(135deg, #4CAF50, #45a049); padding: 8px 15px; border-radius: 20px; font-size: 12px; display: inline-flex; align-items: center; gap: 8px; }
    .user-card { background: rgba(76, 175, 80, 0.1); border: 2px solid #4CAF50; border-radius: 20px; padding: 20px; margin-bottom: 20px; }
    .key-status { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-top: 15px; }
    .key-active { border: 2px solid #4CAF50; background: rgba(76, 175, 80, 0.1); }
    .key-expired { border: 2px solid #f44336; background: rgba(244, 67, 54, 0.1); }
    
    /* COLLAPSIBLE ADMIN SECTIONS */
    .admin-section { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 16px; margin-bottom: 12px; overflow: hidden; }
    .admin-section-header { display: flex; align-items: center; justify-content: space-between; padding: 15px 18px; cursor: pointer; transition: all 0.2s ease; }
    .admin-section-header:hover { background: rgba(255,255,255,0.03); }
    .admin-section-header:active { background: rgba(255,255,255,0.05); }
    .admin-section-title { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 14px; }
    .admin-section-title .icon { font-size: 18px; }
    .admin-section-toggle { font-size: 12px; color: #888; transition: transform 0.3s ease; }
    .admin-section.open .admin-section-toggle { transform: rotate(180deg); }
    .admin-section-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease; padding: 0 18px; }
    .admin-section.open .admin-section-content { max-height: 2000px; padding: 0 18px 18px 18px; }
    
    /* NOTIFICATION TOAST */
    .notification-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: linear-gradient(135deg, #4CAF50, #45a049); color: #fff; padding: 15px 25px; border-radius: 15px; z-index: 2000; transition: transform 0.4s ease; font-size: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 90%; text-align: center; }
    .notification-toast.show { transform: translateX(-50%) translateY(0); }
    .notification-toast.error { background: linear-gradient(135deg, #f44336, #d32f2f); }
    .notification-toast.warning { background: linear-gradient(135deg, #FF9800, #F57C00); }
    
    /* ORDER CARD */
    .order-card { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 12px; }
    .order-card.pending { border-color: #FF9800; background: rgba(255, 152, 0, 0.1); }
    .order-card.approved { border-color: #4CAF50; background: rgba(76, 175, 80, 0.1); }
    .order-card.rejected { border-color: #f44336; background: rgba(244, 67, 54, 0.1); }
    .order-status { display: inline-block; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; }
    .order-status.pending { background: #FF9800; color: #000; }
    .order-status.approved { background: #4CAF50; color: #fff; }
    .order-status.rejected { background: #f44336; color: #fff; }
    
    /* PAYMENT METHOD BUTTONS */
    .payment-method-btn { width: 100%; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 18px 20px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: space-between; color: #fff; }
    .payment-method-btn:hover, .payment-method-btn:active { border-color: #4CAF50; background: rgba(76, 175, 80, 0.1); transform: scale(0.98); }
    
    /* ===================== PROFİL PANELİ SIDEBAR ===================== */
    .profile-toggle-btn { position: fixed !important; top: calc(15px + env(safe-area-inset-top, 0px)) !important; right: 15px !important; left: auto !important; z-index: 999; width: 50px; height: 50px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); background: linear-gradient(135deg, #1a1a2e, #16213e); cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.3s ease; overflow: hidden; }
    .profile-toggle-btn:active { transform: scale(0.95); }
    .profile-toggle-btn img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .profile-toggle-btn .default-avatar { font-size: 24px; }
    .profile-toggle-btn.logged-in { border-color: #4CAF50; }
    .profile-toggle-btn .notification-dot { position: absolute; top: 2px; left: 2px; width: 12px; height: 12px; background: #f44336; border-radius: 50%; border: 2px solid #1a1a2e; }
    
    .profile-sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; backdrop-filter: blur(5px); }
    .profile-sidebar-overlay.active { opacity: 1; visibility: visible; }
    
    .profile-sidebar { position: fixed; top: 0; right: 0; width: 85%; max-width: 320px; height: 100%; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); z-index: 1001; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: -5px 0 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
    .profile-sidebar.active { transform: translateX(0); }
    
    .profile-sidebar-header { background: linear-gradient(135deg, #4CAF50, #45a049); padding: 30px 20px; padding-top: calc(30px + env(safe-area-inset-top, 0px)); text-align: center; position: relative; }
    .profile-sidebar-header.logged-out { background: linear-gradient(135deg, #2196F3, #1976D2); }
    .profile-close-btn { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: #fff; width: 35px; height: 35px; border-radius: 50%; font-size: 18px; cursor: pointer; }
    
    .profile-avatar-container { position: relative; width: 100px; height: 100px; margin: 0 auto 15px; }
    .profile-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); object-fit: cover; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 50px; overflow: hidden; }
    .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .profile-avatar-edit { position: absolute; bottom: 0; right: 0; width: 32px; height: 32px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-size: 14px; }
    .profile-avatar-edit input { display: none; }
    
    .profile-username { font-size: 18px; font-weight: bold; color: #fff; margin-bottom: 5px; word-break: break-all; }
    .profile-email { font-size: 12px; color: rgba(255,255,255,0.8); word-break: break-all; }
    
    .profile-sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }
    
    .profile-menu-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent; }
    .profile-menu-item:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
    .profile-menu-item.active { border-color: #4CAF50; background: rgba(76, 175, 80, 0.15); }
    .profile-menu-item .menu-icon { font-size: 22px; width: 35px; text-align: center; }
    .profile-menu-item .menu-text { flex: 1; }
    .profile-menu-item .menu-title { font-size: 14px; font-weight: bold; }
    .profile-menu-item .menu-subtitle { font-size: 11px; color: #aaa; }
    .profile-menu-item .menu-badge { background: #f44336; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
    .profile-menu-item .menu-arrow { color: #666; font-size: 16px; }
    
    .profile-key-status { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
    .profile-key-status.active { background: rgba(76, 175, 80, 0.15); border: 1px solid rgba(76, 175, 80, 0.3); }
    .profile-key-status.expired { background: rgba(244, 67, 54, 0.15); border: 1px solid rgba(244, 67, 54, 0.3); }
    .profile-key-title { font-size: 12px; color: #aaa; margin-bottom: 5px; }
    .profile-key-value { font-size: 14px; font-weight: bold; }
    .profile-key-value.active { color: #4CAF50; }
    .profile-key-value.expired { color: #f44336; }
    
    .profile-logout-btn { width: 100%; background: rgba(244, 67, 54, 0.15); border: 2px solid rgba(244, 67, 54, 0.3); color: #f44336; padding: 15px; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .profile-logout-btn:active { background: rgba(244, 67, 54, 0.25); transform: scale(0.98); }
    
    .profile-login-section { text-align: center; padding: 30px 20px; }
    .profile-login-section .login-icon { font-size: 60px; margin-bottom: 15px; }
    .profile-login-section h3 { margin-bottom: 10px; }
    .profile-login-section p { color: #aaa; font-size: 13px; margin-bottom: 20px; }
    .profile-login-btn { width: 100%; background: linear-gradient(135deg, #4CAF50, #45a049); border: none; color: #fff; padding: 15px; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
    .profile-register-btn { width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 15px; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; }
    
    @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes slideOutRight { from { transform: translateX(0); } to { transform: translateX(100%); } }
</style>

<body>

<!-- 🏪 BestOfShop - HİLE MAĞAZASI ARKA PLAN -->
<div class="animated-bg">
    <!-- Kayan BestOfShop Yazıları -->
    <div class="text-banner text-banner-1">BestOfShop • BestOfShop • BestOfShop • BestOfShop • BestOfShop • BestOfShop • </div>
    <div class="text-banner text-banner-2">BestOfShop • BestOfShop • BestOfShop • BestOfShop • BestOfShop • BestOfShop • </div>
    <div class="text-banner text-banner-3">BestOfShop • BestOfShop • BestOfShop • BestOfShop • BestOfShop • BestOfShop • </div>
    <div class="text-banner text-banner-4">BestOfShop • BestOfShop • BestOfShop • BestOfShop • BestOfShop • BestOfShop • </div>
    
    <!-- Dikey Kayan Yazılar -->
    <div class="text-vertical text-vertical-1">BestOfShop BestOfShop BestOfShop</div>
    <div class="text-vertical text-vertical-2">BestOfShop BestOfShop BestOfShop</div>
    
    <!-- Parlayan Köşeler -->
    <div class="corner-glow corner-glow-1"></div>
    <div class="corner-glow corner-glow-2"></div>
    <div class="corner-glow corner-glow-3"></div>
    
    <!-- Yatay Çizgiler -->
    <div class="store-line store-line-1"></div>
    <div class="store-line store-line-2"></div>
    <div class="store-line store-line-3"></div>
    
    <!-- Kayan Işık Çubukları -->
    <div class="light-bar light-bar-1"></div>
    <div class="light-bar light-bar-2"></div>
    <div class="light-bar light-bar-3"></div>
    
    <!-- Parıltılar -->
    <div class="sparkle sparkle-1"></div>
    <div class="sparkle sparkle-2"></div>
    <div class="sparkle sparkle-3"></div>
    <div class="sparkle sparkle-4"></div>
    <div class="sparkle sparkle-5"></div>
    <div class="sparkle sparkle-6"></div>
    
    <!-- Efekt Katmanları -->
    <div class="grid-overlay"></div>
    <div class="vignette"></div>
</div>

<!-- ===================== SİPARİŞ ONAY POPUP (EKRAN ORTASI) ===================== -->
<div id="orderApprovalPopup" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 99999; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px; padding: 30px; margin: 20px; max-width: 350px; text-align: center; animation: popupBounce 0.5s ease; border: 2px solid #4CAF50; box-shadow: 0 0 50px rgba(76, 175, 80, 0.5);">
        <div style="font-size: 80px; margin-bottom: 15px;">🎉</div>
        <div style="font-size: 24px; font-weight: bold; color: #4CAF50; margin-bottom: 10px;">Siparişiniz Onaylandı!</div>
        <div id="approvalPopupMessage" style="color: #fff; font-size: 16px; margin-bottom: 20px; line-height: 1.6;"></div>
        <div id="approvalPopupKey" style="background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
            <div style="color: #aaa; font-size: 12px; margin-bottom: 5px;">KEY KODUNUZ</div>
            <div style="color: #4CAF50; font-size: 20px; font-weight: bold; font-family: monospace; word-break: break-all;"></div>
        </div>
        <button onclick="closeOrderApprovalPopup()" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: #fff; border: none; padding: 15px 40px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);">
            ✓ Tamam
        </button>
    </div>
</div>

<style>
@keyframes popupBounce {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); opacity: 1; }
}
.notif-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #f44336;
    color: #fff;
    font-size: 10px;
    font-weight: bold;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    box-shadow: 0 2px 5px rgba(244, 67, 54, 0.5);
    animation: badgePulse 2s infinite;
}
@keyframes badgePulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
</style>

<!-- ===================== PROFİL TOGGLE BUTONU (SAĞ ÜST) ===================== -->
<button class="profile-toggle-btn" id="profileToggleBtn" onclick="toggleProfilePanel()">
    <span class="default-avatar">👤</span>
    <img id="toggleBtnAvatar" src="" style="display: none;">
    <span class="notification-dot" id="profileNotifDot" style="display: none;"></span>
    <span class="notif-badge" id="profileNotifBadge">0</span>
</button>

<!-- ===================== PROFİL SIDEBAR PANELİ ===================== -->
<div class="profile-sidebar-overlay" id="profileOverlay" onclick="toggleProfilePanel()"></div>
<div class="profile-sidebar" id="profileSidebar">
    <!-- Giriş Yapmış Kullanıcı Header -->
    <div class="profile-sidebar-header" id="sidebarHeaderLoggedIn" style="display: none;">
        <button class="profile-close-btn" onclick="toggleProfilePanel()">✕</button>
        <div class="profile-avatar-container">
            <div class="profile-avatar" id="profileAvatarDisplay">
                <span>👤</span>
                <img id="profileAvatarImg" src="" style="display: none;">
            </div>
            <label class="profile-avatar-edit">
                📷
                <input type="file" id="profilePhotoInput" accept="image/*" onchange="handleProfilePhotoSelect(event)">
            </label>
        </div>
        <div class="profile-username" id="sidebarUsername">Kullanıcı</div>
        <div class="profile-email" id="sidebarEmail">kullanici@email.com</div>
    </div>
    
    <!-- Giriş Yapmamış Kullanıcı Header -->
    <div class="profile-sidebar-header logged-out" id="sidebarHeaderLoggedOut">
        <button class="profile-close-btn" onclick="toggleProfilePanel()">✕</button>
        <div class="profile-avatar-container">
            <div class="profile-avatar">
                <span>👤</span>
            </div>
        </div>
        <div class="profile-username">Hoş Geldiniz</div>
        <div class="profile-email">Giriş yapın veya kayıt olun</div>
    </div>
    
    <!-- Sidebar İçerik -->
    <div class="profile-sidebar-content">
        <!-- Giriş Yapmış Kullanıcı İçeriği -->
        <div id="sidebarContentLoggedIn" style="display: none;">
            <!-- Key Durumu -->
            <div class="profile-key-status" id="sidebarKeyStatus" onclick="openKeyDetailModal(); toggleProfilePanel();">
                <div class="profile-key-title">🔑 Key Durumu</div>
                <div class="profile-key-value" id="sidebarKeyText">Aktif Key Yok</div>
            </div>
            
            <!-- Menü Öğeleri -->
            <div class="profile-menu-item" onclick="openModal('redeemKeyModal'); toggleProfilePanel();">
                <span class="menu-icon">🎟️</span>
                <div class="menu-text">
                    <div class="menu-title">Key Kodu Gir</div>
                    <div class="menu-subtitle">Satın aldığınız key'i aktifleştirin</div>
                </div>
                <span class="menu-arrow">›</span>
            </div>
            
            <div class="profile-menu-item" onclick="navigateTo('myOrdersPage'); loadMyOrders(); toggleProfilePanel();">
                <span class="menu-icon">📦</span>
                <div class="menu-text">
                    <div class="menu-title">Siparişlerim</div>
                    <div class="menu-subtitle">Tüm siparişlerinizi görüntüleyin</div>
                </div>
                <span class="menu-badge" id="sidebarOrderBadge" style="display: none;">0</span>
                <span class="menu-arrow">›</span>
            </div>
            
            <div class="profile-menu-item" onclick="openNotificationsModal(); toggleProfilePanel();">
                <span class="menu-icon">🔔</span>
                <div class="menu-text">
                    <div class="menu-title">Bildirimler</div>
                    <div class="menu-subtitle">Bildirimlerinizi kontrol edin</div>
                </div>
                <span class="menu-badge" id="sidebarNotifBadge" style="display: none;">0</span>
                <span class="menu-arrow">›</span>
            </div>
            
            <div class="profile-menu-item" onclick="openUserChatModal(); toggleProfilePanel();">
                <span class="menu-icon">💬</span>
                <div class="menu-text">
                    <div class="menu-title">Destek</div>
                    <div class="menu-subtitle">Yardım alın veya soru sorun</div>
                </div>
                <span class="menu-badge" id="sidebarChatBadge" style="display: none;">0</span>
                <span class="menu-arrow">›</span>
            </div>
            
            <!-- Admin Butonu -->
            <div class="profile-menu-item" id="sidebarAdminBtn" style="display: none;" onclick="navigateTo('adminPage'); loadPendingOrders(); toggleProfilePanel();">
                <span class="menu-icon">👑</span>
                <div class="menu-text">
                    <div class="menu-title">Admin Panel</div>
                    <div class="menu-subtitle">Yönetim paneline erişin</div>
                </div>
                <span class="menu-arrow">›</span>
            </div>
            
            <!-- Şifre Değiştir Butonu -->
            <div class="profile-menu-item" onclick="openChangePasswordModal(); toggleProfilePanel();">
                <span class="menu-icon">🔒</span>
                <div class="menu-text">
                    <div class="menu-title">Şifre Değiştir</div>
                    <div class="menu-subtitle">Hesap şifrenizi güncelleyin</div>
                </div>
                <span class="menu-arrow">›</span>
            </div>
            
            <!-- Çıkış Butonu -->
            <button class="profile-logout-btn" onclick="logout(); toggleProfilePanel();">🚪 Çıkış Yap</button>
        </div>
        
        <!-- Giriş Yapmamış Kullanıcı İçeriği -->
        <div id="sidebarContentLoggedOut">
            <div class="profile-login-section">
                <div class="login-icon">🔐</div>
                <h3>Hesabınıza Giriş Yapın</h3>
                <p>Satın alma, key yönetimi ve özel içeriklere erişmek için giriş yapın</p>
                <button class="profile-login-btn" onclick="navigateTo('loginPage'); toggleProfilePanel();">🔐 Giriş Yap</button>
                <button class="profile-register-btn" onclick="navigateTo('registerPage'); toggleProfilePanel();">📝 Kayıt Ol</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== GİRİŞ SAYFA ==================== -->
<div class="page" id="loginPage">
<div class="container">
    <button class="back-btn" onclick="navigateBack()">← Geri</button>
    <div class="header" style="margin-bottom: 20px;">
        <div style="font-size: 60px; margin-bottom: 10px;">🔐</div>
        <h1 class="title" style="font-size: 24px;">Giriş Yap</h1>
        <p class="subtitle">Hesabınıza giriş yapın</p>
    </div>
    <div class="auth-card">
        <input type="email" id="loginEmail" class="auth-input" placeholder="E-posta adresiniz">
        <input type="password" id="loginPassword" class="auth-input" placeholder="Şifreniz">
        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer; user-select: none;">
            <input type="checkbox" id="rememberMe" style="width: 20px; height: 20px; accent-color: #4CAF50; cursor: pointer;">
            <span style="color: #aaa; font-size: 14px;">Beni Hatırla</span>
        </label>
        <button class="btn btn-primary" onclick="loginUser()">Giriş Yap</button>
        <p style="text-align: center; color: #aaa; font-size: 13px; margin-top: 15px;">
            <span class="auth-link" onclick="navigateTo('forgotPasswordPage')" style="color: #FF9800;">🔑 Şifremi Unuttum</span>
        </p>
        <p style="text-align: center; color: #aaa; font-size: 13px; margin-top: 10px;">
            Hesabınız yok mu? <span class="auth-link" onclick="navigateTo('registerPage')">Kayıt Ol</span>
        </p>
    </div>
</div>
</div>

<!-- ==================== ŞİFREMİ UNUTTUM SAYFA ==================== -->
<div class="page" id="forgotPasswordPage">
<div class="container">
    <button class="back-btn" onclick="navigateTo('loginPage')">← Geri</button>
    <div class="header" style="margin-bottom: 20px;">
        <div style="font-size: 60px; margin-bottom: 10px;">🔐</div>
        <h1 class="title" style="font-size: 24px;">Şifremi Unuttum</h1>
        <p class="subtitle">Şifre sıfırlama bağlantısı alın</p>
    </div>
    <div class="auth-card">
        <div style="background: rgba(33,150,243,0.15); border: 1px solid #2196F3; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="font-size: 24px;">📧</div>
                <div style="font-size: 13px; color: #aaa; line-height: 1.5;">E-posta adresinize şifre sıfırlama bağlantısı göndereceğiz. Bağlantıya tıklayarak yeni şifrenizi belirleyebilirsiniz.</div>
            </div>
        </div>
        <input type="email" id="forgotEmail" class="auth-input" placeholder="Kayıtlı e-posta adresiniz">
        <button class="btn btn-warning" onclick="sendPasswordReset()" id="resetBtn">📤 Sıfırlama Bağlantısı Gönder</button>
        <div id="resetSuccessMsg" style="display: none; background: rgba(76,175,80,0.15); border: 1px solid #4CAF50; border-radius: 12px; padding: 15px; margin-top: 15px; text-align: center;">
            <div style="font-size: 30px; margin-bottom: 10px;">✅</div>
            <div style="font-weight: bold; color: #4CAF50; margin-bottom: 5px;">E-posta Gönderildi!</div>
            <div style="font-size: 13px; color: #aaa;">Lütfen e-posta kutunuzu kontrol edin. Spam klasörünü de kontrol etmeyi unutmayın.</div>
        </div>
        <p style="text-align: center; color: #aaa; font-size: 13px; margin-top: 20px;">
            Şifrenizi hatırladınız mı? <span class="auth-link" onclick="navigateTo('loginPage')">Giriş Yap</span>
        </p>
    </div>
</div>
</div>

<!-- ==================== KAYIT SAYFA ==================== -->
<div class="page" id="registerPage">
<div class="container">
    <button class="back-btn" onclick="navigateBack()">← Geri</button>
    <div class="header" style="margin-bottom: 20px;">
        <div style="font-size: 60px; margin-bottom: 10px;">📝</div>
        <h1 class="title" style="font-size: 24px;">Kayıt Ol</h1>
        <p class="subtitle">Yeni hesap oluşturun</p>
    </div>
    <div class="auth-card">
        <input type="email" id="registerEmail" class="auth-input" placeholder="E-posta adresiniz">
        <input type="password" id="registerPassword" class="auth-input" placeholder="Şifre (min 6 karakter)">
        <input type="password" id="registerPassword2" class="auth-input" placeholder="Şifre tekrar">
        <button class="btn btn-primary" onclick="registerUser()">Kayıt Ol</button>
        <p style="text-align: center; color: #aaa; font-size: 13px; margin-top: 15px;">
            Zaten hesabınız var mı? <span class="auth-link" onclick="navigateTo('loginPage')">Giriş Yap</span>
        </p>
    </div>
</div>
</div>

<!-- ==================== SİPARİŞLERİM SAYFA ==================== -->
<div class="page" id="myOrdersPage">
<div class="container">
    <button class="back-btn" onclick="navigateBack()">← Geri</button>
    <div class="header" style="margin-bottom: 20px;">
        <div style="font-size: 60px; margin-bottom: 10px;">📦</div>
        <h1 class="title" style="font-size: 24px;">Siparişlerim</h1>
        <p class="subtitle">Tüm siparişlerinizi görüntüleyin</p>
    </div>
    
    <div id="myOrdersList">
        <div style="text-align: center; padding: 30px; color: #aaa;">Yükleniyor...</div>
    </div>
</div>
</div>

<!-- ==================== ADMİN PANELİ ==================== -->
<div class="page" id="adminPage">
<div class="container">
    <button class="back-btn" onclick="navigateBack()">← Geri</button>
    <div class="header" style="margin-bottom: 20px;">
        <div style="font-size: 60px; margin-bottom: 10px;">👑</div>
        <h1 class="title" style="font-size: 24px;">Admin Panel</h1>
        <p class="subtitle">Yönetim Paneli</p>
        <div id="myPermissionsBadge" style="margin-top: 10px; font-size: 12px; color: #aaa;"></div>
    </div>
    
    <!-- Admin Yönetimi (admin_management yetkisi) -->
    <div class="admin-section permission-section" id="adminManagementSection" data-permission="admin_management">
        <div class="admin-section-header" onclick="toggleAdminSection(this)">
            <div class="admin-section-title">
                <span class="icon">👮</span>
                <span>Admin Yönetimi</span>
                <span class="permission-badge" style="background: #9C27B0; padding: 2px 6px; border-radius: 5px; font-size: 10px;">admin_management</span>
            </div>
            <span class="admin-section-toggle">▼</span>
        </div>
        <div class="admin-section-content">
            <!-- Admin Ekle -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <input type="email" id="newAdminEmail" class="auth-input" placeholder="Admin yapılacak e-posta" style="flex: 1; margin: 0;">
                <button onclick="openAddAdminModal()" style="background: #4CAF50; border: none; color: #fff; padding: 10px 15px; border-radius: 10px; font-size: 14px; cursor: pointer; white-space: nowrap;">➕ Ekle</button>
            </div>
            <!-- Admin Listesi -->
            <div id="adminListContainer" style="max-height: 400px; overflow-y: auto;">
                <div style="font-size: 13px; color: #aaa; text-align: center; padding: 15px;">Yüklemek için bölümü açın</div>
            </div>
            <button onclick="loadAdminListUI()" style="background: #FF9800; border: none; color: #fff; padding: 8px 15px; border-radius: 8px; font-size: 12px; cursor: pointer; margin-top: 10px; width: 100%;">🔄 Yenile</button>
        </div>
    </div>
    
    <!-- Üye Yönetimi (members_view yetkisi) -->
    <div class="admin-section permission-section" id="membersSection" data-permission="members_view">
        <div class="admin-section-header" onclick="toggleAdminSection(this)">
            <div class="admin-section-title">
                <span class="icon">👥</span>
                <span>Üye Yönetimi</span>
                <span id="totalUsersCount" style="background: #2196F3; padding: 2px 8px; border-radius: 10px; font-size: 11px;">0</span>
                <span class="permission-badge" style="background: #2196F3; padding: 2px 6px; border-radius: 5px; font-size: 10px;">members_view</span>
            </div>
            <span class="admin-section-toggle">▼</span>
        </div>
        <div class="admin-section-content">
            <div id="usersListContainer" style="max-height: 300px; overflow-y: auto;">
                <div style="font-size: 13px; color: #aaa; text-align: center; padding: 20px;">Yüklemek için bölümü açın</div>
            </div>
            <button onclick="loadAllUsers()" style="background: #2196F3; border: none; color: #fff; padding: 8px 15px; border-radius: 8px; font-size: 12px; cursor: pointer; margin-top: 10px; width: 100%;">🔄 Yenile</button>
        </div>
    </div>
    
    <!-- Key Aktifle (keys_add yetkisi) -->
    <div class="admin-section permission-section" id="keysAddSection" data-permission="keys_add">
        <div class="admin-section-header" onclick="toggleAdminSection(this)">
            <div class="admin-section-title">
                <span class="icon">🔑</span>
                <span>Key Aktifle</span>
                <span class="permission-badge" style="background: #4CAF50; padding: 2px 6px; border-radius: 5px; font-size: 10px;">keys_add</span>
            </div>
            <span class="admin-section-toggle">▼</span>
        </div>
        <div class="admin-section-content">
            <input type="email" id="adminUserEmail" class="auth-input" placeholder="Kullanıcı e-posta">
            <select id="adminGame" class="auth-input" style="color: #fff;" onchange="updateCheatOptions()">
                <option value="">🎮 Oyun Seçin...</option>
            </select>
            <select id="adminCheat" class="auth-input" style="color: #fff;" disabled>
                <option value="">🛡️ Önce oyun seçin...</option>
            </select>
            <select id="adminPackage" class="auth-input" style="color: #fff;">
                <option value="1">⏱️ 1 Günlük</option>
                <option value="7">⏱️ 7 Günlük</option>
                <option value="30">⏱️ 30 Günlük</option>
                <option value="60">⏱️ 60 Günlük</option>
                <option value="90">⏱️ 90 Günlük</option>
                <option value="365">⏱️ Sınırsız (1 Yıl)</option>
            </select>
            <input type="text" id="adminKeyCode" class="auth-input" placeholder="🔑 Key Kodu (TheBestML panelden aldığınız key)" style="font-family: monospace;">
            <div style="font-size: 11px; color: #888; margin-top: -8px; margin-bottom: 10px;">💡 Boş bırakılırsa otomatik üretilir</div>
            <button class="btn btn-primary" onclick="activateKey()">✅ Key Aktifle</button>
        </div>
    </div>
    
    <!-- Oyun/Hile Yönetimi (games yetkisi) -->
    <div class="admin-section permission-section" id="gameCheatManagementSection" data-permission="games">
        <div class="admin-section-header" onclick="toggleAdminSection(this)">
            <div class="admin-section-title">
                <span class="icon">🎮</span>
                <span>Oyun & Hile Yönetimi</span>
                <span class="permission-badge" style="background: #E91E63; padding: 2px 6px; border-radius: 5px; font-size: 10px;">games</span>
            </div>
            <span class="admin-section-toggle">▼</span>
        </div>
        <div class="admin-section-content">
            <div id="gameCheatList" style="font-size: 12px; color: #aaa; max-height: 250px; overflow-y: auto; margin-bottom: 15px;"></div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn btn-primary btn-small" onclick="openGameModal()" style="flex: 1;">➕ Yeni Oyun</button>
                <button class="btn btn-secondary btn-small" onclick="openCheatModal()" style="flex: 1;">➕ Yeni Hile</button>
                <button class="btn btn-warning btn-small" onclick="loadGameCheatList()" style="flex: 1;">🔄 Yenile</button>
            </div>
        </div>
    </div>
    
    <!-- 💳 Ödeme Ayarları (payments yetkisi) -->
    <div class="admin-section permission-section" id="paymentSettingsSection" data-permission="payments">
        <div class="admin-section-header" onclick="toggleAdminSection(this)">
            <div class="admin-section-title">
                <span class="icon">💳</span>
                <span>Ödeme Ayarları</span>
                <span class="permission-badge" style="background: #FF9800; padding: 2px 6px; border-radius: 5px; font-size: 10px;">payments</span>
            </div>
            <span class="admin-section-toggle">▼</span>
        </div>
        <div class="admin-section-content">
            <!-- Banka/Havale Bilgileri -->
            <div style="background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 12px; font-weight: bold; color: #FF9800; margin-bottom: 10px;">🏦 Havale Bilgileri</div>
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 11px; color: #aaa;">Alıcı Adı</label>
                    <input type="text" id="paymentBankName" class="auth-input" placeholder="Alıcı adı" style="font-size: 13px;">
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 11px; color: #aaa;">Banka</label>
                    <input type="text" id="paymentBankBank" class="auth-input" placeholder="Banka adı" style="font-size: 13px;">
                </div>
                <div>
                    <label style="font-size: 11px; color: #aaa;">IBAN</label>
                    <input type="text" id="paymentBankIban" class="auth-input" placeholder="TR00 0000 0000 0000 0000 0000 00" style="font-size: 13px;">
                </div>
            </div>
            <!-- Shopier Ayarları -->
            <div style="background: rgba(76,175,80,0.1); border: 1px solid rgba(76,175,80,0.3); border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 12px; font-weight: bold; color: #4CAF50; margin-bottom: 10px;">🛒 Shopier Ayarları</div>
                <div>
                    <label style="font-size: 11px; color: #aaa;">Shopier Mağaza URL</label>
                    <input type="text" id="paymentShopierUrl" class="auth-input" placeholder="https://www.shopier.com/CheatsStore" style="font-size: 13px;">
                </div>
            </div>
            <!-- Push Server Ayarları -->
            <div style="background: rgba(156,39,176,0.1); border: 1px solid rgba(156,39,176,0.3); border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 12px; font-weight: bold; color: #9C27B0; margin-bottom: 10px;">🔔 Push Bildirim Sunucusu</div>
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 11px; color: #aaa;">Vercel URL</label>
                    <input type="text" id="pushServerUrl" class="auth-input" placeholder="https://your-project.vercel.app" style="font-size: 13px;">
                </div>
                <div>
                    <label style="font-size: 11px; color: #aaa;">API Key</label>
                    <input type="password" id="pushServerApiKey" class="auth-input" placeholder="Güvenlik anahtarı" style="font-size: 13px;">
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-primary" onclick="savePaymentSettings()" style="flex: 1;">💾 Kaydet</button>
                <button class="btn btn-secondary btn-small" onclick="loadPaymentSettingsAdmin()" style="flex: 1;">🔄 Yükle</button>
            </div>
        </div>
    </div>
    
    <!-- 📢 Bildirim Gönderme (notifications yetkisi) -->
    <div class="admin-section permission-section" id="notificationsSection" data-permission="notifications">
        <div class="admin-section-header" onclick="toggleAdminSection(this)">
            <div class="admin-section-title">
                <span class="icon">📢</span>
                <span>Bildirim Gönder</span>
                <span class="permission-badge" style="background: #9C27B0; padding: 2px 6px; border-radius: 5px; font-size: 10px;">notifications</span>
            </div>
            <span class="admin-section-toggle">▼</span>
        </div>
        <div class="admin-section-content">
            <div style="margin-bottom: 12px;">
                <select id="notifTargetType" class="auth-input" style="color: #fff;" onchange="updateNotifTarget()">
                    <option value="all">🌍 Tüm Kullanıcılar</option>
                    <option value="user">👤 Belirli Kullanıcı</option>
                </select>
            </div>
            <div id="notifUserEmailDiv" style="margin-bottom: 12px; display: none;">
                <input type="email" id="notifUserEmail" class="auth-input" placeholder="Kullanıcı e-posta adresi">
            </div>
            <div style="margin-bottom: 12px;">
                <input type="text" id="notifTitle" class="auth-input" placeholder="📌 Bildirim Başlığı">
            </div>
            <div style="margin-bottom: 12px;">
                <textarea id="notifMessage" class="auth-input" placeholder="💬 Mesaj içeriği..." style="height: 80px; resize: none;"></textarea>
            </div>
            <div style="margin-bottom: 12px;">
                <select id="notifType" class="auth-input" style="color: #fff;">
                    <option value="info">ℹ️ Bilgilendirme</option>
                    <option value="success">✅ Başarılı</option>
                    <option value="warning">⚠️ Uyarı</option>
                    <option value="promo">🎁 Promosyon</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="sendNotification()">📤 Bildirim Gönder</button>
        </div>
    </div>
    
    <!-- 💬 Destek Mesajları (support yetkisi) -->
    <div class="admin-section permission-section" id="supportSection" data-permission="support">
        <div class="admin-section-header" onclick="toggleAdminSection(this)">
            <div class="admin-section-title">
                <span class="icon">💬</span>
                <span>Destek Mesajları</span>
                <span id="adminChatCount" style="background: #f44336; padding: 2px 8px; border-radius: 10px; font-size: 11px;">0</span>
                <span class="permission-badge" style="background: #00BCD4; padding: 2px 6px; border-radius: 5px; font-size: 10px;">support</span>
            </div>
            <span class="admin-section-toggle">▼</span>
        </div>
        <div class="admin-section-content">
            <div id="adminChatsList" style="font-size: 13px; color: #aaa; max-height: 300px; overflow-y: auto;">Yükleniyor...</div>
            <button onclick="loadAdminChats()" style="background: #00BCD4; border: none; color: #fff; padding: 8px 15px; border-radius: 8px; font-size: 12px; cursor: pointer; margin-top: 10px; width: 100%;">🔄 Yenile</button>
        </div>
    </div>
    
    <!-- TheBestML Panel (keys_add yetkisi) -->
    <div class="admin-section permission-section" id="keyGeneratorSection" data-permission="keys_add">
        <div class="admin-section-header" onclick="toggleAdminSection(this)">
            <div class="admin-section-title">
                <span class="icon">🔗</span>
                <span>Key Üretimi</span>
                <span class="permission-badge" style="background: #4CAF50; padding: 2px 6px; border-radius: 5px; font-size: 10px;">keys_add</span>
            </div>
            <span class="admin-section-toggle">▼</span>
        </div>
        <div class="admin-section-content">
            <p style="color: #aaa; font-size: 13px; margin-bottom: 15px;">TheBestML panelinden key üretmek için aşağıdaki butona tıklayın.</p>
            <button class="btn btn-warning" onclick="window.open('https://newthebestmod.xyz/app/user/cheat/order', '_blank')" style="width: 100%;">🔗 TheBestML Panel Aç</button>
        </div>
    </div>
    
    <!-- Bekleyen Siparişler (orders yetkisi) -->
    <div class="admin-section permission-section" id="ordersSection" data-permission="orders">
        <div class="admin-section-header" onclick="toggleAdminSection(this)">
            <div class="admin-section-title">
                <span class="icon">📋</span>
                <span>Bekleyen Siparişler</span>
                <span id="orderCount" style="background: #f44336; padding: 2px 8px; border-radius: 10px; font-size: 11px;">0</span>
                <span class="permission-badge" style="background: #FF5722; padding: 2px 6px; border-radius: 5px; font-size: 10px;">orders</span>
            </div>
            <span class="admin-section-toggle">▼</span>
        </div>
        <div class="admin-section-content">
            <div id="pendingOrders" style="font-size: 13px; color: #aaa;">Yükleniyor...</div>
            <button onclick="loadPendingOrders()" style="background: #FF5722; border: none; color: #fff; padding: 8px 15px; border-radius: 8px; font-size: 12px; cursor: pointer; margin-top: 10px; width: 100%;">🔄 Yenile</button>
        </div>
    </div>
    
    <!-- 📖 Kurulum Modalları Yönetimi (modals yetkisi) -->
    <div class="admin-section permission-section" id="setupModalsSection" data-permission="modals">
        <div class="admin-section-header" onclick="toggleAdminSection(this)">
            <div class="admin-section-title">
                <span class="icon">📖</span>
                <span>Kurulum Modalları</span>
                <span class="permission-badge" style="background: #673AB7; padding: 2px 6px; border-radius: 5px; font-size: 10px;">modals</span>
            </div>
            <span class="admin-section-toggle">▼</span>
        </div>
        <div class="admin-section-content">
            <p style="color: #aaa; font-size: 12px; margin-bottom: 15px;">Hileler için özel kurulum rehberi modalları oluşturun ve yönetin.</p>
            <div id="setupModalsList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                <div style="text-align: center; padding: 15px; color: #888; font-size: 13px;">Yükleniyor...</div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-primary btn-small" onclick="openSetupModalEditor()" style="flex: 1;">➕ Yeni Modal</button>
                <button class="btn btn-secondary btn-small" onclick="loadSetupModalsList()" style="flex: 1;">🔄 Yenile</button>
            </div>
        </div>
    </div>
    
    <!-- ⚙️ Uygulama Yönetimi (app_settings yetkisi) -->
    <div class="admin-section permission-section" id="appSettingsSection" data-permission="app_settings">
        <div class="admin-section-header" onclick="toggleAdminSection(this)">
            <div class="admin-section-title">
                <span class="icon">⚙️</span>
                <span>Uygulama Yönetimi</span>
                <span class="permission-badge" style="background: #607D8B; padding: 2px 6px; border-radius: 5px; font-size: 10px;">app_settings</span>
            </div>
            <span class="admin-section-toggle">▼</span>
        </div>
        <div class="admin-section-content">
            <p style="color: #aaa; font-size: 12px; margin-bottom: 15px;">Popup, duyuru, bakım modu ve yedekleme yönetimi.</p>
            
            <!-- Ayar Kategorileri -->
            <div style="display: grid; gap: 8px; margin-bottom: 15px;">
                <button onclick="openAppSettingsModal('popup')" style="background: linear-gradient(135deg, #FF9800, #F57C00); border: none; color: #fff; padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;">
                    <span style="font-size: 20px;">📢</span>
                    <div style="text-align: left; flex: 1;">
                        <div style="font-weight: bold;">Popup & Duyuru</div>
                        <div style="font-size: 11px; opacity: 0.8;">Açılış popup, duyuru banner</div>
                    </div>
                    <span>→</span>
                </button>
                
                <button onclick="openAppSettingsModal('maintenance')" style="background: linear-gradient(135deg, #f44336, #d32f2f); border: none; color: #fff; padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;">
                    <span style="font-size: 20px;">🔧</span>
                    <div style="text-align: left; flex: 1;">
                        <div style="font-weight: bold;">Bakım Modu</div>
                        <div style="font-size: 11px; opacity: 0.8;">Uygulamayı bakım moduna al</div>
                    </div>
                    <span>→</span>
                </button>
            </div>
            
            <!-- Son güncelleme bilgisi -->
            <div id="appSettingsLastUpdate" style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px; font-size: 11px; color: #888; text-align: center;">
                Ayarlar yükleniyor...
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 10px;">
                <button onclick="loadAppSettings()" style="background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 8px 15px; border-radius: 8px; font-size: 12px; cursor: pointer; flex: 1;">🔄 Yenile</button>
                <button onclick="backupCurrentSettings()" style="background: linear-gradient(135deg, #2196F3, #1976D2); border: none; color: #fff; padding: 8px 15px; border-radius: 8px; font-size: 12px; cursor: pointer; flex: 1;">💾 Yedekle</button>
            </div>
            
            <!-- Fabrika Ayarları -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="display: grid; gap: 8px;">
                    <button onclick="uploadOriginalDefaults()" style="background: linear-gradient(135deg, #673AB7, #512DA8); border: none; color: #fff; padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;">
                        <span style="font-size: 20px;">📤</span>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-weight: bold;">Orijinal Ayarları Firestore'a Yükle</div>
                            <div style="font-size: 11px; opacity: 0.8;">VS Code varsayılanlarını kaydet</div>
                        </div>
                        <span>💾</span>
                    </button>
                    
                    <button onclick="loadOriginalDefaults()" style="background: linear-gradient(135deg, #009688, #00796B); border: none; color: #fff; padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;">
                        <span style="font-size: 20px;">📥</span>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-weight: bold;">Orijinal Ayarları Geri Yükle</div>
                            <div style="font-size: 11px; opacity: 0.8;">Firestore'daki orijinale dön</div>
                        </div>
                        <span>🔄</span>
                    </button>
                    
                    <button onclick="showFactoryResetConfirm()" style="background: linear-gradient(135deg, #f44336, #c62828); border: none; color: #fff; padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;">
                        <span style="font-size: 20px;">🏭</span>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-weight: bold;">Fabrika Ayarlarına Dön</div>
                            <div style="font-size: 11px; opacity: 0.8;">Tüm ayarları varsayılana sıfırla</div>
                        </div>
                        <span>⚠️</span>
                    </button>
                </div>
                
                <!-- Orijinal ayarlar bilgisi -->
                <div id="originalDefaultsInfo" style="background: rgba(103,58,183,0.2); border-radius: 8px; padding: 10px; font-size: 11px; color: #b39ddb; margin-top: 10px; display: none;">
                    Orijinal ayarlar bilgisi yükleniyor...
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- ŞİFRE DEĞİŞTİRME MODAL -->
<div class="modal-overlay" id="changePasswordModal" onclick="closeModalOutside(event, 'changePasswordModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 400px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #FF6B6B, #EE5A5A);">
            <div class="modal-title">🔒 Şifre Değiştir</div>
            <button class="modal-close" onclick="closeModal('changePasswordModal')">✕</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,193,7,0.1); border-radius: 10px; border-left: 4px solid #FFC107;">
                <div style="font-size: 14px; color: #FFC107;">⚠️ Güvenlik Uyarısı</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 5px;">Şifrenizi değiştirmek için mevcut şifrenizi doğrulamanız gerekmektedir.</div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: rgba(255,255,255,0.8);">Mevcut Şifre</label>
                <input type="password" id="currentPasswordInput" placeholder="Mevcut şifrenizi girin" style="width: 100%; padding: 12px 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: #fff; font-size: 14px; box-sizing: border-box;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: rgba(255,255,255,0.8);">Yeni Şifre</label>
                <input type="password" id="newPasswordInput" placeholder="En az 6 karakter" style="width: 100%; padding: 12px 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: #fff; font-size: 14px; box-sizing: border-box;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: rgba(255,255,255,0.8);">Yeni Şifre (Tekrar)</label>
                <input type="password" id="confirmNewPasswordInput" placeholder="Yeni şifrenizi tekrar girin" style="width: 100%; padding: 12px 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: #fff; font-size: 14px; box-sizing: border-box;">
            </div>
            
            <div id="passwordChangeError" style="display: none; margin-bottom: 15px; padding: 10px; background: rgba(244,67,54,0.2); border-radius: 8px; color: #f44336; font-size: 13px;"></div>
            
            <button onclick="changePassword()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #4CAF50, #388E3C); border: none; border-radius: 10px; color: #fff; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                🔐 Şifreyi Değiştir
            </button>
        </div>
    </div>
</div>

<!-- BİLDİRİMLER MODAL -->
<div class="modal-overlay" id="notificationsModal" onclick="closeModalOutside(event, 'notificationsModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);">
            <div class="modal-title">🔔 Bildirimler</div>
            <button class="modal-close" onclick="closeModal('notificationsModal')">✕</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 0;">
            <div id="notificationsList" style="padding: 15px;"></div>
            <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button onclick="clearAllNotifications()" style="width: 100%; background: linear-gradient(135deg, #f44336, #d32f2f); border: none; color: #fff; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer;">🗑️ Tüm Bildirimleri Temizle</button>
            </div>
        </div>
    </div>
</div>

<!-- KULLANICI CHAT MODAL -->
<div class="modal-overlay" id="userChatModal" onclick="closeModalOutside(event, 'userChatModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px; height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="background: linear-gradient(135deg, #00BCD4, #0097A7);">
            <div style="display: flex; flex-direction: column; flex: 1;">
                <div class="modal-title">💬 Destek</div>
                <div id="supportAgentInfo" style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 2px; display: none;"></div>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button onclick="clearUserChat()" style="background: rgba(244,67,54,0.2); border: 1px solid #f44336; color: #f44336; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 12px;" title="Sohbeti Temizle">🗑️</button>
                <button class="modal-close" onclick="closeModal('userChatModal')">✕</button>
            </div>
        </div>
        <div id="userChatMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #1a1a2e;">
            <!-- Mesajlar buraya yüklenecek -->
        </div>
        <!-- Dosya önizleme alanı -->
        <div id="userFilePreview" style="display: none; padding: 10px 15px; background: #16213e; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; gap: 10px;">
                <img id="userFilePreviewImg" style="max-width: 60px; max-height: 60px; border-radius: 8px; object-fit: cover;">
                <div style="flex: 1;">
                    <div id="userFileName" style="font-size: 13px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
                    <div id="userFileSize" style="font-size: 11px; color: #aaa;"></div>
                </div>
                <button onclick="clearUserFile()" style="background: #f44336; border: none; color: #fff; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;">✕</button>
            </div>
        </div>
        <div style="padding: 15px; background: #16213e; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; gap: 8px;">
                <input type="file" id="userChatFile" accept="image/*" style="display: none;" onchange="previewUserFile(this)">
                <button onclick="document.getElementById('userChatFile').click()" style="background: rgba(255,255,255,0.1); border: none; color: #aaa; padding: 12px 14px; border-radius: 10px; cursor: pointer;" title="Dosya Ekle">📎</button>
                <input type="text" id="userChatInput" class="auth-input" placeholder="Mesajınızı yazın..." style="flex: 1; margin: 0;" onkeypress="if(event.key==='Enter')sendUserMessage()">
                <button onclick="sendUserMessage()" style="background: linear-gradient(135deg, #00BCD4, #0097A7); border: none; color: #fff; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: bold;">📤</button>
            </div>
        </div>
    </div>
</div>

<!-- ADMİN CHAT MODAL -->
<div class="modal-overlay" id="adminChatModal" onclick="closeModalOutside(event, 'adminChatModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px; height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="background: linear-gradient(135deg, #673AB7, #512DA8);">
            <div class="modal-title" id="adminChatTitle">💬 Sohbet</div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button onclick="clearAdminChat()" style="background: rgba(244,67,54,0.2); border: 1px solid #f44336; color: #f44336; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 12px;" title="Sohbeti Temizle">🗑️</button>
                <button class="modal-close" onclick="closeModal('adminChatModal')">✕</button>
            </div>
        </div>
        <div style="padding: 10px 15px; background: #1a1a2e; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div id="adminChatUserInfo" style="font-size: 13px; color: #aaa;"></div>
        </div>
        <div id="adminChatMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #1a1a2e;">
            <!-- Mesajlar buraya yüklenecek -->
        </div>
        <!-- Dosya önizleme alanı -->
        <div id="adminFilePreview" style="display: none; padding: 10px 15px; background: #16213e; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; gap: 10px;">
                <img id="adminFilePreviewImg" style="max-width: 60px; max-height: 60px; border-radius: 8px; object-fit: cover;">
                <div style="flex: 1;">
                    <div id="adminFileName" style="font-size: 13px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
                    <div id="adminFileSize" style="font-size: 11px; color: #aaa;"></div>
                </div>
                <button onclick="clearAdminFile()" style="background: #f44336; border: none; color: #fff; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;">✕</button>
            </div>
        </div>
        <div style="padding: 15px; background: #16213e; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; gap: 8px;">
                <input type="file" id="adminChatFile" accept="image/*" style="display: none;" onchange="previewAdminFile(this)">
                <button onclick="document.getElementById('adminChatFile').click()" style="background: rgba(255,255,255,0.1); border: none; color: #aaa; padding: 12px 14px; border-radius: 10px; cursor: pointer;" title="Dosya Ekle">📎</button>
                <input type="text" id="adminChatInput" class="auth-input" placeholder="Yanıt yazın..." style="flex: 1; margin: 0;" onkeypress="if(event.key==='Enter')sendAdminMessage()">
                <button onclick="sendAdminMessage()" style="background: linear-gradient(135deg, #673AB7, #512DA8); border: none; color: #fff; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: bold;">📤</button>
            </div>
        </div>
    </div>
</div>

<!-- SÜRE UZATMA MODAL -->
<div class="modal-overlay" id="extendModal" onclick="closeModalOutside(event, 'extendModal')" style="z-index: 10001;">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
            <div class="modal-title">⏰ Süre Uzat</div>
            <button class="modal-close" onclick="closeModal('extendModal')">✕</button>
        </div>
        <div class="modal-body">
            <!-- Mevcut Key Bilgisi -->
            <div style="background: rgba(255,152,0,0.15); border: 1px solid #FF9800; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                    <span style="font-size: 28px;">🎮</span>
                    <div>
                        <div style="font-size: 14px; font-weight: bold; color: #fff;" id="extendGameName">-</div>
                        <div style="font-size: 12px; color: #FFD700;" id="extendCheatName">-</div>
                    </div>
                </div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="font-size: 12px; color: #aaa;">🔑 Key</span>
                        <code style="font-size: 12px; color: #FF9800;" id="extendKeyCode">-</code>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 12px; color: #aaa;">📅 Mevcut Bitiş</span>
                        <span style="font-size: 12px; color: #fff;" id="extendCurrentExpiry">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Süre Seçenekleri -->
            <div style="margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 12px;">📦 Eklenecek Süre Seçin</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;" id="extendOptions">
                    <div class="extend-option" onclick="selectExtendOption(30, '30 Gün', '850₺')" style="background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 24px; margin-bottom: 5px;">📅</div>
                        <div style="font-weight: bold; color: #fff;">+30 Gün</div>
                        <div style="color: #4CAF50; font-weight: bold; margin-top: 5px;">850₺</div>
                    </div>
                    <div class="extend-option" onclick="selectExtendOption(60, '60 Gün', '1.300₺')" style="background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 24px; margin-bottom: 5px;">📅</div>
                        <div style="font-weight: bold; color: #fff;">+60 Gün</div>
                        <div style="color: #4CAF50; font-weight: bold; margin-top: 5px;">1.300₺</div>
                    </div>
                    <div class="extend-option" onclick="selectExtendOption(90, '90 Gün', '1.800₺')" style="background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 24px; margin-bottom: 5px;">📅</div>
                        <div style="font-weight: bold; color: #fff;">+90 Gün</div>
                        <div style="color: #4CAF50; font-weight: bold; margin-top: 5px;">1.800₺</div>
                        <div style="font-size: 10px; color: #aaa; margin-top: 3px;">En Popüler</div>
                    </div>
                    <div class="extend-option" onclick="selectExtendOption(365, 'Sınırsız', '6.500₺')" style="background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 24px; margin-bottom: 5px;">♾️</div>
                        <div style="font-weight: bold; color: #fff;">Sınırsız</div>
                        <div style="color: #FFD700; font-weight: bold; margin-top: 5px;">6.500₺</div>
                        <div style="font-size: 10px; color: #FFD700; margin-top: 3px;">⭐ Premium</div>
                    </div>
                </div>
            </div>
            
            <!-- Seçili Paket Özeti -->
            <div id="extendSummary" style="display: none; background: rgba(76,175,80,0.15); border: 1px solid #4CAF50; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="color: #aaa;">Eklenecek Süre</span>
                    <span style="font-weight: bold; color: #4CAF50;" id="extendSelectedDays">-</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="color: #aaa;">Yeni Bitiş Tarihi</span>
                    <span style="font-weight: bold; color: #fff;" id="extendNewExpiry">-</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <span style="font-weight: bold; color: #fff;">Toplam</span>
                    <span style="font-size: 20px; font-weight: bold; color: #4CAF50;" id="extendTotalPrice">-</span>
                </div>
            </div>
            
            <!-- Ödeme Butonu -->
            <button id="extendPayBtn" onclick="proceedExtendPayment()" style="width: 100%; background: linear-gradient(135deg, #FF9800, #F57C00); border: none; color: #fff; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; opacity: 0.5;" disabled>
                Süre seçin
            </button>
        </div>
    </div>
</div>

<!-- SÜRE UZATMA HAVALE MODAL -->
<div class="modal-overlay" id="extendHavaleModal" onclick="closeModalOutside(event, 'extendHavaleModal')" style="z-index: 10002;">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
            <div class="modal-title">💳 Süre Uzatma Ödemesi</div>
            <button class="modal-close" onclick="closeModal('extendHavaleModal')">✕</button>
        </div>
        <div class="modal-body">
            <!-- Ödeme Bilgileri -->
            <div style="background: rgba(255,152,0,0.15); border: 1px solid #FF9800; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #aaa;">Ödenecek Tutar</div>
                    <div style="font-size: 28px; font-weight: bold; color: #FF9800;" id="extendHavaleAmount">-</div>
                    <div style="font-size: 13px; color: #aaa;" id="extendHavaleInfo">-</div>
                </div>
            </div>
            
            <!-- Banka Bilgileri -->
            <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div style="font-size: 13px; font-weight: bold; margin-bottom: 12px;">🏦 Havale Bilgileri</div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                    <div style="font-size: 11px; color: #aaa; margin-bottom: 4px;">Alıcı</div>
                    <div style="font-size: 13px; color: #fff; font-weight: bold;">ONUR TENK</div>
                </div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                    <div style="font-size: 11px; color: #aaa; margin-bottom: 4px;">Banka</div>
                    <div style="font-size: 13px; color: #fff; font-weight: bold;">Garanti Bankası</div>
                </div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                    <div style="font-size: 11px; color: #aaa; margin-bottom: 4px;">IBAN</div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <code style="font-size: 11px; color: #fff;">TR26 0006 2000 7750 0006 8826 02</code>
                        <button onclick="copyToClipboard('TR2600062000775000068826 02')" style="background: #4CAF50; border: none; color: #fff; padding: 4px 8px; border-radius: 5px; font-size: 10px; cursor: pointer;">📋</button>
                    </div>
                </div>
                <div style="background: rgba(244,67,54,0.2); border-radius: 8px; padding: 10px; border: 1px solid #f44336;">
                    <div style="font-size: 11px; color: #f44336; text-align: center;">⚠️ Açıklama kısmını BOŞ bırakın!</div>
                </div>
            </div>
            
            <!-- Dekont Yükleme -->
            <div style="margin-bottom: 20px;">
                <div style="font-size: 13px; font-weight: bold; margin-bottom: 10px;">📄 Dekont Yükle</div>
                <input type="file" id="extendDekontFile" accept="image/*" style="display: none;" onchange="previewExtendDekont(this)">
                <div onclick="document.getElementById('extendDekontFile').click()" style="background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 25px; text-align: center; cursor: pointer;">
                    <div style="font-size: 30px; margin-bottom: 8px;">📷</div>
                    <div style="color: #aaa; font-size: 13px;">Dekont fotoğrafı seçin</div>
                </div>
                <div id="extendDekontPreview" style="display: none; margin-top: 10px;">
                    <img id="extendDekontImg" style="max-width: 100%; border-radius: 10px;">
                </div>
            </div>
            
            <button onclick="submitExtendOrder()" style="width: 100%; background: linear-gradient(135deg, #4CAF50, #45a049); border: none; color: #fff; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer;">
                ✅ Siparişi Gönder
            </button>
        </div>
    </div>
</div>

<!-- MERKEZİ ÖDEME YÖNTEMİ MODAL -->
<div class="modal-overlay" id="unifiedPaymentModal" onclick="closeModalOutside(event, 'unifiedPaymentModal')" style="z-index: 10003;">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50, #45a049);">
            <div class="modal-title">💳 Ödeme Yöntemi Seçin</div>
            <button class="modal-close" onclick="closeModal('unifiedPaymentModal')">✕</button>
        </div>
        <div class="modal-body">
            <!-- Seçilen Paket Bilgisi -->
            <div style="background: rgba(76,175,80,0.15); border: 1px solid #4CAF50; border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <div id="unifiedPaymentInfo">-</div>
                <div style="font-size: 28px; font-weight: bold; color: #4CAF50; margin-top: 10px;" id="unifiedPaymentPrice">-</div>
            </div>
            
            <!-- Ödeme Yöntemleri (Dinamik) -->
            <div style="display: flex; flex-direction: column; gap: 12px;" id="unifiedPaymentMethods">
                <!-- JavaScript ile doldurulacak -->
            </div>
        </div>
    </div>
</div>

<!-- MERKEZİ HAVALE MODAL -->
<div class="modal-overlay" id="unifiedHavaleModal" onclick="closeModalOutside(event, 'unifiedHavaleModal')" style="z-index: 10004;">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
            <div class="modal-title">🏦 Havale / EFT Ödeme</div>
            <button class="modal-close" onclick="closeModal('unifiedHavaleModal')">✕</button>
        </div>
        <div class="modal-body">
            <!-- Ödeme Tutarı -->
            <div style="background: rgba(255,152,0,0.15); border: 1px solid #FF9800; border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 12px; color: #aaa;">Ödenecek Tutar</div>
                <div style="font-size: 32px; font-weight: bold; color: #FF9800;" id="unifiedHavaleAmount">-</div>
                <div style="font-size: 13px; color: #aaa; margin-top: 5px;" id="unifiedHavaleInfo">-</div>
            </div>
            
            <!-- Banka Bilgileri -->
            <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div style="font-size: 13px; font-weight: bold; margin-bottom: 12px;">🏦 Havale Bilgileri</div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                    <div style="font-size: 11px; color: #aaa; margin-bottom: 4px;">Alıcı</div>
                    <div style="font-size: 13px; color: #fff; font-weight: bold;" id="unifiedBankName">-</div>
                </div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                    <div style="font-size: 11px; color: #aaa; margin-bottom: 4px;">Banka</div>
                    <div style="font-size: 13px; color: #fff; font-weight: bold;" id="unifiedBankBank">-</div>
                </div>
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                    <div style="font-size: 11px; color: #aaa; margin-bottom: 4px;">IBAN</div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <code style="font-size: 11px; color: #fff;" id="unifiedBankIban">-</code>
                        <button onclick="copyUnifiedIban()" style="background: #4CAF50; border: none; color: #fff; padding: 4px 8px; border-radius: 5px; font-size: 10px; cursor: pointer;">📋</button>
                    </div>
                </div>
                <div style="background: rgba(244,67,54,0.2); border-radius: 8px; padding: 10px; border: 1px solid #f44336;">
                    <div style="font-size: 11px; color: #f44336; text-align: center;">⚠️ Açıklama kısmını BOŞ bırakın!</div>
                </div>
            </div>
            
            <!-- Dekont Yükleme -->
            <div style="margin-bottom: 20px;">
                <div style="font-size: 13px; font-weight: bold; margin-bottom: 10px;">📄 Dekont Yükle</div>
                <input type="file" id="unifiedDekontFile" accept="image/*" style="display: none;" onchange="previewUnifiedDekont(this)">
                <div onclick="document.getElementById('unifiedDekontFile').click()" style="background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 25px; text-align: center; cursor: pointer;">
                    <div style="font-size: 30px; margin-bottom: 8px;">📷</div>
                    <div style="color: #aaa; font-size: 13px;">Dekont fotoğrafı seçin</div>
                </div>
                <div id="unifiedDekontPreview" style="display: none; margin-top: 10px;">
                    <img id="unifiedDekontImg" style="max-width: 100%; border-radius: 10px;">
                </div>
            </div>
            
            <button onclick="submitUnifiedOrder()" style="width: 100%; background: linear-gradient(135deg, #4CAF50, #45a049); border: none; color: #fff; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer;">
                ✅ Siparişi Gönder
            </button>
        </div>
    </div>
</div>

<!-- DİNAMİK ÖDEME MODAL -->
<div class="modal-overlay" id="dynamicPaymentModal" onclick="closeModalOutside(event, 'dynamicPaymentModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50, #45a049);">
            <div class="modal-title">💳 Ödeme Yöntemi Seçin</div>
            <button class="modal-close" onclick="closeModal('dynamicPaymentModal')">✕</button>
        </div>
        <div class="modal-body">
            <!-- Seçilen Paket Bilgisi -->
            <div style="background: rgba(76,175,80,0.15); border: 1px solid #4CAF50; border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 12px; color: #aaa; margin-bottom: 5px;">Seçilen Paket</div>
                <div style="font-size: 16px; font-weight: bold;" id="dynamicModalPackageName">-</div>
                <div style="font-size: 24px; font-weight: bold; color: #4CAF50; margin-top: 5px;" id="dynamicModalPackagePrice">-</div>
            </div>
            
            <!-- Ödeme Seçenekleri -->
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Kredi Kartı / Shopier -->
                <button onclick="selectDynamicPaymentMethod('shopier')" class="payment-method-btn">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 30px;">💳</div>
                        <div style="text-align: left;">
                            <div style="font-weight: bold; font-size: 15px;">Kredi Kartı</div>
                            <div style="font-size: 12px; color: #aaa;">Shopier ile güvenli ödeme</div>
                        </div>
                    </div>
                    <div style="font-size: 20px; color: #4CAF50;">›</div>
                </button>
                
                <!-- Havale -->
                <button onclick="selectDynamicPaymentMethod('havale')" class="payment-method-btn">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 30px;">🏦</div>
                        <div style="text-align: left;">
                            <div style="font-weight: bold; font-size: 15px;">Havale / EFT</div>
                            <div style="font-size: 12px; color: #aaa;">Banka havalesi ile ödeme</div>
                        </div>
                    </div>
                    <div style="font-size: 20px; color: #4CAF50;">›</div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SİPARİŞ BAŞARILI MODAL -->
<div class="success-overlay" id="orderSuccessModal" onclick="closeOrderSuccessModal()">
    <div class="success-content" onclick="event.stopPropagation()" id="orderSuccessContent">
        <div class="success-icon">✅</div>
        <div class="success-title">Siparişiniz Alındı!</div>
        <div class="success-message">
            Siparişiniz başarıyla oluşturuldu. Ödemeniz onaylandıktan sonra key'iniz otomatik olarak hesabınıza tanımlanacaktır.
        </div>
        <button class="success-btn" onclick="closeOrderSuccessModal()">Tamam</button>
    </div>
</div>

<!-- ÜYE DETAY MODAL -->
<div class="modal-overlay" id="userDetailModal" onclick="closeModalOutside(event, 'userDetailModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #2196F3, #1976D2);">
            <div class="modal-title">👤 Üye Detayı</div>
            <button class="modal-close" onclick="closeModal('userDetailModal')">✕</button>
        </div>
        <div class="modal-body" id="userDetailContent" style="max-height: 70vh; overflow-y: auto;"></div>
    </div>
</div>

<!-- OYUN/HİLE SEÇİM MODAL -->
<div class="modal-overlay" id="gameSelectModal" onclick="closeModalOutside(event, 'gameSelectModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 420px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50, #45a049);">
            <div class="modal-title">🎮 Oyun Seçin</div>
            <button class="modal-close" onclick="closeModal('gameSelectModal')">✕</button>
        </div>
        <div class="modal-body">
            <div id="gameSelectList" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Dinamik olarak yüklenecek -->
            </div>
        </div>
    </div>
</div>

<!-- HİLE SEÇİM MODAL -->
<div class="modal-overlay" id="cheatSelectModal" onclick="closeModalOutside(event, 'cheatSelectModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 420px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
            <div class="modal-title">🗡️ Hile Seçin</div>
            <button class="modal-close" onclick="closeModal('cheatSelectModal')">✕</button>
        </div>
        <div class="modal-body">
            <div id="cheatSelectList" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Dinamik olarak yüklenecek -->
            </div>
        </div>
    </div>
</div>

<!-- SİPARİŞ DETAY MODAL -->
<div class="modal-overlay" id="orderDetailModal" onclick="closeModalOutside(event, 'orderDetailModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
            <div class="modal-title">📋 Sipariş Detayı</div>
            <button class="modal-close" onclick="closeModal('orderDetailModal')">✕</button>
        </div>
        <div class="modal-body">
            <div id="orderDetailContent"></div>
        </div>
    </div>
</div>

<!-- OYUN EKLEME/DÜZENLEME MODAL -->
<div class="modal-overlay" id="gameModal" onclick="closeModalOutside(event, 'gameModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50, #388E3C);">
            <div class="modal-title" id="gameModalTitle">🎮 Yeni Oyun Ekle</div>
            <button class="modal-close" onclick="closeModal('gameModal')">✕</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <input type="hidden" id="editGameId">
            
            <!-- Oyun Adı -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">Oyun Adı *</label>
                <input type="text" id="gameNameInput" class="auth-input" placeholder="örn: Mobile Legends">
            </div>
            
            <!-- Oyun Görseli -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">Oyun Görseli</label>
                <input type="hidden" id="gameImageData">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <label style="flex: 1; background: rgba(255,255,255,0.1); border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 15px; text-align: center; cursor: pointer;">
                        <input type="file" id="gameImageFile" accept="image/*" onchange="previewGameImageFile(this)" style="display: none;">
                        <span id="gameImageLabel" style="color: #888; font-size: 13px;">📷 Görsel Seç (PNG, JPG)</span>
                    </label>
                </div>
                <div id="gameImagePreview" style="margin-top: 10px; text-align: center;"></div>
            </div>
            
            <!-- Oyun Açıklaması -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">Açıklama</label>
                <textarea id="gameDescInput" class="auth-input" placeholder="Oyun hakkında kısa açıklama" style="height: 60px; resize: none;"></textarea>
            </div>
            
            <!-- Play Store Linki -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">Play Store Linki</label>
                <input type="text" id="gamePlayStoreInput" class="auth-input" placeholder="https://play.google.com/store/apps/details?id=...">
            </div>
            
            <!-- Oyun Durumu -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">Durum</label>
                <select id="gameStatusInput" class="auth-input" style="color: #fff;">
                    <option value="active">✅ Aktif</option>
                    <option value="inactive">⏸️ Pasif</option>
                    <option value="coming">🔜 Yakında</option>
                </select>
            </div>
            
            <button class="btn btn-primary" onclick="saveGame()">💾 Kaydet</button>
        </div>
    </div>
</div>

<!-- HİLE EKLEME/DÜZENLEME MODAL -->
<div class="modal-overlay" id="cheatModal" onclick="closeModalOutside(event, 'cheatModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #2196F3, #1976D2);">
            <div class="modal-title" id="cheatModalTitle">🛡️ Yeni Hile Ekle</div>
            <button class="modal-close" onclick="closeModal('cheatModal')">✕</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <input type="hidden" id="editCheatId">
            <input type="hidden" id="editCheatGameId">
            
            <!-- Oyun Seçimi -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">Oyun Seçin *</label>
                <select id="cheatGameSelect" class="auth-input" style="color: #fff;">
                    <option value="">Oyun seçin...</option>
                </select>
            </div>
            
            <!-- Hile Adı -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">Hile Adı *</label>
                <input type="text" id="cheatNameInput" class="auth-input" placeholder="örn: TheBestML IMGUI">
            </div>
            
            <!-- Hile Görseli -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">Hile Görseli</label>
                <input type="hidden" id="cheatImageData">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <label style="flex: 1; background: rgba(255,255,255,0.1); border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 15px; text-align: center; cursor: pointer;">
                        <input type="file" id="cheatImageFile" accept="image/*" onchange="previewCheatImageFile(this)" style="display: none;">
                        <span id="cheatImageLabel" style="color: #888; font-size: 13px;">📷 Görsel Seç (PNG, JPG)</span>
                    </label>
                </div>
                <div id="cheatImagePreview" style="margin-top: 10px; text-align: center;"></div>
            </div>
            
            <!-- Versiyon -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">Versiyon</label>
                <input type="text" id="cheatVersionInput" class="auth-input" placeholder="örn: V2.8">
            </div>
            
            <!-- Hile Açıklaması -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">Açıklama</label>
                <textarea id="cheatDescInput" class="auth-input" placeholder="Hile özellikleri hakkında" style="height: 60px; resize: none;"></textarea>
            </div>
            
            <!-- APK İndirme Linki -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">APK İndirme Linki</label>
                <input type="text" id="cheatApkInput" class="auth-input" placeholder="https://... (APK linki)">
            </div>
            
            <!-- Video URL -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">🎬 Tanıtım Videosu (YouTube)</label>
                <input type="text" id="cheatVideoInput" class="auth-input" placeholder="https://www.youtube.com/watch?v=...">
                <div style="font-size: 10px; color: #666; margin-top: 5px;">💡 YouTube video URL'si eklerseniz detay sayfasında "Video İzle" butonu görünür</div>
            </div>
            
            <!-- Özellikler -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">Özellikler (her satıra bir özellik)</label>
                <textarea id="cheatFeaturesInput" class="auth-input" placeholder="👁 Oyuncu Görünümü&#10;❤️ Düşman HP&#10;🗺 Harita Hilesi&#10;🚪 Oyun & Web Lobi&#10;📦 Kutulama & Çizgi&#10;🏷 İsim & Uzaklık" style="height: 120px; resize: none;"></textarea>
                <div style="font-size: 10px; color: #666; margin-top: 5px;">💡 Emoji ile başlatmanız önerilir</div>
            </div>
            
            <!-- Fiyatlar -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">💰 Fiyatlar</label>
                <div id="cheatPricesContainer" style="margin-bottom: 10px;"></div>
                <button type="button" onclick="addPriceOption()" style="width: 100%; background: rgba(76,175,80,0.2); border: 1px dashed #4CAF50; color: #4CAF50; padding: 10px; border-radius: 8px; font-size: 12px; cursor: pointer;">➕ Fiyat Seçeneği Ekle</button>
            </div>
            
            <!-- Hile Durumu -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; color: #aaa; margin-bottom: 5px;">Durum</label>
                <select id="cheatStatusInput" class="auth-input" style="color: #fff;">
                    <option value="active">✅ Aktif</option>
                    <option value="inactive">⏸️ Pasif</option>
                    <option value="maintenance">🔧 Bakımda</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="saveCheat()" style="flex: 1;">💾 Kaydet</button>
                <button class="btn btn-warning" onclick="openSetupModalFromCheat()" style="flex: 1;">📋 Kurulum Adımları</button>
            </div>
        </div>
    </div>
</div>

<!-- KURULUM TALİMATLARI MODAL -->
<div class="modal-overlay" id="setupModal" onclick="closeModalOutside(event, 'setupModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 550px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
            <div class="modal-title">📋 Kurulum Talimatları Düzenle</div>
            <button class="modal-close" onclick="closeModal('setupModal')">✕</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <input type="hidden" id="setupCheatId">
            <input type="hidden" id="setupGameId">
            
            <div style="background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 12px; color: #FF9800;">💡 Her adım için başlık ve açıklama girin. Buton türü seçerek Play Store, APK indirme veya modal açma butonu ekleyebilirsiniz.</div>
            </div>
            </div>
            
            <!-- Kurulum Adımları -->
            <div id="setupStepsContainer"></div>
            
            <button class="btn btn-secondary btn-small" onclick="addSetupStep()" style="margin-bottom: 15px;">➕ Adım Ekle</button>
            
            <button class="btn btn-primary" onclick="saveSetupSteps()">💾 Kaydet</button>
        </div>
    </div>
</div>

<!-- Admin Yetki Düzenleme Modal -->
<div class="modal-overlay" id="adminPermissionModal" onclick="closeModalOutside(event, 'adminPermissionModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #FF9800, #E65100);">
            <div class="modal-title">👮 Admin Yetkileri</div>
            <button class="modal-close" onclick="closeModal('adminPermissionModal')">✕</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <input type="hidden" id="permissionAdminEmail">
            
            <div style="background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #FF9800, #F57C00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">👤</div>
                    <div>
                        <div style="font-weight: bold; font-size: 16px;" id="permissionAdminName">Admin</div>
                        <div style="font-size: 12px; color: #FF9800;" id="permissionAdminEmailDisplay">admin@email.com</div>
                    </div>
                </div>
            </div>
            
            <div style="font-weight: bold; margin-bottom: 15px;">🔐 Yetkiler</div>
            
            <div id="permissionsCheckboxList"></div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveAdminPermissions()" style="width: 100%;">💾 Yetkileri Kaydet</button>
            </div>
        </div>
    </div>
</div>

<!-- Admin Ekle Modal -->
<div class="modal-overlay" id="addAdminModal" onclick="closeModalOutside(event, 'addAdminModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50, #388E3C);">
            <div class="modal-title">➕ Yeni Admin Ekle</div>
            <button class="modal-close" onclick="closeModal('addAdminModal')">✕</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">📧 E-posta Adresi</label>
                <input type="email" id="addAdminEmailInput" class="auth-input" placeholder="admin@example.com" style="margin: 0;">
            </div>
            
            <div style="font-weight: bold; margin-bottom: 15px;">🔐 Başlangıç Yetkileri</div>
            <div style="font-size: 12px; color: #aaa; margin-bottom: 15px;">Adminin hangi işlemleri yapabileceğini seçin:</div>
            
            <div id="newAdminPermissionsCheckboxList"></div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="addAdminWithPermissions()" style="width: 100%;">✅ Admin Olarak Ekle</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== ANA SAYFA ==================== -->
<div class="page active" id="homePage">
<div class="container" style="padding-top: 70px;">
    <div class="header">
        <!-- BestOfShop SVG Logo - Lazer Animasyonu -->
        <div class="app-logo-container">
            <div class="app-logo-svg">
                <div class="laser-g"></div>
                <div class="laser-s"></div>
                <div class="logo-impact"></div>
                <span class="logo-letter-g">G</span>
                <span class="logo-letter-s">S</span>
            </div>
        </div>
        <h1 class="title">BestOfShop</h1>
        <p class="subtitle">Oyun Modları & Kurulum Rehberleri</p>
        <p class="version">Sürüm: <span id="currentVersion">3.14.9</span></p>
    </div>

    <!-- ÜYELİK KARTI - Artık sidebar'da, bu kısım gizli tutulacak -->
    <div id="authSection" style="display: none;">
        <!-- Giriş yapmamış -->
        <div id="loggedOutCard" class="auth-card" style="text-align: center;">
            <div style="font-size: 50px; margin-bottom: 10px;">👤</div>
            <h3 style="margin-bottom: 8px;">Hoş Geldiniz!</h3>
            <p style="color: #aaa; font-size: 13px; margin-bottom: 20px;">Satın alma ve key yönetimi için giriş yapın</p>
            <button class="btn btn-primary btn-small" onclick="navigateTo('loginPage')" style="margin-bottom: 8px;">🔐 Giriş Yap</button>
            <button class="btn btn-secondary btn-small" onclick="navigateTo('registerPage')">📝 Kayıt Ol</button>
        </div>
        
        <!-- Giriş yapmış -->
        <div id="loggedInCard" class="user-card" style="display: none;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <div class="user-badge">👤 <span id="userEmail">kullanici@email.com</span></div>
                <button onclick="logout()" style="background: rgba(244,67,54,0.2); border: none; color: #f44336; padding: 10px 15px; border-radius: 10px; font-size: 12px; cursor: pointer;">Çıkış</button>
            </div>
            
            <div id="keyStatusBox" class="key-status" onclick="openKeyDetailModal()" style="cursor: pointer;">
                <div id="keyStatusContent">
                    <div style="font-size: 12px; color: #aaa;">Key Durumu</div>
                    <div id="keyStatusText" style="font-weight: bold; color: #f44336;">Aktif Key Yok</div>
                </div>
            </div>
            
            <button onclick="openModal('redeemKeyModal')" style="margin-top: 12px; background: linear-gradient(135deg, #FF9800, #F57C00); border: none; color: #fff; padding: 12px 15px; border-radius: 10px; font-size: 13px; cursor: pointer; width: 100%; font-weight: bold;">🎟️ Key Kodu Gir</button>
            <button onclick="navigateTo('myOrdersPage'); loadMyOrders();" style="width: 100%; margin-top: 8px; background: linear-gradient(135deg, #2196F3, #1976D2); border: none; color: #fff; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer;">📦 Siparişlerim <span id="myOrderBadge" style="background: #f44336; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 5px; display: none;">0</span></button>
            <button onclick="openNotificationsModal()" style="width: 100%; margin-top: 8px; background: linear-gradient(135deg, #9C27B0, #7B1FA2); border: none; color: #fff; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer;">🔔 Bildirimler <span id="notifBadge" style="background: #f44336; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 5px; display: none;">0</span></button>
            <button onclick="openUserChatModal()" style="width: 100%; margin-top: 8px; background: linear-gradient(135deg, #00BCD4, #0097A7); border: none; color: #fff; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer;">💬 Destek <span id="chatBadge" style="background: #f44336; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 5px; display: none;">0</span></button>
            <button id="adminBtn" onclick="navigateTo('adminPage'); loadPendingOrders();" style="display: none; width: 100%; margin-top: 8px; background: linear-gradient(135deg, #673AB7, #512DA8); border: none; color: #fff; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer;">👑 Admin Panel</button>
        </div>
    </div>

    <!-- OYUNLAR -->
    <div class="section">
        <div class="section-title">🎮 Oyunlar</div>
        
        <div class="game-grid" id="homeGamesGrid">
            <!-- Dinamik olarak yüklenecek -->
            <div style="text-align: center; padding: 30px; color: #888;">
                <div style="font-size: 30px; margin-bottom: 10px;">⏳</div>
                <div>Oyunlar yükleniyor...</div>
            </div>
        </div>
    </div>

    <!-- TELEGRAM KANAL KARTI -->
    <div class="telegram-card" onclick="window.open('https://t.me/GameStore81', '_blank')" style="cursor: pointer; margin-top: 20px;">
        <div class="telegram-card-content">
            <div class="telegram-icon">✈️</div>
            <div class="telegram-info">
                <div class="telegram-title">Telegram Kanalımız</div>
                <div class="telegram-subtitle">Güncellemeler ve duyurular için takip edin!</div>
            </div>
            <button class="telegram-btn" onclick="event.stopPropagation(); window.open('https://t.me/GameStore81', '_blank')">👉 Katıl</button>
        </div>
    </div>

    <div class="divider"></div>

    <!-- YENİLE -->
    <div class="section">
        <button class="btn btn-purple" onclick="refreshApp()">
            🔄 UYGULAMAYI YENİLE
            <span class="btn-subtext">Sürüm: v<span id="currentVersionBtn">3.10.5</span></span>
        </button>
    </div>
</div>
</div>

<!-- ==================== DİNAMİK OYUN DETAY SAYFA ==================== -->
<div class="page" id="dynamicGamePage">
<div class="container">
    <button class="back-btn" onclick="navigateBack()">
        ← Geri
    </button>
    
    <div class="header" style="margin-bottom: 20px;">
        <img id="dynamicGameIcon" src="" alt="Oyun" class="app-logo" style="width: 100px; height: 100px; border-radius: 20px;" onerror="this.style.display='none'">
        <h1 class="title" style="font-size: 22px;" id="dynamicGameTitle">Oyun Adı</h1>
        <p class="subtitle" id="dynamicGameDesc">Oyun Açıklaması</p>
    </div>

    <!-- HİLELER LİSTESİ -->
    <div class="section">
        <div class="section-title">🗡️ Mevcut Hileler</div>
        
        <div class="game-grid" id="dynamicCheatsGrid">
            <!-- Dinamik olarak yüklenecek -->
        </div>
    </div>
</div>
</div>

<!-- ==================== DİNAMİK HİLE DETAY SAYFA ==================== -->
<div class="page" id="dynamicCheatPage">
<div class="container">
    <button class="back-btn" onclick="navigateBack()">
        ← Geri
    </button>
    
    <div class="header" style="margin-bottom: 20px;">
        <img id="dynamicCheatIcon" src="" alt="Hile" class="app-logo" style="width: 100px; height: 100px;" onerror="this.style.display='none'">
        <h1 class="title" style="font-size: 22px;" id="dynamicCheatTitle">Hile Adı</h1>
        <p class="subtitle" id="dynamicCheatSubtitle">Hile Bilgisi</p>
    </div>
    
    <!-- HİLE DURUM UYARILARI -->
    <div id="dynamicCheatMaintenanceWarning" class="section" style="display: none;">
        <div style="background: rgba(255,152,0,0.15); border: 2px solid rgba(255,152,0,0.4); border-radius: 20px; padding: 25px; text-align: center;">
            <div style="font-size: 50px; margin-bottom: 15px;">🔧</div>
            <div style="font-size: 18px; font-weight: bold; color: #FF9800; margin-bottom: 10px;">Bakım Modunda</div>
            <div style="color: #aaa; font-size: 14px;">Bu hile şu anda bakım altında. Kısa süre içinde tekrar aktif olacaktır.</div>
        </div>
    </div>
    
    <div id="dynamicCheatInactiveWarning" class="section" style="display: none;">
        <div style="background: rgba(244,67,54,0.15); border: 2px solid rgba(244,67,54,0.4); border-radius: 20px; padding: 25px; text-align: center;">
            <div style="font-size: 50px; margin-bottom: 15px;">⏸️</div>
            <div style="font-size: 18px; font-weight: bold; color: #f44336; margin-bottom: 10px;">Hile Pasif</div>
            <div style="color: #aaa; font-size: 14px;">Bu hile şu anda aktif değil. Lütfen daha sonra tekrar kontrol edin.</div>
        </div>
    </div>

    <!-- AKTİF ÜYELİK KONTROLÜ -->
    <div id="dynamicSetupLocked" class="section" style="display: none;">
        <div style="background: rgba(244,67,54,0.1); border: 2px solid rgba(244,67,54,0.3); border-radius: 20px; padding: 25px; text-align: center;">
            <div style="font-size: 50px; margin-bottom: 15px;">🔒</div>
            <div style="font-size: 18px; font-weight: bold; color: #f44336; margin-bottom: 10px;">Kurulum Talimatları Kilitli</div>
            <div style="color: #aaa; font-size: 14px; margin-bottom: 20px;">Kurulum talimatlarını görmek için bu hileyi satın almanız gerekiyor.</div>
            <div style="color: #888; font-size: 12px;">👇 Aşağıdaki fiyat seçeneklerinden birini seçerek satın alın</div>
        </div>
    </div>
    
    <!-- KURULUM ADIMLARI (Aktif üyelik varsa) -->
    <div id="dynamicSetupUnlocked" class="section" style="display: none;">
        <div class="section-title">🚀 Kurulum Adımları</div>
        <div id="dynamicSetupSteps">
            <!-- Dinamik olarak yüklenecek -->
        </div>
    </div>
    
    <!-- AKTİF ÜYELİK BİLGİSİ -->
    <div id="dynamicActiveMembership" class="section" style="display: none;">
        <div style="background: rgba(76,175,80,0.15); border: 2px solid rgba(76,175,80,0.4); border-radius: 20px; padding: 25px; text-align: center;">
            <div style="font-size: 50px; margin-bottom: 15px;">✅</div>
            <div style="font-size: 18px; font-weight: bold; color: #4CAF50; margin-bottom: 10px;">Aktif Üyeliğiniz Var!</div>
            <div id="dynamicMembershipInfo" style="color: #aaa; font-size: 14px; margin-bottom: 15px;"></div>
            <button class="btn btn-secondary btn-small" onclick="goToAccount()">👤 Hesabım</button>
        </div>
    </div>

    <!-- ÖZELLİKLER -->
    <div class="section">
        <div class="section-title">🗡️ Özellikler</div>
        <div class="features" style="margin-top: 0;">
            <div class="feature-grid" id="dynamicCheatFeatures">
                <!-- Dinamik olarak yüklenecek -->
            </div>
            
            <!-- Video Butonu -->
            <div id="dynamicVideoSection" style="margin-top: 15px; display: none;">
                <button class="btn btn-warning btn-small" onclick="openDynamicVideoModal()">
                    🎬 Tanıtım Videosunu İzle
                </button>
            </div>
        </div>
    </div>

    <!-- FİYATLAR -->
    <div class="section">
        <div class="section-title">💰 Fiyatlar</div>
        <div class="pricing-grid" id="dynamicCheatPrices">
            <!-- Dinamik olarak yüklenecek -->
        </div>
    </div>

    <!-- SATIN AL -->
    <div class="section">
        <button class="btn btn-primary" id="dynamicBuyBtn" onclick="openDynamicBuyModal()">
            💳 SATIN AL
            <span class="btn-subtext" id="dynamicSelectedPrice">Fiyat seçin</span>
        </button>
    </div>
</div>
</div>


<!-- ==================== MODALS ==================== -->

<!-- ÖDEME YÖNTEMİ MODAL -->
<div class="modal-overlay" id="paymentModal" onclick="closeModalOutside(event, 'paymentModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50, #45a049);">
            <div class="modal-title">💳 Ödeme Yöntemi Seçin</div>
            <button class="modal-close" onclick="closeModal('paymentModal')">✕</button>
        </div>
        <div class="modal-body">
            <!-- Seçilen Paket Bilgisi -->
            <div style="background: rgba(76,175,80,0.15); border: 1px solid #4CAF50; border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 12px; color: #aaa; margin-bottom: 5px;">Seçilen Paket</div>
                <div style="font-size: 18px; font-weight: bold;" id="modalPackageName">30 Günlük</div>
                <div style="font-size: 24px; font-weight: bold; color: #4CAF50; margin-top: 5px;" id="modalPackagePrice">850₺</div>
            </div>
            
            <!-- Ödeme Seçenekleri -->
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Kredi Kartı / Shopier -->
                <button onclick="selectPaymentMethod('shopier')" class="payment-method-btn" id="shopierBtn">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 30px;">💳</div>
                        <div style="text-align: left;">
                            <div style="font-weight: bold; font-size: 15px;">Kredi Kartı</div>
                            <div style="font-size: 12px; color: #aaa;">Shopier ile güvenli ödeme</div>
                        </div>
                    </div>
                    <div style="font-size: 20px; color: #4CAF50;">›</div>
                </button>
                
                <!-- Havale -->
                <button onclick="selectPaymentMethod('havale')" class="payment-method-btn" id="havaleBtn">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 30px;">🏦</div>
                        <div style="text-align: left;">
                            <div style="font-weight: bold; font-size: 15px;">Havale / EFT</div>
                            <div style="font-size: 12px; color: #aaa;">Banka havalesi ile ödeme</div>
                        </div>
                    </div>
                    <div style="font-size: 20px; color: #4CAF50;">›</div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- HAVALE ÖDEME MODAL -->
<div class="modal-overlay" id="havaleModal" onclick="closeModalOutside(event, 'havaleModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #2196F3, #1976D2);">
            <div class="modal-title">🏦 Havale ile Ödeme</div>
            <button class="modal-close" onclick="closeModal('havaleModal')">✕</button>
        </div>
        <div class="modal-body">
            <!-- Paket ve Tutar -->
            <div style="background: rgba(33,150,243,0.15); border: 1px solid #2196F3; border-radius: 12px; padding: 15px; margin-bottom: 15px; text-align: center;">
                <div id="havalePackageInfo" style="font-size: 14px; font-weight: bold;"></div>
                <div id="havaleAmount" style="font-size: 22px; font-weight: bold; color: #2196F3; margin-top: 5px;"></div>
            </div>
            
            <!-- Banka Bilgileri -->
            <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <div style="font-size: 12px; color: #aaa; margin-bottom: 5px;">Alıcı</div>
                <div style="font-weight: bold; font-size: 16px;">ONUR TENK</div>
                <div style="font-size: 12px; color: #aaa; margin-top: 12px; margin-bottom: 5px;">Banka</div>
                <div style="font-weight: bold;">Garanti Bankası</div>
                <div style="font-size: 12px; color: #aaa; margin-top: 12px; margin-bottom: 5px;">IBAN</div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-weight: bold; font-size: 13px; flex: 1;">TR26 0006 2000 7750 0006 8826 02</div>
                    <button onclick="copyToClipboard('TR26000620007750000688260 2')" style="background: #4CAF50; border: none; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 11px; cursor: pointer;">📋</button>
                </div>
            </div>
            
            <div class="warning-box" style="margin-bottom: 15px;">
                <div class="boxtitle">⚠️ Önemli</div>
                <div class="content">Açıklama kısmını BOŞ bırakın!</div>
            </div>
            
            <!-- Dekont Yükleme -->
            <div style="font-size: 13px; margin-bottom: 10px; font-weight: bold;">📸 Dekont Fotoğrafı</div>
            <input type="file" id="dekontFile" accept="image/*" class="auth-input" style="padding: 10px;" onchange="previewDekont(this)">
            <div id="dekontPreview" style="display: none; margin: 15px 0; text-align: center;">
                <img id="dekontImg" style="max-width: 100%; max-height: 200px; border-radius: 10px; border: 2px solid #4CAF50;">
            </div>
            
            <button class="btn btn-primary" onclick="submitOrder()" style="margin-top: 10px;">📤 Siparişi Gönder</button>
            <p style="text-align: center; color: #666; font-size: 11px; margin-top: 10px;">Dekont incelendikten sonra key'iniz aktifleştirilecek</p>
        </div>
    </div>
</div>

<!-- AKTİF ÜYELİKLER MODAL -->
<div class="modal-overlay" id="keyDetailModal" onclick="closeModalOutside(event, 'keyDetailModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50, #45a049);">
            <div class="modal-title">🎮 Aktif Üyelikler</div>
            <button class="modal-close" onclick="closeModal('keyDetailModal')">✕</button>
        </div>
        <div class="modal-body" id="keyDetailContent">
            <!-- İçerik JavaScript ile doldurulacak -->
        </div>
    </div>
</div>

<!-- KEY GİRİŞ MODAL -->
<div class="modal-overlay" id="redeemKeyModal" onclick="closeModalOutside(event, 'redeemKeyModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 400px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
            <div class="modal-title">🎟️ Key Kodu Gir</div>
            <button class="modal-close" onclick="closeModal('redeemKeyModal')">✕</button>
        </div>
        <div class="modal-body">
            <p style="color: #aaa; font-size: 13px; margin-bottom: 15px;">Satın aldığınız key kodunu girin:</p>
            <input type="text" id="redeemKeyInput" class="auth-input" placeholder="XXXX-XXXX-XXXX" style="text-transform: uppercase; text-align: center; font-size: 18px; letter-spacing: 2px;">
            <button class="btn btn-primary" onclick="redeemKey()">✅ Kodu Kullan</button>
        </div>
    </div>
</div>

<!-- TANITIM VİDEO MODAL -->
<div class="modal-overlay" id="videoModal" onclick="closeModalOutside(event, 'videoModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
            <div class="modal-title">🎬 TheBestML Tanıtım</div>
            <button class="modal-close" onclick="closeModal('videoModal')">✕</button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <div class="video-container" style="margin: 0; border-radius: 0;">
                <video controls playsinline id="promoVideo" style="max-height: 70vh;">
                    <source src="https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/tanitim-video.mp4" type="video/mp4">
                </video>
            </div>
            <div style="padding: 15px;">
                <div class="success-box" style="margin: 0;">
                    <div class="boxtitle">🗡️ Tüm Özellikler</div>
                    <div class="content">
                        Oyuncu görünümü, düşman HP, kutulama, harita hilesi ve daha fazlası! Telegram'dan key satın alarak hemen kullanmaya başlayın.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SERTİFİKA MODAL -->
<div class="modal-overlay" id="certModal" onclick="closeModalOutside(event, 'certModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header orange">
            <div class="modal-title">🔐 Sertifika Kapatma Rehberi</div>
            <button class="modal-close" onclick="closeModal('certModal')">✕</button>
        </div>
        <div class="modal-body">
            <div class="video-container">
                <video controls playsinline id="certVideo">
                    <source src="https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/sertifika-rehber.mp4" type="video/mp4">
                </video>
            </div>
            
            <div class="warning-box">
                <div class="boxtitle">⚠️ ÖNEMLİ</div>
                <div class="content">
                    <strong style="color: #4CAF50;">GlobalSign NV-SA</strong> sertifikasını <strong>KAPATMAYIN!</strong> Bu açık kalmalı, diğer tüm sertifikaları kapatın.
                </div>
            </div>
            
            <div class="step-item">
                <div class="step-num">1</div>
                <div class="step-content">
                    <strong>Ayarları Aç</strong>
                    <p>Telefonunuzun Ayarlar uygulamasını açın.</p>
                </div>
            </div>
            
            <div class="step-item">
                <div class="step-num">2</div>
                <div class="step-content">
                    <strong>Güvenlik Ayarları</strong>
                    <p>"Güvenlik" veya "Güvenlik ve gizlilik" bölümüne girin.</p>
                </div>
            </div>
            
            <div class="step-item">
                <div class="step-num">3</div>
                <div class="step-content">
                    <strong>Şifreleme ve Kimlik Bilgileri</strong>
                    <p>"Şifreleme ve kimlik bilgileri" veya "Diğer güvenlik ayarları" tıklayın.</p>
                </div>
            </div>
            
            <div class="step-item">
                <div class="step-num">4</div>
                <div class="step-content">
                    <strong>Güvenilen Kimlik Bilgileri</strong>
                    <p>"Güvenilen kimlik bilgileri" veya "Trusted credentials" seçin.</p>
                </div>
            </div>
            
            <div class="step-item">
                <div class="step-num">5</div>
                <div class="step-content">
                    <strong>SİSTEM Sekmesi</strong>
                    <p>Üstteki "SİSTEM" sekmesine tıklayın.</p>
                </div>
            </div>
            
            <div class="step-item">
                <div class="step-num">6</div>
                <div class="step-content">
                    <strong>Sertifikaları Kapat</strong>
                    <p>Her sertifikaya tıklayın ve "Devre dışı bırak" seçin. GlobalSign NV-SA HARİÇ!</p>
                </div>
            </div>
            
            <button class="btn btn-warning" onclick="openSecuritySettings()" style="margin-top: 15px;">
                🔒 Sertifika Ayarlarını Aç
            </button>
        </div>
    </div>
</div>

<!-- IMGUI MODAL -->
<div class="modal-overlay" id="imguiModal" onclick="closeModalOutside(event, 'imguiModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <div class="modal-title">📥 TheBestML IMGUI V2.8 Kurulum Rehberi</div>
            <button class="modal-close" onclick="closeModal('imguiModal')">✕</button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            
            <!-- Tanıtım Videosu -->
            <div style="background: linear-gradient(135deg, rgba(156,39,176,0.2), rgba(103,58,183,0.2)); border: 1px solid rgba(156,39,176,0.4); border-radius: 15px; padding: 15px; margin-bottom: 20px;">
                <div style="font-size: 16px; font-weight: bold; color: #E040FB; margin-bottom: 10px;">🎬 Tanıtım Videosu</div>
                <video controls style="width: 100%; border-radius: 12px; max-height: 200px;" poster="">
                    <source src="https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/tanitim-video.mp4" type="video/mp4">
                    Tarayıcınız video oynatmayı desteklemiyor.
                </video>
            </div>
            
            <!-- İndirme Butonu -->
            <button class="btn btn-primary" onclick="downloadAPK()" style="margin-bottom: 20px; width: 100%;">
                📥 IMGUI APK İNDİR
                <span class="btn-subtext">TheBestML IMGUI V2.8</span>
            </button>
            
            <!-- Uyumluluk Bilgisi -->
            <div style="background: rgba(76,175,80,0.15); border: 1px solid rgba(76,175,80,0.4); border-radius: 12px; padding: 12px; margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: bold; color: #4CAF50; margin-bottom: 8px;">✅ Uyumluluk</div>
                <div style="font-size: 12px; color: #aaa;">
                    • 💘 <strong>Mobile Legends:</strong> Playstoreden Orjinal ML indirin<br>
                    • 💎 <strong>Cihaz:</strong> ROOT & Rootsuz TÜM Android telefonlarda çalışır<br>
                    • ⚡️ <strong>Önemli:</strong> Eski sürümü kaldırın, temiz kurulum yapın
                </div>
            </div>
            
            <!-- Sertifika Kapatma Videosu -->
            <div style="background: linear-gradient(135deg, rgba(255,152,0,0.2), rgba(244,67,54,0.2)); border: 1px solid rgba(255,152,0,0.4); border-radius: 15px; padding: 15px; margin-bottom: 20px;">
                <div style="font-size: 16px; font-weight: bold; color: #FF9800; margin-bottom: 10px;">🔞 ÖNEMLİ: Sertifika Kapatma</div>
                <div style="font-size: 12px; color: #ffcc80; margin-bottom: 10px;">
                    Bypass korumasının sorunsuz çalışabilmesi için aşağıdaki videoda gösterildiği gibi sertifikaları kapatmanız gerekmektedir.
                </div>
                <video controls style="width: 100%; border-radius: 12px; max-height: 200px;">
                    <source src="https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/sertifika-rehber.mp4" type="video/mp4">
                    Tarayıcınız video oynatmayı desteklemiyor.
                </video>
            </div>
            
            <!-- Kurulum Adımları -->
            <div style="font-size: 16px; font-weight: bold; color: #fff; margin-bottom: 15px;">📋 Kurulum Adımları</div>
            
            <div class="step-item" style="background: rgba(33,150,243,0.1); border: 1px solid rgba(33,150,243,0.3); border-radius: 12px; padding: 12px; margin-bottom: 10px;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="background: linear-gradient(135deg, #2196F3, #1976D2); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; flex-shrink: 0;">1</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #2196F3; margin-bottom: 4px;">Orijinal ML İndirin</div>
                        <div style="font-size: 12px; color: #aaa;">Playstoreden Mobile Legends orijinal sürümünü indirin.</div>
                        <button onclick="openPlayStore()" style="background: linear-gradient(135deg, #4CAF50, #388E3C); border: none; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 11px; cursor: pointer; margin-top: 8px;">
                            ▶️ Play Store'a Git
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="step-item" style="background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 12px; padding: 12px; margin-bottom: 10px;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="background: linear-gradient(135deg, #FF9800, #F57C00); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; flex-shrink: 0;">2</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #FF9800; margin-bottom: 4px;">Sertifikaları Kapatın</div>
                        <div style="font-size: 12px; color: #aaa;">Yukarıdaki videoda gösterildiği gibi belirtilen sertifikaları kapatın. Bu adım bypass koruma için zorunludur!</div>
                    </div>
                </div>
            </div>
            
            <div class="step-item" style="background: rgba(156,39,176,0.1); border: 1px solid rgba(156,39,176,0.3); border-radius: 12px; padding: 12px; margin-bottom: 10px;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="background: linear-gradient(135deg, #9C27B0, #7B1FA2); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; flex-shrink: 0;">3</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #9C27B0; margin-bottom: 4px;">IMGUI APK İndirin</div>
                        <div style="font-size: 12px; color: #aaa;">Üstteki indirme butonuna tıklayarak TheBestML IMGUI APK'sını indirin ve kurun.</div>
                    </div>
                </div>
            </div>
            
            <div class="step-item" style="background: rgba(0,188,212,0.1); border: 1px solid rgba(0,188,212,0.3); border-radius: 12px; padding: 12px; margin-bottom: 10px;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="background: linear-gradient(135deg, #00BCD4, #0097A7); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; flex-shrink: 0;">4</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #00BCD4; margin-bottom: 4px;">Spa Dosyasını Çalıştırın</div>
                        <div style="font-size: 12px; color: #aaa;">İndirdiğiniz TheBestML Spa dosyasını çalıştırın. Karşınıza çıkan ekrandan izinleri verin.</div>
                    </div>
                </div>
            </div>
            
            <div class="step-item" style="background: rgba(233,30,99,0.1); border: 1px solid rgba(233,30,99,0.3); border-radius: 12px; padding: 12px; margin-bottom: 10px;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="background: linear-gradient(135deg, #E91E63, #C2185B); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; flex-shrink: 0;">5</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #E91E63; margin-bottom: 4px;">ML Klonlayın</div>
                        <div style="font-size: 12px; color: #aaa;">Listeden Mobile Legends'ı seçin ve <strong>"Klon"</strong> yazısına tıklayın.</div>
                    </div>
                </div>
            </div>
            
            <div class="step-item" style="background: rgba(76,175,80,0.1); border: 1px solid rgba(76,175,80,0.3); border-radius: 12px; padding: 12px; margin-bottom: 10px;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="background: linear-gradient(135deg, #4CAF50, #388E3C); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; flex-shrink: 0;">6</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #4CAF50; margin-bottom: 4px;">Klonlanan ML'yi Başlatın</div>
                        <div style="font-size: 12px; color: #aaa;">Klonladığınız ML sürümünü başlatın ve size verdiğimiz <strong>Key</strong> ile giriş yapın.</div>
                    </div>
                </div>
            </div>
            
            <!-- Uyarılar -->
            <div style="background: rgba(244,67,54,0.15); border: 1px solid rgba(244,67,54,0.4); border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 14px; font-weight: bold; color: #f44336; margin-bottom: 8px;">⚠️ Önemli Uyarılar</div>
                <div style="font-size: 12px; color: #ffcdd2;">
                    • 🤖 Playstoreden <strong>Otomatik Güncellemeleri KAPATIN</strong><br>
                    • ⚡️ Eski IMGUI sürümünü <strong>KALDIRIN</strong> ve temiz kurulum yapın<br>
                    • 🔞 Sertifikaları kapatmadan hile <strong>ÇALIŞMAZ</strong>
                </div>
            </div>
            
            <!-- Başarılı -->
            <div style="background: linear-gradient(135deg, rgba(76,175,80,0.2), rgba(139,195,74,0.2)); border: 1px solid rgba(76,175,80,0.5); border-radius: 12px; padding: 15px; text-align: center;">
                <div style="font-size: 32px; margin-bottom: 8px;">✅</div>
                <div style="font-size: 16px; font-weight: bold; color: #4CAF50; margin-bottom: 5px;">Kurulum Tamamlandı!</div>
                <div style="font-size: 12px; color: #aaa;">Artık klonlanan Mobile Legends'ı açtığınızda IMGUI menüsü görünecektir.</div>
            </div>
            
        </div>
    </div>
</div>

<!-- KURULUM MODAL EDİTÖR MODAL -->
<div class="modal-overlay" id="setupModalEditorModal" onclick="closeModalOutside(event, 'setupModalEditorModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 550px; max-height: 95vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="background: linear-gradient(135deg, #673AB7, #512DA8);">
            <div class="modal-title" id="setupModalEditorTitle">📖 Yeni Kurulum Modalı</div>
            <button class="modal-close" onclick="closeModal('setupModalEditorModal')">✕</button>
        </div>
        <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 15px;">
            
            <!-- Modal ID -->
            <div style="margin-bottom: 15px;">
                <label style="font-size: 12px; color: #aaa; display: block; margin-bottom: 5px;">Modal ID (benzersiz)</label>
                <input type="text" id="setupModalId" class="auth-input" placeholder="örn: myCheatModal" style="font-family: monospace;">
                <div style="font-size: 10px; color: #888; margin-top: 3px;">💡 Kurulum adımlarında bu ID'yi seçeceksiniz</div>
            </div>
            
            <!-- Modal Başlığı -->
            <div style="margin-bottom: 15px;">
                <label style="font-size: 12px; color: #aaa; display: block; margin-bottom: 5px;">Modal Başlığı</label>
                <input type="text" id="setupModalTitle" class="auth-input" placeholder="📖 TheBestML Kurulum Rehberi">
            </div>
            
            <!-- Tanıtım Videosu -->
            <div style="background: rgba(156,39,176,0.1); border: 1px solid rgba(156,39,176,0.3); border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 13px; font-weight: bold; color: #E040FB; margin-bottom: 10px;">🎬 Tanıtım Videosu (Opsiyonel)</div>
                <input type="text" id="setupModalIntroVideo" class="auth-input" placeholder="Video URL (örn: https://...mp4)" style="margin-bottom: 8px;">
                <div style="font-size: 10px; color: #888;">💡 GitHub raw URL veya herhangi bir video linki</div>
            </div>
            
            <!-- APK İndirme -->
            <div style="background: rgba(76,175,80,0.1); border: 1px solid rgba(76,175,80,0.3); border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 13px; font-weight: bold; color: #4CAF50; margin-bottom: 10px;">📥 APK İndirme Butonu (Opsiyonel)</div>
                <input type="text" id="setupModalApkLabel" class="auth-input" placeholder="Buton yazısı (örn: IMGUI APK İNDİR)" style="margin-bottom: 8px;">
                <input type="text" id="setupModalApkUrl" class="auth-input" placeholder="APK indirme URL'si">
            </div>
            
            <!-- Uyumluluk Bilgisi -->
            <div style="background: rgba(33,150,243,0.1); border: 1px solid rgba(33,150,243,0.3); border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 13px; font-weight: bold; color: #2196F3; margin-bottom: 10px;">✅ Uyumluluk Bilgisi (Opsiyonel)</div>
                <textarea id="setupModalCompatibility" class="auth-input" placeholder="Her satır bir madde olacak:&#10;💘 Mobile Legends: Orijinal sürüm&#10;💎 Cihaz: Tüm Android telefonlar" style="height: 80px; resize: none;"></textarea>
            </div>
            
            <!-- Sertifika/Rehber Video -->
            <div style="background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 13px; font-weight: bold; color: #FF9800; margin-bottom: 10px;">🔐 Rehber Videosu (Opsiyonel)</div>
                <input type="text" id="setupModalGuideTitle" class="auth-input" placeholder="Rehber başlığı (örn: Sertifika Kapatma)" style="margin-bottom: 8px;">
                <input type="text" id="setupModalGuideVideo" class="auth-input" placeholder="Video URL'si" style="margin-bottom: 8px;">
                <textarea id="setupModalGuideDesc" class="auth-input" placeholder="Açıklama metni" style="height: 60px; resize: none;"></textarea>
            </div>
            
            <!-- Kurulum Adımları -->
            <div style="background: rgba(0,188,212,0.1); border: 1px solid rgba(0,188,212,0.3); border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                    <div style="font-size: 13px; font-weight: bold; color: #00BCD4;">📋 Kurulum Adımları</div>
                    <button onclick="addSetupModalStep()" style="background: #00BCD4; border: none; color: #fff; padding: 5px 10px; border-radius: 6px; font-size: 11px; cursor: pointer;">➕ Adım Ekle</button>
                </div>
                <div id="setupModalStepsList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Adımlar buraya eklenecek -->
                </div>
            </div>
            
            <!-- Uyarılar -->
            <div style="background: rgba(244,67,54,0.1); border: 1px solid rgba(244,67,54,0.3); border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 13px; font-weight: bold; color: #f44336; margin-bottom: 10px;">⚠️ Uyarılar (Opsiyonel)</div>
                <textarea id="setupModalWarnings" class="auth-input" placeholder="Her satır bir uyarı:&#10;🤖 Otomatik güncellemeleri kapatın&#10;⚡️ Eski sürümü kaldırın" style="height: 80px; resize: none;"></textarea>
            </div>
            
            <!-- Başarı Mesajı -->
            <div style="background: rgba(76,175,80,0.1); border: 1px solid rgba(76,175,80,0.3); border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="font-size: 13px; font-weight: bold; color: #4CAF50; margin-bottom: 10px;">✅ Başarı Mesajı</div>
                <input type="text" id="setupModalSuccessTitle" class="auth-input" placeholder="Kurulum Tamamlandı!" style="margin-bottom: 8px;">
                <input type="text" id="setupModalSuccessDesc" class="auth-input" placeholder="Artık hileyi kullanabilirsiniz.">
            </div>
            
            <!-- Butonlar -->
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveSetupModal()" style="flex: 1;">💾 Kaydet</button>
                <button class="btn btn-warning" onclick="previewSetupModal()" style="flex: 1;">👁️ Önizle</button>
            </div>
            
        </div>
    </div>
</div>

<!-- DİNAMİK KURULUM MODAL (Önizleme/Görüntüleme) -->
<div class="modal-overlay" id="dynamicSetupModal" onclick="closeModalOutside(event, 'dynamicSetupModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header" id="dynamicSetupModalHeader" style="background: linear-gradient(135deg, #673AB7, #512DA8);">
            <div class="modal-title" id="dynamicSetupModalTitle">📖 Kurulum Rehberi</div>
            <button class="modal-close" onclick="closeModal('dynamicSetupModal')">✕</button>
        </div>
        <div class="modal-body" id="dynamicSetupModalContent" style="padding: 15px;">
            <!-- Dinamik içerik buraya yüklenecek -->
        </div>
    </div>
</div>

<!-- ⚙️ UYGULAMA AYARLARI MODAL -->
<div class="modal-overlay" id="appSettingsModal" onclick="closeModalOutside(event, 'appSettingsModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header" id="appSettingsModalHeader" style="background: linear-gradient(135deg, #607D8B, #455A64);">
            <div class="modal-title" id="appSettingsModalTitle">⚙️ Uygulama Ayarları</div>
            <button class="modal-close" onclick="closeModal('appSettingsModal')">✕</button>
        </div>
        <div class="modal-body" id="appSettingsModalContent" style="padding: 15px;">
            <!-- Dinamik içerik buraya yüklenecek -->
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>
<div class="notification-toast" id="notificationToast"></div>

<script>
    // Config
    let appConfig = {
        apkUrl: 'https://dosya.co/dho18v1fbzq0/THEBEST_IMGUI-v2.8.apk.html',
        playStoreUrl: 'https://play.google.com/store/apps/details?id=com.mobile.legends'
    };
    
    const APP_VERSION = '3.10.7';
    function toggleProfilePanel() {
        const sidebar = document.getElementById('profileSidebar');
        const overlay = document.getElementById('profileOverlay');
        
        if (sidebar.classList.contains('active')) {
            // Kapat
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        } else {
            // Aç
            sidebar.classList.add('active');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }
    
    // Profil paneli UI'ını güncelle
    function updateProfilePanelUI() {
        const headerLoggedIn = document.getElementById('sidebarHeaderLoggedIn');
        const headerLoggedOut = document.getElementById('sidebarHeaderLoggedOut');
        const contentLoggedIn = document.getElementById('sidebarContentLoggedIn');
        const contentLoggedOut = document.getElementById('sidebarContentLoggedOut');
        const toggleBtn = document.getElementById('profileToggleBtn');
        const sidebarAdminBtn = document.getElementById('sidebarAdminBtn');
        
        if (currentUser) {
            // Giriş yapmış
            headerLoggedIn.style.display = 'block';
            headerLoggedOut.style.display = 'none';
            contentLoggedIn.style.display = 'block';
            contentLoggedOut.style.display = 'none';
            toggleBtn.classList.add('logged-in');
            
            // Email'i göster
            document.getElementById('sidebarEmail').textContent = currentUser.email;
            document.getElementById('sidebarUsername').textContent = currentUser.email.split('@')[0];
            
            // Admin kontrolü
            if (isAdmin()) {
                sidebarAdminBtn.style.display = 'flex';
            } else {
                sidebarAdminBtn.style.display = 'none';
            }
            
            // Profil fotoğrafını yükle
            loadProfilePhoto();
            
        } else {
            // Giriş yapmamış
            headerLoggedIn.style.display = 'none';
            headerLoggedOut.style.display = 'block';
            contentLoggedIn.style.display = 'none';
            contentLoggedOut.style.display = 'block';
            toggleBtn.classList.remove('logged-in');
            
            // Avatarları sıfırla
            resetProfileAvatars();
        }
    }
    
    // Profil fotoğrafını Firestore'dan yükle
    async function loadProfilePhoto() {
        if (!currentUser) return;
        
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (userDoc.exists && userDoc.data().profilePhoto) {
                const photoUrl = userDoc.data().profilePhoto;
                setProfileAvatars(photoUrl);
            } else {
                resetProfileAvatars();
            }
        } catch(e) {
            console.log('Profil fotoğrafı yüklenemedi:', e);
            resetProfileAvatars();
        }
    }
    
    // Profil avatarlarını ayarla
    function setProfileAvatars(photoUrl) {
        // Sidebar avatar
        const avatarImg = document.getElementById('profileAvatarImg');
        const avatarDisplay = document.getElementById('profileAvatarDisplay');
        avatarImg.src = photoUrl;
        avatarImg.style.display = 'block';
        avatarDisplay.querySelector('span').style.display = 'none';
        
        // Toggle buton avatar
        const toggleBtnAvatar = document.getElementById('toggleBtnAvatar');
        const toggleDefaultAvatar = document.querySelector('.profile-toggle-btn .default-avatar');
        toggleBtnAvatar.src = photoUrl;
        toggleBtnAvatar.style.display = 'block';
        toggleDefaultAvatar.style.display = 'none';
    }
    
    // Profil avatarlarını sıfırla
    function resetProfileAvatars() {
        // Sidebar avatar
        const avatarImg = document.getElementById('profileAvatarImg');
        const avatarDisplay = document.getElementById('profileAvatarDisplay');
        if (avatarImg) {
            avatarImg.src = '';
            avatarImg.style.display = 'none';
        }
        if (avatarDisplay) {
            const span = avatarDisplay.querySelector('span');
            if (span) span.style.display = 'block';
        }
        
        // Toggle buton avatar
        const toggleBtnAvatar = document.getElementById('toggleBtnAvatar');
        const toggleDefaultAvatar = document.querySelector('.profile-toggle-btn .default-avatar');
        if (toggleBtnAvatar) {
            toggleBtnAvatar.src = '';
            toggleBtnAvatar.style.display = 'none';
        }
        if (toggleDefaultAvatar) {
            toggleDefaultAvatar.style.display = 'block';
        }
    }
    
    // Profil fotoğrafı seçildiğinde
    async function handleProfilePhotoSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Dosya boyutu kontrolü (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            showToast('❌ Fotoğraf 2MB\'dan küçük olmalı');
            return;
        }
        
        // Sadece resim dosyaları
        if (!file.type.startsWith('image/')) {
            showToast('❌ Sadece resim dosyası yükleyebilirsiniz');
            return;
        }
        
        showToast('⏳ Fotoğraf yükleniyor...');
        
        try {
            // Resmi sıkıştır ve Base64'e çevir
            const compressedBase64 = await compressAndConvertToBase64(file);
            
            // Firestore'a kaydet
            await db.collection('users').doc(currentUser.uid).set({
                profilePhoto: compressedBase64,
                profilePhotoUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            // Avatar'ları güncelle
            setProfileAvatars(compressedBase64);
            
            showToast('✅ Profil fotoğrafı güncellendi!');
        } catch(e) {
            console.error('Fotoğraf yükleme hatası:', e);
            showToast('❌ Fotoğraf yüklenemedi');
        }
    }
    
    // Resmi sıkıştır ve Base64'e çevir
    function compressAndConvertToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // Canvas ile sıkıştır
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Max boyut 300x300
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 300;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // JPEG olarak %70 kalitede kaydet
                    const base64 = canvas.toDataURL('image/jpeg', 0.7);
                    resolve(base64);
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
    
    // Sidebar badge'lerini güncelle
    function updateSidebarBadges() {
        // Sipariş badge
        const orderBadge = document.getElementById('sidebarOrderBadge');
        const mainOrderBadge = document.getElementById('myOrderBadge');
        if (mainOrderBadge && mainOrderBadge.textContent !== '0') {
            orderBadge.textContent = mainOrderBadge.textContent;
            orderBadge.style.display = 'inline';
        } else {
            orderBadge.style.display = 'none';
        }
        
        // Bildirim badge
        const notifBadge = document.getElementById('sidebarNotifBadge');
        const mainNotifBadge = document.getElementById('notifBadge');
        if (mainNotifBadge && mainNotifBadge.textContent !== '0') {
            notifBadge.textContent = mainNotifBadge.textContent;
            notifBadge.style.display = 'inline';
        } else {
            notifBadge.style.display = 'none';
        }
        
        // Chat badge
        const chatBadge = document.getElementById('sidebarChatBadge');
        const mainChatBadge = document.getElementById('chatBadge');
        if (mainChatBadge && mainChatBadge.textContent !== '0') {
            chatBadge.textContent = mainChatBadge.textContent;
            chatBadge.style.display = 'inline';
        } else {
            chatBadge.style.display = 'none';
        }
        
        // Profil toggle notification dot
        const notifDot = document.getElementById('profileNotifDot');
        const hasNotifications = (mainOrderBadge && mainOrderBadge.style.display !== 'none') ||
                                 (mainNotifBadge && mainNotifBadge.style.display !== 'none') ||
                                 (mainChatBadge && mainChatBadge.style.display !== 'none');
        notifDot.style.display = hasNotifications ? 'block' : 'none';
    }
    
    // Sidebar key durumunu güncelle
    function updateSidebarKeyStatus(text, isActive) {
        const keyStatus = document.getElementById('sidebarKeyStatus');
        const keyText = document.getElementById('sidebarKeyText');
        
        keyText.textContent = text;
        keyStatus.className = 'profile-key-status' + (isActive ? ' active' : ' expired');
        keyText.className = 'profile-key-value' + (isActive ? ' active' : ' expired');
    }
    
    // ==================== MERKEZİ GİRİŞ KONTROLÜ ====================
    // Satın alma işlemleri için giriş zorunluluğu
    function requireLogin(action = 'bu işlemi yapmak') {
        if (!currentUser) {
            showLoginRequiredModal(action);
            return false;
        }
        return true;
    }
    
    // Giriş gerekli modal'ını göster
    function showLoginRequiredModal(action) {
        // Overlay oluştur
        const overlay = document.createElement('div');
        overlay.id = 'loginRequiredOverlay';
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); animation: fadeIn 0.3s ease;';
        
        overlay.innerHTML = `
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; padding: 30px; text-align: center; max-width: 350px; width: 100%; border: 2px solid rgba(255,152,0,0.5); box-shadow: 0 0 30px rgba(255,152,0,0.2); animation: scaleIn 0.3s ease;">
                <div style="font-size: 60px; margin-bottom: 15px;">🔐</div>
                <h3 style="color: #FF9800; margin-bottom: 10px; font-size: 20px;">Giriş Yapmanız Gerekiyor</h3>
                <p style="color: #aaa; font-size: 14px; margin-bottom: 25px; line-height: 1.5;">
                    ${action.charAt(0).toUpperCase() + action.slice(1)} için hesabınıza giriş yapmanız gerekmektedir.
                </p>
                <button onclick="closeLoginRequiredModal(); navigateTo('loginPage');" style="width: 100%; background: linear-gradient(135deg, #4CAF50, #45a049); border: none; color: #fff; padding: 15px; border-radius: 12px; font-size: 15px; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                    🔐 Giriş Yap
                </button>
                <button onclick="closeLoginRequiredModal(); navigateTo('registerPage');" style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 15px; border-radius: 12px; font-size: 15px; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                    📝 Kayıt Ol
                </button>
                <button onclick="closeLoginRequiredModal();" style="width: 100%; background: transparent; border: none; color: #888; padding: 10px; font-size: 13px; cursor: pointer;">
                    ← Vazgeç
                </button>
            </div>
        `;
        
        document.body.appendChild(overlay);
        document.body.style.overflow = 'hidden';
    }
    
    // Giriş gerekli modal'ını kapat
    function closeLoginRequiredModal() {
        const overlay = document.getElementById('loginRequiredOverlay');
        if (overlay) {
            overlay.remove();
            document.body.style.overflow = '';
        }
    }
    
    // ==================== PUSH NOTIFICATION SERVER ====================
    // Ücretsiz Vercel sunucusu ile push bildirimi gönderme
    const PUSH_SERVER = {
        url: '', // Vercel deploy sonrası buraya URL gelecek
        apiKey: '' // Güvenlik anahtarı
    };
    
    // Push notification gönder (sunucu üzerinden)
    async function sendPushNotification(token, title, body, data = {}) {
        if (!PUSH_SERVER.url || !PUSH_SERVER.apiKey) {
            console.log('Push server yapılandırılmamış');
            return false;
        }
        
        try {
            const response = await fetch(`${PUSH_SERVER.url}/api/send-notification`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': PUSH_SERVER.apiKey
                },
                body: JSON.stringify({ token, title, body, data })
            });
            
            const result = await response.json();
            console.log('Push bildirim gönderildi:', result);
            return result.success;
        } catch (e) {
            console.error('Push bildirim hatası:', e);
            return false;
        }
    }
    
    // Birden fazla kullanıcıya push bildirim gönder
    async function sendPushToMultiple(tokens, title, body, data = {}) {
        if (!PUSH_SERVER.url || !PUSH_SERVER.apiKey || !tokens.length) {
            return false;
        }
        
        try {
            const response = await fetch(`${PUSH_SERVER.url}/api/send-notification`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': PUSH_SERVER.apiKey
                },
                body: JSON.stringify({ tokens, title, body, data })
            });
            
            const result = await response.json();
            return result.success;
        } catch (e) {
            console.error('Çoklu push bildirim hatası:', e);
            return false;
        }
    }
    
    // Tüm kullanıcılara push bildirim gönder (topic)
    async function sendPushToAll(title, body, data = {}) {
        if (!PUSH_SERVER.url || !PUSH_SERVER.apiKey) {
            return false;
        }
        
        try {
            const response = await fetch(`${PUSH_SERVER.url}/api/send-notification`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': PUSH_SERVER.apiKey
                },
                body: JSON.stringify({ topic: 'all_users', title, body, data })
            });
            
            const result = await response.json();
            return result.success;
        } catch (e) {
            console.error('Topic push bildirim hatası:', e);
            return false;
        }
    }
    
    // ==================== MERKEZİ ÖDEME SİSTEMİ ====================
    // Tüm ödeme işlemleri bu sistem üzerinden yönetilir
    let paymentSettings = {
        bankInfo: {
            name: 'ONUR TENK',
            bank: 'Garanti Bankası',
            iban: 'TR26 0006 2000 7750 0006 8826 02',
            ibanClean: 'TR2600062000775000068826 02'
        },
        shopier: {
            enabled: true,
            storeUrl: 'https://www.shopier.com/CheatsStore',
            // Varsayılan linkler (hile bazında özelleştirilebilir)
            defaultLinks: {}
        },
        methods: [
            { id: 'shopier', name: 'Kredi Kartı', icon: '💳', desc: 'Shopier ile güvenli ödeme', enabled: true, comingSoon: true },
            { id: 'havale', name: 'Havale / EFT', icon: '🏦', desc: 'Banka havalesi ile ödeme', enabled: true }
        ]
    };
    
    // Merkezi sipariş verisi
    let currentPaymentOrder = null;
    
    // Ödeme ayarlarını Firestore'dan yükle
    async function loadPaymentSettings() {
        try {
            const doc = await db.collection('settings').doc('paymentSettings').get();
            if (doc.exists) {
                const data = doc.data();
                if (data.bankInfo) paymentSettings.bankInfo = data.bankInfo;
                if (data.methods) paymentSettings.methods = data.methods;
                if (data.shopier) paymentSettings.shopier = { ...paymentSettings.shopier, ...data.shopier };
                // Push server ayarlarını yükle
                if (data.pushServer) {
                    PUSH_SERVER.url = data.pushServer.url || '';
                    PUSH_SERVER.apiKey = data.pushServer.apiKey || '';
                    console.log('📱 Push server ayarları yüklendi');
                }
            }
        } catch(e) {
            console.log('Ödeme ayarları yüklenemedi, varsayılan kullanılıyor');
        }
    }
    
    // Merkezi ödeme modalını aç (tüm satın alma işlemleri için)
    function openUnifiedPaymentModal(orderData) {
        // orderData: { type, game, cheat, package, packageName, price, days, keyCode?, currentExpiry?, newExpiry? }
        currentPaymentOrder = orderData;
        
        // Modal içeriğini oluştur
        let typeLabel = orderData.type === 'extension' ? '⏰ Süre Uzatma' : '🛒 Yeni Satın Alma';
        let infoHtml = '';
        
        if (orderData.type === 'extension') {
            infoHtml = `
                <div style="font-size: 12px; color: #aaa; margin-bottom: 5px;">${typeLabel}</div>
                <div style="font-size: 14px; font-weight: bold;">${orderData.game} - ${orderData.cheat}</div>
                <div style="font-size: 12px; color: #FF9800; margin-top: 3px;">+${orderData.packageName}</div>
            `;
        } else {
            infoHtml = `
                <div style="font-size: 12px; color: #aaa; margin-bottom: 5px;">${typeLabel}</div>
                <div style="font-size: 14px; font-weight: bold;">${orderData.game || ''} ${orderData.cheat || ''}</div>
                <div style="font-size: 12px; color: #4CAF50; margin-top: 3px;">${orderData.packageName}</div>
            `;
        }
        
        document.getElementById('unifiedPaymentInfo').innerHTML = infoHtml;
        document.getElementById('unifiedPaymentPrice').textContent = orderData.price;
        
        // Ödeme yöntemlerini render et
        renderPaymentMethods();
        
        openModal('unifiedPaymentModal');
    }
    
    // Ödeme yöntemlerini render et
    function renderPaymentMethods() {
        const container = document.getElementById('unifiedPaymentMethods');
        container.innerHTML = paymentSettings.methods.filter(m => m.enabled).map(method => {
            if (method.comingSoon) {
                // Yakında gelecek - devre dışı görünüm
                return `
                    <button onclick="showToast('🔜 Bu ödeme yöntemi yakında aktif edilecek!', 'info')" class="payment-method-btn" style="opacity: 0.6; cursor: not-allowed; position: relative;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 30px;">${method.icon}</div>
                            <div style="text-align: left;">
                                <div style="font-weight: bold; font-size: 15px;">${method.name}</div>
                                <div style="font-size: 12px; color: #aaa;">${method.desc}</div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #FF9800, #FF5722); color: white; font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold;">🔜 Yakında</div>
                    </button>
                `;
            } else {
                // Normal aktif buton
                return `
                    <button onclick="selectUnifiedPaymentMethod('${method.id}')" class="payment-method-btn">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 30px;">${method.icon}</div>
                            <div style="text-align: left;">
                                <div style="font-weight: bold; font-size: 15px;">${method.name}</div>
                                <div style="font-size: 12px; color: #aaa;">${method.desc}</div>
                            </div>
                        </div>
                        <div style="font-size: 20px; color: #4CAF50;">›</div>
                    </button>
                `;
            }
        }).join('');
    }
    
    // Ödeme yöntemi seç
    function selectUnifiedPaymentMethod(method) {
        if (!currentPaymentOrder) return;
        
        closeModal('unifiedPaymentModal');
        
        if (method === 'shopier') {
            // Shopier'a yönlendir
            redirectToShopier();
        } else if (method === 'havale') {
            openUnifiedHavaleModal();
        }
    }
    
    // Shopier'a yönlendirme fonksiyonu
    function redirectToShopier() {
        if (!currentPaymentOrder) {
            showToast('❌ Sipariş bilgisi bulunamadı');
            return;
        }
        
        // Önce fiyat içindeki shopierLink'i kontrol et
        let shopierUrl = null;
        
        // 1. Seçilen fiyat paketinde shopierLink varsa onu kullan
        if (currentPaymentOrder.shopierLink) {
            shopierUrl = currentPaymentOrder.shopierLink;
        }
        // 2. Hilenin genel shopierLinks ayarlarından gün bazlı bul
        else if (currentPaymentOrder.cheatId && currentPaymentOrder.days) {
            const cheatShopierLinks = getCheatShopierLinks(currentPaymentOrder.gameId, currentPaymentOrder.cheatId);
            if (cheatShopierLinks && cheatShopierLinks[currentPaymentOrder.days]) {
                shopierUrl = cheatShopierLinks[currentPaymentOrder.days];
            }
        }
        // 3. Varsayılan mağaza linkine yönlendir
        if (!shopierUrl) {
            shopierUrl = paymentSettings.shopier?.storeUrl || 'https://www.shopier.com/CheatsStore';
            showToast('ℹ️ Shopier mağazasına yönlendiriliyorsunuz. Lütfen ürünü manuel seçin.');
        } else {
            showToast('🔗 Shopier ödeme sayfasına yönlendiriliyorsunuz...');
        }
        
        // Yeni sekmede aç
        setTimeout(() => {
            window.open(shopierUrl, '_blank');
        }, 500);
    }
    
    // Hile bazlı Shopier linklerini al
    function getCheatShopierLinks(gameId, cheatId) {
        try {
            // Firebase'den yüklenen gamesData'dan al
            const game = Object.values(gamesData || {}).find(g => g.id === gameId);
            if (game && game.cheats) {
                const cheat = Object.values(game.cheats).find(c => c.id === cheatId);
                if (cheat && cheat.shopierLinks) {
                    return cheat.shopierLinks;
                }
            }
        } catch(e) {
            console.log('Shopier links alınamadı:', e);
        }
        return null;
    }
    
    // Merkezi havale modalını aç
    function openUnifiedHavaleModal() {
        if (!currentPaymentOrder) return;
        
        // Bilgileri doldur
        document.getElementById('unifiedHavaleAmount').textContent = currentPaymentOrder.price;
        
        let infoText = currentPaymentOrder.type === 'extension' 
            ? `${currentPaymentOrder.game} - ${currentPaymentOrder.cheat} için ${currentPaymentOrder.packageName}`
            : `${currentPaymentOrder.game || ''} ${currentPaymentOrder.cheat || ''} - ${currentPaymentOrder.packageName}`;
        document.getElementById('unifiedHavaleInfo').textContent = infoText;
        
        // Banka bilgilerini render et
        document.getElementById('unifiedBankName').textContent = paymentSettings.bankInfo.name;
        document.getElementById('unifiedBankBank').textContent = paymentSettings.bankInfo.bank;
        document.getElementById('unifiedBankIban').textContent = paymentSettings.bankInfo.iban;
        
        // Dekont önizlemeyi sıfırla
        document.getElementById('unifiedDekontFile').value = '';
        document.getElementById('unifiedDekontPreview').style.display = 'none';
        
        openModal('unifiedHavaleModal');
    }
    
    // Dekont önizleme
    function previewUnifiedDekont(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('unifiedDekontImg').src = e.target.result;
                document.getElementById('unifiedDekontPreview').style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    // IBAN kopyalama
    function copyUnifiedIban() {
        copyToClipboard(paymentSettings.bankInfo.ibanClean);
    }
    
    // Merkezi sipariş gönder
    async function submitUnifiedOrder() {
        if (!currentUser) {
            showToast('❌ Giriş yapmanız gerekiyor');
            return;
        }
        
        if (!currentPaymentOrder) {
            showToast('❌ Sipariş bilgisi bulunamadı');
            return;
        }
        
        const fileInput = document.getElementById('unifiedDekontFile');
        if (!fileInput.files[0]) {
            showToast('❌ Dekont fotoğrafı seçin');
            return;
        }
        
        showToast('⏳ Sipariş gönderiliyor...');
        
        try {
            // Dekont'u base64'e çevir
            const dekontBase64 = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('Dosya okunamadı'));
                reader.readAsDataURL(fileInput.files[0]);
            });
            
            // Sipariş objesi
            const orderData = {
                userId: currentUser.uid,
                email: currentUser.email,
                userEmail: currentUser.email,
                type: currentPaymentOrder.type || 'purchase',
                game: currentPaymentOrder.game || '',
                cheat: currentPaymentOrder.cheat || '',
                package: currentPaymentOrder.package,
                packageName: currentPaymentOrder.packageName,
                price: currentPaymentOrder.price,
                days: currentPaymentOrder.days,
                dekont: dekontBase64,
                paymentMethod: 'havale',
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Süre uzatma için ek alanlar
            if (currentPaymentOrder.type === 'extension') {
                orderData.keyCode = currentPaymentOrder.keyCode;
                orderData.keyId = currentPaymentOrder.keyId;
                orderData.currentExpiry = currentPaymentOrder.currentExpiry;
                orderData.newExpiry = currentPaymentOrder.newExpiry;
                orderData.extensionDays = currentPaymentOrder.days;
            }
            
            await db.collection('orders').add(orderData);
            
            closeModal('unifiedHavaleModal');
            showOrderSuccessModal();
            showToast('✅ Siparişiniz alındı!');
            currentPaymentOrder = null;
            
        } catch(e) {
            console.error('Sipariş hatası:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }
    // ==================== MERKEZİ ÖDEME SİSTEMİ SON ====================

    // Firebase Auth State
    let currentUser = null;
    let orderListener = null; // Real-time listener
    
    auth.onAuthStateChanged(async (user) => {
        currentUser = user;
        if (user) {
            // Önce admin listesini yükle, sonra UI güncelle
            await loadAdminList();
            updateAuthUI();
            await loadUserData();
            startOrderListener(); // Anlık sipariş dinleme başlat
            
            // Arka plan bildirimleri için email'i native'e kaydet
            saveUserEmailForBackgroundNotifications(user.email);
        } else {
            updateAuthUI();
            stopOrderListener();
            
            // Çıkış yapıldığında email'i temizle
            clearUserEmailForBackgroundNotifications();
        }
    });
    
    // Arka plan bildirimleri için kullanıcı email'ini native'e kaydet
    async function saveUserEmailForBackgroundNotifications(email) {
        try {
            if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                const { NotificationPrefs } = Capacitor.Plugins;
                if (NotificationPrefs) {
                    await NotificationPrefs.setUserEmail({ email: email });
                    console.log('📱 Arka plan bildirimleri için email kaydedildi:', email);
                }
            }
        } catch(e) {
            console.log('Email kaydetme hatası:', e);
        }
    }
    
    // Arka plan bildirimleri için email'i temizle
    async function clearUserEmailForBackgroundNotifications() {
        try {
            if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                const { NotificationPrefs } = Capacitor.Plugins;
                if (NotificationPrefs) {
                    await NotificationPrefs.clearUserEmail();
                    console.log('📱 Arka plan bildirimleri için email temizlendi');
                }
            }
        } catch(e) {
            console.log('Email temizleme hatası:', e);
        }
    }
    
    // Anlık bildirim göster
    function showNotification(message, type = 'success') {
        const toast = document.getElementById('notificationToast');
        toast.textContent = message;
        toast.className = 'notification-toast ' + type;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 5000);
    }
    
    // Sipariş dinleyici başlat
    function startOrderListener() {
        if (!currentUser || isAdmin()) return;
        stopOrderListener();
        
        // Bildirim gönderilen sipariş ID'lerini takip et
        const notifiedOrders = JSON.parse(localStorage.getItem('notifiedOrders') || '[]');
        
        orderListener = db.collection('orders')
            .where('userId', '==', currentUser.uid)
            .onSnapshot((snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'modified') {
                        const orderId = change.doc.id;
                        const order = change.doc.data();
                        const notifKey = orderId + '_' + order.status; // Sipariş ID + durum
                        
                        // Bu sipariş+durum için daha önce bildirim gönderildi mi?
                        if (notifiedOrders.includes(notifKey)) {
                            console.log('Bu sipariş için zaten bildirim gönderildi:', notifKey);
                            return;
                        }
                        
                        if (order.status === 'approved') {
                            console.log('🎉 SİPARİŞ ONAYLANDI - MERKEZİ BİLDİRİM GÖNDERİLİYOR');
                            
                            // Toast bildirimi
                            showNotification('🎉 Siparişiniz onaylandı! Key: ' + order.keyCode);
                            
                            // MERKEZİ BİLDİRİM SİSTEMİ - Tüm kanallar
                            await showFullNotification({
                                title: '🎉 Siparişiniz Onaylandı!',
                                message: `Paketiniz aktif edildi! Key: ${order.keyCode}`,
                                type: 'order',
                                keyCode: order.keyCode,
                                showPopup: true,
                                playSound: true,
                                showNative: true,
                                vibrate: true,
                                updateBadge: true
                            });
                            
                            // Key durumunu HEMEN güncelle
                            loadUserData();
                            
                            // Bildirim gönderildi olarak işaretle
                            notifiedOrders.push(notifKey);
                            localStorage.setItem('notifiedOrders', JSON.stringify(notifiedOrders));
                            
                        } else if (order.status === 'rejected') {
                            console.log('❌ SİPARİŞ REDDEDİLDİ - MERKEZİ BİLDİRİM GÖNDERİLİYOR');
                            
                            showNotification('❌ Siparişiniz reddedildi: ' + (order.rejectReason || 'Sebep belirtilmedi'), 'error');
                            
                            // MERKEZİ BİLDİRİM SİSTEMİ - Tüm kanallar
                            await showFullNotification({
                                title: '❌ Sipariş Reddedildi',
                                message: order.rejectReason || 'Sebep belirtilmedi',
                                type: 'warning',
                                showPopup: true,
                                playSound: true,
                                showNative: true,
                                vibrate: true,
                                updateBadge: true
                            });
                            
                            notifiedOrders.push(notifKey);
                            localStorage.setItem('notifiedOrders', JSON.stringify(notifiedOrders));
                        }
                    }
                });
                updateOrderBadge();
            });
        
        // Bildirim dinleyiciyi de başlat
        startNotificationListener();
        
        // KEY DURUMU DİNLEYİCİ - Realtime key güncellemesi
        startKeyStatusListener();
        
        // Chat dinleyiciyi başlat
        startChatListener();
        
        // Push notification başlat
        initPushNotifications();
    }
    
    // ==================== KEY DURUMU REALTİME DİNLEYİCİ ====================
    let keyStatusListener = null;
    
    function startKeyStatusListener() {
        if (!currentUser) {
            console.log('🔑 Key listener: currentUser yok');
            return;
        }
        stopKeyStatusListener();
        
        console.log('🔑 Key durumu dinleyici başlatılıyor... UID:', currentUser.uid);
        
        keyStatusListener = db.collection('users').doc(currentUser.uid)
            .onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    const keyCount = data.keys ? data.keys.length : 0;
                    console.log('🔑 ✅ Key durumu REALTIME güncellendi:', keyCount, 'key');
                    
                    // Key durumunu güncelle (ana sayfa + sidebar)
                    updateKeyStatus(data.keys || []);
                    
                    // Aktif key var mı kontrol et
                    const now = new Date();
                    const activeKeys = (data.keys || []).filter(k => {
                        const exp = toDate(k.expiresAt);
                        return exp && exp > now;
                    });
                    
                    if (activeKeys.length > 0) {
                        console.log('🔑 🎉 AKTİF KEY TESPİT EDİLDİ!', activeKeys.length, 'adet');
                    }
                } else {
                    console.log('🔑 Kullanıcı dökümanı bulunamadı');
                }
            }, (error) => {
                console.error('🔑 ❌ Key dinleyici hatası:', error);
                // Hata durumunda 5 saniye sonra tekrar dene
                setTimeout(() => {
                    if (currentUser) {
                        console.log('🔑 Dinleyici yeniden başlatılıyor...');
                        startKeyStatusListener();
                    }
                }, 5000);
            });
        
        console.log('🔑 Key dinleyici aktif');
    }
    
    function stopKeyStatusListener() {
        if (keyStatusListener) {
            keyStatusListener();
            keyStatusListener = null;
            console.log('🔑 Key dinleyici durduruldu');
        }
    }
    
    // ==================== MERKEZİ BİLDİRİM SİSTEMİ ====================
    /*
     * Tüm bildirimler bu merkezi sistem üzerinden gönderilir.
     * showFullNotification() - Tüm bildirim kanallarını kullanır:
     *   1. In-app popup (sağ üst köşe)
     *   2. Bildirim sesi
     *   3. Native push notification (telefon üst bar)
     *   4. Titreşim
     *   5. Badge güncelleme
     */
    
    // MERKEZİ BİLDİRİM GÖNDERİCİ
    async function showFullNotification(options = {}) {
        const {
            title = 'Bildirim',
            message = '',
            type = 'info',  // info, success, warning, promo, order
            keyCode = null,
            showPopup = true,
            playSound = true,
            showNative = true,
            vibrate = true,
            updateBadge = true
        } = options;
        
        console.log('🔔 MERKEZİ BİLDİRİM:', title, message);
        
        // 1. In-app popup göster
        if (showPopup) {
            if (type === 'order' && keyCode) {
                showOrderApprovalPopup({ title, message, keyCode });
            } else {
                showNotificationPopup({ title, message, type });
            }
        }
        
        // 2. Bildirim sesi çal
        if (playSound) {
            playNotificationSound();
        }
        
        // 3. Native push notification (telefon üst bar)
        if (showNative) {
            await sendNativeNotification(title, message, { type, keyCode });
        }
        
        // 4. Titreşim
        if (vibrate && navigator.vibrate) {
            if (type === 'order') {
                navigator.vibrate([200, 100, 200, 100, 200, 100, 400]);
            } else {
                navigator.vibrate([200, 100, 200]);
            }
        }
        
        // 5. Badge güncelle
        if (updateBadge) {
            updateProfileNotifBadge();
            updateNotificationBadge();
        }
        
        console.log('✅ Merkezi bildirim gönderildi');
    }
    
    // ==================== BİLDİRİM SİSTEMİ ====================
    
    let notificationListener = null;
    let allNotificationListener = null;
    let emailNotificationListener = null;
    let userNotifications = [];
    let fcmToken = null;
    
    // Push Notifications başlat (FCM)
    async function initPushNotifications() {
        try {
            if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                const { PushNotifications } = Capacitor.Plugins;
                if (!PushNotifications) {
                    console.log('PushNotifications plugin bulunamadı');
                    return;
                }
                
                // İzin iste
                const permResult = await PushNotifications.requestPermissions();
                if (permResult.receive !== 'granted') {
                    console.log('Push notification izni reddedildi');
                    return;
                }
                
                // Kaydol
                await PushNotifications.register();
                
                // Token alındığında
                PushNotifications.addListener('registration', async (token) => {
                    console.log('FCM Token:', token.value);
                    fcmToken = token.value;
                    
                    // Token'ı Firestore'a kaydet
                    if (currentUser && fcmToken) {
                        try {
                            await db.collection('users').doc(currentUser.uid).update({
                                fcmToken: fcmToken,
                                fcmTokenUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log('FCM token Firestore\'a kaydedildi');
                        } catch(e) {
                            console.log('FCM token kaydetme hatası:', e);
                        }
                    }
                });
                
                // Kayıt hatası
                PushNotifications.addListener('registrationError', (error) => {
                    console.error('Push kayıt hatası:', error);
                });
                
                // Bildirim alındığında (uygulama açıkken)
                PushNotifications.addListener('pushNotificationReceived', (notification) => {
                    console.log('Push bildirim alındı:', notification);
                    // Uygulama içi popup göster
                    showNotificationPopup({
                        title: notification.title,
                        message: notification.body,
                        type: notification.data?.type || 'info'
                    });
                });
                
                // Bildirime tıklandığında
                PushNotifications.addListener('pushNotificationActionPerformed', (notification) => {
                    console.log('Push bildirime tıklandı:', notification);
                    // İlgili sayfaya yönlendir
                    if (notification.notification.data?.page) {
                        navigateTo(notification.notification.data.page);
                    }
                });
                
                console.log('Push notifications başlatıldı');
            }
        } catch(e) {
            console.error('Push notification başlatma hatası:', e);
        }
    }
    
    // Native Push Notification izni iste
    async function requestNotificationPermission() {
        try {
            if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                // Capacitor Local Notifications
                const { LocalNotifications } = Capacitor.Plugins;
                if (LocalNotifications) {
                    const permission = await LocalNotifications.requestPermissions();
                    console.log('Bildirim izni:', permission.display);
                    return permission.display === 'granted';
                }
            } else if ('Notification' in window) {
                // Web Notification API
                const permission = await Notification.requestPermission();
                console.log('Web bildirim izni:', permission);
                return permission === 'granted';
            }
        } catch(e) {
            console.log('Bildirim izni hatası:', e);
        }
        return false;
    }
    
    // Native Push Notification gönder
    async function sendNativeNotification(title, body, data = {}) {
        console.log('sendNativeNotification çağrıldı:', title, body);
        
        try {
            if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                console.log('Capacitor native platform algılandı');
                
                // Önce kanalların oluşturulduğundan emin ol
                await createNotificationChannel();
                
                // Capacitor Local Notifications
                const { LocalNotifications } = Capacitor.Plugins;
                if (LocalNotifications) {
                    console.log('LocalNotifications plugin mevcut');
                    
                    // Önce izin kontrol et
                    const permStatus = await LocalNotifications.checkPermissions();
                    console.log('Bildirim izin durumu:', permStatus.display);
                    
                    if (permStatus.display !== 'granted') {
                        const reqResult = await LocalNotifications.requestPermissions();
                        console.log('İzin istek sonucu:', reqResult.display);
                        if (reqResult.display !== 'granted') {
                            console.log('Bildirim izni reddedildi');
                            return;
                        }
                    }
                    
                    const notifId = Math.floor(Math.random() * 100000);
                    console.log('Bildirim ID:', notifId);
                    
                    // Hep default kanalı kullan (order-channel sorun çıkarıyor)
                    await LocalNotifications.schedule({
                        notifications: [{
                            title: title,
                            body: body,
                            id: notifId,
                            schedule: { at: new Date(Date.now() + 100) }, // Hemen göster
                            sound: 'default',
                            smallIcon: 'ic_stat_icon_config_sample',
                            largeIcon: 'ic_launcher',
                            channelId: 'default',
                            autoCancel: true,
                            extra: data
                        }]
                    });
                    console.log('✅ Native bildirim gönderildi:', title);
                } else {
                    console.log('LocalNotifications plugin bulunamadı');
                }
            } else if ('Notification' in window) {
                console.log('Web Notification API kullanılıyor');
                if (Notification.permission === 'granted') {
                    new Notification(title, {
                        body: body,
                        icon: 'https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/logo.png',
                        requireInteraction: true,
                        vibrate: [200, 100, 200]
                    });
                    console.log('Web bildirim gönderildi');
                } else if (Notification.permission !== 'denied') {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        new Notification(title, { body: body });
                    }
                }
            } else {
                console.log('Bildirim desteklenmiyor');
            }
        } catch(e) {
            console.error('Native bildirim hatası:', e);
        }
    }
    
    // Bildirim kanalları oluştur (Android 8+)
    let channelsCreated = false;
    
    async function createNotificationChannel() {
        if (channelsCreated) return; // Zaten oluşturulduysa tekrar oluşturma
        
        try {
            if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                const { LocalNotifications } = Capacitor.Plugins;
                if (LocalNotifications && LocalNotifications.createChannel) {
                    // Genel bildirim kanalı
                    await LocalNotifications.createChannel({
                        id: 'default',
                        name: 'BestOfShop Bildirimleri',
                        description: 'Genel bildirimler',
                        importance: 4, // HIGH
                        visibility: 1, // PUBLIC
                        sound: 'default',
                        vibration: true,
                        lights: true
                    });
                    
                    // Sipariş bildirim kanalı (daha yüksek öncelik)
                    await LocalNotifications.createChannel({
                        id: 'order-channel',
                        name: 'Sipariş Bildirimleri',
                        description: 'Sipariş onay ve red bildirimleri',
                        importance: 5, // MAX
                        visibility: 1, // PUBLIC
                        sound: 'default',
                        vibration: true,
                        lights: true
                    });
                    
                    channelsCreated = true;
                    console.log('✅ Bildirim kanalları oluşturuldu');
                }
            }
        } catch(e) {
            console.log('Kanal oluşturma hatası:', e);
        }
    }
    
    // Bildirim dinleyici başlat
    let listenerStartTime = null; // Dinleyici başlangıç zamanı
    
    function startNotificationListener() {
        if (!currentUser) return;
        stopNotificationListener();
        
        // Bildirim izni ve kanalı oluştur
        requestNotificationPermission();
        createNotificationChannel();
        
        // Email'i normalize et
        const userEmail = currentUser.email.toLowerCase().trim();
        console.log('🔔 Bildirim dinleyiciler başlatılıyor...', userEmail);
        
        // Dinleyici başlangıç zamanını kaydet - bu zamandan sonra gelen bildirimler yeni sayılır
        listenerStartTime = new Date();
        console.log('🔔 Listener başlangıç zamanı:', listenerStartTime.toISOString());
        
        // Genel bildirimleri dinle (all) - orderBy kaldırıldı, index gerektirmez
        allNotificationListener = db.collection('notifications')
            .where('targetType', '==', 'all')
            .limit(50)
            .onSnapshot((snapshot) => {
                console.log('🔔 Genel bildirim snapshot:', snapshot.size, 'adet');
                processNotificationSnapshot(snapshot);
            }, (error) => {
                console.error('Genel bildirim dinleyici hatası:', error);
                showToast('⚠️ Bildirim bağlantı hatası');
            });
        
        // Kullanıcıya özel bildirimleri dinle (normalize edilmiş email)
        notificationListener = db.collection('notifications')
            .where('targetType', '==', userEmail)
            .limit(50)
            .onSnapshot((snapshot) => {
                console.log('🔔 Kullanıcı bildirim snapshot (targetType):', snapshot.size, 'adet');
                processNotificationSnapshot(snapshot);
            }, (error) => {
                console.error('Kullanıcı bildirim dinleyici hatası:', error);
            });
        
        // Email alanına göre de dinle (eski bildirimler için)
        emailNotificationListener = db.collection('notifications')
            .where('email', '==', userEmail)
            .limit(50)
            .onSnapshot((snapshot) => {
                console.log('🔔 Kullanıcı bildirim snapshot (email):', snapshot.size, 'adet');
                processNotificationSnapshot(snapshot);
            }, (error) => {
                console.error('Email bildirim dinleyici hatası:', error);
            });
    }
    
    // Bildirim snapshot işle - YENİ VERSİYON
    function processNotificationSnapshot(snapshot) {
        // Daha önce bildirim gönderilmiş ID'leri al
        const notifiedIds = JSON.parse(localStorage.getItem('notifiedNotifications') || '[]');
        const readNotifs = JSON.parse(localStorage.getItem('readNotifications') || '[]');
        
        snapshot.docChanges().forEach((change) => {
            if (change.type === 'added') {
                const notif = { id: change.doc.id, ...change.doc.data() };
                console.log('🔔 Bildirim algılandı:', notif.title, 'ID:', notif.id);
                
                // Listede zaten var mı kontrol et
                const existingIndex = userNotifications.findIndex(n => n.id === notif.id);
                if (existingIndex === -1) {
                    userNotifications.push(notif);
                }
                
                // Bildirim daha önce gösterilmiş mi?
                const alreadyNotified = notifiedIds.includes(notif.id);
                const alreadyRead = readNotifs.includes(notif.id);
                
                if (alreadyNotified || alreadyRead) {
                    console.log('🔔 Bu bildirim zaten gösterildi:', notif.id);
                    return;
                }
                
                // Bildirim tarihi kontrolü - listenerStartTime'dan sonra mı oluşturulmuş?
                let notifDate = null;
                if (notif.createdAt && notif.createdAt.toDate) {
                    notifDate = notif.createdAt.toDate();
                } else if (notif.notifiedAt) {
                    notifDate = new Date(notif.notifiedAt);
                } else {
                    notifDate = new Date(); // Tarih yoksa şimdiki zaman kabul et
                }
                
                const now = new Date();
                const diffSeconds = (now - notifDate) / 1000;
                
                console.log('🔔 Bildirim tarihi:', notifDate.toISOString());
                console.log('🔔 Listener başlangıç:', listenerStartTime ? listenerStartTime.toISOString() : 'null');
                console.log('🔔 Bildirim yaşı:', diffSeconds, 'saniye');
                
                // KRITIK: Bildirim listener başladıktan SONRA veya son 10 saniye içinde oluşturulduysa göster
                // Bu, realtime olarak gelen yeni bildirimleri yakalar
                let shouldShowPopup = false;
                
                if (listenerStartTime && notifDate >= listenerStartTime) {
                    // Listener başladıktan sonra oluşturulan bildirim
                    shouldShowPopup = true;
                    console.log('🔔 ✅ Listener başladıktan sonra oluşturulmuş - GÖSTER');
                } else if (diffSeconds <= 10) {
                    // Son 10 saniye içinde oluşturulan bildirim (race condition için)
                    shouldShowPopup = true;
                    console.log('🔔 ✅ Son 10 saniye içinde oluşturulmuş - GÖSTER');
                } else {
                    console.log('🔔 ❌ Eski bildirim, popup gösterilmeyecek');
                }
                
                if (shouldShowPopup) {
                    console.log('🔔 🚀 YENİ BİLDİRİM GÖSTERİLİYOR:', notif.title);
                    
                    // MERKEZİ BİLDİRİM SİSTEMİ KULLAN
                    showFullNotification({
                        title: notif.title || 'Bildirim',
                        message: notif.message || '',
                        type: notif.type || 'info',
                        keyCode: notif.keyCode,
                        showPopup: true,
                        playSound: true,
                        showNative: true,
                        vibrate: true,
                        updateBadge: true
                    });
                }
                
                // Bu ID'yi notified listesine ekle (tekrar gösterilmesin)
                notifiedIds.push(notif.id);
            }
        });
        
        // Notified listesini kaydet
        localStorage.setItem('notifiedNotifications', JSON.stringify([...new Set(notifiedIds)]));
        
        // Bildirimleri tarihe göre sırala
        userNotifications.sort((a, b) => {
            const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
            const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
            return dateB - dateA;
        });
        
        updateNotificationBadge();
    }
    
    // Bildirim dinleyiciyi durdur
    function stopNotificationListener() {
        if (notificationListener) {
            notificationListener();
            notificationListener = null;
        }
        if (allNotificationListener) {
            allNotificationListener();
            allNotificationListener = null;
        }
        if (emailNotificationListener) {
            emailNotificationListener();
            emailNotificationListener = null;
        }
        userNotifications = [];
    }
    
    // Bildirim popup göster
    function showNotificationPopup(notif) {
        const icons = {
            'info': 'ℹ️',
            'success': '✅',
            'warning': '⚠️',
            'promo': '🎁',
            'order': '📦'
        };
        
        const colors = {
            'info': '#2196F3',
            'success': '#4CAF50',
            'warning': '#FF9800',
            'promo': '#E91E63',
            'order': '#9C27B0'
        };
        
        const icon = icons[notif.type] || '🔔';
        const color = colors[notif.type] || '#2196F3';
        
        // Popup container
        let popup = document.createElement('div');
        popup.className = 'notif-popup';
        popup.innerHTML = `
            <div style="background: linear-gradient(135deg, ${color}, ${color}dd); border-radius: 15px; padding: 15px; margin: 10px; box-shadow: 0 5px 30px rgba(0,0,0,0.4); animation: slideInRight 0.3s ease;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="font-size: 24px;">${icon}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #fff; margin-bottom: 5px;">${notif.title || 'Bildirim'}</div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 13px;">${notif.message || ''}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; opacity: 0.7;">✕</button>
                </div>
            </div>
        `;
        popup.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10001; max-width: 350px;';
        document.body.appendChild(popup);
        
        // 5 saniye sonra otomatik kapat
        setTimeout(() => {
            if (popup.parentElement) {
                popup.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => popup.remove(), 300);
            }
        }, 5000);
    }
    
    // Bildirim badge güncelle
    function updateNotificationBadge() {
        const badge = document.getElementById('notifBadge');
        if (!badge) return;
        
        const readNotifs = JSON.parse(localStorage.getItem('readNotifications') || '[]');
        const unreadCount = userNotifications.filter(n => !readNotifs.includes(n.id)).length;
        
        if (unreadCount > 0) {
            badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
        
        // Profil butonu badge'ini de güncelle
        updateProfileNotifBadge();
    }
    
    // Profil butonu bildirim badge güncelle
    function updateProfileNotifBadge() {
        const badge = document.getElementById('profileNotifBadge');
        if (!badge) return;
        
        const readNotifs = JSON.parse(localStorage.getItem('readNotifications') || '[]');
        const unreadCount = userNotifications.filter(n => !readNotifs.includes(n.id)).length;
        
        if (unreadCount > 0) {
            badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
    
    // Bildirim sesi çal
    function playNotificationSound() {
        try {
            // Web Audio API ile bildirim sesi oluştur
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // İlk beep
            const oscillator1 = audioContext.createOscillator();
            const gainNode1 = audioContext.createGain();
            oscillator1.connect(gainNode1);
            gainNode1.connect(audioContext.destination);
            oscillator1.frequency.value = 880; // A5 notası
            oscillator1.type = 'sine';
            gainNode1.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            oscillator1.start(audioContext.currentTime);
            oscillator1.stop(audioContext.currentTime + 0.2);
            
            // İkinci beep (daha yüksek)
            setTimeout(() => {
                const oscillator2 = audioContext.createOscillator();
                const gainNode2 = audioContext.createGain();
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioContext.destination);
                oscillator2.frequency.value = 1108; // C#6 notası
                oscillator2.type = 'sine';
                gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator2.start(audioContext.currentTime);
                oscillator2.stop(audioContext.currentTime + 0.3);
            }, 150);
            
            console.log('🔊 Bildirim sesi çalındı');
        } catch(e) {
            console.log('Ses çalınamadı:', e.message);
        }
    }
    
    // Sipariş onay popup göster (büyük, ekran ortası)
    function showOrderApprovalPopup(notif) {
        const popup = document.getElementById('orderApprovalPopup');
        const messageEl = document.getElementById('approvalPopupMessage');
        const keyEl = document.querySelector('#approvalPopupKey div:last-child');
        
        if (!popup) return;
        
        messageEl.innerHTML = notif.message || 'Paketiniz aktif edildi!';
        keyEl.textContent = notif.keyCode || '';
        
        popup.style.display = 'flex';
        
        // Titreşim (varsa)
        if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200, 100, 200]);
        }
        
        // Ses çal
        playNotificationSound();
        
        console.log('🎉 Sipariş onay popup gösterildi');
    }
    
    // Sipariş onay popup kapat
    function closeOrderApprovalPopup() {
        const popup = document.getElementById('orderApprovalPopup');
        if (popup) {
            popup.style.display = 'none';
        }
    }
    
    // Bildirimler modalını aç
    async function openNotificationsModal() {
        const container = document.getElementById('notificationsList');
        
        // Loading göster
        container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div class="spinner"></div>
                <div style="color: #888; margin-top: 15px;">Bildirimler yükleniyor...</div>
            </div>
        `;
        openModal('notificationsModal');
        
        // Firestore'dan bildirimleri çek (dinleyici çalışmasa bile)
        try {
            if (!currentUser) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 50px; margin-bottom: 15px;">🔔</div>
                        <div style="color: #888;">Giriş yapmalısınız</div>
                    </div>
                `;
                return;
            }
            
            const userEmail = currentUser.email.toLowerCase().trim();
            console.log('🔔 Bildirimler yükleniyor... Email:', userEmail);
            
            // Genel bildirimleri çek
            const allNotifs = await db.collection('notifications')
                .where('targetType', '==', 'all')
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            // Kullanıcıya özel bildirimleri çek
            const userNotifs = await db.collection('notifications')
                .where('targetType', '==', userEmail)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            console.log('🔔 Genel bildirim sayısı:', allNotifs.size);
            console.log('🔔 Kullanıcı bildirim sayısı:', userNotifs.size);
            
            // Temizlenmiş bildirimleri al
            const clearedIds = JSON.parse(localStorage.getItem('clearedNotifications') || '[]');
            
            // Bildirimleri birleştir (temizlenenleri hariç tut)
            userNotifications = [];
            allNotifs.forEach(doc => {
                if (!clearedIds.includes(doc.id)) {
                    userNotifications.push({ id: doc.id, ...doc.data() });
                }
            });
            userNotifs.forEach(doc => {
                // Duplikasyonu önle ve temizlenenleri hariç tut
                if (!userNotifications.find(n => n.id === doc.id) && !clearedIds.includes(doc.id)) {
                    userNotifications.push({ id: doc.id, ...doc.data() });
                }
            });
            
            // Tarihe göre sırala
            userNotifications.sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                return dateB - dateA;
            });
            
            console.log('🔔 Toplam bildirim (temizlenenler hariç):', userNotifications.length);
            
            renderNotificationsList(container);
            
        } catch(e) {
            console.error('🔔 Bildirim yükleme hatası:', e);
            // Index hatası olabilir - orderBy olmadan dene
            try {
                const userEmail = currentUser.email.toLowerCase().trim();
                
                const allNotifs = await db.collection('notifications')
                    .where('targetType', '==', 'all')
                    .limit(50)
                    .get();
                
                const userNotifs = await db.collection('notifications')
                    .where('targetType', '==', userEmail)
                    .limit(50)
                    .get();
                
                // Temizlenmiş bildirimleri al
                const clearedIds = JSON.parse(localStorage.getItem('clearedNotifications') || '[]');
                
                userNotifications = [];
                allNotifs.forEach(doc => {
                    if (!clearedIds.includes(doc.id)) {
                        userNotifications.push({ id: doc.id, ...doc.data() });
                    }
                });
                userNotifs.forEach(doc => {
                    if (!userNotifications.find(n => n.id === doc.id) && !clearedIds.includes(doc.id)) {
                        userNotifications.push({ id: doc.id, ...doc.data() });
                    }
                });
                
                renderNotificationsList(container);
            } catch(e2) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 50px; margin-bottom: 15px;">❌</div>
                        <div style="color: #888;">Bildirimler yüklenemedi</div>
                        <div style="color: #666; font-size: 12px; margin-top: 10px;">${e2.message}</div>
                    </div>
                `;
            }
        }
    }
    
    // Bildirim listesini render et
    function renderNotificationsList(container) {
        if (userNotifications.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 50px; margin-bottom: 15px;">🔔</div>
                    <div style="color: #888;">Henüz bildirim yok</div>
                </div>
            `;
            return;
        }
        
        const readNotifs = JSON.parse(localStorage.getItem('readNotifications') || '[]');
        
        let html = '';
        userNotifications.forEach(notif => {
            const icons = { 'info': 'ℹ️', 'success': '✅', 'warning': '⚠️', 'promo': '🎁', 'order': '📦' };
            const colors = { 'info': '#2196F3', 'success': '#4CAF50', 'warning': '#FF9800', 'promo': '#E91E63', 'order': '#9C27B0' };
            const icon = icons[notif.type] || '🔔';
            const color = colors[notif.type] || '#2196F3';
            const isRead = readNotifs.includes(notif.id);
            const date = notif.createdAt?.toDate ? notif.createdAt.toDate().toLocaleString('tr-TR') : '';
            
            html += `
                <div style="background: ${isRead ? 'rgba(255,255,255,0.03)' : 'rgba(255,255,255,0.08)'}; border-left: 3px solid ${color}; border-radius: 10px; padding: 15px; margin-bottom: 10px; ${!isRead ? 'box-shadow: 0 2px 10px rgba(0,0,0,0.2);' : ''}">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="font-size: 24px;">${icon}</div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-weight: bold; color: #fff;">${notif.title || 'Bildirim'}</div>
                                ${!isRead ? '<span style="background: #f44336; color: #fff; padding: 2px 6px; border-radius: 8px; font-size: 9px;">YENİ</span>' : ''}
                            </div>
                            <div style="color: #aaa; font-size: 13px; margin-top: 5px;">${notif.message || ''}</div>
                            <div style="color: #666; font-size: 11px; margin-top: 8px;">${date}</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Tüm bildirimleri okundu olarak işaretle
        const allIds = userNotifications.map(n => n.id);
        localStorage.setItem('readNotifications', JSON.stringify([...new Set([...readNotifs, ...allIds])]));
        updateNotificationBadge();
    }
    
    // Tüm bildirimleri temizle
    function clearAllNotifications() {
        if (userNotifications.length === 0) {
            showToast('📭 Temizlenecek bildirim yok');
            return;
        }
        
        // Tüm bildirim ID'lerini "temizlendi" listesine ekle
        const clearedIds = JSON.parse(localStorage.getItem('clearedNotifications') || '[]');
        const allIds = userNotifications.map(n => n.id);
        const newClearedIds = [...new Set([...clearedIds, ...allIds])];
        localStorage.setItem('clearedNotifications', JSON.stringify(newClearedIds));
        
        // Okundu listesine de ekle
        localStorage.setItem('readNotifications', JSON.stringify(newClearedIds));
        
        // Listeyi temizle
        userNotifications = [];
        
        // UI güncelle
        const container = document.getElementById('notificationsList');
        container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 50px; margin-bottom: 15px;">✅</div>
                <div style="color: #4CAF50;">Tüm bildirimler temizlendi!</div>
            </div>
        `;
        
        updateNotificationBadge();
        showToast('✅ Bildirimler temizlendi');
    }
    
    // ============ KURULUM MODALLARI YÖNETİMİ ============
    let setupModals = {}; // Tüm kurulum modalları
    let editingModalSteps = []; // Editor'daki adımlar
    let editingModalId = null; // Düzenlenen modal ID
    
    // Kurulum modallarını Firestore'dan yükle
    async function loadSetupModals() {
        try {
            const doc = await db.collection('settings').doc('setupModals').get();
            if (doc.exists) {
                setupModals = doc.data().modals || {};
            }
            console.log('Kurulum modalları yüklendi:', Object.keys(setupModals).length);
        } catch(e) {
            console.error('Kurulum modalları yüklenemedi:', e);
        }
    }
    
    // =============== UYGULAMA AYARLARI YÖNETİMİ ===============
    let appSettingsData = null;
    
    // GitHub API Ayarları - Token Firestore'dan yüklenir
    const GITHUB_CONFIG = {
        owner: 'bestofexpertopera-bit',
        repo: 'thebestml-updates',
        branch: 'main',
        token: ''
    };
    
    // GitHub token'ı Firestore'dan yükle
    async function loadGithubToken() {
        try {
            const doc = await db.collection('settings').doc('github_config').get();
            if (doc.exists && doc.data().token) {
                GITHUB_CONFIG.token = doc.data().token;
                console.log('✅ GitHub token yüklendi');
            } else {
                // Token yoksa ve owner ise, varsayılan token'ı kaydet
                console.log('⚠️ GitHub token bulunamadı');
            }
        } catch(e) {
            console.log('GitHub token yüklenemedi:', e.message);
        }
    }
    
    // Gizli kurulum fonksiyonu (konsol üzerinden çağrılabilir)
    window.setupGithubToken = async function(token) {
        if (!isOwner()) {
            console.error('❌ Bu işlem sadece owner için!');
            return;
        }
        try {
            await db.collection('settings').doc('github_config').set({
                token: token,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser.email
            });
            GITHUB_CONFIG.token = token;
            console.log('✅ GitHub token kaydedildi!');
        } catch(e) {
            console.error('❌ Hata:', e);
        }
    };
    
    // Varsayılan ayarlar
    const defaultAppSettings = {
        general: {
            appName: 'BestOfShop',
            appSubtitle: 'Oyun Modları & Kurulum Rehberleri',
            logoUrl: '',
            iconUrl: '',
            footerText: '© 2025 BestOfShop. Tüm hakları saklıdır.'
        },
        theme: {
            primaryColor: '#4CAF50',
            secondaryColor: '#2196F3',
            backgroundColor: '#0f0f23',
            cardBackground: '#1a1a2e',
            gradientStart: '#667eea',
            gradientEnd: '#764ba2',
            textColor: '#ffffff',
            accentColor: '#FF9800'
        },
        popup: {
            enabled: false,
            title: '📢 Duyuru',
            message: '',
            buttonText: 'Tamam',
            buttonUrl: '',
            showOnce: true,
            bgColor: '#1a1a2e',
            borderColor: '#4CAF50'
        },
        announcement: {
            enabled: false,
            text: '',
            bgColor: '#FF9800',
            textColor: '#000000',
            link: ''
        },
        maintenance: {
            enabled: false,
            title: '🔧 Bakım Modu',
            message: 'Uygulama şu anda bakımda. Lütfen daha sonra tekrar deneyin.',
            estimatedTime: ''
        },
        texts: {
            homeTitle: 'BestOfShop',
            homeSubtitle: 'Oyun Modları & Kurulum Rehberleri',
            welcomeMessage: 'Hoş Geldiniz!',
            footerText: '© 2025 BestOfShop'
        },
        update: {
            currentVersion: APP_VERSION,
            latestVersion: APP_VERSION,
            changelog: [],
            forceUpdate: false,
            updateUrl: ''
        },
        lastUpdated: null,
        updatedBy: null
    };
    
    // Uygulama ayarlarını yükle
    async function loadAppSettings() {
        try {
            const doc = await db.collection('settings').doc('appConfig').get();
            if (doc.exists) {
                appSettingsData = { ...defaultAppSettings, ...doc.data() };
            } else {
                appSettingsData = { ...defaultAppSettings };
            }
            
            // UI'ı güncelle
            updateAppSettingsUI();
            
            // Ayarları uygula (sadece popup/duyuru/bakım)
            applyAppSettings();
            
            // Orijinal ayarlar bilgisini yükle
            loadOriginalDefaultsInfo();
            
            console.log('✅ Uygulama ayarları yüklendi');
        } catch(e) {
            console.error('❌ Uygulama ayarları yüklenemedi:', e);
            appSettingsData = { ...defaultAppSettings };
        }
    }
    
    // Son güncelleme bilgisini göster
    function updateAppSettingsUI() {
        const container = document.getElementById('appSettingsLastUpdate');
        if (!container || !appSettingsData) return;
        
        if (appSettingsData.lastUpdated) {
            const date = appSettingsData.lastUpdated.toDate ? appSettingsData.lastUpdated.toDate() : new Date(appSettingsData.lastUpdated);
            container.innerHTML = `
                <div>📅 Son Güncelleme: ${date.toLocaleString('tr-TR')}</div>
                <div style="margin-top: 3px;">👤 ${appSettingsData.updatedBy || 'Bilinmiyor'}</div>
            `;
        } else {
            container.innerHTML = 'Henüz ayar kaydedilmemiş';
        }
    }
    
    // Ayarları uygulamaya uygula (sadece popup, duyuru, bakım modu)
    function applyAppSettings() {
        if (!appSettingsData) return;
        
        console.log('🔄 Uygulama ayarları uygulanıyor (popup/duyuru/bakım)...');
        
        // Versiyon gösterimi - HER ZAMAN APP_VERSION kullan
        const displayVersion = APP_VERSION;
        document.querySelectorAll('#currentVersion, #currentVersionBtn, .app-version').forEach(el => {
            el.textContent = displayVersion;
        });
        localStorage.setItem('displayed_version', displayVersion);
        console.log('📱 Görünen versiyon:', displayVersion);
        
        // Popup kontrolü
        if (appSettingsData.popup?.enabled) {
            showStartupPopup();
        }
        
        // Duyuru banner
        if (appSettingsData.announcement?.enabled) {
            showAnnouncementBanner();
        }
        
        // Bakım modu
        if (appSettingsData.maintenance?.enabled) {
            showMaintenanceScreen();
        }
        
        console.log('✅ Uygulama ayarları uygulandı');
    }
    
    // Açılış popup'ı göster
    function showStartupPopup() {
        if (!appSettingsData?.popup?.enabled) return;
        
        const p = appSettingsData.popup;
        const popupKey = 'startup_popup_' + (p.title || '').replace(/\s/g, '_');
        
        // Sadece bir kez göster seçeneği
        if (p.showOnce && localStorage.getItem(popupKey)) {
            return;
        }
        
        const popupHtml = `
            <div id="startupPopupOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 99999; display: flex; align-items: center; justify-content: center; padding: 20px;">
                <div style="background: ${p.bgColor || '#1a1a2e'}; border: 2px solid ${p.borderColor || '#4CAF50'}; border-radius: 20px; padding: 25px; max-width: 350px; text-align: center; animation: popupBounce 0.5s ease;">
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 15px; color: #fff;">${p.title || '📢 Duyuru'}</div>
                    <div style="color: #ccc; font-size: 14px; line-height: 1.6; margin-bottom: 20px; white-space: pre-line;">${p.message || ''}</div>
                    ${p.buttonUrl ? `
                        <a href="${p.buttonUrl}" target="_blank" style="display: inline-block; background: linear-gradient(135deg, ${p.borderColor || '#4CAF50'}, ${p.borderColor || '#45a049'}); color: #fff; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; font-size: 14px; cursor: pointer; text-decoration: none; margin-bottom: 10px;">${p.buttonText || 'Tamam'}</a>
                        <br>
                    ` : ''}
                    <button onclick="closeStartupPopup('${popupKey}')" style="background: ${p.buttonUrl ? 'rgba(255,255,255,0.1)' : `linear-gradient(135deg, ${p.borderColor || '#4CAF50'}, ${p.borderColor || '#45a049'})`}; color: #fff; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; font-size: 14px; cursor: pointer;">
                        ${p.buttonUrl ? 'Kapat' : (p.buttonText || 'Tamam')}
                    </button>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', popupHtml);
    }
    
    function closeStartupPopup(popupKey) {
        const overlay = document.getElementById('startupPopupOverlay');
        if (overlay) overlay.remove();
        if (popupKey) localStorage.setItem(popupKey, 'shown');
    }
    
    // Duyuru banner'ı göster
    function showAnnouncementBanner() {
        if (!appSettingsData?.announcement?.enabled) return;
        
        const a = appSettingsData.announcement;
        const existingBanner = document.getElementById('announcementBanner');
        if (existingBanner) existingBanner.remove();
        
        const bannerHtml = `
            <div id="announcementBanner" style="position: fixed; bottom: 60px; left: 0; right: 0; background: ${a.bgColor || '#FF9800'}; padding: 10px 15px; z-index: 9998; display: flex; align-items: center; justify-content: space-between;">
                <div style="flex: 1; color: ${a.textColor || '#000'}; font-size: 13px; font-weight: 500;">
                    ${a.link ? `<a href="${a.link}" target="_blank" style="color: inherit; text-decoration: underline;">${a.text}</a>` : a.text}
                </div>
                <button onclick="document.getElementById('announcementBanner').remove()" style="background: rgba(0,0,0,0.2); border: none; color: ${a.textColor || '#000'}; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: 10px;">✕</button>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', bannerHtml);
    }
    
    // Bakım ekranı göster
    function showMaintenanceScreen() {
        if (!appSettingsData?.maintenance?.enabled) return;
        
        // Owner veya Admin ise bakım ekranını gösterme
        if (currentUser) {
            const userRole = currentUser.role || localStorage.getItem('userRole');
            if (userRole === 'owner' || userRole === 'admin') {
                console.log('🔧 Bakım modu aktif ama admin/owner olarak devam ediyorsunuz');
                showToast('🔧 Bakım modu aktif - Ekip erişimi ile devam ediyorsunuz');
                return;
            }
        }
        
        const m = appSettingsData.maintenance;
        
        // Bakım ekranını göster - Ekip Girişi butonuyla
        document.body.innerHTML = `
            <div id="maintenanceScreen" style="min-height: 100vh; background: linear-gradient(135deg, #1a1a2e, #16213e); display: flex; align-items: center; justify-content: center; padding: 20px;">
                <div style="text-align: center; max-width: 400px; width: 100%;">
                    <div style="font-size: 80px; margin-bottom: 20px;">🔧</div>
                    <h1 style="color: #fff; margin-bottom: 15px;">${m.title || 'Bakım Modu'}</h1>
                    <p style="color: #aaa; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">${m.message || 'Uygulama şu anda bakımda. Kısa süre içinde tekrar açılacaktır.'}</p>
                    ${m.estimatedTime ? `<div style="background: rgba(255,152,0,0.2); border: 1px solid #FF9800; border-radius: 10px; padding: 15px; color: #FF9800; margin-bottom: 20px;"><span style="font-weight: bold;">⏰ Tahmini Süre:</span> ${m.estimatedTime}</div>` : ''}
                    
                    <!-- Ekip Girişi Bölümü -->
                    <div id="teamLoginSection" style="margin-top: 30px;">
                        <button onclick="showTeamLoginForm()" style="background: rgba(103,58,183,0.2); border: 1px solid #673AB7; color: #673AB7; padding: 12px 25px; border-radius: 10px; font-size: 14px; cursor: pointer;">
                            👥 Ekip Girişi
                        </button>
                    </div>
                    
                    <!-- Ekip Giriş Formu (Gizli) -->
                    <div id="teamLoginForm" style="display: none; margin-top: 20px; background: rgba(103,58,183,0.1); border: 1px solid rgba(103,58,183,0.3); border-radius: 15px; padding: 20px;">
                        <div style="font-size: 16px; font-weight: bold; color: #673AB7; margin-bottom: 15px;">👑 Ekip Girişi</div>
                        <input type="email" id="teamLoginEmail" placeholder="E-posta" style="width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; margin-bottom: 10px; box-sizing: border-box;">
                        <input type="password" id="teamLoginPassword" placeholder="Şifre" style="width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; margin-bottom: 15px; box-sizing: border-box;">
                        <button onclick="attemptTeamLogin()" style="width: 100%; background: linear-gradient(135deg, #673AB7, #512DA8); color: #fff; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                            🔐 Giriş Yap
                        </button>
                        <button onclick="hideTeamLoginForm()" style="width: 100%; background: rgba(255,255,255,0.1); color: #aaa; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                            ← Geri
                        </button>
                        <div id="teamLoginError" style="display: none; color: #f44336; font-size: 13px; margin-top: 10px;"></div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Ekip giriş formunu göster
    function showTeamLoginForm() {
        document.getElementById('teamLoginSection').style.display = 'none';
        document.getElementById('teamLoginForm').style.display = 'block';
    }
    
    // Ekip giriş formunu gizle
    function hideTeamLoginForm() {
        document.getElementById('teamLoginSection').style.display = 'block';
        document.getElementById('teamLoginForm').style.display = 'none';
        document.getElementById('teamLoginError').style.display = 'none';
    }
    
    // Ekip girişi dene
    async function attemptTeamLogin() {
        const email = document.getElementById('teamLoginEmail').value.trim().toLowerCase();
        const password = document.getElementById('teamLoginPassword').value;
        const errorEl = document.getElementById('teamLoginError');
        
        if (!email || !password) {
            errorEl.textContent = '❌ E-posta ve şifre gerekli';
            errorEl.style.display = 'block';
            return;
        }
        
        // Loading göster
        errorEl.textContent = '⏳ Giriş yapılıyor...';
        errorEl.style.display = 'block';
        errorEl.style.color = '#3b82f6';
        
        try {
            // Firebase hazır mı kontrol et
            if (!firebase || !firebase.auth) {
                throw new Error('Firebase henüz yüklenmedi');
            }
            
            // Firebase ile giriş yap
            const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            console.log('Firebase giriş başarılı:', user.email);
            
            // Owner e-posta kontrolü (hardcoded)
            const ownerEmail = 'onurtenk0@gmail.com';
            const isUserOwner = email === ownerEmail;
            
            // Admin listesini Firestore'dan yükle
            let isUserAdmin = false;
            try {
                const adminDoc = await db.collection('settings').doc('admins').get();
                if (adminDoc.exists) {
                    const data = adminDoc.data();
                    const admins = data.adminList || [];
                    const adminEmailList = admins.map(a => a.email.toLowerCase());
                    isUserAdmin = adminEmailList.includes(email);
                    console.log('Admin listesi:', adminEmailList, 'Kullanıcı admin mi:', isUserAdmin);
                }
            } catch(adminErr) {
                console.log('Admin listesi yüklenemedi:', adminErr);
            }
            
            if (isUserOwner || isUserAdmin) {
                // Başarılı - Ekip üyesi
                localStorage.setItem('userRole', isUserOwner ? 'owner' : 'admin');
                errorEl.textContent = '✅ Ekip girişi başarılı! Yönlendiriliyor...';
                errorEl.style.color = '#22c55e';
                
                // Sayfayı yenile
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 800);
            } else {
                // Normal kullanıcı - Bakım ekranı kalsın
                errorEl.textContent = '⚠️ Bu hesap ekip üyesi değil. Bakım bitene kadar bekleyin.';
                errorEl.style.color = '#f59e0b';
                await firebase.auth().signOut();
            }
            
        } catch(e) {
            console.error('Ekip giriş hatası:', e);
            errorEl.style.color = '#ef4444';
            
            let errorMsg = '❌ Giriş başarısız: ' + (e.message || e.code || 'Bilinmeyen hata');
            
            if (e.code === 'auth/user-not-found') errorMsg = '❌ Bu e-posta ile kayıtlı kullanıcı yok';
            else if (e.code === 'auth/wrong-password') errorMsg = '❌ Şifre yanlış';
            else if (e.code === 'auth/invalid-email') errorMsg = '❌ Geçersiz e-posta formatı';
            else if (e.code === 'auth/invalid-credential') errorMsg = '❌ E-posta veya şifre hatalı';
            else if (e.code === 'auth/too-many-requests') errorMsg = '❌ Çok fazla deneme. Biraz bekleyin.';
            else if (e.code === 'auth/network-request-failed') errorMsg = '❌ İnternet bağlantısı yok';
            
            errorEl.textContent = errorMsg;
            errorEl.style.display = 'block';
        }
    }
    
    // Ayarlar modalını aç
    function openAppSettingsModal(category) {
        if (!requirePermission('app_settings', 'uygulama ayarlarını düzenlemek')) return;
        
        const modal = document.getElementById('appSettingsModal');
        const header = document.getElementById('appSettingsModalHeader');
        const title = document.getElementById('appSettingsModalTitle');
        const content = document.getElementById('appSettingsModalContent');
        
        if (!appSettingsData) {
            appSettingsData = { ...defaultAppSettings };
        }
        
        let headerColor = '#607D8B';
        let headerTitle = '⚙️ Ayarlar';
        let bodyHtml = '';
        
        switch(category) {
            case 'popup':
                headerColor = '#FF9800';
                headerTitle = '📢 Popup & Duyuru';
                const p = appSettingsData.popup || defaultAppSettings.popup;
                const a = appSettingsData.announcement || defaultAppSettings.announcement;
                bodyHtml = `
                    <!-- Açılış Popup -->
                    <div style="background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div style="font-size: 14px; font-weight: bold; color: #FF9800;">🎯 Açılış Popup</div>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="settingPopupEnabled" ${p.enabled ? 'checked' : ''} style="width: 18px; height: 18px;">
                                <span style="color: #aaa; font-size: 12px;">Aktif</span>
                            </label>
                        </div>
                        <input type="text" id="settingPopupTitle" class="auth-input" value="${p.title || ''}" placeholder="📢 Duyuru" style="margin-bottom: 8px;">
                        <textarea id="settingPopupMessage" class="auth-input" placeholder="Popup mesajı..." style="height: 60px; resize: none; margin-bottom: 8px;">${p.message || ''}</textarea>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <input type="text" id="settingPopupButtonText" class="auth-input" value="${p.buttonText || ''}" placeholder="Buton metni">
                            <input type="url" id="settingPopupButtonUrl" class="auth-input" value="${p.buttonUrl || ''}" placeholder="Buton URL (opsiyonel)">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <div>
                                <label style="font-size: 10px; color: #888;">Arka Plan</label>
                                <input type="color" id="settingPopupBgColor" value="${p.bgColor || '#1a1a2e'}" style="width: 100%; height: 30px; border: none; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="font-size: 10px; color: #888;">Kenarlık</label>
                                <input type="color" id="settingPopupBorderColor" value="${p.borderColor || '#4CAF50'}" style="width: 100%; height: 30px; border: none; border-radius: 5px;">
                            </div>
                        </div>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="settingPopupShowOnce" ${p.showOnce ? 'checked' : ''}>
                            <span style="color: #aaa; font-size: 12px;">Sadece bir kez göster</span>
                        </label>
                    </div>
                    
                    <!-- Duyuru Banner -->
                    <div style="background: rgba(0,188,212,0.1); border: 1px solid rgba(0,188,212,0.3); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div style="font-size: 14px; font-weight: bold; color: #00BCD4;">📣 Duyuru Banner</div>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="settingAnnouncementEnabled" ${a.enabled ? 'checked' : ''} style="width: 18px; height: 18px;">
                                <span style="color: #aaa; font-size: 12px;">Aktif</span>
                            </label>
                        </div>
                        <input type="text" id="settingAnnouncementText" class="auth-input" value="${a.text || ''}" placeholder="Duyuru metni..." style="margin-bottom: 8px;">
                        <input type="url" id="settingAnnouncementLink" class="auth-input" value="${a.link || ''}" placeholder="Link (opsiyonel)" style="margin-bottom: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div>
                                <label style="font-size: 10px; color: #888;">Arka Plan</label>
                                <input type="color" id="settingAnnouncementBgColor" value="${a.bgColor || '#FF9800'}" style="width: 100%; height: 30px; border: none; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="font-size: 10px; color: #888;">Metin Rengi</label>
                                <input type="color" id="settingAnnouncementTextColor" value="${a.textColor || '#000000'}" style="width: 100%; height: 30px; border: none; border-radius: 5px;">
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="saveAppSettings('popup')" class="btn btn-primary" style="width: 100%;">💾 Kaydet</button>
                `;
                break;
                
            case 'maintenance':
                headerColor = '#f44336';
                headerTitle = '🔧 Bakım Modu';
                const m = appSettingsData.maintenance || defaultAppSettings.maintenance;
                bodyHtml = `
                    <div style="background: rgba(244,67,54,0.1); border: 1px solid rgba(244,67,54,0.3); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <div style="font-size: 16px; font-weight: bold; color: #f44336;">⚠️ Bakım Modu</div>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="settingMaintenanceEnabled" ${m.enabled ? 'checked' : ''} style="width: 22px; height: 22px;">
                                <span style="color: ${m.enabled ? '#f44336' : '#aaa'}; font-size: 14px; font-weight: bold;">${m.enabled ? 'AKTİF' : 'Pasif'}</span>
                            </label>
                        </div>
                        
                        ${m.enabled ? `
                            <div style="background: #f44336; color: #fff; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px; animation: pulse 2s infinite;">
                                🚨 BAKIM MODU ŞU AN AKTİF! Kullanıcılar uygulamayı kullanamıyor.
                            </div>
                        ` : ''}
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 5px;">Başlık</label>
                            <input type="text" id="settingMaintenanceTitle" class="auth-input" value="${m.title || ''}" placeholder="🔧 Bakım Modu">
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 5px;">Mesaj</label>
                            <textarea id="settingMaintenanceMessage" class="auth-input" placeholder="Uygulama şu anda bakımda..." style="height: 80px; resize: none;">${m.message || ''}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 5px;">Tahmini Süre (Opsiyonel)</label>
                            <input type="text" id="settingMaintenanceTime" class="auth-input" value="${m.estimatedTime || ''}" placeholder="Örn: 2 saat, 30 dakika">
                        </div>
                    </div>
                    
                    <button onclick="saveAppSettings('maintenance')" class="btn btn-danger" style="width: 100%;">
                        ${m.enabled ? '🔓 Bakım Modunu Kapat' : '🔒 Bakım Modunu Aç'}
                    </button>
                    
                    <div style="margin-top: 15px; padding: 12px; background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 8px;">
                        <div style="font-size: 12px; color: #FF9800; font-weight: bold; margin-bottom: 5px;">⚠️ Dikkat</div>
                        <div style="font-size: 11px; color: #888; line-height: 1.5;">
                            Bakım modu aktif olduğunda TÜM kullanıcılar (adminler dahil) uygulamayı kullanamazlar. Sadece bu ekranı görebilirler.
                        </div>
                    </div>
                `;
                break;
        }
        
        header.style.background = `linear-gradient(135deg, ${headerColor}, ${adjustColor(headerColor, -20)})`;
        title.textContent = headerTitle;
        content.innerHTML = bodyHtml;
        
        openModal('appSettingsModal');
    }
    
    // Renk ayarlama yardımcı fonksiyonu
    function adjustColor(color, amount) {
        const hex = color.replace('#', '');
        const r = Math.max(0, Math.min(255, parseInt(hex.substr(0, 2), 16) + amount));
        const g = Math.max(0, Math.min(255, parseInt(hex.substr(2, 2), 16) + amount));
        const b = Math.max(0, Math.min(255, parseInt(hex.substr(4, 2), 16) + amount));
        return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
    }
    
    // ========== FABRİKA AYARLARI FONKSİYONLARI ==========
    
    // Mevcut ayarları yedekle
    async function backupCurrentSettings() {
        if (!requirePermission('app_settings', 'ayarları yedeklemek')) return;
        
        try {
            showToast('⏳ Ayarlar yedekleniyor...');
            
            // Mevcut ayarları al
            const currentSettings = { ...appSettingsData };
            currentSettings.backupDate = firebase.firestore.FieldValue.serverTimestamp();
            currentSettings.backupBy = currentUser ? currentUser.email : 'Bilinmiyor';
            
            // Yedek olarak kaydet
            await db.collection('settings').doc('appConfig_backup').set(currentSettings);
            
            showToast('✅ Ayarlar yedeklendi!');
            console.log('✅ Ayarlar yedeklendi:', currentSettings);
        } catch(e) {
            console.error('❌ Yedekleme hatası:', e);
            showToast('❌ Yedekleme başarısız: ' + e.message);
        }
    }
    
    // Fabrika ayarlarına dönüş onay ekranı
    function showFactoryResetConfirm() {
        if (!requirePermission('app_settings', 'fabrika ayarlarına dönmek')) return;
        
        const modal = document.createElement('div');
        modal.id = 'factoryResetModal';
        modal.className = 'modal-overlay';
        modal.style.cssText = 'display: flex; z-index: 10001;';
        modal.innerHTML = `
            <div class="modal" style="max-width: 400px;" onclick="event.stopPropagation()">
                <div class="modal-header" style="background: linear-gradient(135deg, #f44336, #c62828);">
                    <div class="modal-title">🏭 Fabrika Ayarlarına Dön</div>
                    <button class="modal-close" onclick="closeFactoryResetModal()">✕</button>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <span style="font-size: 60px;">⚠️</span>
                    </div>
                    
                    <div style="background: rgba(244,67,54,0.2); border: 1px solid #f44336; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                        <strong style="color: #ff5252;">DİKKAT!</strong>
                        <p style="margin: 10px 0 0 0; font-size: 13px; color: #ffcdd2;">
                            Bu işlem geri alınamaz! Tüm uygulama ayarları (tema, renkler, logo, metinler, popup) varsayılan değerlere dönecektir.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="resetType" value="default" checked style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: bold;">🔄 Varsayılan Ayarlara Dön</div>
                                <div style="font-size: 11px; color: #aaa;">Kod içindeki varsayılan değerleri kullan</div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="resetType" value="backup" style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: bold;">📦 Yedekten Geri Yükle</div>
                                <div style="font-size: 11px; color: #aaa;">Son yedeklenen ayarları kullan</div>
                            </div>
                        </label>
                    </div>
                    
                    <div id="backupInfo" style="background: rgba(33,150,243,0.2); border-radius: 8px; padding: 10px; font-size: 12px; color: #90caf9; margin-bottom: 15px; display: none;">
                        Yedek bilgisi yükleniyor...
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="closeFactoryResetModal()" style="flex: 1; padding: 12px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: #fff; border-radius: 8px; cursor: pointer;">İptal</button>
                        <button onclick="executeFactoryReset()" style="flex: 1; padding: 12px; border: none; background: linear-gradient(135deg, #f44336, #c62828); color: #fff; border-radius: 8px; cursor: pointer; font-weight: bold;">Sıfırla</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.onclick = (e) => { if (e.target === modal) closeFactoryResetModal(); };
        
        // Yedek bilgisini yükle
        loadBackupInfo();
        
        // Radio değişikliğinde yedek bilgisini göster/gizle
        document.querySelectorAll('input[name="resetType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('backupInfo').style.display = this.value === 'backup' ? 'block' : 'none';
            });
        });
    }
    
    // Yedek bilgisini yükle
    async function loadBackupInfo() {
        try {
            const doc = await db.collection('settings').doc('appConfig_backup').get();
            const infoEl = document.getElementById('backupInfo');
            
            if (doc.exists) {
                const data = doc.data();
                const date = data.backupDate ? (data.backupDate.toDate ? data.backupDate.toDate() : new Date(data.backupDate)) : null;
                infoEl.innerHTML = `
                    <div>📅 Yedek Tarihi: ${date ? date.toLocaleString('tr-TR') : 'Bilinmiyor'}</div>
                    <div>👤 Yedekleyen: ${data.backupBy || 'Bilinmiyor'}</div>
                `;
            } else {
                infoEl.innerHTML = '⚠️ Henüz yedek alınmamış';
                infoEl.style.background = 'rgba(255,152,0,0.2)';
                infoEl.style.color = '#ffcc80';
            }
        } catch(e) {
            console.error('Yedek bilgisi yüklenemedi:', e);
        }
    }
    
    // Fabrika ayarlarına dönüş modalını kapat
    function closeFactoryResetModal() {
        const modal = document.getElementById('factoryResetModal');
        if (modal) modal.remove();
    }
    
    // Fabrika ayarlarına dönüşü uygula
    async function executeFactoryReset() {
        const resetType = document.querySelector('input[name="resetType"]:checked').value;
        
        try {
            showToast('⏳ Ayarlar sıfırlanıyor...');
            
            let newSettings;
            
            if (resetType === 'backup') {
                // Yedekten geri yükle
                const backupDoc = await db.collection('settings').doc('appConfig_backup').get();
                if (!backupDoc.exists) {
                    showToast('❌ Yedek bulunamadı!');
                    return;
                }
                newSettings = backupDoc.data();
                delete newSettings.backupDate;
                delete newSettings.backupBy;
            } else {
                // Varsayılan ayarlara dön
                newSettings = JSON.parse(JSON.stringify(defaultAppSettings));
            }
            
            // Meta bilgileri ekle
            newSettings.lastUpdated = firebase.firestore.FieldValue.serverTimestamp();
            newSettings.updatedBy = currentUser ? currentUser.email : 'Sistem';
            newSettings.resetType = resetType;
            newSettings.resetDate = firebase.firestore.FieldValue.serverTimestamp();
            
            // Firestore'a kaydet
            await db.collection('settings').doc('appConfig').set(newSettings);
            
            // Local değişkeni güncelle
            appSettingsData = newSettings;
            
            // Tema CSS'ini temizle
            const dynamicStyle = document.getElementById('dynamic-theme-css');
            if (dynamicStyle) dynamicStyle.remove();
            
            // Ayarları uygula
            applyAppSettings();
            updateAppSettingsUI();
            
            closeFactoryResetModal();
            
            showToast('✅ Fabrika ayarlarına dönüldü!');
            
            // Sayfayı yenile
            setTimeout(() => {
                showToast('🔄 Sayfa yenileniyor...');
                setTimeout(() => window.location.href = 'index.html', 500);
            }, 1000);
            
        } catch(e) {
            console.error('❌ Sıfırlama hatası:', e);
            showToast('❌ Sıfırlama başarısız: ' + e.message);
        }
    }
    
    // Orijinal varsayılan ayarları Firestore'a yükle (VS Code'daki defaultAppSettings)
    async function uploadOriginalDefaults() {
        if (!requirePermission('app_settings', 'orijinal ayarları yüklemek')) return;
        
        // Onay iste
        if (!confirm('⚠️ DİKKAT!\n\nBu işlem kod içindeki varsayılan ayarları Firestore\'a "orijinal ayarlar" olarak kaydedecek.\n\nDevam etmek istiyor musunuz?')) {
            return;
        }
        
        try {
            showToast('⏳ Orijinal ayarlar yükleniyor...');
            
            // defaultAppSettings'i kopyala
            const originalSettings = JSON.parse(JSON.stringify(defaultAppSettings));
            
            // Meta bilgileri ekle
            originalSettings.uploadedAt = firebase.firestore.FieldValue.serverTimestamp();
            originalSettings.uploadedBy = currentUser ? currentUser.email : 'Sistem';
            originalSettings.appVersion = APP_VERSION;
            originalSettings.description = 'VS Code varsayılan ayarları - Orijinal fabrika ayarları';
            
            // Firestore'a kaydet
            await db.collection('settings').doc('original_defaults').set(originalSettings);
            
            showToast('✅ Orijinal ayarlar Firestore\'a yüklendi!');
            console.log('✅ Orijinal ayarlar kaydedildi:', originalSettings);
            
            // Bilgi panelini güncelle
            loadOriginalDefaultsInfo();
            
        } catch(e) {
            console.error('❌ Yükleme hatası:', e);
            showToast('❌ Yükleme başarısız: ' + e.message);
        }
    }
    
    // Firestore'daki orijinal ayarları geri yükle
    async function loadOriginalDefaults() {
        if (!requirePermission('app_settings', 'orijinal ayarları geri yüklemek')) return;
        
        try {
            // Önce orijinal ayarların var olup olmadığını kontrol et
            const doc = await db.collection('settings').doc('original_defaults').get();
            
            if (!doc.exists) {
                showToast('⚠️ Firestore\'da orijinal ayarlar bulunamadı!\n\nÖnce "Orijinal Ayarları Firestore\'a Yükle" butonunu kullanın.');
                return;
            }
            
            // Onay iste
            if (!confirm('⚠️ DİKKAT!\n\nBu işlem tüm mevcut ayarları Firestore\'daki orijinal ayarlarla değiştirecek.\n\nTema, renkler, metinler ve tüm özelleştirmeler sıfırlanacak!\n\nDevam etmek istiyor musunuz?')) {
                return;
            }
            
            showToast('⏳ Orijinal ayarlar geri yükleniyor...');
            
            // Orijinal ayarları al
            const originalData = doc.data();
            
            // Meta bilgileri temizle
            delete originalData.uploadedAt;
            delete originalData.uploadedBy;
            delete originalData.appVersion;
            delete originalData.description;
            
            // Yeni meta bilgileri ekle
            originalData.lastUpdated = firebase.firestore.FieldValue.serverTimestamp();
            originalData.updatedBy = currentUser ? currentUser.email : 'Sistem';
            originalData.restoredFromOriginal = true;
            originalData.restoreDate = firebase.firestore.FieldValue.serverTimestamp();
            
            // Firestore'a kaydet
            await db.collection('settings').doc('appConfig').set(originalData);
            
            // Local değişkeni güncelle
            appSettingsData = originalData;
            
            // Tema CSS'ini temizle
            const dynamicStyle = document.getElementById('dynamic-theme-css');
            if (dynamicStyle) dynamicStyle.remove();
            
            // Ayarları uygula
            applyAppSettings();
            updateAppSettingsUI();
            
            showToast('✅ Orijinal ayarlar geri yüklendi!');
            
            // Sayfayı yenile
            setTimeout(() => {
                showToast('🔄 Sayfa yenileniyor...');
                setTimeout(() => window.location.href = 'index.html', 500);
            }, 1000);
            
        } catch(e) {
            console.error('❌ Geri yükleme hatası:', e);
            showToast('❌ Geri yükleme başarısız: ' + e.message);
        }
    }
    
    // Orijinal ayarlar bilgisini yükle ve göster
    async function loadOriginalDefaultsInfo() {
        const infoEl = document.getElementById('originalDefaultsInfo');
        if (!infoEl) return;
        
        try {
            const doc = await db.collection('settings').doc('original_defaults').get();
            
            if (doc.exists) {
                const data = doc.data();
                const date = data.uploadedAt ? (data.uploadedAt.toDate ? data.uploadedAt.toDate() : new Date(data.uploadedAt)) : null;
                
                infoEl.style.display = 'block';
                infoEl.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">📦 Firestore'daki Orijinal Ayarlar:</div>
                    <div>📅 Yüklenme: ${date ? date.toLocaleString('tr-TR') : 'Bilinmiyor'}</div>
                    <div>👤 Yükleyen: ${data.uploadedBy || 'Bilinmiyor'}</div>
                    <div>📱 Versiyon: ${data.appVersion || 'Bilinmiyor'}</div>
                `;
            } else {
                infoEl.style.display = 'block';
                infoEl.style.background = 'rgba(255,152,0,0.2)';
                infoEl.style.color = '#ffcc80';
                infoEl.innerHTML = '⚠️ Henüz orijinal ayarlar Firestore\'a yüklenmemiş. Önce "Orijinal Ayarları Firestore\'a Yükle" butonunu kullanın.';
            }
        } catch(e) {
            console.error('Orijinal ayarlar bilgisi yüklenemedi:', e);
        }
    }
    
    // ========== FABRİKA AYARLARI SONU ==========
    
    // ========== GITHUB API FONKSİYONLARI ==========
    
    // GitHub token input'unu göster/gizle
    function toggleGithubTokenInput() {
        const section = document.getElementById('githubTokenSection');
        if (section) {
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }
    }
    
    // GitHub token'ı kaydet (Firestore'a)
    async function saveGithubToken() {
        const token = document.getElementById('githubTokenInput').value.trim();
        if (!token) {
            showToast('❌ Token boş olamaz');
            return;
        }
        
        try {
            // Firestore'a kaydet
            await db.collection('settings').doc('github_config').set({
                token: token,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser ? currentUser.email : 'Sistem'
            });
            
            GITHUB_CONFIG.token = token;
            showToast('✅ GitHub token Firestore\'a kaydedildi');
            closeModal('appSettingsModal');
            setTimeout(() => openAppSettingsModal('update'), 300);
        } catch(e) {
            console.error('Token kaydetme hatası:', e);
            showToast('❌ Token kaydedilemedi: ' + e.message);
        }
    }
    
    // GitHub'daki mevcut manifest.json'u al
    async function fetchCurrentManifest() {
        try {
            const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/manifest.json?t=${Date.now()}`;
            const res = await fetch(url, { cache: 'no-store' });
            const manifest = await res.json();
            
            const versionDisplay = document.getElementById('publishedVersionDisplay');
            if (versionDisplay) {
                versionDisplay.textContent = manifest.version || 'Bilinmiyor';
            }
            
            // Build number otomatik artır
            const buildInput = document.getElementById('settingBuildNumber');
            if (buildInput) {
                buildInput.value = (manifest.buildNumber || 0) + 1;
            }
            
            // Versiyon otomatik artır
            const versionInput = document.getElementById('settingNewVersion');
            if (versionInput && !versionInput.value) {
                versionInput.value = incrementVersion(manifest.version || APP_VERSION);
            }
            
            return manifest;
        } catch(e) {
            console.error('Manifest yüklenemedi:', e);
            const versionDisplay = document.getElementById('publishedVersionDisplay');
            if (versionDisplay) {
                versionDisplay.textContent = 'Yüklenemedi';
            }
            return null;
        }
    }
    
    // GitHub dosyasının SHA'sını al
    async function getGithubFileSha(filePath) {
        try {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}?ref=${GITHUB_CONFIG.branch}`;
            const res = await fetch(url, {
                headers: {
                    'Authorization': `token ${GITHUB_CONFIG.token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            if (res.ok) {
                const data = await res.json();
                return data.sha;
            }
            return null;
        } catch(e) {
            console.error('SHA alınamadı:', e);
            return null;
        }
    }
    
    // GitHub'a dosya yükle/güncelle
    async function updateGithubFile(filePath, content, commitMessage) {
        try {
            const sha = await getGithubFileSha(filePath);
            
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
            
            const body = {
                message: commitMessage,
                content: btoa(unescape(encodeURIComponent(content))), // Base64 encode
                branch: GITHUB_CONFIG.branch
            };
            
            if (sha) {
                body.sha = sha;
            }
            
            const res = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_CONFIG.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.message || 'GitHub API hatası');
            }
            
            return await res.json();
        } catch(e) {
            console.error('GitHub dosya güncelleme hatası:', e);
            throw e;
        }
    }
    
    // GitHub'a güncelleme yayınla
    async function publishUpdateToGithub() {
        if (!requirePermission('app_settings', 'güncelleme yayınlamak')) return;
        
        // Token kontrolü
        if (!GITHUB_CONFIG.token) {
            showToast('❌ Önce GitHub token girmelisiniz!');
            toggleGithubTokenInput();
            return;
        }
        
        const newVersion = document.getElementById('settingNewVersion').value.trim();
        let buildNumber = parseInt(document.getElementById('settingBuildNumber').value) || 0;
        const changelog = document.getElementById('settingChangelog').value.trim().split('\n').filter(l => l.trim());
        const forceUpdate = document.getElementById('settingForceUpdate').checked;
        
        if (!newVersion) {
            showToast('❌ Versiyon numarası girilmeli');
            return;
        }
        
        // Build number yoksa manifest'ten al ve artır
        if (!buildNumber) {
            try {
                const manifest = await fetchCurrentManifest();
                buildNumber = (manifest?.buildNumber || 210) + 1;
            } catch(e) {
                buildNumber = 213; // Fallback
            }
        }
        
        // Onay iste
        if (!confirm(`🚀 GÜNCELLEME YAYINLA\n\nVersiyon: ${newVersion}\nBuild: ${buildNumber}\n\nBu güncelleme TÜM kullanıcılara gönderilecek.\n\nDevam etmek istiyor musunuz?`)) {
            return;
        }
        
        try {
            showToast('⏳ GitHub\'a yükleniyor...');
            
            // manifest.json içeriği
            const manifestContent = JSON.stringify({
                version: newVersion,
                buildNumber: buildNumber,
                minBuildNumber: 150,
                releaseDate: new Date().toISOString().split('T')[0],
                changelog: changelog,
                required: forceUpdate
            }, null, 4);
            
            // manifest.json'u güncelle
            await updateGithubFile('manifest.json', manifestContent, `v${newVersion}: Güncelleme yayınlandı`);
            
            showToast('🎉 Güncelleme başarıyla yayınlandı: v' + newVersion);
            
            // NOT: Artık Firestore'a yazmıyoruz - sadece GitHub manifest kullanılıyor
            // Bu sayede versiyon karmaşası önleniyor
            
            // Versiyonu güncelle
            const versionDisplay = document.getElementById('publishedVersionDisplay');
            if (versionDisplay) {
                versionDisplay.textContent = newVersion;
            }
            
            // Modalı kapat
            setTimeout(() => closeModal('appSettingsModal'), 1500);
            
        } catch(e) {
            console.error('❌ Güncelleme yayınlama hatası:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // ========== GITHUB API SONU ==========
    
    // Ayarları kaydet
    async function saveAppSettings(category) {
        if (!requirePermission('app_settings', 'uygulama ayarlarını kaydetmek')) return;
        
        try {
            if (!appSettingsData) appSettingsData = { ...defaultAppSettings };
            
            switch(category) {
                case 'popup':
                    appSettingsData.popup = {
                        enabled: document.getElementById('settingPopupEnabled').checked,
                        title: document.getElementById('settingPopupTitle').value.trim(),
                        message: document.getElementById('settingPopupMessage').value.trim(),
                        buttonText: document.getElementById('settingPopupButtonText').value.trim(),
                        buttonUrl: document.getElementById('settingPopupButtonUrl').value.trim(),
                        bgColor: document.getElementById('settingPopupBgColor').value,
                        borderColor: document.getElementById('settingPopupBorderColor').value,
                        showOnce: document.getElementById('settingPopupShowOnce').checked
                    };
                    appSettingsData.announcement = {
                        enabled: document.getElementById('settingAnnouncementEnabled').checked,
                        text: document.getElementById('settingAnnouncementText').value.trim(),
                        link: document.getElementById('settingAnnouncementLink').value.trim(),
                        bgColor: document.getElementById('settingAnnouncementBgColor').value,
                        textColor: document.getElementById('settingAnnouncementTextColor').value
                    };
                    break;
                    
                case 'maintenance':
                    const wasEnabled = appSettingsData.maintenance?.enabled;
                    const isEnabled = document.getElementById('settingMaintenanceEnabled').checked;
                    
                    appSettingsData.maintenance = {
                        enabled: isEnabled,
                        title: document.getElementById('settingMaintenanceTitle').value.trim(),
                        message: document.getElementById('settingMaintenanceMessage').value.trim(),
                        estimatedTime: document.getElementById('settingMaintenanceTime').value.trim()
                    };
                    
                    if (isEnabled && !wasEnabled) {
                        showToast('🔒 Bakım modu AKTİF edildi!');
                    } else if (!isEnabled && wasEnabled) {
                        showToast('🔓 Bakım modu kapatıldı');
                    }
                    break;
            }
            
            // Güncelleme bilgisi ekle
            appSettingsData.lastUpdated = firebase.firestore.FieldValue.serverTimestamp();
            appSettingsData.updatedBy = currentUser?.email || 'Unknown';
            
            // Firestore'a kaydet
            await db.collection('settings').doc('appConfig').set(appSettingsData, { merge: true });
            
            // Ayarları uygula
            applyAppSettings();
            updateAppSettingsUI();
            
            if (category !== 'update' && category !== 'maintenance') {
                showToast('✅ Ayarlar kaydedildi!');
            }
            
            closeModal('appSettingsModal');
            
        } catch(e) {
            console.error('Ayar kaydetme hatası:', e);
            showToast('❌ Kaydetme hatası: ' + e.message);
        }
    }
    
    // Versiyon numarasını artır
    function incrementVersion(version) {
        const parts = version.split('.');
        if (parts.length >= 3) {
            parts[2] = (parseInt(parts[2]) + 1).toString();
        }
        return parts.join('.');
    }
    
    // Güncelleme bildirimini test et (önizleme)
    function testUpdateNotification() {
        const version = document.getElementById('settingNewVersion').value.trim() || incrementVersion(APP_VERSION);
        const changelog = document.getElementById('settingChangelog').value.trim().split('\n').filter(l => l.trim());
        
        showUpdateNotification({
            version: version,
            changelog: changelog.length > 0 ? changelog : ['Test bildirimi']
        });
        
        closeModal('appSettingsModal');
        showToast('👁️ Güncelleme bildirimi önizlemesi gösterildi');
    }
    
    // Güncelleme bildirimini kaldır
    async function clearUpdateNotification() {
        // NOT: Güncelleme sistemi artık sadece GitHub manifest kullanıyor
        // Bildirimi kaldırmak için GitHub'daki manifest.json'u güncellemeniz gerekiyor
        showToast('ℹ️ Güncelleme bildirimi GitHub manifest.json üzerinden yönetiliyor', 4000);
        closeModal('appSettingsModal');
    }
    
    // Kurulum modalları listesini göster
    async function loadSetupModalsList() {
        await loadSetupModals();
        
        const container = document.getElementById('setupModalsList');
        if (!container) return;
        
        if (Object.keys(setupModals).length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #888;">
                    <div style="font-size: 30px; margin-bottom: 10px;">📖</div>
                    <div>Henüz kurulum modalı oluşturulmadı</div>
                    <div style="font-size: 11px; margin-top: 5px;">➕ Yeni Modal butonuna tıklayarak oluşturun</div>
                </div>
            `;
            return;
        }
        
        let html = '';
        Object.entries(setupModals).forEach(([id, modal]) => {
            const stepCount = modal.steps?.length || 0;
            html += `
                <div style="background: rgba(103,58,183,0.15); border: 1px solid rgba(103,58,183,0.3); border-radius: 10px; padding: 12px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-size: 14px; font-weight: bold; color: #fff;">${modal.title || id}</div>
                            <div style="font-size: 11px; color: #888; margin-top: 3px;">
                                <span style="background: rgba(103,58,183,0.3); padding: 2px 6px; border-radius: 4px; margin-right: 5px;">${id}</span>
                                <span>${stepCount} adım</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="previewSavedModal('${id}')" style="background: #2196F3; border: none; color: #fff; padding: 5px 8px; border-radius: 6px; cursor: pointer; font-size: 11px;">👁️</button>
                            <button onclick="editSetupModal('${id}')" style="background: #FF9800; border: none; color: #fff; padding: 5px 8px; border-radius: 6px; cursor: pointer; font-size: 11px;">✏️</button>
                            <button onclick="deleteSetupModal('${id}')" style="background: #f44336; border: none; color: #fff; padding: 5px 8px; border-radius: 6px; cursor: pointer; font-size: 11px;">🗑️</button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // Kurulum modal editörünü aç
    function openSetupModalEditor(modalId = null) {
        editingModalId = modalId;
        editingModalSteps = [];
        
        // Form alanlarını temizle
        document.getElementById('setupModalId').value = '';
        document.getElementById('setupModalTitle').value = '';
        document.getElementById('setupModalIntroVideo').value = '';
        document.getElementById('setupModalApkLabel').value = '';
        document.getElementById('setupModalApkUrl').value = '';
        document.getElementById('setupModalCompatibility').value = '';
        document.getElementById('setupModalGuideTitle').value = '';
        document.getElementById('setupModalGuideVideo').value = '';
        document.getElementById('setupModalGuideDesc').value = '';
        document.getElementById('setupModalWarnings').value = '';
        document.getElementById('setupModalSuccessTitle').value = 'Kurulum Tamamlandı!';
        document.getElementById('setupModalSuccessDesc').value = 'Artık hileyi kullanabilirsiniz.';
        
        if (modalId && setupModals[modalId]) {
            // Düzenleme modu
            const modal = setupModals[modalId];
            document.getElementById('setupModalEditorTitle').textContent = '✏️ Modal Düzenle: ' + modalId;
            document.getElementById('setupModalId').value = modalId;
            document.getElementById('setupModalId').disabled = true;
            document.getElementById('setupModalTitle').value = modal.title || '';
            document.getElementById('setupModalIntroVideo').value = modal.introVideo || '';
            document.getElementById('setupModalApkLabel').value = modal.apkButton?.label || '';
            document.getElementById('setupModalApkUrl').value = modal.apkButton?.url || '';
            document.getElementById('setupModalCompatibility').value = (modal.compatibility || []).join('\\n');
            document.getElementById('setupModalGuideTitle').value = modal.guideSection?.title || '';
            document.getElementById('setupModalGuideVideo').value = modal.guideSection?.video || '';
            document.getElementById('setupModalGuideDesc').value = modal.guideSection?.description || '';
            document.getElementById('setupModalWarnings').value = (modal.warnings || []).join('\\n');
            document.getElementById('setupModalSuccessTitle').value = modal.successMessage?.title || 'Kurulum Tamamlandı!';
            document.getElementById('setupModalSuccessDesc').value = modal.successMessage?.description || '';
            editingModalSteps = [...(modal.steps || [])];
        } else {
            // Yeni modal
            document.getElementById('setupModalEditorTitle').textContent = '📖 Yeni Kurulum Modalı';
            document.getElementById('setupModalId').disabled = false;
        }
        
        renderSetupModalSteps();
        openModal('setupModalEditorModal');
    }
    
    // Modal düzenleme
    function editSetupModal(modalId) {
        openSetupModalEditor(modalId);
    }
    
    // Adımları render et
    function renderSetupModalSteps() {
        const container = document.getElementById('setupModalStepsList');
        if (!container) return;
        
        if (editingModalSteps.length === 0) {
            container.innerHTML = `<div style="text-align: center; padding: 15px; color: #888; font-size: 12px;">Henüz adım eklenmedi</div>`;
            return;
        }
        
        let html = '';
        editingModalSteps.forEach((step, index) => {
            const colors = ['#2196F3', '#FF9800', '#9C27B0', '#00BCD4', '#E91E63', '#4CAF50', '#FF5722', '#607D8B'];
            const color = colors[index % colors.length];
            
            html += `
                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <div style="background: ${color}; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0;">${index + 1}</div>
                        <input type="text" value="${step.title || ''}" onchange="updateModalStep(${index}, 'title', this.value)" class="auth-input" placeholder="Adım başlığı" style="flex: 1; margin: 0; padding: 6px 10px; font-size: 12px;">
                        <button onclick="removeModalStep(${index})" style="background: #f44336; border: none; color: #fff; width: 24px; height: 24px; border-radius: 6px; cursor: pointer; font-size: 10px;">✕</button>
                    </div>
                    <textarea onchange="updateModalStep(${index}, 'description', this.value)" class="auth-input" placeholder="Adım açıklaması" style="margin: 0; padding: 6px 10px; font-size: 11px; height: 50px; resize: none;">${step.description || ''}</textarea>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <button onclick="moveModalStep(${index}, -1)" style="background: rgba(255,255,255,0.1); border: none; color: #aaa; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;" ${index === 0 ? 'disabled' : ''}>⬆️</button>
                        <button onclick="moveModalStep(${index}, 1)" style="background: rgba(255,255,255,0.1); border: none; color: #aaa; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;" ${index === editingModalSteps.length - 1 ? 'disabled' : ''}>⬇️</button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // Adım ekle
    function addSetupModalStep() {
        editingModalSteps.push({
            title: '',
            description: ''
        });
        renderSetupModalSteps();
    }
    
    // Modal Adım güncelle
    function updateModalStep(index, field, value) {
        if (editingModalSteps[index]) {
            editingModalSteps[index][field] = value;
        }
    }
    
    // Modal Adım sil
    function removeModalStep(index) {
        editingModalSteps.splice(index, 1);
        renderSetupModalSteps();
    }
    
    // Modal Adım taşı
    function moveModalStep(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= editingModalSteps.length) return;
        
        const temp = editingModalSteps[index];
        editingModalSteps[index] = editingModalSteps[newIndex];
        editingModalSteps[newIndex] = temp;
        renderSetupModalSteps();
    }
    
    // Modal kaydet
    async function saveSetupModal() {
        if (!requirePermission('modals', 'kurulum modalı kaydetmek')) return;
        
        const id = document.getElementById('setupModalId').value.trim();
        const title = document.getElementById('setupModalTitle').value.trim();
        
        if (!id) {
            showToast('❌ Modal ID girilmeli');
            return;
        }
        
        if (!title) {
            showToast('❌ Modal başlığı girilmeli');
            return;
        }
        
        // ID formatı kontrol
        if (!/^[a-zA-Z0-9_-]+$/.test(id)) {
            showToast('❌ Modal ID sadece harf, rakam, - ve _ içerebilir');
            return;
        }
        
        // Modal verisini hazırla
        const modalData = {
            title: title,
            introVideo: document.getElementById('setupModalIntroVideo').value.trim() || null,
            apkButton: {
                label: document.getElementById('setupModalApkLabel').value.trim() || null,
                url: document.getElementById('setupModalApkUrl').value.trim() || null
            },
            compatibility: document.getElementById('setupModalCompatibility').value.trim().split('\\n').filter(s => s.trim()),
            guideSection: {
                title: document.getElementById('setupModalGuideTitle').value.trim() || null,
                video: document.getElementById('setupModalGuideVideo').value.trim() || null,
                description: document.getElementById('setupModalGuideDesc').value.trim() || null
            },
            steps: editingModalSteps.filter(s => s.title?.trim()),
            warnings: document.getElementById('setupModalWarnings').value.trim().split('\\n').filter(s => s.trim()),
            successMessage: {
                title: document.getElementById('setupModalSuccessTitle').value.trim() || 'Kurulum Tamamlandı!',
                description: document.getElementById('setupModalSuccessDesc').value.trim() || ''
            },
            updatedAt: new Date().toISOString(),
            updatedBy: currentUser?.email
        };
        
        try {
            // Firestore'a kaydet
            setupModals[id] = modalData;
            await db.collection('settings').doc('setupModals').set({
                modals: setupModals,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('✅ Kurulum modalı kaydedildi!');
            closeModal('setupModalEditorModal');
            loadSetupModalsList();
        } catch(e) {
            console.error('Modal kaydetme hatası:', e);
            showToast('❌ Kaydetme hatası: ' + e.message);
        }
    }
    
    // Modal sil
    async function deleteSetupModal(modalId) {
        if (!requirePermission('modals', 'kurulum modalı silmek')) return;
        
        if (!confirm('Bu kurulum modalını silmek istediğinize emin misiniz?\\n\\nModal ID: ' + modalId)) {
            return;
        }
        
        try {
            delete setupModals[modalId];
            await db.collection('settings').doc('setupModals').set({
                modals: setupModals,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('✅ Modal silindi');
            loadSetupModalsList();
        } catch(e) {
            console.error('Modal silme hatası:', e);
            showToast('❌ Silme hatası: ' + e.message);
        }
    }
    
    // Modal önizle (editor'dan)
    function previewSetupModal() {
        const title = document.getElementById('setupModalTitle').value.trim() || 'Önizleme';
        
        const modalData = {
            title: title,
            introVideo: document.getElementById('setupModalIntroVideo').value.trim() || null,
            apkButton: {
                label: document.getElementById('setupModalApkLabel').value.trim() || null,
                url: document.getElementById('setupModalApkUrl').value.trim() || null
            },
            compatibility: document.getElementById('setupModalCompatibility').value.trim().split('\\n').filter(s => s.trim()),
            guideSection: {
                title: document.getElementById('setupModalGuideTitle').value.trim() || null,
                video: document.getElementById('setupModalGuideVideo').value.trim() || null,
                description: document.getElementById('setupModalGuideDesc').value.trim() || null
            },
            steps: editingModalSteps.filter(s => s.title?.trim()),
            warnings: document.getElementById('setupModalWarnings').value.trim().split('\\n').filter(s => s.trim()),
            successMessage: {
                title: document.getElementById('setupModalSuccessTitle').value.trim() || 'Kurulum Tamamlandı!',
                description: document.getElementById('setupModalSuccessDesc').value.trim() || ''
            }
        };
        
        renderDynamicSetupModal(modalData);
    }
    
    // Kaydedilmiş modal önizle
    function previewSavedModal(modalId) {
        if (setupModals[modalId]) {
            renderDynamicSetupModal(setupModals[modalId]);
        } else {
            showToast('❌ Modal bulunamadı');
        }
    }
    
    // Dinamik modal aç (kurulum adımlarından)
    function openDynamicSetupModal(modalId) {
        if (setupModals[modalId]) {
            renderDynamicSetupModal(setupModals[modalId]);
        } else if (modalId === 'imguiModal') {
            // Geriye uyumluluk - eski IMGUI modal
            openModal('imguiModal');
        } else {
            showToast('❌ Kurulum rehberi bulunamadı');
        }
    }
    
    // Dinamik modal render
    function renderDynamicSetupModal(modalData) {
        const titleEl = document.getElementById('dynamicSetupModalTitle');
        const contentEl = document.getElementById('dynamicSetupModalContent');
        
        titleEl.textContent = modalData.title || '📖 Kurulum Rehberi';
        
        let html = '';
        
        // Tanıtım videosu
        if (modalData.introVideo) {
            html += `
                <div style="background: linear-gradient(135deg, rgba(156,39,176,0.2), rgba(103,58,183,0.2)); border: 1px solid rgba(156,39,176,0.4); border-radius: 15px; padding: 15px; margin-bottom: 20px;">
                    <div style="font-size: 16px; font-weight: bold; color: #E040FB; margin-bottom: 10px;">🎬 Tanıtım Videosu</div>
                    <video controls style="width: 100%; border-radius: 12px; max-height: 200px;">
                        <source src="${modalData.introVideo}" type="video/mp4">
                    </video>
                </div>
            `;
        }
        
        // APK indirme butonu
        if (modalData.apkButton?.label && modalData.apkButton?.url) {
            html += `
                <button onclick="window.open('${modalData.apkButton.url}', '_blank')" class="btn btn-primary" style="margin-bottom: 20px; width: 100%;">
                    📥 ${modalData.apkButton.label}
                </button>
            `;
        }
        
        // Uyumluluk bilgisi
        if (modalData.compatibility?.length > 0) {
            html += `
                <div style="background: rgba(76,175,80,0.15); border: 1px solid rgba(76,175,80,0.4); border-radius: 12px; padding: 12px; margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: bold; color: #4CAF50; margin-bottom: 8px;">✅ Uyumluluk</div>
                    <div style="font-size: 12px; color: #aaa;">
                        ${modalData.compatibility.map(c => '• ' + c).join('<br>')}
                    </div>
                </div>
            `;
        }
        
        // Rehber video bölümü
        if (modalData.guideSection?.title && modalData.guideSection?.video) {
            html += `
                <div style="background: linear-gradient(135deg, rgba(255,152,0,0.2), rgba(244,67,54,0.2)); border: 1px solid rgba(255,152,0,0.4); border-radius: 15px; padding: 15px; margin-bottom: 20px;">
                    <div style="font-size: 16px; font-weight: bold; color: #FF9800; margin-bottom: 10px;">🔐 ${modalData.guideSection.title}</div>
                    ${modalData.guideSection.description ? `<div style="font-size: 12px; color: #ffcc80; margin-bottom: 10px;">${modalData.guideSection.description}</div>` : ''}
                    <video controls style="width: 100%; border-radius: 12px; max-height: 200px;">
                        <source src="${modalData.guideSection.video}" type="video/mp4">
                    </video>
                </div>
            `;
        }
        
        // Kurulum adımları
        if (modalData.steps?.length > 0) {
            html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin-bottom: 15px;">📋 Kurulum Adımları</div>`;
            
            const colors = [
                { bg: 'rgba(33,150,243,0.1)', border: 'rgba(33,150,243,0.3)', text: '#2196F3', gradient: 'linear-gradient(135deg, #2196F3, #1976D2)' },
                { bg: 'rgba(255,152,0,0.1)', border: 'rgba(255,152,0,0.3)', text: '#FF9800', gradient: 'linear-gradient(135deg, #FF9800, #F57C00)' },
                { bg: 'rgba(156,39,176,0.1)', border: 'rgba(156,39,176,0.3)', text: '#9C27B0', gradient: 'linear-gradient(135deg, #9C27B0, #7B1FA2)' },
                { bg: 'rgba(0,188,212,0.1)', border: 'rgba(0,188,212,0.3)', text: '#00BCD4', gradient: 'linear-gradient(135deg, #00BCD4, #0097A7)' },
                { bg: 'rgba(233,30,99,0.1)', border: 'rgba(233,30,99,0.3)', text: '#E91E63', gradient: 'linear-gradient(135deg, #E91E63, #C2185B)' },
                { bg: 'rgba(76,175,80,0.1)', border: 'rgba(76,175,80,0.3)', text: '#4CAF50', gradient: 'linear-gradient(135deg, #4CAF50, #388E3C)' }
            ];
            
            modalData.steps.forEach((step, index) => {
                const color = colors[index % colors.length];
                html += `
                    <div style="background: ${color.bg}; border: 1px solid ${color.border}; border-radius: 12px; padding: 12px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: ${color.gradient}; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; flex-shrink: 0;">${index + 1}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: ${color.text}; margin-bottom: 4px;">${step.title}</div>
                                <div style="font-size: 12px; color: #aaa;">${step.description || ''}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        // Uyarılar
        if (modalData.warnings?.length > 0) {
            html += `
                <div style="background: rgba(244,67,54,0.15); border: 1px solid rgba(244,67,54,0.4); border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                    <div style="font-size: 14px; font-weight: bold; color: #f44336; margin-bottom: 8px;">⚠️ Önemli Uyarılar</div>
                    <div style="font-size: 12px; color: #ffcdd2;">
                        ${modalData.warnings.map(w => '• ' + w).join('<br>')}
                    </div>
                </div>
            `;
        }
        
        // Başarı mesajı
        if (modalData.successMessage) {
            html += `
                <div style="background: linear-gradient(135deg, rgba(76,175,80,0.2), rgba(139,195,74,0.2)); border: 1px solid rgba(76,175,80,0.5); border-radius: 12px; padding: 15px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 8px;">✅</div>
                    <div style="font-size: 16px; font-weight: bold; color: #4CAF50; margin-bottom: 5px;">${modalData.successMessage.title}</div>
                    <div style="font-size: 12px; color: #aaa;">${modalData.successMessage.description || ''}</div>
                </div>
            `;
        }
        
        contentEl.innerHTML = html;
        openModal('dynamicSetupModal');
    }
    // ============ KURULUM MODALLARI SONU ============
    
    // Admin: Ödeme ayarlarını yükle
    async function loadPaymentSettingsAdmin() {
        if (!isAdmin()) return;
        
        try {
            const doc = await db.collection('settings').doc('paymentSettings').get();
            if (doc.exists) {
                const data = doc.data();
                if (data.bankInfo) {
                    document.getElementById('paymentBankName').value = data.bankInfo.name || '';
                    document.getElementById('paymentBankBank').value = data.bankInfo.bank || '';
                    document.getElementById('paymentBankIban').value = data.bankInfo.iban || '';
                }
                if (data.shopier) {
                    document.getElementById('paymentShopierUrl').value = data.shopier.storeUrl || '';
                }
                if (data.pushServer) {
                    document.getElementById('pushServerUrl').value = data.pushServer.url || '';
                    document.getElementById('pushServerApiKey').value = data.pushServer.apiKey || '';
                    // Global değişkenleri güncelle
                    PUSH_SERVER.url = data.pushServer.url || '';
                    PUSH_SERVER.apiKey = data.pushServer.apiKey || '';
                }
            } else {
                // Varsayılan değerlerle doldur
                document.getElementById('paymentBankName').value = paymentSettings.bankInfo.name;
                document.getElementById('paymentBankBank').value = paymentSettings.bankInfo.bank;
                document.getElementById('paymentBankIban').value = paymentSettings.bankInfo.iban;
                document.getElementById('paymentShopierUrl').value = paymentSettings.shopier?.storeUrl || 'https://www.shopier.com/CheatsStore';
            }
            showToast('✅ Ayarlar yüklendi');
        } catch(e) {
            console.error('Ayarlar yüklenemedi:', e);
            showToast('❌ Yüklenemedi: ' + e.message);
        }
    }
    
    // Admin: Ödeme ayarlarını kaydet (SADECE KURUCU)
    async function savePaymentSettings() {
        if (!requirePermission('payments', 'ödeme ayarlarını değiştirmek')) return;
        
        const name = document.getElementById('paymentBankName').value.trim();
        const bank = document.getElementById('paymentBankBank').value.trim();
        const iban = document.getElementById('paymentBankIban').value.trim();
        const shopierUrl = document.getElementById('paymentShopierUrl').value.trim();
        const pushUrl = document.getElementById('pushServerUrl').value.trim();
        const pushApiKey = document.getElementById('pushServerApiKey').value.trim();
        
        if (!name || !bank || !iban) {
            showToast('❌ Banka bilgilerini doldurun');
            return;
        }
        
        try {
            const ibanClean = iban.replace(/\s/g, '');
            
            await db.collection('settings').doc('paymentSettings').set({
                bankInfo: {
                    name: name,
                    bank: bank,
                    iban: iban,
                    ibanClean: ibanClean
                },
                shopier: {
                    enabled: true,
                    storeUrl: shopierUrl || 'https://www.shopier.com/CheatsStore'
                },
                pushServer: {
                    url: pushUrl,
                    apiKey: pushApiKey
                },
                methods: paymentSettings.methods,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser.email
            }, { merge: true });
            
            // Local değişkenleri güncelle
            paymentSettings.bankInfo = { name, bank, iban, ibanClean };
            paymentSettings.shopier.storeUrl = shopierUrl || 'https://www.shopier.com/CheatsStore';
            
            // Push server ayarlarını güncelle
            PUSH_SERVER.url = pushUrl;
            PUSH_SERVER.apiKey = pushApiKey;
            
            showToast('✅ Ayarlar kaydedildi!');
        } catch(e) {
            console.error('Ödeme ayarları kaydedilemedi:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Admin: Bildirim gönder
    function updateNotifTarget() {
        const targetType = document.getElementById('notifTargetType').value;
        const emailDiv = document.getElementById('notifUserEmailDiv');
        emailDiv.style.display = targetType === 'user' ? 'block' : 'none';
    }
    
    async function sendNotification() {
        if (!requirePermission('notifications', 'bildirim göndermek')) return;
        
        const targetType = document.getElementById('notifTargetType').value;
        const userEmail = document.getElementById('notifUserEmail').value.trim().toLowerCase();
        const title = document.getElementById('notifTitle').value.trim();
        const message = document.getElementById('notifMessage').value.trim();
        const type = document.getElementById('notifType').value;
        
        if (!title) { showToast('❌ Başlık girin'); return; }
        if (!message) { showToast('❌ Mesaj girin'); return; }
        if (targetType === 'user' && !userEmail) { showToast('❌ E-posta girin'); return; }
        
        try {
            // Target değerini belirle (email normalize edildi)
            const targetValue = targetType === 'all' ? 'all' : userEmail;
            console.log('📤 Bildirim gönderiliyor...', { targetType, targetValue, title, message, type });
            
            // notifiedAt ekleyerek realtime dinleyicinin yakalamasını sağla
            const docRef = await db.collection('notifications').add({
                targetType: targetValue,
                targetEmail: targetType === 'user' ? userEmail : null,
                title,
                message,
                type,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.email,
                read: false,
                notifiedAt: new Date().toISOString() // Realtime bildirim için
            });
            
            console.log('✅ Bildirim Firestore\'a kaydedildi:', docRef.id, 'Hedef:', targetValue);
            
            // GERÇEK PUSH NOTIFICATION GÖNDER
            if (targetType === 'all') {
                // Tüm kullanıcılara push bildirim (topic)
                await sendPushToAll(title, message, { type: type });
                showToast('✅ Bildirim tüm kullanıcılara gönderildi!');
            } else {
                // Belirli kullanıcıya push bildirim
                const userDocs = await db.collection('users').where('email', '==', userEmail).get();
                if (!userDocs.empty) {
                    const userData = userDocs.docs[0].data();
                    if (userData.fcmToken) {
                        await sendPushNotification(userData.fcmToken, title, message, { type: type });
                        showToast('✅ Push bildirim gönderildi!');
                    } else {
                        showToast('⚠️ Kullanıcının FCM token\'ı yok, sadece uygulama içi bildirim gönderildi');
                    }
                } else {
                    showToast('⚠️ Kullanıcı bulunamadı, sadece Firestore\'a kaydedildi');
                }
            }
            
            // Admin kendisi için de MERKEZİ BİLDİRİM göster
            await showFullNotification({
                title: title,
                message: message,
                type: type,
                showPopup: true,
                playSound: true,
                showNative: true,
                vibrate: true
            });
            
            // Formu temizle
            document.getElementById('notifTitle').value = '';
            document.getElementById('notifMessage').value = '';
            document.getElementById('notifUserEmail').value = '';
            
        } catch(e) {
            console.error('❌ Bildirim gönderme hatası:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Sipariş onaylandığında otomatik bildirim gönder (MERKEZİ SİSTEM KULLANIR)
    async function sendOrderApprovalNotification(userEmail, keyCode, packageName) {
        try {
            console.log('📩 Sipariş onay bildirimi gönderiliyor:', userEmail, packageName);
            
            // Email'i küçük harfe çevir (eşleşme sorunu önleme)
            const normalizedEmail = userEmail.toLowerCase().trim();
            
            const notifData = {
                targetType: normalizedEmail,
                targetEmail: normalizedEmail,  // Yedek alan
                title: '🎉 Siparişiniz Onaylandı!',
                message: `${packageName} paketiniz aktif edildi. Key kodunuz: ${keyCode}`,
                type: 'order',
                keyCode: keyCode,
                packageName: packageName,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser?.email || 'system',
                read: false,
                notifiedAt: new Date().toISOString() // Realtime bildirim için zaman damgası
            };
            
            const notifRef = await db.collection('notifications').add(notifData);
            console.log('✅ Firestore bildirimi kaydedildi! ID:', notifRef.id);
            
            // GERÇEK PUSH NOTIFICATION GÖNDER (Vercel sunucu üzerinden)
            try {
                const userDocs = await db.collection('users').where('email', '==', normalizedEmail).get();
                if (!userDocs.empty) {
                    const userData = userDocs.docs[0].data();
                    if (userData.fcmToken) {
                        await sendPushNotification(
                            userData.fcmToken,
                            '🎉 Siparişiniz Onaylandı!',
                            `${packageName} paketiniz aktif edildi. Key: ${keyCode}`,
                            { type: 'order_approved', keyCode: keyCode }
                        );
                        console.log('📱 Push notification gönderildi!');
                    }
                }
            } catch(pushErr) {
                console.log('Push bildirim gönderilemedi:', pushErr);
            }
            
            // Bu kullanıcı şu an online mı kontrol et - Online ise MERKEZİ BİLDİRİM gönder
            if (currentUser && currentUser.email.toLowerCase() === normalizedEmail) {
                console.log('📢 Kullanıcı online, MERKEZİ BİLDİRİM gönderiliyor...');
                
                await showFullNotification({
                    title: '🎉 Siparişiniz Onaylandı!',
                    message: `${packageName} paketiniz aktif edildi!`,
                    type: 'order',
                    keyCode: keyCode,
                    showPopup: true,
                    playSound: true,
                    showNative: true,
                    vibrate: true,
                    updateBadge: true
                });
            }
            
            showToast('✅ Kullanıcıya bildirim gönderildi');
        } catch(e) {
            console.error('❌ Bildirim gönderme hatası:', e);
            showToast('⚠️ Bildirim gönderilemedi: ' + e.message);
        }
    }
    
    // Sipariş dinleyiciyi durdur
    function stopOrderListener() {
        if (orderListener) {
            orderListener();
            orderListener = null;
        }
        stopNotificationListener();
        stopKeyStatusListener();
        stopChatListener();
    }
    
    // ==================== CHAT SİSTEMİ ====================
    let chatListener = null;
    let userChatMessages = [];
    let currentAdminChatId = null;
    let adminChatListener = null;
    
    // Kullanıcı: Chat dinleyici başlat
    function startChatListener() {
        if (!currentUser) return;
        stopChatListener();
        
        console.log('💬 Chat dinleyici başlatılıyor... UID:', currentUser.uid);
        
        chatListener = db.collection('chats').doc(currentUser.uid)
            .onSnapshot((doc) => {
                console.log('💬 Chat güncelleme alındı:', doc.exists, 'Zaman:', new Date().toLocaleTimeString());
                if (doc.exists) {
                    const data = doc.data();
                    const oldCount = userChatMessages.length;
                    const oldMessages = JSON.stringify(userChatMessages);
                    userChatMessages = data.messages || [];
                    const newMessages = JSON.stringify(userChatMessages);
                    
                    updateChatBadge(data.unreadUser || 0);
                    
                    console.log('💬 Mesaj sayısı:', oldCount, '->', userChatMessages.length);
                    console.log('💬 Değişiklik var mı:', oldMessages !== newMessages);
                    
                    // Modal açıksa MUTLAKA güncelle
                    const modal = document.getElementById('userChatModal');
                    const isModalOpen = modal && modal.classList.contains('show');
                    
                    console.log('💬 Modal açık mı:', isModalOpen);
                    
                    if (isModalOpen) {
                        console.log('💬 Modal açık, mesajlar yenileniyor...');
                        renderUserChatMessages();
                        scrollChatToBottom();
                    }
                    
                    // Sidebar badge'ı de güncelle
                    updateSidebarBadges();
                    
                    // Yeni mesaj geldiğinde ve modal kapalıysa toast göster
                    if (userChatMessages.length > oldCount && data.unreadUser > 0) {
                        const lastMsg = userChatMessages[userChatMessages.length - 1];
                        if (lastMsg && lastMsg.sender === 'admin' && !isModalOpen) {
                            showToast('💬 Yeni destek mesajı!');
                            // Native bildirim de gönder
                            sendNativeNotification('💬 Yeni Destek Mesajı', lastMsg.message || 'Destek ekibinden yeni mesaj');
                        }
                    }
                } else {
                    userChatMessages = [];
                    updateChatBadge(0);
                }
            }, (error) => {
                console.error('Chat dinleyici hatası:', error);
                // Hata durumunda 5 saniye sonra tekrar dene
                setTimeout(() => {
                    console.log('💬 Chat dinleyici yeniden başlatılıyor...');
                    startChatListener();
                }, 5000);
            });
    }
    
    // Chat'i en alta kaydır
    function scrollChatToBottom() {
        setTimeout(() => {
            const container = document.getElementById('userChatMessages');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }, 100);
    }
    
    // Chat dinleyiciyi durdur
    function stopChatListener() {
        if (chatListener) {
            chatListener();
            chatListener = null;
        }
        if (adminChatListener) {
            adminChatListener();
            adminChatListener = null;
        }
    }
    
    // Chat badge güncelle
    function updateChatBadge(count) {
        const badge = document.getElementById('chatBadge');
        if (!badge) return;
        
        if (count > 0) {
            badge.textContent = count > 9 ? '9+' : count;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    }
    
    // Kullanıcı: Chat modalını aç
    let chatRefreshInterval = null;
    
    async function openUserChatModal() {
        if (!currentUser) {
            showToast('⚠️ Giriş yapmanız gerekiyor');
            return;
        }
        
        // Modalı aç
        openModal('userChatModal');
        
        // Mesajları Firestore'dan taze olarak çek
        await refreshUserChatMessages();
        
        // Okunmamış mesajları sıfırla
        try {
            await db.collection('chats').doc(currentUser.uid).update({
                unreadUser: 0
            });
            updateChatBadge(0);
            updateSidebarBadges();
        } catch(e) {}
        
        // Input'a fokuslan
        setTimeout(() => {
            document.getElementById('userChatInput').focus();
        }, 300);
        
        // En alta kaydır
        scrollChatToBottom('userChatMessages');
        
        // Modal açıkken her 3 saniyede bir mesajları yenile (onSnapshot çalışmazsa diye)
        stopChatRefreshInterval();
        chatRefreshInterval = setInterval(async () => {
            const modal = document.getElementById('userChatModal');
            if (modal && modal.classList.contains('show')) {
                await refreshUserChatMessages(true); // silent mode
            } else {
                stopChatRefreshInterval();
            }
        }, 3000);
    }
    
    // Chat mesajlarını yenile
    async function refreshUserChatMessages(silent = false) {
        try {
            const chatDoc = await db.collection('chats').doc(currentUser.uid).get();
            if (chatDoc.exists) {
                const newMessages = chatDoc.data().messages || [];
                const hasNewMessages = newMessages.length !== userChatMessages.length;
                userChatMessages = newMessages;
                
                if (!silent) {
                    console.log('💬 Modal açıldı, mesajlar yüklendi:', userChatMessages.length);
                } else if (hasNewMessages) {
                    console.log('💬 Yeni mesaj algılandı, güncelleniyor...');
                }
                
                renderUserChatMessages();
                
                if (hasNewMessages) {
                    scrollChatToBottom('userChatMessages');
                }
            } else {
                userChatMessages = [];
                renderUserChatMessages();
            }
        } catch(e) {
            if (!silent) {
                console.error('Mesaj yükleme hatası:', e);
            }
        }
    }
    
    // Chat refresh interval'ı durdur
    function stopChatRefreshInterval() {
        if (chatRefreshInterval) {
            clearInterval(chatRefreshInterval);
            chatRefreshInterval = null;
        }
    }
    
    // Tarih formatla helper
    function formatChatDate(createdAt) {
        let dateObj = null;
        if (createdAt?.toDate) {
            dateObj = createdAt.toDate();
        } else if (createdAt instanceof Date) {
            dateObj = createdAt;
        } else if (typeof createdAt === 'string') {
            dateObj = new Date(createdAt);
        }
        
        if (!dateObj || isNaN(dateObj.getTime())) {
            return { date: '', time: '' };
        }
        
        return {
            date: dateObj.toLocaleDateString('tr-TR'),
            time: dateObj.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
        };
    }
    
    // Kullanıcı: Mesajları render et
    function renderUserChatMessages() {
        const container = document.getElementById('userChatMessages');
        const agentInfo = document.getElementById('supportAgentInfo');
        
        if (userChatMessages.length === 0) {
            // Bilgilendirme mesajı göster
            container.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 60px; margin-bottom: 20px;">🎧</div>
                    <div style="background: linear-gradient(135deg, rgba(0,188,212,0.15), rgba(0,151,167,0.1)); border: 1px solid rgba(0,188,212,0.3); border-radius: 15px; padding: 20px; margin-bottom: 15px;">
                        <div style="color: #00BCD4; font-weight: bold; font-size: 15px; margin-bottom: 10px;">🕐 En kısa zamanda bir yöneticimiz sizinle iletişime geçecek</div>
                        <div style="color: #aaa; font-size: 13px; line-height: 1.6;">Lütfen destek almak istediğiniz konuyu detaylı bir şekilde iletin. Ortalama yanıt süresi: <strong style="color: #4CAF50;">5-15 dakika</strong></div>
                    </div>
                    <div style="color: #666; font-size: 12px;">💡 Mesajınızı yazıp gönderin</div>
                </div>
            `;
            // Agent bilgisini gizle
            if (agentInfo) agentInfo.style.display = 'none';
            return;
        }
        
        // Admin mesajı var mı kontrol et ve son admin bilgisini al
        let lastAdminMsg = null;
        userChatMessages.forEach(msg => {
            if (msg.sender === 'admin') {
                lastAdminMsg = msg;
            }
        });
        
        // Eğer admin cevap verdiyse, rolünü göster
        if (lastAdminMsg && agentInfo) {
            const role = lastAdminMsg.adminRole || 'Admin';
            const adminName = lastAdminMsg.adminName || 'Destek Ekibi';
            const roleColors = {
                'Admin': '#FFD700',
                'Developer': '#00BCD4',
                'Moderator': '#9C27B0',
                'Support': '#4CAF50'
            };
            const roleColor = roleColors[role] || '#FFD700';
            agentInfo.innerHTML = `<span style="color: ${roleColor};">👤 ${role}</span> • ${adminName}`;
            agentInfo.style.display = 'block';
        } else if (agentInfo) {
            agentInfo.style.display = 'none';
        }
        
        let html = '';
        userChatMessages.forEach(msg => {
            const isUser = msg.sender === 'user';
            const { date, time } = formatChatDate(msg.createdAt);
            
            // Admin için rol bilgisi
            let senderLabel = '';
            if (!isUser) {
                const role = msg.adminRole || 'Admin';
                const roleColors = {
                    'Admin': '#FFD700',
                    'Developer': '#00BCD4',
                    'Moderator': '#9C27B0',
                    'Support': '#4CAF50'
                };
                const roleColor = roleColors[role] || '#FFD700';
                const roleIcons = {
                    'Admin': '👑',
                    'Developer': '💻',
                    'Moderator': '🛡️',
                    'Support': '🎧'
                };
                const roleIcon = roleIcons[role] || '👑';
                senderLabel = `<div style="font-size: 11px; color: ${roleColor}; margin-bottom: 5px; font-weight: bold;">${roleIcon} ${role}</div>`;
            }
            
            html += `
                <div style="display: flex; ${isUser ? 'justify-content: flex-end' : 'justify-content: flex-start'}; margin-bottom: 12px;">
                    <div style="max-width: 80%; ${isUser ? 'background: linear-gradient(135deg, #00BCD4, #0097A7);' : 'background: rgba(255,255,255,0.1);'} padding: 12px 16px; border-radius: ${isUser ? '15px 15px 5px 15px' : '15px 15px 15px 5px'};">
                        ${senderLabel}
                        ${msg.image ? `<img src="${msg.image}" style="max-width: 100%; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="openImageFullscreen('${msg.image}')">` : ''}
                        ${msg.message ? `<div style="color: #fff; font-size: 14px; line-height: 1.5; word-break: break-word;">${escapeHtml(msg.message)}</div>` : ''}
                        <div style="font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 5px; text-align: right;">${date} ${time}</div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        scrollChatToBottom('userChatMessages');
    }
    
    // Görsel tam ekran aç
    function openImageFullscreen(src) {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px;';
        overlay.onclick = () => overlay.remove();
        overlay.innerHTML = `
            <img src="${src}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 10px;">
            <button style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer;">✕</button>
        `;
        document.body.appendChild(overlay);
    }
    
    // Kullanıcı dosya önizleme
    let userPendingFile = null;
    function previewUserFile(input) {
        const file = input.files[0];
        if (!file) return;
        
        if (file.size > 5 * 1024 * 1024) {
            showToast('❌ Dosya boyutu 5MB\'dan küçük olmalı');
            input.value = '';
            return;
        }
        
        userPendingFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('userFilePreviewImg').src = e.target.result;
            document.getElementById('userFileName').textContent = file.name;
            document.getElementById('userFileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            document.getElementById('userFilePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
    
    function clearUserFile() {
        userPendingFile = null;
        document.getElementById('userChatFile').value = '';
        document.getElementById('userFilePreview').style.display = 'none';
    }
    
    // Kullanıcı sohbeti temizle
    async function clearUserChat() {
        if (!currentUser) return;
        
        if (!confirm('Tüm mesajlar silinecek. Emin misiniz?')) return;
        
        try {
            await db.collection('chats').doc(currentUser.uid).delete();
            userChatMessages = [];
            renderUserChatMessages();
            showToast('✅ Sohbet temizlendi');
        } catch(e) {
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Kullanıcı: Mesaj gönder
    async function sendUserMessage() {
        if (!currentUser) {
            showToast('⚠️ Giriş yapmanız gerekiyor');
            return;
        }
        
        const input = document.getElementById('userChatInput');
        const message = input.value.trim();
        
        // Mesaj veya dosya olmalı
        if (!message && !userPendingFile) {
            showToast('⚠️ Mesaj yazın veya dosya seçin');
            return;
        }
        
        const msgText = message;
        input.value = '';
        input.disabled = true;
        
        // Dosya varsa base64'e çevir
        let imageData = null;
        if (userPendingFile) {
            try {
                imageData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Dosya okunamadı'));
                    reader.readAsDataURL(userPendingFile);
                });
            } catch(e) {
                showToast('❌ Dosya yüklenemedi');
                input.disabled = false;
                return;
            }
        }
        
        // Önce UI'da göster (optimistic update)
        const now = new Date();
        const newMessage = {
            sender: 'user',
            message: msgText,
            image: imageData,
            createdAt: now,
            read: false
        };
        
        userChatMessages.push(newMessage);
        renderUserChatMessages();
        clearUserFile(); // Dosya önizlemeyi temizle
        
        try {
            const chatRef = db.collection('chats').doc(currentUser.uid);
            const chatDoc = await chatRef.get();
            
            const lastMsgPreview = msgText || '📷 Görsel';
            
            if (chatDoc.exists) {
                // Mevcut sohbete ekle
                const existingMessages = chatDoc.data().messages || [];
                existingMessages.push(newMessage);
                
                await chatRef.update({
                    messages: existingMessages,
                    lastMessage: lastMsgPreview,
                    lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                    unreadAdmin: firebase.firestore.FieldValue.increment(1)
                });
            } else {
                // Yeni sohbet oluştur
                await chatRef.set({
                    userEmail: currentUser.email,
                    userId: currentUser.uid,
                    messages: [newMessage],
                    lastMessage: lastMsgPreview,
                    lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                    unreadAdmin: 1,
                    unreadUser: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
        } catch(e) {
            console.error('Mesaj gönderme hatası:', e);
            showToast('❌ Mesaj gönderilemedi: ' + e.message);
        }
        
        input.disabled = false;
        input.focus();
    }
    
    // Admin: Tüm sohbetleri yükle
    async function loadAdminChats() {
        if (!hasPermission('support')) {
            document.getElementById('adminChatsList').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Bu özellik için yetkiniz yok</div>';
            return;
        }
        
        const container = document.getElementById('adminChatsList');
        const countBadge = document.getElementById('adminChatCount');
        
        try {
            const snapshot = await db.collection('chats')
                .orderBy('lastMessageAt', 'desc')
                .get();
            
            let totalUnread = 0;
            let html = '';
            
            if (snapshot.empty) {
                html = '<div style="text-align: center; padding: 20px; color: #666;">Henüz mesaj yok</div>';
            } else {
                snapshot.forEach(doc => {
                    const chat = doc.data();
                    const unread = chat.unreadAdmin || 0;
                    totalUnread += unread;
                    
                    const lastTime = chat.lastMessageAt?.toDate ? chat.lastMessageAt.toDate().toLocaleString('tr-TR') : '';
                    
                    html += `
                        <div onclick="openAdminChat('${doc.id}')" style="background: ${unread > 0 ? 'rgba(0,188,212,0.15)' : 'rgba(255,255,255,0.05)'}; border-radius: 10px; padding: 12px; margin-bottom: 8px; cursor: pointer; border-left: 3px solid ${unread > 0 ? '#00BCD4' : 'transparent'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-weight: bold; color: #fff;">👤 ${chat.userEmail}</div>
                                ${unread > 0 ? `<span style="background: #f44336; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${unread}</span>` : ''}
                            </div>
                            <div style="color: #aaa; font-size: 12px; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(chat.lastMessage || '')}</div>
                            <div style="color: #666; font-size: 10px; margin-top: 5px;">${lastTime}</div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            countBadge.textContent = totalUnread;
            countBadge.style.display = totalUnread > 0 ? 'inline' : 'none';
            
        } catch(e) {
            container.innerHTML = '<div style="color: #f44336;">Hata: ' + e.message + '</div>';
        }
    }
    
    // Admin: Sohbet aç
    async function openAdminChat(chatId) {
        if (!hasPermission('support')) return;
        
        currentAdminChatId = chatId;
        
        try {
            const chatDoc = await db.collection('chats').doc(chatId).get();
            if (!chatDoc.exists) {
                showToast('❌ Sohbet bulunamadı');
                return;
            }
            
            const chat = chatDoc.data();
            
            // Header güncelle
            document.getElementById('adminChatTitle').textContent = '💬 ' + chat.userEmail;
            document.getElementById('adminChatUserInfo').textContent = 'Kullanıcı ID: ' + chatId;
            
            // Mesajları render et
            renderAdminChatMessages(chat.messages || []);
            
            // Okunmamış mesajları sıfırla
            await db.collection('chats').doc(chatId).update({
                unreadAdmin: 0
            });
            
            // Real-time listener başlat
            if (adminChatListener) adminChatListener();
            adminChatListener = db.collection('chats').doc(chatId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        renderAdminChatMessages(doc.data().messages || []);
                    }
                });
            
            openModal('adminChatModal');
            
            // Input'a fokuslan
            setTimeout(() => {
                document.getElementById('adminChatInput').focus();
            }, 300);
            
            // Liste yenile
            loadAdminChats();
            
        } catch(e) {
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Admin: Mesajları render et
    function renderAdminChatMessages(messages) {
        const container = document.getElementById('adminChatMessages');
        
        if (messages.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">Henüz mesaj yok</div>';
            return;
        }
        
        let html = '';
        messages.forEach(msg => {
            const isAdmin = msg.sender === 'admin';
            const { date, time } = formatChatDate(msg.createdAt);
            
            html += `
                <div style="display: flex; ${isAdmin ? 'justify-content: flex-end' : 'justify-content: flex-start'}; margin-bottom: 12px;">
                    <div style="max-width: 80%; ${isAdmin ? 'background: linear-gradient(135deg, #673AB7, #512DA8);' : 'background: rgba(255,255,255,0.1);'} padding: 12px 16px; border-radius: ${isAdmin ? '15px 15px 5px 15px' : '15px 15px 15px 5px'};">
                        ${!isAdmin ? '<div style="font-size: 11px; color: #00BCD4; margin-bottom: 5px; font-weight: bold;">👤 Kullanıcı</div>' : '<div style="font-size: 11px; color: #FFD700; margin-bottom: 5px; font-weight: bold;">👑 Admin</div>'}
                        ${msg.image ? `<img src="${msg.image}" style="max-width: 100%; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="openImageFullscreen('${msg.image}')">` : ''}
                        ${msg.message ? `<div style="color: #fff; font-size: 14px; line-height: 1.5; word-break: break-word;">${escapeHtml(msg.message)}</div>` : ''}
                        <div style="font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 5px; text-align: right;">${date} ${time}</div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        scrollChatToBottom('adminChatMessages');
    }
    
    // Admin dosya önizleme
    let adminPendingFile = null;
    function previewAdminFile(input) {
        const file = input.files[0];
        if (!file) return;
        
        if (file.size > 5 * 1024 * 1024) {
            showToast('❌ Dosya boyutu 5MB\'dan küçük olmalı');
            input.value = '';
            return;
        }
        
        adminPendingFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('adminFilePreviewImg').src = e.target.result;
            document.getElementById('adminFileName').textContent = file.name;
            document.getElementById('adminFileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            document.getElementById('adminFilePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
    
    function clearAdminFile() {
        adminPendingFile = null;
        document.getElementById('adminChatFile').value = '';
        document.getElementById('adminFilePreview').style.display = 'none';
    }
    
    // Admin sohbeti temizle
    async function clearAdminChat() {
        if (!isAdmin() || !currentAdminChatId) return;
        
        if (!confirm('Bu kullanıcının tüm mesajları silinecek. Emin misiniz?')) return;
        
        try {
            await db.collection('chats').doc(currentAdminChatId).delete();
            closeModal('adminChatModal');
            loadAdminChats();
            showToast('✅ Sohbet temizlendi');
        } catch(e) {
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Admin: Mesaj gönder
    async function sendAdminMessage() {
        if (!requirePermission('support', 'destek mesajı göndermek')) return;
        if (!currentAdminChatId) {
            showToast('⚠️ Sohbet seçilmedi');
            return;
        }
        
        const input = document.getElementById('adminChatInput');
        const message = input.value.trim();
        
        // Mesaj veya dosya olmalı
        if (!message && !adminPendingFile) {
            showToast('⚠️ Mesaj yazın veya dosya seçin');
            return;
        }
        
        const msgText = message;
        input.value = '';
        input.disabled = true;
        
        // Dosya varsa base64'e çevir
        let imageData = null;
        if (adminPendingFile) {
            try {
                imageData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Dosya okunamadı'));
                    reader.readAsDataURL(adminPendingFile);
                });
            } catch(e) {
                showToast('❌ Dosya yüklenemedi');
                input.disabled = false;
                return;
            }
        }
        
        clearAdminFile(); // Dosya önizlemeyi temizle
        
        try {
            const chatRef = db.collection('chats').doc(currentAdminChatId);
            const chatDoc = await chatRef.get();
            
            if (!chatDoc.exists) {
                showToast('❌ Sohbet bulunamadı');
                input.disabled = false;
                return;
            }
            
            const now = new Date();
            
            // Admin rolünü belirle
            const adminRoles = {
                'onurtenk0@gmail.com': { role: 'Kurucu', name: 'Onur' },
                'developer@cheatstore.com': { role: 'Developer', name: 'Developer' },
                'support@cheatstore.com': { role: 'Support', name: 'Destek' }
            };
            const adminInfo = adminRoles[currentUser.email] || { role: 'Admin', name: 'Yönetici' };
            
            const newMessage = {
                sender: 'admin',
                message: msgText,
                image: imageData,
                createdAt: now,
                read: false,
                adminRole: adminInfo.role,
                adminName: adminInfo.name,
                adminEmail: currentUser.email
            };
            
            const existingMessages = chatDoc.data().messages || [];
            existingMessages.push(newMessage);
            
            const lastMsgPreview = msgText || '📷 Görsel';
            
            await chatRef.update({
                messages: existingMessages,
                lastMessage: lastMsgPreview,
                lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                unreadUser: firebase.firestore.FieldValue.increment(1)
            });
            
            showToast('✅ Mesaj gönderildi');
            
        } catch(e) {
            console.error('Admin mesaj hatası:', e);
            showToast('❌ Mesaj gönderilemedi: ' + e.message);
        }
        
        input.disabled = false;
        input.focus();
    }
    
    // Chat scroll helper
    function scrollChatToBottom(containerId) {
        setTimeout(() => {
            const container = document.getElementById(containerId);
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }, 100);
    }
    
    // HTML escape helper
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // ==================== CHAT SİSTEMİ SON ====================
    
    // ==================== SÜRE UZATMA SİSTEMİ ====================
    let currentExtendData = null;
    let selectedExtendOption = null;
    
    // Süre uzatma modalını aç
    function openExtendModal(keyId, gameName, cheatName, keyCode, expiryDate) {
        currentExtendData = {
            keyId: keyId,
            gameName: gameName,
            cheatName: cheatName,
            keyCode: keyCode,
            currentExpiry: new Date(expiryDate)
        };
        selectedExtendOption = null;
        
        // Modal bilgilerini doldur
        document.getElementById('extendGameName').textContent = gameName;
        document.getElementById('extendCheatName').textContent = cheatName;
        document.getElementById('extendKeyCode').textContent = keyCode;
        document.getElementById('extendCurrentExpiry').textContent = currentExtendData.currentExpiry.toLocaleDateString('tr-TR');
        
        // Seçimleri sıfırla
        document.querySelectorAll('.extend-option').forEach(opt => {
            opt.style.borderColor = 'rgba(255,255,255,0.1)';
            opt.style.background = 'rgba(255,255,255,0.05)';
        });
        document.getElementById('extendSummary').style.display = 'none';
        document.getElementById('extendPayBtn').disabled = true;
        document.getElementById('extendPayBtn').style.opacity = '0.5';
        document.getElementById('extendPayBtn').textContent = 'Süre seçin';
        
        openModal('extendModal');
    }
    
    // Süre seçeneği seç
    function selectExtendOption(days, label, price) {
        selectedExtendOption = { days, label, price };
        
        // Görsel seçim
        document.querySelectorAll('.extend-option').forEach(opt => {
            opt.style.borderColor = 'rgba(255,255,255,0.1)';
            opt.style.background = 'rgba(255,255,255,0.05)';
        });
        event.currentTarget.style.borderColor = '#FF9800';
        event.currentTarget.style.background = 'rgba(255,152,0,0.15)';
        
        // Yeni bitiş tarihi hesapla
        const newExpiry = new Date(currentExtendData.currentExpiry);
        if (days >= 365) {
            newExpiry.setFullYear(newExpiry.getFullYear() + 10); // Sınırsız = 10 yıl
        } else {
            newExpiry.setDate(newExpiry.getDate() + days);
        }
        
        // Özet bilgileri güncelle
        document.getElementById('extendSelectedDays').textContent = label;
        document.getElementById('extendNewExpiry').textContent = newExpiry.toLocaleDateString('tr-TR');
        document.getElementById('extendTotalPrice').textContent = price;
        document.getElementById('extendSummary').style.display = 'block';
        
        // Butonu aktif et
        document.getElementById('extendPayBtn').disabled = false;
        document.getElementById('extendPayBtn').style.opacity = '1';
        document.getElementById('extendPayBtn').textContent = '💳 Ödemeye Geç - ' + price;
    }
    
    // Ödeme sayfasına geç
    // Ödeme sayfasına geç (Merkezi sistemi kullan)
    function proceedExtendPayment() {
        if (!selectedExtendOption || !currentExtendData) {
            showToast('⚠️ Önce süre seçin');
            return;
        }
        
        closeModal('extendModal');
        
        // Yeni bitiş tarihi hesapla
        const newExpiry = new Date(currentExtendData.currentExpiry);
        if (selectedExtendOption.days >= 365) {
            newExpiry.setFullYear(newExpiry.getFullYear() + 10);
        } else {
            newExpiry.setDate(newExpiry.getDate() + selectedExtendOption.days);
        }
        
        // Merkezi ödeme sistemini kullan
        openUnifiedPaymentModal({
            type: 'extension',
            game: currentExtendData.gameName,
            cheat: currentExtendData.cheatName,
            keyCode: currentExtendData.keyCode,
            keyId: currentExtendData.keyId,
            package: selectedExtendOption.label,
            packageName: selectedExtendOption.label,
            price: selectedExtendOption.price,
            days: selectedExtendOption.days,
            currentExpiry: currentExtendData.currentExpiry,
            newExpiry: newExpiry
        });
    }
    
    // Eski havale fonksiyonları - geriye uyumluluk için tutuldu
    function previewExtendDekont(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('extendDekontImg').src = e.target.result;
                document.getElementById('extendDekontPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }
    
    // Süre uzatma siparişi gönder (eski modal için - artık merkezi sistem kullanılıyor)
    async function submitExtendOrder() {
        if (!currentUser) {
            showToast('❌ Giriş yapmanız gerekiyor');
            return;
        }
        
        if (!currentExtendData || !selectedExtendOption) {
            showToast('❌ Süre seçimi yapılmadı');
            return;
        }
        
        const fileInput = document.getElementById('extendDekontFile');
        if (!fileInput.files[0]) {
            showToast('❌ Dekont fotoğrafı seçin');
            return;
        }
        
        showToast('⏳ Sipariş gönderiliyor...');
        
        try {
            // Dekont'u base64'e çevir
            const dekontBase64 = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('Dosya okunamadı'));
                reader.readAsDataURL(fileInput.files[0]);
            });
            
            // Yeni bitiş tarihi hesapla
            const newExpiry = new Date(currentExtendData.currentExpiry);
            if (selectedExtendOption.days >= 365) {
                newExpiry.setFullYear(newExpiry.getFullYear() + 10);
            } else {
                newExpiry.setDate(newExpiry.getDate() + selectedExtendOption.days);
            }
            
            // Siparişi kaydet
            await db.collection('orders').add({
                userId: currentUser.uid,
                email: currentUser.email,
                userEmail: currentUser.email,
                type: 'extension', // Süre uzatma tipi
                game: currentExtendData.gameName,
                cheat: currentExtendData.cheatName,
                keyCode: currentExtendData.keyCode,
                keyId: currentExtendData.keyId,
                currentExpiry: currentExtendData.currentExpiry,
                extensionDays: selectedExtendOption.days,
                newExpiry: newExpiry,
                package: selectedExtendOption.label,
                packageName: `Süre Uzatma - ${selectedExtendOption.label}`,
                price: selectedExtendOption.price,
                dekont: dekontBase64,
                paymentMethod: 'havale',
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Modalları kapat
            closeModal('extendHavaleModal');
            
            // Başarı mesajı
            showOrderSuccessModal();
            showToast('✅ Süre uzatma talebiniz alındı!');
            
        } catch(e) {
            console.error('Süre uzatma hatası:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // ==================== SÜRE UZATMA SİSTEMİ SON ====================

    // Sipariş badge güncelle
    async function updateOrderBadge() {
        if (!currentUser) return;
        try {
            const orders = await db.collection('orders')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'approved')
                .get();
            
            const badge = document.getElementById('myOrderBadge');
            const count = orders.size;
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        } catch(e) {}
    }
    
    // Siparişlerimi yükle
    async function loadMyOrders() {
        if (!currentUser) return;
        const container = document.getElementById('myOrdersList');
        
        try {
            const orders = await db.collection('orders')
                .where('userId', '==', currentUser.uid)
                .get();
            
            if (orders.empty) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 60px; margin-bottom: 15px;">📭</div>
                        <div style="color: #aaa;">Henüz sipariş vermediniz</div>
                        <button class="btn btn-primary btn-small" onclick="openGameSelectModal()" style="margin-top: 15px;">🛒 Satın Al</button>
                    </div>
                `;
                return;
            }
            
            // Client-side sıralama
            let orderList = [];
            orders.forEach(doc => {
                orderList.push({ id: doc.id, ...doc.data() });
            });
            orderList.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
            
            let html = '';
            orderList.forEach(o => {
                const date = o.createdAt.toDate().toLocaleString('tr-TR');
                let statusText = '', statusClass = '';
                
                if (o.status === 'pending') {
                    statusText = '⏳ Beklemede';
                    statusClass = 'pending';
                } else if (o.status === 'approved') {
                    statusText = '✅ Onaylandı';
                    statusClass = 'approved';
                } else if (o.status === 'rejected') {
                    statusText = '❌ Reddedildi';
                    statusClass = 'rejected';
                }
                
                html += `
                    <div class="order-card ${statusClass}" id="order-${o.id}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; font-size: 16px;">${o.packageName}</div>
                                <div style="color: #FFD700; font-size: 14px; margin-top: 3px;">${o.price}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="order-status ${statusClass}">${statusText}</span>
                                <button onclick="deleteOrder('${o.id}', '${o.packageName}', '${o.status}')" style="background: rgba(244,67,54,0.2); border: 1px solid #f44336; color: #f44336; padding: 4px 8px; border-radius: 8px; font-size: 11px; cursor: pointer;">🗑️</button>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 10px;">📅 ${date}</div>
                        ${o.status === 'approved' && o.keyCode ? `
                            <div style="background: rgba(76,175,80,0.2); border: 1px solid #4CAF50; border-radius: 10px; padding: 12px; margin-top: 10px;">
                                <div style="font-size: 11px; color: #aaa; margin-bottom: 5px;">🔑 Key Kodunuz</div>
                                <div style="font-family: monospace; font-size: 14px; color: #4CAF50; word-break: break-all;">${o.keyCode}</div>
                                <button onclick="copyToClipboard('${o.keyCode}')" style="margin-top: 10px; background: #4CAF50; border: none; color: #fff; padding: 8px 15px; border-radius: 8px; font-size: 12px; cursor: pointer; width: 100%;">📋 Kopyala</button>
                            </div>
                        ` : ''}
                        ${o.status === 'rejected' && o.rejectReason ? `
                            <div style="background: rgba(244,67,54,0.2); border: 1px solid #f44336; border-radius: 10px; padding: 12px; margin-top: 10px;">
                                <div style="font-size: 11px; color: #aaa; margin-bottom: 5px;">❌ Red Sebebi</div>
                                <div style="font-size: 13px; color: #f44336;">${o.rejectReason}</div>
                            </div>
                        ` : ''}
                        ${o.status === 'pending' ? `
                            <div style="background: rgba(255,152,0,0.2); border: 1px solid #FF9800; border-radius: 10px; padding: 12px; margin-top: 10px;">
                                <div style="font-size: 12px; color: #FF9800;">⏳ Dekontunuz inceleniyor. Onaylandığında bildirim alacaksınız.</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        } catch(e) {
            container.innerHTML = '<div style="color: #f44336; text-align: center; padding: 20px;">Hata: ' + e.message + '</div>';
        }
    }
    
    // Sipariş silme fonksiyonu
    async function deleteOrder(orderId, packageName, status) {
        let confirmMsg = `⚠️ "${packageName}" siparişini silmek istediğinize emin misiniz?`;
        
        if (status === 'pending') {
            confirmMsg += '\n\n⚠️ Bu sipariş henüz beklemede! Silmek isterseniz dekontunuz işleme alınmayacak.';
        } else if (status === 'approved') {
            confirmMsg += '\n\n✅ Bu sipariş onaylanmış. Sadece kayıt silinecek, key\'iniz aktif kalacak.';
        }
        
        confirmMsg += '\n\nBu işlem geri alınamaz!';
        
        if (!confirm(confirmMsg)) return;
        
        try {
            showToast('⏳ Siliniyor...');
            
            // Firebase'den siparişi sil
            await db.collection('orders').doc(orderId).delete();
            
            // Kartı animasyonlu kaldır
            const card = document.getElementById(`order-${orderId}`);
            if (card) {
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'translateX(-100%)';
                setTimeout(() => {
                    card.remove();
                    
                    // Eğer hiç sipariş kalmadıysa boş mesaj göster
                    const container = document.getElementById('myOrdersList');
                    if (container && container.children.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 60px; margin-bottom: 15px;">📭</div>
                                <div style="color: #aaa;">Henüz sipariş vermediniz</div>
                                <button class="btn btn-primary btn-small" onclick="openGameSelectModal()" style="margin-top: 15px;">🛒 Satın Al</button>
                            </div>
                        `;
                    }
                }, 300);
            }
            
            showToast('✅ Sipariş silindi!');
            
            // Badge'i güncelle
            updateOrderBadge();
        } catch(e) {
            console.error('Sipariş silme hatası:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Sipariş badge'ini güncelle
    async function updateOrderBadge() {
        if (!currentUser) return;
        try {
            const orders = await db.collection('orders')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'pending')
                .get();
            
            const badge = document.getElementById('myOrderBadge');
            if (badge) {
                if (orders.size > 0) {
                    badge.textContent = orders.size;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            }
        } catch(e) {
            console.error('Badge güncelleme hatası:', e);
        }
    }
    
    // Clipboard copy
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('📋 Kopyalandı!');
        }).catch(() => {
            showToast('❌ Kopyalama başarısız');
        });
    }
    
    // Admin - Üyenin key'ini sil (keys_delete yetkisi gerekli)
    async function adminDeleteUserKey(userId, keyIndex, keyCode, keyType) {
        if (!requirePermission('keys_delete', 'key silmek')) return;
        
        const confirmMsg = keyType === 'expired' 
            ? `Süresi dolmuş key'i silmek istiyor musunuz?\n${keyCode}`
            : `⚠️ DİKKAT: Aktif key'i silmek istiyor musunuz?\n${keyCode}`;
            
        if (!confirm(confirmMsg)) return;
        
        try {
            showToast('⏳ Key siliniyor...');
            
            // Kullanıcının verilerini al
            const userDoc = await db.collection('users').doc(userId).get();
            if (!userDoc.exists) {
                showToast('❌ Kullanıcı bulunamadı');
                return;
            }
            
            const userData = userDoc.data();
            let keys = userData.keys || [];
            let activityLog = userData.activityLog || [];
            
            // Silinecek key'i bul
            const deletedKey = keys[keyIndex];
            if (!deletedKey) {
                showToast('❌ Key bulunamadı');
                return;
            }
            
            // Activity log'a ekle
            activityLog.push({
                type: 'key_deleted',
                keyCode: deletedKey.keyCode || deletedKey.code || keyCode,
                game: deletedKey.game || 'Bilinmiyor',
                cheat: deletedKey.cheat || 'Bilinmiyor',
                days: deletedKey.days || 0,
                expiresAt: deletedKey.expiresAt,
                deletedAt: new Date(),
                deletedBy: 'admin',
                reason: keyType === 'expired' ? 'Admin tarafından süresi dolmuş key silindi' : 'Admin tarafından aktif key silindi'
            });
            
            // Key'i listeden çıkar
            keys.splice(keyIndex, 1);
            
            // Veritabanını güncelle
            await db.collection('users').doc(userId).update({
                keys: keys,
                activityLog: activityLog
            });
            
            showToast('✅ Key silindi!');
            
            // Modal'ı yeniden yükle
            openUserDetail(userId);
            
        } catch(e) {
            console.error('Admin key silme hatası:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Şifre görünürlüğünü değiştir
    let passwordVisible = false;
    function togglePasswordVisibility(password) {
        const field = document.getElementById('userPasswordField');
        if (!field) return;
        
        passwordVisible = !passwordVisible;
        if (passwordVisible) {
            field.textContent = password;
            field.style.color = '#4CAF50';
        } else {
            field.textContent = '••••••••';
            field.style.color = '#FF9800';
        }
    }
    
    // Admin - Üyenin tüm süresi dolmuş keylerini sil
    async function adminDeleteAllExpiredKeys(userId) {
        if (!isAdmin()) { showToast('❌ Yetkiniz yok'); return; }
        
        if (!confirm('Tüm süresi dolmuş keyleri silmek istiyor musunuz?')) return;
        
        try {
            showToast('⏳ Keyler siliniyor...');
            
            const userDoc = await db.collection('users').doc(userId).get();
            if (!userDoc.exists) {
                showToast('❌ Kullanıcı bulunamadı');
                return;
            }
            
            const userData = userDoc.data();
            let keys = userData.keys || [];
            let activityLog = userData.activityLog || [];
            const now = new Date();
            
            // Expired keyleri bul ve logla
            const expiredKeys = keys.filter(k => k.expiresAt && k.expiresAt.toDate() <= now);
            
            expiredKeys.forEach(key => {
                activityLog.push({
                    type: 'key_deleted',
                    keyCode: key.keyCode || key.code || '***',
                    game: key.game || 'Bilinmiyor',
                    cheat: key.cheat || 'Bilinmiyor',
                    days: key.days || 0,
                    expiresAt: key.expiresAt,
                    deletedAt: new Date(),
                    deletedBy: 'admin',
                    reason: 'Admin tarafından süresi dolmuş keyler toplu silindi'
                });
            });
            
            // Sadece aktif keyleri tut
            const activeKeys = keys.filter(k => k.expiresAt && k.expiresAt.toDate() > now);
            
            await db.collection('users').doc(userId).update({
                keys: activeKeys,
                activityLog: activityLog
            });
            
            showToast(`✅ ${expiredKeys.length} key silindi!`);
            openUserDetail(userId);
            
        } catch(e) {
            console.error('Admin toplu key silme hatası:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Admin - Üyeyi tamamen sil
    async function deleteUser(userId, email) {
        if (!requirePermission('members_edit', 'üye silmek')) return;
        
        // Kurucu kendini silemez
        if (email === OWNER_EMAIL) {
            showToast('❌ Kurucu hesabı silinemez!');
            return;
        }
        
        // Çift onay iste
        if (!confirm(`⚠️ DİKKAT!\n\n"${email}" kullanıcısını silmek üzeresiniz.\n\nBu işlem geri alınamaz!\n\nDevam etmek istiyor musunuz?`)) return;
        
        if (!confirm(`🔴 SON UYARI!\n\nBu üyenin TÜM verileri silinecek:\n- Tüm keyler\n- Tüm siparişler\n- Aktivite geçmişi\n\nEmin misiniz?`)) return;
        
        try {
            showToast('⏳ Üye siliniyor...');
            
            // 1. Üyenin siparişlerini sil
            const ordersSnapshot = await db.collection('orders').where('userId', '==', userId).get();
            const batch = db.batch();
            
            ordersSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            // 2. Üyeyi sil
            batch.delete(db.collection('users').doc(userId));
            
            // Batch işlemini uygula
            await batch.commit();
            
            showToast(`✅ "${email}" silindi!`);
            
            // Modal'ı kapat ve listeyi yenile
            closeModal('userDetailModal');
            loadAllUsers();
            
        } catch(e) {
            console.error('Üye silme hatası:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }

    function updateAuthUI() {
        const loggedOut = document.getElementById('loggedOutCard');
        const loggedIn = document.getElementById('loggedInCard');
        const adminBtn = document.getElementById('adminBtn');
        if (currentUser) {
            loggedOut.style.display = 'none';
            loggedIn.style.display = 'block';
            document.getElementById('userEmail').textContent = currentUser.email;
            if (isAdmin()) {
                adminBtn.style.display = 'block';
            } else {
                adminBtn.style.display = 'none';
            }
        } else {
            loggedOut.style.display = 'block';
            loggedIn.style.display = 'none';
        }
        
        // Profil sidebar UI'ını da güncelle
        updateProfilePanelUI();
    }
    
    async function loginUser() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const rememberMe = document.getElementById('rememberMe').checked;
        if (!email || !password) { showToast('❌ Tüm alanları doldurun'); return; }
        try {
            showToast('⏳ Giriş yapılıyor...');
            await auth.signInWithEmailAndPassword(email, password);
            
            // Beni hatırla
            if (rememberMe) {
                localStorage.setItem('remembered_email', email);
                localStorage.setItem('remembered_password', btoa(password)); // Basit şifreleme
                localStorage.setItem('remember_me', 'true');
            } else {
                localStorage.removeItem('remembered_email');
                localStorage.removeItem('remembered_password');
                localStorage.removeItem('remember_me');
            }
            
            showToast('✅ Giriş başarılı!');
            navigateTo('homePage');
        } catch (e) {
            showToast('❌ ' + (e.code === 'auth/invalid-credential' ? 'Hatalı e-posta veya şifre' : e.message));
        }
    }
    
    // Sayfa yüklendiğinde hatırlanan bilgileri doldur
    function loadRememberedCredentials() {
        const remembered = localStorage.getItem('remember_me');
        if (remembered === 'true') {
            const email = localStorage.getItem('remembered_email');
            const password = localStorage.getItem('remembered_password');
            if (email && password) {
                document.getElementById('loginEmail').value = email;
                document.getElementById('loginPassword').value = atob(password);
                document.getElementById('rememberMe').checked = true;
            }
        }
    }
    
    // Şifre sıfırlama fonksiyonu
    async function sendPasswordReset() {
        const email = document.getElementById('forgotEmail').value.trim();
        const resetBtn = document.getElementById('resetBtn');
        const successMsg = document.getElementById('resetSuccessMsg');
        
        if (!email) {
            showToast('❌ E-posta adresinizi girin');
            return;
        }
        
        // Email formatı kontrolü
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showToast('❌ Geçerli bir e-posta adresi girin');
            return;
        }
        
        try {
            resetBtn.disabled = true;
            resetBtn.innerHTML = '⏳ Gönderiliyor...';
            
            // Firebase şifre sıfırlama e-postası gönder
            await auth.sendPasswordResetEmail(email);
            
            // Başarı mesajını göster
            successMsg.style.display = 'block';
            resetBtn.innerHTML = '✅ E-posta Gönderildi';
            resetBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            
            showToast('✅ Şifre sıfırlama e-postası gönderildi!');
            
            // 3 saniye sonra butonu sıfırla
            setTimeout(() => {
                resetBtn.disabled = false;
                resetBtn.innerHTML = '📤 Sıfırlama Bağlantısı Gönder';
                resetBtn.style.background = 'linear-gradient(135deg, #FF9800, #F57C00)';
            }, 5000);
            
        } catch (e) {
            resetBtn.disabled = false;
            resetBtn.innerHTML = '📤 Sıfırlama Bağlantısı Gönder';
            
            // Hata mesajlarını Türkçeleştir
            let errorMsg = 'Bir hata oluştu';
            if (e.code === 'auth/user-not-found') {
                errorMsg = 'Bu e-posta ile kayıtlı kullanıcı bulunamadı';
            } else if (e.code === 'auth/invalid-email') {
                errorMsg = 'Geçersiz e-posta adresi';
            } else if (e.code === 'auth/too-many-requests') {
                errorMsg = 'Çok fazla deneme yaptınız. Lütfen bekleyin.';
            }
            
            showToast('❌ ' + errorMsg);
        }
    }
    
    async function registerUser() {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const password2 = document.getElementById('registerPassword2').value;
        if (!email || !password) { showToast('❌ Tüm alanları doldurun'); return; }
        if (password !== password2) { showToast('❌ Şifreler eşleşmiyor'); return; }
        if (password.length < 6) { showToast('❌ Şifre en az 6 karakter'); return; }
        try {
            showToast('⏳ Kayıt yapılıyor...');
            const cred = await auth.createUserWithEmailAndPassword(email, password);
            // Şifreyi de kaydet (admin görebilmesi için)
            await db.collection('users').doc(cred.user.uid).set({ 
                email, 
                password: password,
                createdAt: new Date(), 
                keys: [] 
            });
            showToast('✅ Kayıt başarılı!');
            navigateTo('homePage');
        } catch (e) {
            showToast('❌ ' + (e.code === 'auth/email-already-in-use' ? 'Bu e-posta zaten kayıtlı' : e.message));
        }
    }
    
    function logout() {
        auth.signOut();
        showToast('👋 Çıkış yapıldı');
    }
    
    async function loadUserData() {
        if (!currentUser) return;
        try {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                const data = doc.data();
                updateKeyStatus(data.keys || []);
            }
        } catch (e) { console.log(e); }
    }
    
    // Global değişken - aktif ve süresi dolmuş keyleri sakla
    let userActiveKeys = [];
    let userExpiredKeys = [];
    
    // Tarih dönüştürme yardımcı fonksiyonu (Firestore Timestamp veya Date)
    function toDate(dateField) {
        if (!dateField) return null;
        if (dateField.toDate && typeof dateField.toDate === 'function') {
            return dateField.toDate(); // Firestore Timestamp
        }
        if (dateField instanceof Date) {
            return dateField; // Zaten Date
        }
        if (typeof dateField === 'string' || typeof dateField === 'number') {
            return new Date(dateField); // String veya number
        }
        return null;
    }
    
    function updateKeyStatus(keys) {
        console.log('🔑 updateKeyStatus çağrıldı, key sayısı:', keys.length);
        
        const box = document.getElementById('keyStatusBox');
        const content = document.getElementById('keyStatusContent');
        
        if (!box || !content) {
            console.log('🔑 keyStatusBox veya content bulunamadı');
            return;
        }
        
        // Aktif ve süresi dolmuş keyleri filtrele ve sakla
        const now = new Date();
        userActiveKeys = keys.filter(k => {
            const exp = toDate(k.expiresAt);
            return exp && exp > now;
        });
        userExpiredKeys = keys.filter(k => {
            const exp = toDate(k.expiresAt);
            return exp && exp <= now;
        });
        
        console.log('🔑 Aktif key sayısı:', userActiveKeys.length);
        console.log('🔑 Süresi dolmuş key sayısı:', userExpiredKeys.length);
        
        if (userActiveKeys.length > 0) {
            box.className = 'key-status key-active';
            box.style.cursor = 'pointer';
            
            // TOPLAM kalan süreyi hesapla (tüm keylerin kalan süreleri toplamı)
            let totalRemainingMs = 0;
            userActiveKeys.forEach(key => {
                const exp = toDate(key.expiresAt);
                totalRemainingMs += (exp - now);
            });
            
            // Toplam kalan gün ve saat
            const totalRemainingDays = Math.floor(totalRemainingMs / (1000 * 60 * 60 * 24));
            const totalRemainingHours = Math.floor((totalRemainingMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            // Toplam süre metni
            let totalRemainingText = '';
            if (totalRemainingDays > 0) {
                totalRemainingText = `${totalRemainingDays} gün ${totalRemainingHours} saat`;
            } else {
                totalRemainingText = `${totalRemainingHours} saat`;
            }
            
            // Son bitiş tarihini hesapla (en son biten key'in bitiş tarihi)
            const lastExpireDate = new Date(Math.max(...userActiveKeys.map(k => toDate(k.expiresAt).getTime())));
            
            // Toplam paket günlerini hesapla
            let totalPackageDays = 0;
            userActiveKeys.forEach(key => {
                const exp = toDate(key.expiresAt);
                const activatedAt = toDate(key.activatedAt) || new Date();
                const keyDays = key.days || Math.ceil((exp - activatedAt) / (1000 * 60 * 60 * 24));
                totalPackageDays += keyDays;
            });
            
            // Etiket
            let packageLabel = totalPackageDays >= 365 ? 'Sınırsız' : `Toplam ${totalPackageDays} Gün`;
            
            // İlerleme yüzdesi - toplam kullanılan / toplam süre
            let totalOriginalMs = 0;
            let totalUsedMs = 0;
            userActiveKeys.forEach(key => {
                const exp = toDate(key.expiresAt);
                const activatedAt = toDate(key.activatedAt) || new Date();
                totalOriginalMs += (exp - activatedAt);
                totalUsedMs += (now - activatedAt);
            });
            const progressPercent = Math.max(0, Math.min(100, 100 - (totalUsedMs / totalOriginalMs * 100)));
            
            content.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 28px;">✅</div>
                        <div>
                            <div style="font-size: 14px; font-weight: bold; color: #4CAF50;">${packageLabel}</div>
                            <div style="font-size: 11px; color: #aaa;">⏱️ ${totalRemainingText} kaldı</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        ${userActiveKeys.length > 1 ? `<span style="background: #4CAF50; color: #fff; padding: 3px 8px; border-radius: 10px; font-size: 10px;">${userActiveKeys.length} Key</span>` : ''}
                        <span style="font-size: 18px; color: #4CAF50;">›</span>
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 4px; margin-top: 10px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: ${progressPercent}%; border-radius: 4px;"></div>
                </div>
                <div style="font-size: 10px; color: #666; margin-top: 5px; text-align: center;">📅 Bitiş: ${lastExpireDate.toLocaleDateString('tr-TR')} • Detaylar için tıklayın</div>
            `;
            // Sidebar key durumunu güncelle
            updateSidebarKeyStatus(`✅ ${totalRemainingText} kaldı`, true);
        } else {
            box.className = 'key-status key-expired';
            
            // Süresi dolmuş key varsa tıklanabilir yap
            if (userExpiredKeys.length > 0) {
                box.style.cursor = 'pointer';
                content.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 28px;">❌</div>
                            <div>
                                <div style="font-size: 14px; font-weight: bold; color: #f44336;">Süresi Doldu</div>
                                <div style="font-size: 11px; color: #aaa;">${userExpiredKeys.length} eski key mevcut</div>
                            </div>
                        </div>
                        <span style="font-size: 18px; color: #f44336;">›</span>
                    </div>
                    <div style="font-size: 10px; color: #666; margin-top: 8px; text-align: center;">Silmek için tıklayın</div>
                `;
                // Sidebar'da süresi doldu göster
                updateSidebarKeyStatus('❌ Süresi Doldu', false);
            } else {
                box.style.cursor = 'default';
                content.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 28px;">❌</div>
                        <div>
                            <div style="font-size: 14px; font-weight: bold; color: #f44336;">Pasif</div>
                            <div style="font-size: 11px; color: #aaa;">Aktif üyeliğiniz yok</div>
                        </div>
                    </div>
                `;
                // Sidebar'da aktif key yok göster
                updateSidebarKeyStatus('Aktif Key Yok', false);
            }
        }
    }
    
    // Key detay modal'ını aç
    function openKeyDetailModal() {
        // Hiç key yoksa
        if (userActiveKeys.length === 0 && userExpiredKeys.length === 0) {
            showToast('❌ Hiç key\'iniz yok');
            return;
        }
        
        const now = new Date();
        let keysHtml = '';
        
        // Önce aktif keyleri göster
        if (userActiveKeys.length > 0) {
            keysHtml += `<div style="font-size: 14px; font-weight: bold; color: #4CAF50; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <span>✅ Aktif Keyler</span>
                <span style="background: #4CAF50; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${userActiveKeys.length}</span>
            </div>`;
        }
        
        userActiveKeys.forEach((key, index) => {
            const exp = key.expiresAt.toDate();
            const activatedAt = key.activatedAt ? key.activatedAt.toDate() : new Date();
            const totalDays = key.days || Math.ceil((exp - activatedAt) / (1000 * 60 * 60 * 24));
            
            // Kalan süreyi hesapla
            const remainingMs = exp - now;
            const remainingDays = Math.floor(remainingMs / (1000 * 60 * 60 * 24));
            const remainingHours = Math.floor((remainingMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const remainingMins = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
            
            // Süre metni
            let remainingText = '';
            if (totalDays === 1) {
                remainingText = remainingHours > 0 ? `${remainingHours} saat ${remainingMins} dk` : `${remainingMins} dakika`;
            } else if (remainingDays > 0) {
                remainingText = `${remainingDays} gün ${remainingHours} saat`;
            } else {
                remainingText = `${remainingHours} saat ${remainingMins} dk`;
            }
            
            // Paket etiketi
            let packageLabel = '';
            if (totalDays === 1) packageLabel = '1 Günlük';
            else if (totalDays === 30) packageLabel = '30 Günlük';
            else if (totalDays === 60) packageLabel = '60 Günlük';
            else if (totalDays === 90) packageLabel = '90 Günlük';
            else if (totalDays >= 365) packageLabel = 'Sınırsız';
            else packageLabel = `${totalDays} Günlük`;
            
            const gameName = key.game || 'Mobile Legends';
            const cheatName = key.cheat || 'TheBestML';
            const keyCode = key.keyCode || key.code || '***';
            const keyId = key.id || index;
            
            // İlerleme yüzdesi
            const totalMs = exp - activatedAt;
            const usedMs = now - activatedAt;
            const progressPercent = Math.max(0, Math.min(100, 100 - (usedMs / totalMs * 100)));
            
            keysHtml += `
                <div style="background: rgba(0,0,0,0.2); border: 1px solid rgba(76,175,80,0.3); border-radius: 15px; padding: 15px; ${index > 0 ? 'margin-top: 12px;' : ''}">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">✅</span>
                            <span style="font-weight: bold; font-size: 16px; color: #4CAF50;">${packageLabel}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: #4CAF50; color: #fff; padding: 4px 12px; border-radius: 10px; font-size: 11px; font-weight: bold;">AKTİF</span>
                            <button onclick="deleteKey('${keyId}', '${packageLabel}'); event.stopPropagation();" style="background: rgba(244,67,54,0.2); border: 1px solid #f44336; color: #f44336; padding: 4px 8px; border-radius: 8px; font-size: 11px; cursor: pointer;">🗑️</button>
                        </div>
                    </div>
                    
                    <!-- İlerleme Çubuğu -->
                    <div style="background: rgba(255,255,255,0.1); border-radius: 5px; height: 8px; margin-bottom: 12px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: ${progressPercent}%; border-radius: 5px;"></div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 12px;">
                        <span style="color: #fff;">⏱️ ${remainingText} kaldı</span>
                        <span style="color: #888;">📅 ${exp.toLocaleDateString('tr-TR')}</span>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 12px; color: #888;">🎮 Oyun</span>
                            <span style="font-size: 12px; color: #fff;">${gameName}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #888;">🛡️ Hile</span>
                            <span style="font-size: 12px; color: #FFD700;">${cheatName}</span>
                        </div>
                    </div>
                    
                    <div style="background: rgba(76,175,80,0.15); border: 1px solid rgba(76,175,80,0.3); border-radius: 10px; padding: 12px;">
                        <div style="font-size: 11px; color: #888; margin-bottom: 6px;">🔑 Key Kodunuz</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <code style="flex: 1; font-size: 13px; color: #4CAF50; word-break: break-all; font-weight: bold;">${keyCode}</code>
                            <button onclick="copyToClipboard('${keyCode}'); event.stopPropagation();" style="background: #4CAF50; border: none; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 12px; cursor: pointer;">📋 Kopyala</button>
                        </div>
                    </div>
                    
                    <!-- Süre Uzat Butonu -->
                    <button onclick="openExtendModal('${keyId}', '${gameName}', '${cheatName}', '${keyCode}', '${exp.toISOString()}'); event.stopPropagation();" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #FF9800, #F57C00); border: none; color: #fff; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        ⏰ Süre Uzat
                    </button>
                </div>
            `;
        });
        
        // Süresi dolmuş keyleri göster
        if (userExpiredKeys.length > 0) {
            keysHtml += `<div style="font-size: 14px; font-weight: bold; color: #f44336; margin: 20px 0 12px 0; display: flex; align-items: center; gap: 8px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                <span>❌ Süresi Dolan Keyler</span>
                <span style="background: #f44336; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${userExpiredKeys.length}</span>
            </div>`;
            
            userExpiredKeys.forEach((key, index) => {
                const exp = key.expiresAt.toDate();
                const activatedAt = key.activatedAt ? key.activatedAt.toDate() : new Date();
                const totalDays = key.days || Math.ceil((exp - activatedAt) / (1000 * 60 * 60 * 24));
                
                // Paket etiketi
                let packageLabel = '';
                if (totalDays === 1) packageLabel = '1 Günlük';
                else if (totalDays === 30) packageLabel = '30 Günlük';
                else if (totalDays === 60) packageLabel = '60 Günlük';
                else if (totalDays === 90) packageLabel = '90 Günlük';
                else if (totalDays >= 365) packageLabel = 'Sınırsız';
                else packageLabel = `${totalDays} Günlük`;
                
                const gameName = key.game || 'Mobile Legends';
                const cheatName = key.cheat || 'TheBestML';
                const keyCode = key.keyCode || key.code || '***';
                const keyId = key.id || `exp_${index}`;
                
                // Ne kadar önce bittiğini hesapla
                const expiredMs = now - exp;
                const expiredDays = Math.floor(expiredMs / (1000 * 60 * 60 * 24));
                const expiredHours = Math.floor((expiredMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                let expiredText = expiredDays > 0 ? `${expiredDays} gün önce` : `${expiredHours} saat önce`;
                
                keysHtml += `
                    <div style="background: rgba(244,67,54,0.1); border: 1px solid rgba(244,67,54,0.3); border-radius: 15px; padding: 15px; ${index > 0 ? 'margin-top: 12px;' : ''}">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">⏰</span>
                                <span style="font-weight: bold; font-size: 16px; color: #f44336;">${packageLabel}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="background: #f44336; color: #fff; padding: 4px 12px; border-radius: 10px; font-size: 11px; font-weight: bold;">DOLDU</span>
                                <button onclick="deleteKey('${keyId}', '${packageLabel}'); event.stopPropagation();" style="background: rgba(244,67,54,0.3); border: 1px solid #f44336; color: #f44336; padding: 4px 8px; border-radius: 8px; font-size: 11px; cursor: pointer;">🗑️</button>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 12px;">
                            <span style="color: #f44336;">⏱️ ${expiredText} sona erdi</span>
                            <span style="color: #888;">📅 ${exp.toLocaleDateString('tr-TR')}</span>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="font-size: 12px; color: #888;">🎮 Oyun</span>
                                <span style="font-size: 12px; color: #fff;">${gameName}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-size: 12px; color: #888;">🛡️ Hile</span>
                                <span style="font-size: 12px; color: #FFD700;">${cheatName}</span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(244,67,54,0.1); border: 1px solid rgba(244,67,54,0.2); border-radius: 10px; padding: 12px;">
                            <div style="font-size: 11px; color: #888; margin-bottom: 6px;">🔑 Eski Key Kodu</div>
                            <code style="font-size: 12px; color: #888; word-break: break-all;">${keyCode}</code>
                        </div>
                    </div>
                `;
            });
        }
        
        // Tümünü sil butonu
        if (userExpiredKeys.length > 1) {
            keysHtml += `
                <button onclick="deleteAllExpiredKeys()" style="width: 100%; margin-top: 15px; background: linear-gradient(135deg, #f44336, #d32f2f); border: none; color: #fff; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer;">
                    🗑️ Tüm Süresi Dolmuş Keyleri Sil (${userExpiredKeys.length})
                </button>
            `;
        }
        
        document.getElementById('keyDetailContent').innerHTML = keysHtml;
        openModal('keyDetailModal');
    }
    
    // Tüm süresi dolmuş keyleri sil
    async function deleteAllExpiredKeys() {
        if (!currentUser) {
            showToast('❌ Önce giriş yapın');
            return;
        }
        
        const confirmed = confirm(`⚠️ Tüm süresi dolmuş keyleri (${userExpiredKeys.length} adet) silmek istediğinize emin misiniz?\n\nBu işlem geri alınamaz!`);
        
        if (!confirmed) return;
        
        try {
            showToast('⏳ Siliniyor...');
            
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                const keys = userData.keys || [];
                const now = new Date();
                
                // Süresi dolmuş keyleri bul
                const expiredKeys = keys.filter(k => k.expiresAt && k.expiresAt.toDate() <= now);
                
                // Sadece aktif keyleri tut
                const activeKeys = keys.filter(k => k.expiresAt && k.expiresAt.toDate() > now);
                
                // Silinen keyleri logla
                const activityLog = userData.activityLog || [];
                expiredKeys.forEach(key => {
                    activityLog.push({
                        type: 'key_deleted',
                        keyCode: key.keyCode || key.code || '***',
                        game: key.game || 'Mobile Legends',
                        cheat: key.cheat || 'TheBestML',
                        days: key.days || 0,
                        expiresAt: key.expiresAt,
                        deletedAt: new Date(),
                        deletedBy: 'user',
                        reason: 'Toplu silme - Süresi dolmuş'
                    });
                });
                
                await db.collection('users').doc(currentUser.uid).update({
                    keys: activeKeys,
                    activityLog: activityLog
                });
                
                showToast(`✅ ${expiredKeys.length} key silindi!`);
                closeModal('keyDetailModal');
                loadUserData();
            }
        } catch(e) {
            console.error('Toplu silme hatası:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Key silme fonksiyonu
    async function deleteKey(keyId, packageLabel) {
        if (!currentUser) {
            showToast('❌ Önce giriş yapın');
            return;
        }
        
        // Onay iste
        const confirmed = confirm(`⚠️ "${packageLabel}" paketini silmek istediğinize emin misiniz?\n\nBu işlem geri alınamaz ve kalan süreniz kaybolur!`);
        
        if (!confirmed) return;
        
        try {
            showToast('⏳ Siliniyor...');
            
            // Firebase'den key'i sil
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                const keys = userData.keys || [];
                
                // Silinecek key'i bul
                let deletedKey = null;
                const updatedKeys = keys.filter((k, idx) => {
                    const kId = k.id || idx;
                    if (kId.toString() === keyId.toString()) {
                        deletedKey = k;
                        return false;
                    }
                    return true;
                });
                
                // Aktivite loguna ekle
                const activityLog = userData.activityLog || [];
                if (deletedKey) {
                    const now = new Date();
                    const isExpired = deletedKey.expiresAt && deletedKey.expiresAt.toDate() <= now;
                    activityLog.push({
                        type: 'key_deleted',
                        keyCode: deletedKey.keyCode || deletedKey.code || '***',
                        game: deletedKey.game || 'Mobile Legends',
                        cheat: deletedKey.cheat || 'TheBestML',
                        days: deletedKey.days || 0,
                        expiresAt: deletedKey.expiresAt,
                        deletedAt: new Date(),
                        deletedBy: 'user',
                        reason: isExpired ? 'Süresi dolmuş key silindi' : 'Aktif key silindi'
                    });
                }
                
                // Güncelle
                await db.collection('users').doc(currentUser.uid).update({
                    keys: updatedKeys,
                    activityLog: activityLog
                });
                
                showToast('✅ Key silindi!');
                
                // Modal'ı kapat ve yeniden yükle
                closeModal('keyDetailModal');
                
                // Kullanıcı verilerini yeniden yükle
                loadUserData();
            }
        } catch(e) {
            console.error('Key silme hatası:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // ==================== YETKİ SİSTEMİ ====================
    
    // Kurucu (Owner) - TÜM yetkiler
    const OWNER_EMAIL = 'onurtenk0@gmail.com';
    
    // Yetki tanımları
    const PERMISSIONS = {
        orders: { name: 'Sipariş Yönetimi', icon: '📦', desc: 'Siparişleri görüntüleme ve onaylama/reddetme' },
        support: { name: 'Destek Yönetimi', icon: '💬', desc: 'Destek mesajlarına cevap verme' },
        members_view: { name: 'Üye Görüntüleme', icon: '👁️', desc: 'Üye listesini görüntüleme' },
        members_edit: { name: 'Üye Düzenleme', icon: '✏️', desc: 'Üye verilerini düzenleme' },
        keys_add: { name: 'Key Ekleme', icon: '🔑', desc: 'Üyelere key ekleme' },
        keys_delete: { name: 'Key Silme', icon: '🗑️', desc: 'Üyelerin keylerini silme' },
        games: { name: 'Oyun/Hile Yönetimi', icon: '🎮', desc: 'Oyun ve hile ekleme/düzenleme' },
        payments: { name: 'Ödeme Ayarları', icon: '💳', desc: 'Ödeme ayarlarını değiştirme' },
        notifications: { name: 'Bildirim Gönderme', icon: '📢', desc: 'Tüm kullanıcılara bildirim gönderme' },
        admin_management: { name: 'Admin Yönetimi', icon: '👮', desc: 'Admin ekleme/çıkarma/yetkilendirme' },
        modals: { name: 'Kurulum Modalları', icon: '📖', desc: 'Kurulum rehberi modalları oluşturma/düzenleme' },
        app_settings: { name: 'Uygulama Yönetimi', icon: '⚙️', desc: 'Uygulama ayarları, tema, logo ve güncelleme yönetimi' }
    };
    
    // Dinamik admin listesi (Firestore'dan yüklenir) - Yeni yapı: { email: string, permissions: string[] }
    let adminList = [];  // [{ email: 'xxx', permissions: ['orders', 'support'] }, ...]
    let adminEmails = []; // Eski yapı ile uyumluluk için
    
    // Firestore'dan admin listesini yükle
    async function loadAdminList() {
        try {
            const doc = await db.collection('settings').doc('admins').get();
            if (doc.exists) {
                const data = doc.data();
                
                // Yeni yapı varsa kullan
                if (data.adminList) {
                    adminList = data.adminList;
                    adminEmails = adminList.map(a => a.email.toLowerCase());
                } 
                // Eski yapıyı yeni yapıya dönüştür
                else if (data.emails) {
                    adminEmails = data.emails;
                    adminList = adminEmails.map(email => ({
                        email: email,
                        permissions: ['orders', 'support', 'members_view'] // Varsayılan yetkiler
                    }));
                    // Yeni yapıyı kaydet
                    await saveAdminList();
                }
                
                console.log('Admin listesi yüklendi:', adminList.length, 'admin');
            }
        } catch(e) {
            console.log('Admin listesi yüklenemedi:', e);
        }
    }
    
    // Admin listesini kaydet
    async function saveAdminList() {
        try {
            await db.collection('settings').doc('admins').set({
                adminList: adminList,
                emails: adminEmails, // Eski yapı ile uyumluluk
                updatedAt: new Date(),
                updatedBy: currentUser?.email || 'system'
            });
            return true;
        } catch(e) {
            console.error('Admin listesi kaydedilemedi:', e);
            return false;
        }
    }
    
    // Admin ekle (ADMIN YÖNETİMİ YETKİSİ GEREKLİ)
    async function addAdmin(email, permissions = ['orders', 'support', 'members_view']) {
        if (!requirePermission('admin_management', 'admin eklemek')) return false;
        
        email = email.toLowerCase().trim();
        if (!email || !email.includes('@')) {
            showToast('❌ Geçerli e-posta girin');
            return false;
        }
        
        if (email === OWNER_EMAIL) {
            showToast('⚠️ Kurucu zaten en üst yetkiye sahip');
            return false;
        }
        
        if (adminEmails.includes(email)) {
            showToast('⚠️ Bu kullanıcı zaten admin');
            return false;
        }
        
        try {
            // Yeni admin objesini ekle
            adminList.push({
                email: email,
                permissions: permissions,
                addedAt: new Date().toISOString(),
                addedBy: currentUser.email
            });
            adminEmails.push(email);
            
            if (await saveAdminList()) {
                showToast('✅ ' + email + ' admin yapıldı!');
                return true;
            }
            return false;
        } catch(e) {
            adminList = adminList.filter(a => a.email !== email);
            adminEmails = adminEmails.filter(e => e !== email);
            showToast('❌ Hata: ' + e.message);
            return false;
        }
    }
    
    // Admin kaldır (ADMIN YÖNETİMİ YETKİSİ GEREKLİ)
    async function removeAdmin(email) {
        if (!requirePermission('admin_management', 'admin kaldırmak')) return false;
        
        email = email.toLowerCase().trim();
        
        if (!adminEmails.includes(email)) {
            showToast('⚠️ Bu kullanıcı admin değil');
            return false;
        }
        
        if (!confirm(`"${email}" kullanıcısının admin yetkisini kaldırmak istiyor musunuz?`)) {
            return false;
        }
        
        try {
            adminList = adminList.filter(a => a.email !== email);
            adminEmails = adminEmails.filter(e => e !== email);
            
            if (await saveAdminList()) {
                showToast('✅ ' + email + ' artık admin değil');
                loadAdminListUI();
                return true;
            }
            return false;
        } catch(e) {
            showToast('❌ Hata: ' + e.message);
            await loadAdminList();
            return false;
        }
    }
    
    // Admin yetkilerini güncelle (ADMIN YÖNETİMİ YETKİSİ GEREKLİ)
    async function updateAdminPermissions(email, permissions) {
        if (!requirePermission('admin_management', 'yetki değiştirmek')) return false;
        
        email = email.toLowerCase().trim();
        const adminIndex = adminList.findIndex(a => a.email === email);
        
        if (adminIndex === -1) {
            showToast('⚠️ Bu kullanıcı admin değil');
            return false;
        }
        
        try {
            adminList[adminIndex].permissions = permissions;
            adminList[adminIndex].updatedAt = new Date().toISOString();
            adminList[adminIndex].updatedBy = currentUser.email;
            
            if (await saveAdminList()) {
                showToast('✅ Yetkiler güncellendi!');
                return true;
            }
            return false;
        } catch(e) {
            showToast('❌ Hata: ' + e.message);
            await loadAdminList();
            return false;
        }
    }
    
    // Adminin yetkilerini al
    function getAdminPermissions(email) {
        const admin = adminList.find(a => a.email === email.toLowerCase());
        return admin ? admin.permissions : [];
    }
    
    // Kurucu mu kontrol et (tüm yetkiler)
    function isOwner() {
        return currentUser && currentUser.email === OWNER_EMAIL;
    }
    
    // Admin mi kontrol et (kurucu dahil)
    function isAdmin() {
        if (!currentUser) return false;
        return currentUser.email === OWNER_EMAIL || adminEmails.includes(currentUser.email.toLowerCase());
    }
    
    // Yetki kontrolü - belirli bir yetki için
    function hasPermission(permission) {
        if (!currentUser) return false;
        
        // Kurucu tüm yetkilere sahip
        if (isOwner()) return true;
        
        // Admin ise yetkilerini kontrol et
        const userEmail = currentUser.email.toLowerCase();
        const admin = adminList.find(a => a.email === userEmail);
        
        if (admin && admin.permissions) {
            return admin.permissions.includes(permission);
        }
        
        return false;
    }
    
    // Belirli bir yetki gerekli - yoksa uyarı göster
    function requirePermission(permission, actionName) {
        if (!hasPermission(permission)) {
            const permInfo = PERMISSIONS[permission];
            showToast(`🔒 "${permInfo?.name || permission}" yetkisi gerekli`);
            return false;
        }
        return true;
    }
    
    // Kurucu yetkisi gerektiren işlem kontrolü
    function requireOwner(action) {
        if (!isOwner()) {
            showToast('🔒 Bu işlem için kurucu yetkisi gerekli');
            return false;
        }
        return true;
    }
    
    // Gelişmiş oyun/hile veri yapısı
    let gamesData = {};  // { gameId: { name, image, desc, playStore, status, cheats: { cheatId: {...} } } }
    let currentDynamicGame = null;  // Şu an açık olan dinamik oyun
    let currentDynamicCheat = null; // Şu an açık olan dinamik hile
    let selectedDynamicPrice = null; // Seçili fiyat
    
    // Firestore'dan oyun/hile verilerini yükle
    async function loadGamesAndCheats() {
        try {
            const doc = await db.collection('settings').doc('gamesData').get();
            if (doc.exists && doc.data().games) {
                gamesData = doc.data().games;
                console.log('Oyunlar yüklendi:', Object.keys(gamesData));
                
                // ============ KURULUM ADIMLARI MİGRATION ============
                // Mevcut veride setupSteps boşsa otomatik olarak doldur
                let needsUpdate = false;
                
                // TheBestML IMGUI için kurulum adımları
                if (gamesData.mobile_legends?.cheats?.thebestml) {
                    const imgui = gamesData.mobile_legends.cheats.thebestml;
                    if (!imgui.setupSteps || imgui.setupSteps.length === 0) {
                        imgui.setupSteps = [
                            {
                                title: '1️⃣ Orijinal ML İndirin',
                                description: 'Playstoreden Mobile Legends orijinal sürümünü indirin. Otomatik güncellemeleri kapatmayı unutmayın!',
                                actionType: 'playstore'
                            },
                            {
                                title: '2️⃣ Sertifikaları Kapatın',
                                description: 'Bypass korumasının sorunsuz çalışabilmesi için videoda gösterildiği gibi sertifikaları kapatın. Bu adım ÇOK ÖNEMLİ!',
                                actionType: 'modal',
                                modalId: 'imguiModal'
                            },
                            {
                                title: '3️⃣ IMGUI APK İndirin',
                                description: 'TheBestML IMGUI V2.8 APK dosyasını indirin ve telefonunuza kurun.',
                                actionType: 'download',
                                downloadUrl: 'https://dosya.co/dho18v1fbzq0/THEBEST_IMGUI-v2.8.apk.html'
                            },
                            {
                                title: '4️⃣ Spa Dosyasını Çalıştırın',
                                description: 'İndirdiğiniz TheBestML Spa dosyasını çalıştırın. Karşınıza çıkan ekrandan gerekli izinleri verin.',
                                actionType: 'none'
                            },
                            {
                                title: '5️⃣ Mobile Legends Klonlayın',
                                description: 'Uygulama içinden Mobile Legends\'ı seçin ve "Klon" yazısına tıklayın. Klonlama işlemi birkaç dakika sürebilir.',
                                actionType: 'none'
                            },
                            {
                                title: '6️⃣ Klonlanan ML\'yi Başlatın',
                                description: 'Klonladığınız ML sürümünü başlatın. Key giriş ekranında hesabım kısmındaki KEY\'inizi kopyalayıp yapıştırın. IMGUI menüsü oyun içinde görünecektir!',
                                actionType: 'none'
                            }
                        ];
                        // apkUrl ve features'ı da güncelle
                        imgui.apkUrl = imgui.apkUrl || 'https://dosya.co/dho18v1fbzq0/THEBEST_IMGUI-v2.8.apk.html';
                        imgui.features = imgui.features || ['👁 Oyuncu Görünümü', '❤️ Düşman HP', '🗺 Harita Hilesi', '📦 Kutulama', '🌲 Orman Yaratıklarını Görme'];
                        needsUpdate = true;
                        console.log('TheBestML IMGUI kurulum adımları güncellendi');
                    }
                }
                
                // TheBestML Pro için kurulum adımları
                if (gamesData.mobile_legends?.cheats?.thebestml_pro) {
                    const pro = gamesData.mobile_legends.cheats.thebestml_pro;
                    if (!pro.setupSteps || pro.setupSteps.length === 0) {
                        pro.setupSteps = [
                            {
                                title: '1️⃣ Orijinal ML İndirin',
                                description: 'Playstoreden Mobile Legends orijinal sürümünü indirin.',
                                actionType: 'playstore'
                            },
                            {
                                title: '2️⃣ TheBestML Pro APK İndirin',
                                description: 'TheBestML Pro APK dosyasını indirin ve kurun.',
                                actionType: 'download',
                                downloadUrl: ''
                            },
                            {
                                title: '3️⃣ Oyuna Giriş Yapın',
                                description: 'Oyuna giriş yapın, key giriş ekranına geldiğinizde hesabım kısmındaki KEY\'inizi kopyalayıp yapıştırın.',
                                actionType: 'none'
                            }
                        ];
                        needsUpdate = true;
                        console.log('TheBestML Pro kurulum adımları güncellendi');
                    }
                }
                
                // Değişiklik varsa Firestore'a kaydet
                if (needsUpdate) {
                    try {
                        await db.collection('settings').doc('gamesData').set({ games: gamesData });
                        console.log('✅ Kurulum adımları Firestore\'a kaydedildi!');
                    } catch(e) {
                        console.error('Kurulum adımları kaydetme hatası:', e);
                    }
                }
                // ============ MİGRATION SONU ============
                
            } else {
                console.log('Firestore\'da oyun verisi yok, varsayılan oluşturuluyor...');
                // Varsayılan veri yapısı
                gamesData = {
                    'mobile_legends': {
                        name: 'Mobile Legends',
                        image: 'https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/mobile-legends-icon.jpg', 
                        desc: 'Mobil MOBA oyunu',
                        playStore: 'https://play.google.com/store/apps/details?id=com.mobile.legends',
                        status: 'active',
                        cheats: {
                            'thebestml': {
                                name: 'TheBestML IMGUI',
                                image: 'https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/thebestml-icon.jpg',
                                version: 'V2.8',
                                desc: 'Gelişmiş IMGUI modu • ESP, Map Hack ve daha fazlası',
                                apkUrl: 'https://dosya.co/dho18v1fbzq0/THEBEST_IMGUI-v2.8.apk.html',
                                videoUrl: '',
                                features: ['👁 Oyuncu Görünümü', '❤️ Düşman HP', '🗺 Harita Hilesi', '📦 Kutulama', '🌲 Orman Yaratıklarını Görme'],
                                prices: [
                                    { days: '1', label: '1 Gün', price: '220₺' },
                                    { days: '30', label: '30 Gün', price: '850₺' },
                                    { days: '90', label: '90 Gün', price: '1800₺' },
                                    { days: 'unlimited', label: 'Sınırsız', price: '6500₺' }
                                ],
                                status: 'active',
                                setupSteps: [
                                    {
                                        title: 'Orijinal ML İndirin',
                                        description: 'Playstoreden Mobile Legends orijinal sürümünü indirin.',
                                        actionType: 'playstore'
                                    },
                                    {
                                        title: 'Sertifikaları Kapatın',
                                        description: 'Bypass korumasının çalışabilmesi için sertifikaları kapatın. Aşağıdaki butona tıklayarak video rehberi izleyin.',
                                        actionType: 'modal',
                                        modalId: 'imguiModal'
                                    },
                                    {
                                        title: 'IMGUI APK İndirin',
                                        description: 'TheBestML IMGUI APK dosyasını indirin ve kurun.',
                                        actionType: 'download',
                                        downloadUrl: 'https://dosya.co/dho18v1fbzq0/THEBEST_IMGUI-v2.8.apk.html'
                                    },
                                    {
                                        title: 'Spa Dosyasını Çalıştırın',
                                        description: 'İndirdiğiniz TheBestML Spa dosyasını çalıştırın ve karşınıza çıkan ekrandan izinleri verin.',
                                        actionType: 'none'
                                    },
                                    {
                                        title: 'ML Klonlayın',
                                        description: 'Listeden Mobile Legends\'ı seçin ve "Klon" yazısına tıklayın.',
                                        actionType: 'none'
                                    },
                                    {
                                        title: 'Klonlanan ML\'yi Başlatın',
                                        description: 'Klonladığınız ML sürümünü başlatın ve hesabım kısmındaki KEY\'iniz ile giriş yapın.',
                                        actionType: 'none'
                                    }
                                ]
                            },
                            'thebestml_pro': {
                                name: 'TheBestML Pro',
                                image: 'https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/thebestml-icon.jpg',
                                version: 'YENİ',
                                desc: 'Full Map • Auto Combo • Auto Aim • Rootlu/Rootsuz',
                                apkUrl: '',
                                videoUrl: '',
                                features: [
                                    '🗺️ Full Map',
                                    '🐾 Oto Pençe',
                                    '⚔️ Ling Oto Combo',
                                    '🌟 Julian Oto Combo',
                                    '🗡️ Arlott Oto Combo',
                                    '💀 Gusion Oto Combo',
                                    '🔫 Granger Oto Ulti',
                                    '🧲 Franco Mıknatıs Hook',
                                    '🎯 Xavier Oto Ulti',
                                    '🚀 Tigreal Oto Işınlanma + Ulti',
                                    '👊 Chou Oto Combo',
                                    '🪓 Balmond Oto Ulti',
                                    '⚡ Martis Oto Ulti',
                                    '🎯 Full Auto Aim'
                                ],
                                prices: [
                                    { days: '1', label: '1 Gün', price: '220₺' },
                                    { days: '30', label: '30 Gün', price: '850₺' },
                                    { days: '90', label: '90 Gün', price: '1800₺' },
                                    { days: 'unlimited', label: 'Sınırsız', price: '6500₺' }
                                ],
                                status: 'active',
                                setupSteps: [
                                    {
                                        title: 'Orijinal ML İndirin',
                                        description: 'Playstoreden Mobile Legends orijinal sürümünü indirin.',
                                        actionType: 'playstore'
                                    },
                                    {
                                        title: 'TheBestML Pro APK İndirin',
                                        description: 'TheBestML Pro APK dosyasını indirin ve kurun.',
                                        actionType: 'download',
                                        downloadUrl: ''
                                    },
                                    {
                                        title: 'Oyuna Giriş Yapın',
                                        description: 'Oyuna giriş yapın, key giriş ekranına geldiğinizde hesabım kısmındaki KEY\'inizi kopyalayıp yapıştırın.',
                                        actionType: 'none'
                                    }
                                ]
                            }
                        }
                    }
                };
                try {
                    await db.collection('settings').doc('gamesData').set({ games: gamesData });
                    console.log('Varsayılan oyun verisi kaydedildi');
                } catch(saveErr) {
                    console.error('Varsayılan veri kaydetme hatası:', saveErr);
                }
            }
            
            renderHomeGames(); // Ana sayfadaki oyunları render et
            updateGameSelects();
            loadGameCheatList();
            updateCheatStatusBadges(); // Durum badge'lerini güncelle
        } catch(e) {
            console.error('Oyun/Hile yükleme hatası:', e);
            // Hata durumunda bile bir şey göster
            const grid = document.getElementById('homeGamesGrid');
            if (grid) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #f44336;">
                        <div style="font-size: 50px; margin-bottom: 15px;">⚠️</div>
                        <div style="font-size: 16px; margin-bottom: 10px;">Oyunlar yüklenemedi</div>
                        <div style="font-size: 13px; color: #666;">${e.message}</div>
                        <button onclick="loadGamesAndCheats()" style="margin-top: 15px; background: #4CAF50; border: none; color: #fff; padding: 10px 20px; border-radius: 8px; cursor: pointer;">🔄 Tekrar Dene</button>
                    </div>
                `;
            }
        }
    }
    
    // Ana sayfadaki oyunları dinamik olarak render et
    function renderHomeGames() {
        const grid = document.getElementById('homeGamesGrid');
        if (!grid) {
            console.error('homeGamesGrid elementi bulunamadı!');
            return;
        }
        
        try {
            let html = '';
            const gameIds = Object.keys(gamesData || {});
            let activeGames = 0;
            
            console.log('Render edilecek oyun sayısı:', gameIds.length);
            
            gameIds.forEach(gameId => {
                const game = gamesData[gameId];
                if (!game || game.status !== 'active') return; // Sadece aktif oyunları göster
                activeGames++;
                
                const cheats = game.cheats || {};
                const cheatCount = Object.keys(cheats).filter(id => cheats[id]?.status === 'active').length;
                
                // Resim - base64 veya URL olabilir
                const imgSrc = game.image && game.image.startsWith('data:') 
                    ? game.image 
                    : (game.image || '');
                
                const fallbackSvg = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22 rx=%2215%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2230%22>🎮</text></svg>`;
                
                html += `
                    <div class="game-card" onclick="openGameDetail('${gameId}')">
                        <img src="${imgSrc || fallbackSvg}" alt="${game.name}" class="game-icon" onerror="this.src='${fallbackSvg}'">
                        <div class="game-info">
                            <div class="game-name">${game.name || 'Oyun'}</div>
                            <div class="game-desc">${game.desc || 'Oyun hileleri'}</div>
                            <div class="game-badge">${cheatCount} Hile Mevcut</div>
                        </div>
                        <div class="game-arrow">›</div>
                    </div>
                `;
            });
            
            // Hiç aktif oyun yoksa
            if (activeGames === 0) {
                html = `
                    <div style="text-align: center; padding: 30px; color: #888;">
                        <div style="font-size: 50px; margin-bottom: 15px;">🎮</div>
                        <div style="font-size: 16px; margin-bottom: 10px;">Henüz oyun eklenmemiş</div>
                        <div style="font-size: 13px; color: #666;">Admin panelden yeni oyun ekleyebilirsiniz</div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
            console.log('Oyunlar render edildi, aktif:', activeGames);
        } catch(e) {
            console.error('renderHomeGames hatası:', e);
            grid.innerHTML = `
                <div style="text-align: center; padding: 30px; color: #f44336;">
                    <div style="font-size: 50px; margin-bottom: 15px;">⚠️</div>
                    <div>Oyunlar görüntülenirken hata oluştu</div>
                </div>
            `;
        }
    }
    
    // Oyun detay sayfasını aç
    function openGameDetail(gameId) {
        const game = gamesData[gameId];
        if (!game) {
            showToast('❌ Oyun bulunamadı!');
            return;
        }
        
        currentDynamicGame = { id: gameId, ...game };
        
        // Sayfa elemanlarını güncelle
        document.getElementById('dynamicGameIcon').src = game.image || '';
        document.getElementById('dynamicGameTitle').textContent = game.name;
        document.getElementById('dynamicGameDesc').textContent = game.desc || 'Oyun hileleri';
        
        // Hileleri listele
        const cheatsGrid = document.getElementById('dynamicCheatsGrid');
        const cheats = game.cheats || {};
        let cheatsHtml = '';
        
        Object.keys(cheats).forEach(cheatId => {
            const cheat = cheats[cheatId];
            if (cheat.status === 'inactive' && !currentUser) return; // Giriş yapmamışsa pasif hileleri gösterme
            
            const version = cheat.version || '';
            let statusBadge = version ? `${version} • Aktif` : 'Aktif';
            let badgeStyle = 'background: linear-gradient(135deg, #4CAF50, #45a049);';
            
            if (cheat.status === 'maintenance') {
                statusBadge = `${version} • 🔧 Bakımda`;
                badgeStyle = 'background: linear-gradient(135deg, #FF9800, #F57C00);';
            } else if (cheat.status === 'inactive') {
                statusBadge = `${version} • ⏸️ Pasif`;
                badgeStyle = 'background: linear-gradient(135deg, #f44336, #d32f2f);';
            }
            
            const imgSrc = cheat.image && cheat.image.startsWith('data:') 
                ? cheat.image 
                : (cheat.image || '');
            
            const fallbackSvg = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%234CAF50%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2240%22>🗡</text></svg>`;
            
            cheatsHtml += `
                <div class="game-card" onclick="openCheatDetail('${gameId}', '${cheatId}')">
                    <img src="${imgSrc}" alt="${cheat.name}" class="game-icon" onerror="this.src='${fallbackSvg}'">
                    <div class="game-info">
                        <div class="game-name">${cheat.name}</div>
                        <div class="game-desc">${cheat.desc || 'Hile açıklaması'}</div>
                        <div class="game-badge" style="${badgeStyle}">${statusBadge}</div>
                    </div>
                    <div class="game-arrow">›</div>
                </div>
            `;
        });
        
        if (!cheatsHtml) {
            cheatsHtml = `
                <div style="text-align: center; padding: 30px; color: #888;">
                    <div style="font-size: 50px; margin-bottom: 15px;">🗡️</div>
                    <div>Bu oyun için henüz hile eklenmemiş</div>
                </div>
            `;
        }
        
        cheatsGrid.innerHTML = cheatsHtml;
        navigateTo('dynamicGamePage');
    }
    
    // Hile detay sayfasını aç
    async function openCheatDetail(gameId, cheatId) {
        const game = gamesData[gameId];
        const cheat = game?.cheats?.[cheatId];
        
        if (!cheat) {
            showToast('❌ Hile bulunamadı!');
            return;
        }
        
        currentDynamicGame = { id: gameId, ...game };
        currentDynamicCheat = { id: cheatId, gameId, ...cheat };
        selectedDynamicPrice = null;
        
        // Sayfa elemanlarını güncelle
        document.getElementById('dynamicCheatIcon').src = cheat.image || '';
        document.getElementById('dynamicCheatTitle').textContent = cheat.name;
        document.getElementById('dynamicCheatSubtitle').textContent = `${game.name} • ${cheat.version || ''}`;
        
        // Durum uyarıları
        document.getElementById('dynamicCheatMaintenanceWarning').style.display = cheat.status === 'maintenance' ? 'block' : 'none';
        document.getElementById('dynamicCheatInactiveWarning').style.display = cheat.status === 'inactive' ? 'block' : 'none';
        
        // Özellikleri grid yapısında listele
        const featuresDiv = document.getElementById('dynamicCheatFeatures');
        const features = cheat.features || [];
        featuresDiv.innerHTML = features.map(f => `
            <div class="feature-item-new">${f}</div>
        `).join('');
        
        // Video butonu - eğer videoUrl varsa göster
        const videoSection = document.getElementById('dynamicVideoSection');
        if (cheat.videoUrl) {
            videoSection.style.display = 'block';
            window.currentCheatVideoUrl = cheat.videoUrl;
        } else {
            videoSection.style.display = 'none';
        }
        
        // Fiyatları listele
        const pricesDiv = document.getElementById('dynamicCheatPrices');
        const prices = cheat.prices || [];
        pricesDiv.innerHTML = prices.map((p, i) => `
            <div class="price-card ${i === prices.length - 1 ? 'premium' : ''}" onclick="selectDynamicPrice(${i})">
                <div class="price-label">${p.label}</div>
                <div class="price-value">${p.price}</div>
            </div>
        `).join('');
        
        // Aktif üyelik kontrolü
        let hasAccess = false;
        let membershipInfo = '';
        
        if (currentUser) {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                const keys = userData.keys || [];
                const now = new Date();
                
                // Bu oyun ve hile için aktif key var mı?
                const activeKey = keys.find(key => {
                    if (key.game === game.name && key.cheat === cheat.name) {
                        if (key.days === 'unlimited' || key.days === 0) return true;
                        if (key.expiresAt && key.expiresAt.toDate() > now) return true;
                    }
                    return false;
                });
                
                if (activeKey) {
                    hasAccess = true;
                    if (activeKey.days === 'unlimited' || activeKey.days === 0) {
                        membershipInfo = '⭐ Sınırsız Üyelik';
                    } else if (activeKey.expiresAt) {
                        const expDate = activeKey.expiresAt.toDate();
                        const daysLeft = Math.ceil((expDate - now) / (1000 * 60 * 60 * 24));
                        membershipInfo = `📅 ${daysLeft} gün kaldı (${expDate.toLocaleDateString('tr-TR')})`;
                    }
                }
            }
        }
        
        // Kurulum talimatları ve üyelik bölümlerini güncelle
        document.getElementById('dynamicSetupLocked').style.display = hasAccess ? 'none' : 'block';
        document.getElementById('dynamicSetupUnlocked').style.display = hasAccess ? 'block' : 'none';
        document.getElementById('dynamicActiveMembership').style.display = hasAccess ? 'block' : 'none';
        
        if (hasAccess) {
            document.getElementById('dynamicMembershipInfo').textContent = membershipInfo;
        }
        
        // Kurulum adımlarını render et
        const stepsDiv = document.getElementById('dynamicSetupSteps');
        if (hasAccess) {
            // Önce Firestore'dan kurulum adımlarını kontrol et
            let setupSteps = cheat.setupSteps || [];
            
            // Eğer setupSteps boşsa ve TheBestML IMGUI ise varsayılan adımları kullan
            if (setupSteps.length === 0 && cheat.name && cheat.name.toLowerCase().includes('imgui')) {
                setupSteps = [
                    {
                        title: '1️⃣ Orijinal ML İndirin',
                        description: 'Playstoreden Mobile Legends orijinal sürümünü indirin.',
                        actionType: 'playstore'
                    },
                    {
                        title: '2️⃣ Sertifikaları Kapatın',
                        description: 'Bypass korumasının çalışabilmesi için sertifikaları kapatın. Aşağıdaki butona tıklayarak video rehberi izleyin.',
                        actionType: 'modal',
                        modalId: 'imguiModal'
                    },
                    {
                        title: '3️⃣ IMGUI APK İndirin',
                        description: 'TheBestML IMGUI APK dosyasını indirin ve kurun.',
                        actionType: 'download',
                        downloadUrl: cheat.apkUrl || 'https://dosya.co/dho18v1fbzq0/THEBEST_IMGUI-v2.8.apk.html'
                    },
                    {
                        title: '4️⃣ Spa Dosyasını Çalıştırın',
                        description: 'İndirdiğiniz TheBestML Spa dosyasını çalıştırın ve karşınıza çıkan ekrandan izinleri verin.',
                        actionType: 'none'
                    },
                    {
                        title: '5️⃣ ML Klonlayın',
                        description: 'Listeden Mobile Legends\'ı seçin ve "Klon" yazısına tıklayın.',
                        actionType: 'none'
                    },
                    {
                        title: '6️⃣ Klonlanan ML\'yi Başlatın',
                        description: 'Klonladığınız ML sürümünü başlatın ve hesabım kısmındaki KEY\'iniz ile giriş yapın. IMGUI menüsü oyun içinde görünecektir.',
                        actionType: 'none'
                    }
                ];
            }
            
            if (setupSteps.length > 0) {
                // Admin panelden eklenen özel kurulum adımları
                stepsDiv.innerHTML = setupSteps.map((step, i) => `
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">${i + 1}</div>
                            <div class="setup-step-title">${step.title}</div>
                        </div>
                        <div class="setup-step-desc">${step.description}</div>
                        ${step.actionType === 'playstore' ? `
                            <div class="setup-step-action">
                                <button class="btn btn-secondary btn-small" onclick="openPlayStore()">
                                    🎮 Play Store'dan İndir
                                </button>
                            </div>
                        ` : ''}
                        ${step.actionType === 'download' && step.downloadUrl ? `
                            <div class="setup-step-action">
                                <button class="btn btn-secondary btn-small" onclick="downloadDynamicApk('${step.downloadUrl}')">
                                    📥 APK İndir
                                </button>
                            </div>
                        ` : ''}
                        ${step.actionType === 'modal' && step.modalId ? `
                            <div class="setup-step-action">
                                <button class="detail-btn" onclick="openDynamicSetupModal('${step.modalId}')">
                                    📖 Detaylı Kurulum Rehberi
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } else {
                // Varsayılan kurulum adımları
                stepsDiv.innerHTML = `
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">1</div>
                            <div class="setup-step-title">${game.name} İndir</div>
                        </div>
                        <div class="setup-step-desc">
                            Play Store'dan orijinal ${game.name} oyununu indirin ve kurun.
                        </div>
                        <div class="setup-step-action">
                            <button class="btn btn-secondary btn-small" onclick="openPlayStore()">
                                🎮 Play Store'dan İndir
                            </button>
                        </div>
                    </div>
                    
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">2</div>
                            <div class="setup-step-title">${cheat.name} APK İndir</div>
                        </div>
                        <div class="setup-step-desc">
                            ${cheat.name} APK dosyasını indirin ve kurulum adımlarını takip edin.
                        </div>
                        ${cheat.apkUrl ? `
                            <div class="setup-step-action">
                                <button class="btn btn-secondary btn-small" onclick="downloadDynamicApk('${cheat.apkUrl}')">
                                    📥 APK İndir
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="setup-step" style="border-color: #4CAF50;">
                        <div class="setup-step-header">
                            <div class="setup-step-number" style="background: linear-gradient(135deg, #4CAF50, #45a049);">3</div>
                            <div class="setup-step-title">Oyuna Giriş Yap</div>
                        </div>
                        <div class="setup-step-desc">
                            Oyuna giriş yapın, key giriş ekranına geldiğinizde hesabım kısmındaki key'inizi kopyalayıp yapıştırın.
                        </div>
                    </div>
                `;
            }
        }
        
        // Satın al butonu güncelle
        document.getElementById('dynamicSelectedPrice').textContent = 'Fiyat seçin';
        
        navigateTo('dynamicCheatPage');
    }
    
    // Dinamik video modalını aç
    function openDynamicVideoModal() {
        if (window.currentCheatVideoUrl) {
            // YouTube video ID'sini çıkar
            const videoId = extractYouTubeId(window.currentCheatVideoUrl);
            if (videoId) {
                openYouTubeVideo(videoId);
            } else {
                // Direkt URL aç
                window.open(window.currentCheatVideoUrl, '_blank');
            }
        }
    }
    
    // YouTube video ID çıkarma
    function extractYouTubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }
    
    // Dinamik APK indirme
    function downloadDynamicApk(url) {
        if (url) {
            window.open(url, '_blank');
        } else {
            showToast('⚠️ İndirme linki bulunamadı!');
        }
    }
    
    // Dinamik fiyat seçimi
    function selectDynamicPrice(index) {
        // Giriş kontrolü
        if (!requireLogin('satın alma işlemi yapmak')) return;
        
        const prices = currentDynamicCheat?.prices || [];
        if (index < 0 || index >= prices.length) return;
        
        selectedDynamicPrice = prices[index];
        
        // UI güncelle
        document.querySelectorAll('#dynamicCheatPrices .price-card').forEach((card, i) => {
            card.classList.toggle('selected', i === index);
        });
        
        document.getElementById('dynamicSelectedPrice').textContent = `${selectedDynamicPrice.label} - ${selectedDynamicPrice.price}`;
    }
    
    // Dinamik satın alma modalını aç
    function openDynamicBuyModal() {
        if (!requireLogin('satın alma işlemi yapmak')) return;
        
        if (!selectedDynamicPrice) {
            showToast('⚠️ Lütfen bir fiyat seçin!');
            return;
        }
        
        // Sipariş için bilgileri kaydet
        window.pendingDynamicOrder = {
            game: currentDynamicGame.name,
            gameId: currentDynamicGame.id,
            cheat: currentDynamicCheat.name,
            cheatId: currentDynamicCheat.id,
            days: selectedDynamicPrice.days,
            label: selectedDynamicPrice.label,
            price: selectedDynamicPrice.price
        };
        
        // Merkezi ödeme sistemini kullan
        openUnifiedPaymentModal({
            type: 'purchase',
            game: currentDynamicGame.name,
            cheat: currentDynamicCheat.name,
            gameId: currentDynamicGame.id,
            cheatId: currentDynamicCheat.id,
            package: selectedDynamicPrice.days,
            packageName: `${currentDynamicCheat.name} - ${selectedDynamicPrice.label}`,
            price: selectedDynamicPrice.price,
            days: selectedDynamicPrice.days,
            shopierLink: selectedDynamicPrice.shopierLink || null
        });
    }
    
    // Dinamik ödeme yöntemi seç (eski - geriye uyumluluk)
    function selectDynamicPaymentMethod(method) {
        closeModal('dynamicPaymentModal');
        const order = window.pendingDynamicOrder;
        
        if (method === 'shopier') {
            // Kredi kartı geçici olarak devre dışı
            showToast('⚠️ Kredi kartı ile ödeme yakında aktif olacak!');
            return;
        } else if (method === 'havale') {
            // Havale bilgilerini göster
            const havalePackageInfo = document.getElementById('havalePackageInfo');
            const havaleAmount = document.getElementById('havaleAmount');
            
            if (havalePackageInfo && havaleAmount && order) {
                havalePackageInfo.textContent = `${order.cheat} - ${order.label}`;
                havaleAmount.textContent = order.price;
            }
            
            // Dinamik sipariş bilgisini global olarak sakla (dekont gönderildiğinde kullanılacak)
            window.isDynamicOrder = true;
            
            openModal('havaleModal');
            // NOT: Sipariş, dekont yüklendikten ve gönder butonuna basıldıktan sonra kaydedilecek
        }
    }
    
    // Dinamik sipariş kaydet
    async function saveDynamicOrder(paymentMethod) {
        const order = window.pendingDynamicOrder;
        if (!order || !currentUser) return;
        
        try {
            const orderData = {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                game: order.game,
                gameId: order.gameId,
                cheat: order.cheat,
                cheatId: order.cheatId,
                days: order.days,
                packageName: `${order.cheat} - ${order.label}`,
                label: order.label,
                price: order.price,
                paymentMethod: paymentMethod,
                status: 'pending',
                createdAt: new Date()
            };
            
            await db.collection('orders').add(orderData);
            updateOrderBadge();
            
            // Fiyat seçimini sıfırla
            selectedDynamicPrice = null;
            document.querySelectorAll('#dynamicCheatPrices .price-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('dynamicSelectedPrice').textContent = 'Fiyat seçin';
            
            // Başarı modalını göster
            showOrderSuccessModal();
            
        } catch(e) {
            console.error('Sipariş hatası:', e);
            showToast('❌ Sipariş gönderilemedi: ' + e.message);
        }
    }
    
    // Hile durum badge'lerini güncelle (kullanıcı tarafı)
    function updateCheatStatusBadges() {
        // TheBestML için
        const thebestmlBadge = document.getElementById('thebestmlStatusBadge');
        if (thebestmlBadge && gamesData.mobile_legends?.cheats?.thebestml) {
            const cheat = gamesData.mobile_legends.cheats.thebestml;
            const version = cheat.version || 'V2.8';
            
            if (cheat.status === 'maintenance') {
                thebestmlBadge.textContent = `${version} • 🔧 Bakımda`;
                thebestmlBadge.style.background = 'linear-gradient(135deg, #FF9800, #F57C00)';
            } else if (cheat.status === 'inactive') {
                thebestmlBadge.textContent = `${version} • ⏸️ Pasif`;
                thebestmlBadge.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';
            } else {
                thebestmlBadge.textContent = `${version} • Aktif`;
                thebestmlBadge.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            }
        }
    }
    
    // Hile sayfasına girince durumu kontrol et
    function checkCheatStatus(gameId, cheatId) {
        const cheat = gamesData[gameId]?.cheats?.[cheatId];
        if (!cheat) return;
        
        const maintenanceWarning = document.getElementById('cheatMaintenanceWarning');
        const inactiveWarning = document.getElementById('cheatInactiveWarning');
        
        // Önce tüm uyarıları gizle
        if (maintenanceWarning) maintenanceWarning.style.display = 'none';
        if (inactiveWarning) inactiveWarning.style.display = 'none';
        
        if (cheat.status === 'maintenance') {
            if (maintenanceWarning) maintenanceWarning.style.display = 'block';
        } else if (cheat.status === 'inactive') {
            if (inactiveWarning) inactiveWarning.style.display = 'block';
        }
    }
    
    // Veritabanına kaydet
    async function saveGamesData() {
        try {
            await db.collection('settings').doc('gamesData').set({ games: gamesData });
            updateCheatStatusBadges(); // Kayıt sonrası badge'leri güncelle
            return true;
        } catch(e) {
            console.error('Kaydetme hatası:', e);
            showToast('❌ Kaydetme hatası: ' + e.message);
            return false;
        }
    }
    
    // Tüm oyun selectlerini güncelle
    function updateGameSelects() {
        const selects = ['adminGame', 'cheatGameSelect'];
        
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = '<option value="">🎮 Oyun Seçin...</option>';
                Object.keys(gamesData).forEach(gameId => {
                    const game = gamesData[gameId];
                    if (game.status === 'active') {
                        select.innerHTML += `<option value="${gameId}">🎮 ${game.name}</option>`;
                    }
                });
            }
        });
    }
    
    // Oyun seçilince hileleri güncelle
    function updateCheatOptions() {
        const gameSelect = document.getElementById('adminGame');
        const cheatSelect = document.getElementById('adminCheat');
        const selectedGameId = gameSelect.value;
        
        if (!selectedGameId || !gamesData[selectedGameId]) {
            cheatSelect.innerHTML = '<option value="">🛡️ Önce oyun seçin...</option>';
            cheatSelect.disabled = true;
            return;
        }
        
        const cheats = gamesData[selectedGameId].cheats || {};
        cheatSelect.innerHTML = '';
        
        const cheatIds = Object.keys(cheats);
        if (cheatIds.length === 0) {
            cheatSelect.innerHTML = '<option value="">🛡️ Bu oyun için hile yok</option>';
            cheatSelect.disabled = true;
        } else {
            cheatIds.forEach(cheatId => {
                const cheat = cheats[cheatId];
                if (cheat.status === 'active') {
                    cheatSelect.innerHTML += `<option value="${cheatId}">🛡️ ${cheat.name}</option>`;
                }
            });
            cheatSelect.disabled = false;
        }
    }
    
    // ==================== OYUN MODAL FONKSİYONLARI ====================
    
    function openGameModal(gameId = null) {
        if (!requirePermission('games', 'oyun eklemek/düzenlemek')) return;
        
        document.getElementById('editGameId').value = gameId || '';
        document.getElementById('gameModalTitle').textContent = gameId ? '🎮 Oyun Düzenle' : '🎮 Yeni Oyun Ekle';
        
        // Görsel input'ları temizle
        document.getElementById('gameImageFile').value = '';
        document.getElementById('gameImageData').value = '';
        document.getElementById('gameImageLabel').textContent = '📷 Görsel Seç (PNG, JPG)';
        
        if (gameId && gamesData[gameId]) {
            const game = gamesData[gameId];
            document.getElementById('gameNameInput').value = game.name || '';
            document.getElementById('gameImageData').value = game.image || '';
            document.getElementById('gameDescInput').value = game.desc || '';
            document.getElementById('gamePlayStoreInput').value = game.playStore || '';
            document.getElementById('gameStatusInput').value = game.status || 'active';
            
            // Mevcut görsel varsa göster
            if (game.image) {
                document.getElementById('gameImagePreview').innerHTML = `
                    <img src="${game.image}" style="max-width: 100px; max-height: 100px; border-radius: 15px;">
                    <div style="font-size: 11px; color: #4CAF50; margin-top: 5px;">✅ Mevcut görsel</div>
                `;
                document.getElementById('gameImageLabel').textContent = '📷 Yeni Görsel Seç (değiştirmek için)';
            } else {
                document.getElementById('gameImagePreview').innerHTML = '';
            }
        } else {
            document.getElementById('gameNameInput').value = '';
            document.getElementById('gameDescInput').value = '';
            document.getElementById('gamePlayStoreInput').value = '';
            document.getElementById('gameStatusInput').value = 'active';
            document.getElementById('gameImagePreview').innerHTML = '';
        }
        
        openModal('gameModal');
    }
    
    // Dosya önizleme - Oyun
    function previewGameImageFile(input) {
        const file = input.files[0];
        if (!file) return;
        
        // Dosya boyut kontrolü (2MB)
        if (file.size > 2 * 1024 * 1024) {
            showToast('❌ Dosya çok büyük (max 2MB)');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64 = e.target.result;
            document.getElementById('gameImageData').value = base64;
            document.getElementById('gameImagePreview').innerHTML = `
                <img src="${base64}" style="max-width: 100px; max-height: 100px; border-radius: 15px;">
                <div style="font-size: 11px; color: #4CAF50; margin-top: 5px;">✅ ${file.name}</div>
            `;
            document.getElementById('gameImageLabel').textContent = '📷 ' + file.name;
        };
        reader.readAsDataURL(file);
    }
    
    function previewGameImage() {
        // Artık kullanılmıyor - dosya yükleme kullanılıyor
    }
    
    async function saveGame() {
        if (!requirePermission('games', 'oyun kaydetmek')) return;
        
        const gameId = document.getElementById('editGameId').value;
        const name = document.getElementById('gameNameInput').value.trim();
        const image = document.getElementById('gameImageData').value.trim();
        const desc = document.getElementById('gameDescInput').value.trim();
        const playStore = document.getElementById('gamePlayStoreInput').value.trim();
        const status = document.getElementById('gameStatusInput').value;
        
        if (!name) { showToast('❌ Oyun adı girin'); return; }
        
        // ID oluştur veya mevcut ID'yi kullan
        const newGameId = gameId || name.toLowerCase().replace(/[^a-z0-9]/g, '_');
        
        if (!gameId && gamesData[newGameId]) {
            showToast('⚠️ Bu isimde bir oyun zaten var');
            return;
        }
        
        // Mevcut görsel varsa ve yeni yüklenmemişse eski görseli koru
        const existingImage = gamesData[newGameId]?.image || '';
        const finalImage = image || existingImage;
        
        gamesData[newGameId] = {
            ...gamesData[newGameId],
            name, 
            image: finalImage, 
            desc, playStore, status,
            cheats: gamesData[newGameId]?.cheats || {}
        };
        
        if (await saveGamesData()) {
            showToast('✅ Oyun kaydedildi!');
            closeModal('gameModal');
            updateGameSelects();
            loadGameCheatList();
            renderHomeGames(); // Ana sayfayı anında güncelle
            
            // Eğer oyun detay sayfası açıksa onu da güncelle
            if (currentDynamicGame && currentDynamicGame.id === newGameId) {
                currentDynamicGame = { id: newGameId, ...gamesData[newGameId] };
                document.getElementById('dynamicGameIcon').src = finalImage || '';
                document.getElementById('dynamicGameTitle').textContent = name;
                document.getElementById('dynamicGameDesc').textContent = desc || 'Oyun hileleri';
            }
        }
    }
    
    // ==================== HİLE MODAL FONKSİYONLARI ====================
    
    let currentPrices = []; // Dinamik fiyat listesi
    
    function openCheatModal(gameId = null, cheatId = null) {
        if (!requirePermission('games', 'hile eklemek/düzenlemek')) return;
        
        document.getElementById('editCheatId').value = cheatId || '';
        document.getElementById('editCheatGameId').value = gameId || '';
        document.getElementById('cheatModalTitle').textContent = cheatId ? '🛡️ Hile Düzenle' : '🛡️ Yeni Hile Ekle';
        
        // Oyun selectini güncelle
        const gameSelect = document.getElementById('cheatGameSelect');
        gameSelect.innerHTML = '<option value="">Oyun seçin...</option>';
        Object.keys(gamesData).forEach(gId => {
            const game = gamesData[gId];
            gameSelect.innerHTML += `<option value="${gId}" ${gId === gameId ? 'selected' : ''}>${game.name}</option>`;
        });
        
        // Görsel input'ları temizle
        document.getElementById('cheatImageFile').value = '';
        document.getElementById('cheatImageData').value = '';
        document.getElementById('cheatImageLabel').textContent = '📷 Görsel Seç (PNG, JPG)';
        
        if (cheatId && gameId && gamesData[gameId]?.cheats?.[cheatId]) {
            const cheat = gamesData[gameId].cheats[cheatId];
            document.getElementById('cheatNameInput').value = cheat.name || '';
            document.getElementById('cheatImageData').value = cheat.image || '';
            document.getElementById('cheatVersionInput').value = cheat.version || '';
            document.getElementById('cheatDescInput').value = cheat.desc || '';
            document.getElementById('cheatApkInput').value = cheat.apkUrl || '';
            document.getElementById('cheatVideoInput').value = cheat.videoUrl || '';
            document.getElementById('cheatFeaturesInput').value = (cheat.features || []).join('\n');
            document.getElementById('cheatStatusInput').value = cheat.status || 'active';
            
            // Fiyatları yükle - eski format (object) veya yeni format (array) desteği
            if (Array.isArray(cheat.prices)) {
                currentPrices = [...cheat.prices];
            } else if (cheat.prices && typeof cheat.prices === 'object') {
                // Eski format: { '1': '220₺', '30': '850₺', ... } -> yeni formata çevir
                currentPrices = Object.entries(cheat.prices).map(([days, price]) => ({
                    days: days,
                    label: days === 'unlimited' ? 'Sınırsız' : `${days} Gün`,
                    price: price
                }));
            } else {
                currentPrices = [];
            }
            renderPriceOptions();
            
            // Mevcut görsel varsa göster
            if (cheat.image) {
                document.getElementById('cheatImagePreview').innerHTML = `
                    <img src="${cheat.image}" style="max-width: 80px; max-height: 80px; border-radius: 12px;">
                    <div style="font-size: 11px; color: #4CAF50; margin-top: 5px;">✅ Mevcut görsel</div>
                `;
                document.getElementById('cheatImageLabel').textContent = '📷 Yeni Görsel Seç (değiştirmek için)';
            } else {
                document.getElementById('cheatImagePreview').innerHTML = '';
            }
        } else {
            document.getElementById('cheatNameInput').value = '';
            document.getElementById('cheatVersionInput').value = '';
            document.getElementById('cheatDescInput').value = '';
            document.getElementById('cheatApkInput').value = '';
            document.getElementById('cheatVideoInput').value = '';
            document.getElementById('cheatFeaturesInput').value = '';
            document.getElementById('cheatStatusInput').value = 'active';
            document.getElementById('cheatImagePreview').innerHTML = '';
            
            // Varsayılan fiyatlar
            currentPrices = [
                { days: '1', label: '1 Gün', price: '220₺' },
                { days: '30', label: '30 Gün', price: '850₺' },
                { days: '90', label: '90 Gün', price: '1800₺' },
                { days: 'unlimited', label: 'Sınırsız', price: '6500₺' }
            ];
            renderPriceOptions();
        }
        
        openModal('cheatModal');
    }
    
    // Dosya önizleme
    function previewCheatImageFile(input) {
        const file = input.files[0];
        if (!file) return;
        
        // Dosya boyut kontrolü (2MB)
        if (file.size > 2 * 1024 * 1024) {
            showToast('❌ Dosya çok büyük (max 2MB)');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64 = e.target.result;
            document.getElementById('cheatImageData').value = base64;
            document.getElementById('cheatImagePreview').innerHTML = `
                <img src="${base64}" style="max-width: 80px; max-height: 80px; border-radius: 12px;">
                <div style="font-size: 11px; color: #4CAF50; margin-top: 5px;">✅ ${file.name}</div>
            `;
            document.getElementById('cheatImageLabel').textContent = '📷 ' + file.name;
        };
        reader.readAsDataURL(file);
    }
    
    // Fiyat seçenekleri render
    function renderPriceOptions() {
        const container = document.getElementById('cheatPricesContainer');
        
        if (currentPrices.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 15px; color: #888; font-size: 12px;">Henüz fiyat eklenmemiş</div>';
            return;
        }
        
        let html = '';
        currentPrices.forEach((price, index) => {
            const isUnlimited = price.days === 'unlimited' || price.days === 'sınırsız';
            html += `
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 10px;">
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                        <input type="text" class="auth-input" placeholder="Gün" value="${isUnlimited ? 'Sınırsız' : price.days}" 
                            onchange="updatePriceOption(${index}, 'days', this.value)" 
                            style="width: 70px; text-align: center; font-size: 12px;">
                        <input type="text" class="auth-input" placeholder="Etiket" value="${price.label || ''}" 
                            onchange="updatePriceOption(${index}, 'label', this.value)" 
                            style="flex: 1; font-size: 12px;">
                        <input type="text" class="auth-input" placeholder="Fiyat" value="${price.price || ''}" 
                            onchange="updatePriceOption(${index}, 'price', this.value)" 
                            style="width: 80px; text-align: center; font-size: 12px;">
                        <button onclick="removePriceOption(${index})" style="background: #f44336; border: none; color: #fff; padding: 8px 10px; border-radius: 8px; cursor: pointer; font-size: 12px;">🗑️</button>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="font-size: 11px; color: #888; white-space: nowrap;">🛒 Shopier:</span>
                        <input type="text" class="auth-input" placeholder="https://www.shopier.com/CheatsStore/..." value="${price.shopierLink || ''}" 
                            onchange="updatePriceOption(${index}, 'shopierLink', this.value)" 
                            style="flex: 1; font-size: 11px; padding: 8px;">
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function addPriceOption() {
        currentPrices.push({ days: '', label: '', price: '', shopierLink: '' });
        renderPriceOptions();
    }
    
    function updatePriceOption(index, field, value) {
        if (currentPrices[index]) {
            currentPrices[index][field] = value;
        }
    }
    
    function removePriceOption(index) {
        currentPrices.splice(index, 1);
        renderPriceOptions();
    }
    
    function previewCheatImage() {
        // Artık kullanılmıyor - dosya yükleme kullanılıyor
    }
    
    async function saveCheat() {
        if (!requirePermission('games', 'hile eklemek/düzenlemek')) return;
        
        const cheatId = document.getElementById('editCheatId').value;
        const originalGameId = document.getElementById('editCheatGameId').value;
        const gameId = document.getElementById('cheatGameSelect').value;
        const name = document.getElementById('cheatNameInput').value.trim();
        const image = document.getElementById('cheatImageData').value.trim();
        const version = document.getElementById('cheatVersionInput').value.trim();
        const desc = document.getElementById('cheatDescInput').value.trim();
        const apkUrl = document.getElementById('cheatApkInput').value.trim();
        const videoUrl = document.getElementById('cheatVideoInput').value.trim();
        const featuresText = document.getElementById('cheatFeaturesInput').value.trim();
        const features = featuresText ? featuresText.split('\n').filter(f => f.trim()) : [];
        
        // Fiyatları al (boş olmayanları)
        const prices = currentPrices.filter(p => p.days && p.price);
        
        const status = document.getElementById('cheatStatusInput').value;
        
        if (!gameId) { showToast('❌ Oyun seçin'); return; }
        if (!name) { showToast('❌ Hile adı girin'); return; }
        
        // ID oluştur
        const newCheatId = cheatId || name.toLowerCase().replace(/[^a-z0-9]/g, '_');
        
        // Oyun değiştiyse eski yerden sil
        if (cheatId && originalGameId && originalGameId !== gameId) {
            delete gamesData[originalGameId].cheats[cheatId];
        }
        
        if (!gamesData[gameId].cheats) {
            gamesData[gameId].cheats = {};
        }
        
        // Mevcut görsel varsa ve yeni yüklenmemişse eski görseli koru
        const existingImage = gamesData[gameId].cheats[newCheatId]?.image || '';
        const finalImage = image || existingImage;
        
        gamesData[gameId].cheats[newCheatId] = {
            ...gamesData[gameId].cheats[newCheatId],
            name, 
            image: finalImage, 
            version, desc, apkUrl, videoUrl, features, 
            prices, 
            status,
            setupSteps: gamesData[gameId].cheats[newCheatId]?.setupSteps || []
        };
        
        if (await saveGamesData()) {
            showToast('✅ Hile kaydedildi!');
            closeModal('cheatModal');
            updateGameSelects();
            loadGameCheatList();
            renderHomeGames(); // Ana sayfayı anında güncelle
            
            // Eğer bu hilenin detay sayfası açıksa onu da güncelle
            if (currentDynamicCheat && currentDynamicCheat.id === newCheatId) {
                const updatedCheat = gamesData[gameId].cheats[newCheatId];
                currentDynamicCheat = { id: newCheatId, gameId, ...updatedCheat };
                
                // Sayfa elemanlarını güncelle
                document.getElementById('dynamicCheatIcon').src = finalImage || '';
                document.getElementById('dynamicCheatTitle').textContent = name;
                document.getElementById('dynamicCheatSubtitle').textContent = `${gamesData[gameId].name} • ${version || ''}`;
                
                // Özellikleri güncelle
                const featuresDiv = document.getElementById('dynamicCheatFeatures');
                featuresDiv.innerHTML = features.map(f => `<div class="feature-item-new">${f}</div>`).join('');
                
                // Fiyatları güncelle
                const pricesDiv = document.getElementById('dynamicCheatPrices');
                pricesDiv.innerHTML = prices.map((p, i) => `
                    <div class="price-card ${i === prices.length - 1 ? 'premium' : ''}" onclick="selectDynamicPrice(${i})">
                        <div class="price-label">${p.label}</div>
                        <div class="price-value">${p.price}</div>
                    </div>
                `).join('');
                
                // Video butonunu güncelle
                const videoSection = document.getElementById('dynamicVideoSection');
                if (videoUrl) {
                    videoSection.style.display = 'block';
                    window.currentCheatVideoUrl = videoUrl;
                } else {
                    videoSection.style.display = 'none';
                }
            }
            
            // Eğer oyun detay sayfası açıksa hile listesini güncelle
            if (currentDynamicGame && currentDynamicGame.id === gameId) {
                openGameDetail(gameId);
            }
        }
    }
    
    // Hile modalından kurulum adımlarına geçiş
    function openSetupModalFromCheat() {
        const gameId = document.getElementById('cheatGameSelect').value;
        const cheatId = document.getElementById('editCheatId').value;
        
        if (!gameId) {
            showToast('❌ Önce oyun seçin');
            return;
        }
        
        if (!cheatId) {
            showToast('⚠️ Önce hileyi kaydedin, sonra kurulum adımları ekleyebilirsiniz');
            return;
        }
        
        closeModal('cheatModal');
        setTimeout(() => openSetupModal(gameId, cheatId), 300);
    }
    
    // ==================== KURULUM TALİMATLARI ====================
    
    let currentSetupSteps = [];
    
    function openSetupModal(gameId, cheatId) {
        if (!isAdmin()) { showToast('❌ Yetkiniz yok'); return; }
        
        document.getElementById('setupGameId').value = gameId;
        document.getElementById('setupCheatId').value = cheatId;
        
        const cheat = gamesData[gameId]?.cheats?.[cheatId];
        currentSetupSteps = cheat?.setupSteps ? [...cheat.setupSteps] : [];
        
        renderSetupSteps();
        openModal('setupModal');
    }
    
    function renderSetupSteps() {
        const container = document.getElementById('setupStepsContainer');
        
        if (currentSetupSteps.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">Henüz adım eklenmemiş. "Adım Ekle" butonuna tıklayın.</div>';
            return;
        }
        
        let html = '';
        currentSetupSteps.forEach((step, index) => {
            const actionType = step.actionType || 'none';
            
            html += `
                <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 3px solid #FF9800;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="background: #FF9800; color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">📌 Adım ${index + 1}</span>
                        <div style="display: flex; gap: 5px;">
                            ${index > 0 ? `<button onclick="moveSetupStep(${index}, -1)" style="background: #2196F3; border: none; color: #fff; padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer;">⬆️</button>` : ''}
                            ${index < currentSetupSteps.length - 1 ? `<button onclick="moveSetupStep(${index}, 1)" style="background: #2196F3; border: none; color: #fff; padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer;">⬇️</button>` : ''}
                            <button onclick="removeSetupStep(${index})" style="background: #f44336; border: none; color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer;">🗑️</button>
                        </div>
                    </div>
                    
                    <input type="text" class="auth-input" placeholder="Adım Başlığı (örn: Oyunu İndir)" value="${step.title || ''}" onchange="currentSetupSteps[${index}].title = this.value" style="margin-bottom: 8px;">
                    
                    <textarea class="auth-input" placeholder="Adım açıklaması (örn: Play Store'dan orijinal oyunu indirin...)" onchange="currentSetupSteps[${index}].description = this.value" style="height: 60px; resize: none; margin-bottom: 10px;">${step.description || step.desc || ''}</textarea>
                    
                    <!-- Buton Türü -->
                    <div style="background: rgba(33,150,243,0.1); border: 1px solid rgba(33,150,243,0.3); border-radius: 8px; padding: 10px; margin-bottom: 8px;">
                        <label style="font-size: 11px; color: #2196F3; display: block; margin-bottom: 5px;">🔘 Buton Türü</label>
                        <select class="auth-input" style="color: #fff; margin-bottom: 8px;" onchange="updateStepActionType(${index}, this.value)">
                            <option value="none" ${actionType === 'none' ? 'selected' : ''}>Buton Yok</option>
                            <option value="playstore" ${actionType === 'playstore' ? 'selected' : ''}>🎮 Play Store</option>
                            <option value="download" ${actionType === 'download' ? 'selected' : ''}>📥 APK İndir</option>
                            <option value="link" ${actionType === 'link' ? 'selected' : ''}>🔗 Özel Link</option>
                            <option value="modal" ${actionType === 'modal' ? 'selected' : ''}>📖 Bilgi Modalı</option>
                        </select>
                        
                        <!-- Koşullu alanlar -->
                        <div id="stepAction_${index}">
                            ${renderStepActionFields(index, step)}
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function renderStepActionFields(index, step) {
        const actionType = step.actionType || 'none';
        
        if (actionType === 'none') {
            return '';
        }
        
        if (actionType === 'playstore') {
            return `<div style="font-size: 11px; color: #4CAF50; padding: 8px; background: rgba(76,175,80,0.1); border-radius: 6px;">✅ Play Store butonu otomatik eklenecek</div>`;
        }
        
        if (actionType === 'download') {
            return `
                <input type="text" class="auth-input" placeholder="APK İndirme Linki (https://...)" value="${step.downloadUrl || ''}" onchange="currentSetupSteps[${index}].downloadUrl = this.value">
            `;
        }
        
        if (actionType === 'link') {
            return `
                <input type="text" class="auth-input" placeholder="Buton Yazısı (örn: Detaylı Bilgi)" value="${step.btnText || ''}" onchange="currentSetupSteps[${index}].btnText = this.value" style="margin-bottom: 5px;">
                <input type="text" class="auth-input" placeholder="Link URL (https://...)" value="${step.btnUrl || ''}" onchange="currentSetupSteps[${index}].btnUrl = this.value">
            `;
        }
        
        if (actionType === 'modal') {
            // Dinamik modal seçenekleri oluştur
            let modalOptions = `
                <option value="">Modal Seçin...</option>
                <option value="imguiModal" ${step.modalId === 'imguiModal' ? 'selected' : ''}>📖 IMGUI Kurulum (Varsayılan)</option>
                <option value="certModal" ${step.modalId === 'certModal' ? 'selected' : ''}>🔒 Sertifika Kapatma</option>
            `;
            
            // Dinamik oluşturulan modalleri ekle
            Object.entries(setupModals || {}).forEach(([id, modal]) => {
                modalOptions += `<option value="${id}" ${step.modalId === id ? 'selected' : ''}>📖 ${modal.title || id}</option>`;
            });
            
            return `
                <select class="auth-input" style="color: #fff;" onchange="currentSetupSteps[${index}].modalId = this.value">
                    ${modalOptions}
                </select>
                <div style="font-size: 10px; color: #888; margin-top: 5px;">💡 Admin Panel → Kurulum Modalları'ndan yeni modal oluşturabilirsiniz</div>
            `;
        }
        
        return '';
    }
    
    function updateStepActionType(index, actionType) {
        currentSetupSteps[index].actionType = actionType;
        // Eski değerleri temizle
        delete currentSetupSteps[index].downloadUrl;
        delete currentSetupSteps[index].btnText;
        delete currentSetupSteps[index].btnUrl;
        delete currentSetupSteps[index].modalId;
        renderSetupSteps();
    }
    
    function moveSetupStep(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= currentSetupSteps.length) return;
        
        const temp = currentSetupSteps[index];
        currentSetupSteps[index] = currentSetupSteps[newIndex];
        currentSetupSteps[newIndex] = temp;
        renderSetupSteps();
    }
    
    function addSetupStep() {
        currentSetupSteps.push({ title: '', description: '', actionType: 'none' });
        renderSetupSteps();
    }
    
    function removeSetupStep(index) {
        if (confirm('Bu adımı silmek istiyor musunuz?')) {
            currentSetupSteps.splice(index, 1);
            renderSetupSteps();
        }
    }
    
    async function saveSetupSteps() {
        if (!requirePermission('games', 'kurulum adımlarını düzenlemek')) return;
        
        const gameId = document.getElementById('setupGameId').value;
        const cheatId = document.getElementById('setupCheatId').value;
        
        if (!gamesData[gameId]?.cheats?.[cheatId]) {
            showToast('❌ Hile bulunamadı');
            return;
        }
        
        // description alanını desc olarak da kaydet (uyumluluk için)
        currentSetupSteps.forEach(step => {
            if (step.description && !step.desc) {
                step.desc = step.description;
            }
        });
        
        gamesData[gameId].cheats[cheatId].setupSteps = currentSetupSteps;
        
        if (await saveGamesData()) {
            showToast('✅ Kurulum adımları kaydedildi!');
            closeModal('setupModal');
            loadGameCheatList();
            
            // ===== GERÇEK ZAMANLI GÜNCELLEMELERİ UYGULA =====
            
            // Hile detay sayfası açıksa kurulum adımlarını güncelle
            if (currentDynamicCheat && currentDynamicCheat.id === cheatId) {
                currentDynamicCheat.setupSteps = [...currentSetupSteps];
                
                const stepsContainer = document.getElementById('dynamicSetupSteps');
                if (stepsContainer) {
                    let stepsHtml = '';
                    currentSetupSteps.forEach((step, index) => {
                        const description = step.description || step.desc || '';
                        stepsHtml += `
                            <div style="display: flex; gap: 12px; padding: 12px; background: #1a1a1a; border-radius: 12px; margin-bottom: 8px;">
                                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">
                                    ${index + 1}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">${step.title || 'Adım ' + (index + 1)}</div>
                                    <div style="font-size: 13px; color: #aaa; line-height: 1.4;">${description}</div>
                                    ${renderStepButton(step)}
                                </div>
                            </div>
                        `;
                    });
                    stepsContainer.innerHTML = stepsHtml || '<p style="text-align: center; color: #666;">Kurulum adımı yok</p>';
                }
            }
        }
    }
    
    // Adım butonunu render et
    function renderStepButton(step) {
        const actionType = step.actionType || 'none';
        
        if (actionType === 'playstore' && step.btnUrl) {
            return `<button onclick="window.open('${step.btnUrl}', '_system')" style="margin-top: 8px; padding: 8px 16px; background: linear-gradient(135deg, #34a853, #0f9d58); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                <i class="fab fa-google-play"></i> ${step.btnText || 'Play Store\'da Aç'}
            </button>`;
        } else if (actionType === 'download' && step.downloadUrl) {
            return `<button onclick="window.open('${step.downloadUrl}', '_system')" style="margin-top: 8px; padding: 8px 16px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                <i class="fas fa-download"></i> ${step.btnText || 'İndir'}
            </button>`;
        } else if (actionType === 'link' && step.btnUrl) {
            return `<button onclick="window.open('${step.btnUrl}', '_system')" style="margin-top: 8px; padding: 8px 16px; background: linear-gradient(135deg, #00b894, #00cec9); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                <i class="fas fa-external-link-alt"></i> ${step.btnText || 'Bağlantıya Git'}
            </button>`;
        } else if (actionType === 'modal' && step.modalId) {
            return `<button onclick="openModal('${step.modalId}')" style="margin-top: 8px; padding: 8px 16px; background: linear-gradient(135deg, #e17055, #d63031); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                <i class="fas fa-info-circle"></i> ${step.btnText || 'Detaylar'}
            </button>`;
        }
        
        return '';
    }
    
    // ==================== SİLME FONKSİYONLARI ====================
    
    async function deleteGame(gameId) {
        if (!requirePermission('games', 'oyun silmek')) return;
        
        const game = gamesData[gameId];
        if (!game) return;
        
        const cheatCount = Object.keys(game.cheats || {}).length;
        if (!confirm(`"${game.name}" oyununu ve ${cheatCount} hilesini silmek istiyor musunuz?\n\nBu işlem geri alınamaz!`)) return;
        
        delete gamesData[gameId];
        
        if (await saveGamesData()) {
            showToast('✅ Oyun silindi!');
            updateGameSelects();
            loadGameCheatList();
            
            // ===== GERÇEK ZAMANLI GÜNCELLEMELERİ UYGULA =====
            renderHomeGames(); // Ana sayfayı güncelle
            
            // Silinen oyunun detay sayfası açıksa ana sayfaya dön
            if (currentDynamicGame && currentDynamicGame.id === gameId) {
                showPage('home');
                currentDynamicGame = null;
            }
        }
    }
    
    async function deleteCheat(gameId, cheatId) {
        if (!requirePermission('games', 'hile silmek')) return;
        
        const cheat = gamesData[gameId]?.cheats?.[cheatId];
        if (!cheat) return;
        
        if (!confirm(`"${cheat.name}" hilesini silmek istiyor musunuz?`)) return;
        
        delete gamesData[gameId].cheats[cheatId];
        
        if (await saveGamesData()) {
            showToast('✅ Hile silindi!');
            updateGameSelects();
            loadGameCheatList();
            
            // ===== GERÇEK ZAMANLI GÜNCELLEMELERİ UYGULA =====
            renderHomeGames(); // Ana sayfayı güncelle
            
            // Silinen hilenin detay sayfası açıksa oyun sayfasına dön
            if (currentDynamicCheat && currentDynamicCheat.id === cheatId) {
                if (currentDynamicGame) {
                    openGameDetail(currentDynamicGame.id);
                } else {
                    showPage('home');
                }
                currentDynamicCheat = null;
            }
            
            // Oyun sayfası açıksa hile listesini güncelle
            if (currentDynamicGame && currentDynamicGame.id === gameId) {
                openGameDetail(gameId);
            }
        }
    }
    
    // ==================== LİSTE GÖRÜNTÜLEME ====================
    
    function loadGameCheatList() {
        const container = document.getElementById('gameCheatList');
        if (!container) return;
        
        // Oyun/hile yönetimi yetkisi yoksa gösterme
        if (!hasPermission('games')) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Oyun/hile yönetimi yetkiniz yok</div>';
            return;
        }
        
        const gameIds = Object.keys(gamesData);
        
        if (gameIds.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Henüz oyun eklenmemiş</div>';
            return;
        }
        
        let html = '';
        
        gameIds.forEach(gameId => {
            const game = gamesData[gameId];
            const cheats = game.cheats || {};
            const cheatCount = Object.keys(cheats).length;
            const statusBadge = game.status === 'active' ? '🟢' : (game.status === 'coming' ? '🟡' : '🔴');
            
            html += `
                <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 12px; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        ${game.image ? `<img src="${game.image}" style="width: 40px; height: 40px; border-radius: 10px; object-fit: cover;" onerror="this.style.display='none'">` : ''}
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="color: #4CAF50; font-weight: bold;">${statusBadge} ${game.name}</span>
                                <span style="background: #2196F3; color: #fff; padding: 2px 6px; border-radius: 8px; font-size: 10px;">${cheatCount} hile</span>
                            </div>
                            <div style="font-size: 11px; color: #888;">${game.desc || 'Açıklama yok'}</div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="openGameModal('${gameId}')" style="background: #2196F3; border: none; color: #fff; padding: 5px 8px; border-radius: 6px; font-size: 10px; cursor: pointer;">✏️</button>
                            <button onclick="deleteGame('${gameId}')" style="background: #f44336; border: none; color: #fff; padding: 5px 8px; border-radius: 6px; font-size: 10px; cursor: pointer;">🗑️</button>
                        </div>
                    </div>
                    
                    <!-- Hileler -->
                    <div style="padding-left: 10px; border-left: 2px solid rgba(255,255,255,0.1);">
            `;
            
            Object.keys(cheats).forEach(cheatId => {
                const cheat = cheats[cheatId];
                const cheatStatus = cheat.status === 'active' ? '🟢' : (cheat.status === 'maintenance' ? '🟠' : '🔴');
                const hasSetup = (cheat.setupSteps || []).length > 0;
                const hasVideo = !!cheat.videoUrl;
                const featureCount = cheat.features?.length || 0;
                const priceCount = cheat.prices?.length || 0;
                
                html += `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        ${cheat.image ? `<img src="${cheat.image}" style="width: 30px; height: 30px; border-radius: 8px; object-fit: cover;" onerror="this.style.display='none'">` : '<span style="font-size: 20px;">🛡️</span>'}
                        <div style="flex: 1;">
                            <div style="color: #2196F3; font-size: 12px;">${cheatStatus} ${cheat.name} <span style="color: #888;">${cheat.version || ''}</span></div>
                            <div style="font-size: 10px; color: #666;">
                                ${featureCount} özellik • ${priceCount} fiyat • 
                                ${hasSetup ? '✅ Kurulum' : '⚠️ Kurulum yok'} • 
                                ${hasVideo ? '🎬 Video' : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 3px;">
                            <button onclick="openSetupModal('${gameId}', '${cheatId}')" style="background: #FF9800; border: none; color: #fff; padding: 4px 6px; border-radius: 5px; font-size: 9px; cursor: pointer;" title="Kurulum Adımları">📋</button>
                            <button onclick="openCheatModal('${gameId}', '${cheatId}')" style="background: #2196F3; border: none; color: #fff; padding: 4px 6px; border-radius: 5px; font-size: 9px; cursor: pointer;" title="Düzenle">✏️</button>
                            <button onclick="deleteCheat('${gameId}', '${cheatId}')" style="background: #f44336; border: none; color: #fff; padding: 4px 6px; border-radius: 5px; font-size: 9px; cursor: pointer;" title="Sil">🗑️</button>
                        </div>
                    </div>
                `;
            });
            
            if (cheatCount === 0) {
                html += `<div style="padding: 10px; color: #666; font-size: 11px; text-align: center;">Hile eklenmemiş</div>`;
            }
            
            html += `
                        <button onclick="openCheatModal('${gameId}')" style="width: 100%; margin-top: 8px; background: rgba(33,150,243,0.2); border: 1px dashed #2196F3; color: #2196F3; padding: 6px; border-radius: 6px; font-size: 11px; cursor: pointer;">➕ Hile Ekle</button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // Eski fonksiyonları kaldır - uyumluluk için boş bırak
    let gamesAndCheats = {};
    function addNewGame() { openGameModal(); }
    function addNewCheat() { openCheatModal(); }
    function deleteGameOrCheat() { }
    
    // Key Aktifle (SADECE KURUCU)
    async function activateKey() {
        if (!requirePermission('keys_add', 'key aktifleştirmek')) return;
        
        const email = document.getElementById('adminUserEmail').value.trim();
        const game = document.getElementById('adminGame').value;
        const cheat = document.getElementById('adminCheat').value;
        const days = parseInt(document.getElementById('adminPackage').value);
        let keyCode = document.getElementById('adminKeyCode').value.trim();
        
        if (!email) { showToast('❌ E-posta girin'); return; }
        if (!game) { showToast('❌ Oyun seçin'); return; }
        if (!cheat) { showToast('❌ Hile seçin'); return; }
        
        // Key kodu boşsa otomatik üret
        if (!keyCode) {
            keyCode = generateKeyCode();
        }
        
        try {
            showToast('⏳ Key aktifleştiriliyor...');
            
            // Kullanıcıyı bul
            const users = await db.collection('users').where('email', '==', email).get();
            if (users.empty) { showToast('❌ Kullanıcı bulunamadı'); return; }
            
            const userDoc = users.docs[0];
            const activatedAt = new Date();
            const expiresAt = new Date();
            expiresAt.setDate(expiresAt.getDate() + days);
            
            // Key ekle
            const userData = userDoc.data();
            const keys = userData.keys || [];
            keys.push({
                id: Date.now().toString(),
                keyCode: keyCode,
                game: game,
                cheat: cheat,
                days: days,
                activatedAt: activatedAt,
                expiresAt: expiresAt,
                activatedBy: currentUser.email
            });
            
            await db.collection('users').doc(userDoc.id).update({ keys });
            
            // Formu temizle
            document.getElementById('adminUserEmail').value = '';
            document.getElementById('adminKeyCode').value = '';
            
            // Başarı mesajı
            const packageLabel = days >= 365 ? 'Sınırsız' : days + ' Günlük';
            showNotification(`✅ Key aktifleştirildi!\n\n👤 ${email}\n🎮 ${game}\n🛡️ ${cheat}\n⏱️ ${packageLabel}\n🔑 ${keyCode}`);
            
            // Üye listesini yenile
            loadAllUsers();
        } catch(e) {
            console.error('Key aktifleştirme hatası:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Otomatik key kodu üretici
    function generateKeyCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = 'TB-';
        for (let i = 0; i < 4; i++) {
            for (let j = 0; j < 4; j++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            if (i < 3) code += '-';
        }
        return code;
    }
    
    // ==================== ÜYE YÖNETİMİ ====================
    
    // Tüm üyeleri yükle
    async function loadAllUsers() {
        if (!hasPermission('members_view')) {
            document.getElementById('usersListContainer').innerHTML = '<div style="text-align: center; padding: 20px; color: #aaa;">Bu özellik için yetkiniz yok</div>';
            return;
        }
        const container = document.getElementById('usersListContainer');
        const countEl = document.getElementById('totalUsersCount');
        
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #aaa;">⏳ Yükleniyor...</div>';
        
        try {
            const usersSnapshot = await db.collection('users').get();
            countEl.textContent = usersSnapshot.size;
            
            if (usersSnapshot.empty) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #aaa;">Henüz üye yok</div>';
                return;
            }
            
            const now = new Date();
            
            // Kullanıcıları admin ve normal olarak ayır
            let adminUsers = [];
            let normalUsers = [];
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const userId = doc.id;
                const email = user.email || 'E-posta yok';
                
                // Kurucu/Admin kontrolü
                const isUserOwner = email === OWNER_EMAIL;
                const isUserAdmin = isUserOwner || adminEmails.includes(email.toLowerCase());
                
                const userData = {
                    userId,
                    email,
                    user,
                    isAdmin: isUserAdmin,
                    isOwner: isUserOwner
                };
                
                if (isUserAdmin) {
                    adminUsers.push(userData);
                } else {
                    normalUsers.push(userData);
                }
            });
            
            // HTML oluştur
            let usersHtml = '';
            
            // Önce adminleri göster
            [...adminUsers, ...normalUsers].forEach(({ userId, email, user, isAdmin: isUserAdmin, isOwner: isUserOwner }) => {
                const keys = user.keys || [];
                
                // Aktif key sayısı
                const activeKeys = keys.filter(k => k.expiresAt && k.expiresAt.toDate() > now);
                const expiredKeys = keys.filter(k => k.expiresAt && k.expiresAt.toDate() <= now);
                
                // Durum belirleme
                let statusBadge = '';
                let statusIcon = '';
                if (activeKeys.length > 0) {
                    statusBadge = `<span style="background: #4CAF50; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 10px;">AKTİF</span>`;
                    statusIcon = '🟢';
                } else if (expiredKeys.length > 0) {
                    statusBadge = `<span style="background: #FF9800; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 10px;">DOLDU</span>`;
                    statusIcon = '🟠';
                } else {
                    statusBadge = `<span style="background: #9E9E9E; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 10px;">YENİ</span>`;
                    statusIcon = '⚪';
                }
                
                // Kurucu/Admin badge - Kurucu ve Admin için farklı etiket
                let roleBadge = '';
                if (isUserOwner) {
                    roleBadge = `<span style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">👑 KURUCU</span>`;
                } else if (isUserAdmin) {
                    roleBadge = `<span style="background: linear-gradient(135deg, #9C27B0, #7B1FA2); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">👮 ADMİN</span>`;
                }
                
                // Kayıt tarihi
                const createdAt = user.createdAt ? user.createdAt.toDate().toLocaleDateString('tr-TR') : 'Bilinmiyor';
                
                // Kurucu/Admin için özel border
                let cardStyle = 'background: rgba(255,255,255,0.05); border-radius: 10px; padding: 12px; margin-bottom: 8px; transition: all 0.2s;';
                if (isUserOwner) {
                    cardStyle = 'background: rgba(255,215,0,0.15); border: 1px solid rgba(255,215,0,0.4); border-radius: 10px; padding: 12px; margin-bottom: 8px; transition: all 0.2s;';
                } else if (isUserAdmin) {
                    cardStyle = 'background: rgba(156,39,176,0.15); border: 1px solid rgba(156,39,176,0.4); border-radius: 10px; padding: 12px; margin-bottom: 8px; transition: all 0.2s;';
                }
                
                usersHtml += `
                    <div style="${cardStyle}" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; cursor: pointer;" onclick="openUserDetail('${userId}')">>
                                <span style="font-size: 18px;">${isUserOwner ? '👑' : (isUserAdmin ? '👮' : statusIcon)}</span>
                                <div style="min-width: 0;">
                                    <div style="font-size: 13px; color: #fff; word-break: break-all;">${email}</div>
                                    <div style="font-size: 11px; color: #888; margin-top: 2px;">📅 ${createdAt} • 🔑 ${activeKeys.length} aktif, ${expiredKeys.length} dolmuş</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                ${roleBadge}
                                ${!isUserAdmin && !isUserOwner ? statusBadge : ''}
                                ${isOwner() && !isUserAdmin && !isUserOwner ? `<button onclick="event.stopPropagation(); deleteUser('${userId}', '${email}')" style="background: #f44336; border: none; color: #fff; padding: 4px 8px; border-radius: 5px; font-size: 10px; cursor: pointer; margin-left: 4px;" title="Üyeyi Sil">🗑️</button>` : ''}
                                <span style="color: #666;" onclick="openUserDetail('${userId}')">›</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = usersHtml;
        } catch(e) {
            console.error('Üye yükleme hatası:', e);
            container.innerHTML = `<div style="color: #f44336; text-align: center; padding: 20px;">Hata: ${e.message}</div>`;
        }
    }
    
    // Üye detay modal'ını aç
    async function openUserDetail(userId) {
        if (!hasPermission('members_view')) {
            showToast('❌ Üye görüntüleme yetkiniz yok');
            return;
        }
        const content = document.getElementById('userDetailContent');
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: #aaa;">⏳ Yükleniyor...</div>';
        openModal('userDetailModal');
        
        try {
            const userDoc = await db.collection('users').doc(userId).get();
            
            if (!userDoc.exists) {
                content.innerHTML = '<div style="color: #f44336; text-align: center; padding: 20px;">Üye bulunamadı</div>';
                return;
            }
            
            const user = userDoc.data();
            const email = user.email || 'E-posta yok';
            const keys = user.keys || [];
            const now = new Date();
            
            // Keyleri ayır
            const activeKeys = keys.filter(k => k.expiresAt && k.expiresAt.toDate() > now);
            const expiredKeys = keys.filter(k => k.expiresAt && k.expiresAt.toDate() <= now);
            
            // Kayıt tarihi
            const createdAt = user.createdAt ? user.createdAt.toDate().toLocaleString('tr-TR') : 'Bilinmiyor';
            const lastLogin = user.lastLogin ? user.lastLogin.toDate().toLocaleString('tr-TR') : 'Bilinmiyor';
            
            // Şifre (varsa) - Sadece kurucu görebilir
            const userPassword = user.password || 'Kayıtlı değil';
            const canSeePassword = isOwner();
            
            let html = `
                <!-- Üye Bilgileri -->
                <div style="background: rgba(33,150,243,0.1); border: 1px solid rgba(33,150,243,0.3); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <div style="font-size: 14px; font-weight: bold; color: #2196F3; margin-bottom: 12px;">📧 Üye Bilgileri</div>
                    <div style="display: grid; gap: 8px; font-size: 13px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #888;">E-posta:</span>
                            <span style="color: #fff; word-break: break-all;">${email}</span>
                        </div>
                        ${canSeePassword ? `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #888;">Şifre:</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span id="userPasswordField" style="color: #FF9800; font-family: monospace;">••••••••</span>
                                <button onclick="togglePasswordVisibility('${userPassword}')" style="background: #FF9800; border: none; color: #fff; padding: 3px 8px; border-radius: 5px; font-size: 10px; cursor: pointer;">👁️</button>
                                <button onclick="copyToClipboard('${userPassword}')" style="background: #2196F3; border: none; color: #fff; padding: 3px 8px; border-radius: 5px; font-size: 10px; cursor: pointer;">📋</button>
                            </div>
                        </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #888;">Kayıt Tarihi:</span>
                            <span style="color: #fff;">${createdAt}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #888;">Toplam Key:</span>
                            <span style="color: #fff;">${keys.length}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Hızlı İşlemler -->
                <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <button onclick="document.getElementById('adminUserEmail').value='${email}'; closeModal('userDetailModal'); showToast('📧 E-posta kopyalandı');" style="flex: 1; background: linear-gradient(135deg, #4CAF50, #388E3C); border: none; color: #fff; padding: 10px; border-radius: 8px; font-size: 12px; cursor: pointer;">🔑 Key Ekle</button>
                    <button onclick="copyToClipboard('${email}')" style="flex: 1; background: linear-gradient(135deg, #2196F3, #1976D2); border: none; color: #fff; padding: 10px; border-radius: 8px; font-size: 12px; cursor: pointer;">📋 E-posta Kopyala</button>
                </div>
                
                <!-- Üye Silme (Sadece kurucu görebilir, kurucu silinemez) -->
                ${isOwner() && email !== OWNER_EMAIL ? `
                <div style="margin-bottom: 15px;">
                    <button onclick="deleteUser('${userId}', '${email}')" style="width: 100%; background: linear-gradient(135deg, #f44336, #d32f2f); border: none; color: #fff; padding: 10px; border-radius: 8px; font-size: 12px; cursor: pointer;">🗑️ Üyeyi Sil</button>
                </div>
                ` : ''}
            `;
            
            // Aktif Keyler
            if (activeKeys.length > 0) {
                html += `
                    <div style="font-size: 14px; font-weight: bold; color: #4CAF50; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <span>✅ Aktif Keyler</span>
                        <span style="background: #4CAF50; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${activeKeys.length}</span>
                    </div>
                `;
                
                activeKeys.forEach((key, index) => {
                    const exp = key.expiresAt.toDate();
                    const activatedAt = key.activatedAt ? key.activatedAt.toDate() : new Date();
                    const totalDays = key.days || Math.ceil((exp - activatedAt) / (1000 * 60 * 60 * 24));
                    
                    const remainingMs = exp - now;
                    const remainingDays = Math.floor(remainingMs / (1000 * 60 * 60 * 24));
                    const remainingHours = Math.floor((remainingMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    
                    let remainingText = remainingDays > 0 ? `${remainingDays}g ${remainingHours}s` : `${remainingHours} saat`;
                    let packageLabel = totalDays >= 365 ? 'Sınırsız' : `${totalDays} Günlük`;
                    const keyCode = key.keyCode || key.code || '***';
                    const gameName = key.game || 'Mobile Legends';
                    const cheatName = key.cheat || 'TheBestML';
                    
                    html += `
                        <div style="background: rgba(76,175,80,0.1); border: 1px solid rgba(76,175,80,0.3); border-radius: 10px; padding: 12px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: bold; color: #4CAF50;">${packageLabel}</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 11px; color: #aaa;">⏱️ ${remainingText} kaldı</span>
                                    ${isOwner() ? `<button onclick="adminDeleteUserKey('${userId}', ${index}, '${keyCode}', 'active')" style="background: #f44336; border: none; color: #fff; padding: 3px 8px; border-radius: 5px; font-size: 10px; cursor: pointer;" title="Key'i Sil">🗑️</button>` : ''}
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #888; margin-bottom: 6px;">🎮 ${gameName} • 🛡️ ${cheatName}</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <code style="flex: 1; font-size: 11px; color: #4CAF50; word-break: break-all;">${keyCode}</code>
                                <button onclick="copyToClipboard('${keyCode}'); event.stopPropagation();" style="background: #4CAF50; border: none; color: #fff; padding: 4px 8px; border-radius: 5px; font-size: 10px; cursor: pointer;">📋</button>
                            </div>
                            <div style="font-size: 10px; color: #666; margin-top: 6px;">📅 Bitiş: ${exp.toLocaleDateString('tr-TR')}</div>
                        </div>
                    `;
                });
            }
            
            // Süresi Dolmuş Keyler
            if (expiredKeys.length > 0) {
                html += `
                    <div style="font-size: 14px; font-weight: bold; color: #f44336; margin: 15px 0 10px 0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>❌ Süresi Dolmuş</span>
                            <span style="background: #f44336; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${expiredKeys.length}</span>
                        </div>
                        ${isOwner() ? `<button onclick="adminDeleteAllExpiredKeys('${userId}')" style="background: #ff5722; border: none; color: #fff; padding: 5px 10px; border-radius: 6px; font-size: 10px; cursor: pointer;">🗑️ Tümünü Sil</button>` : ''}
                    </div>
                `;
                
                expiredKeys.forEach((key, index) => {
                    const exp = key.expiresAt.toDate();
                    const activatedAt = key.activatedAt ? key.activatedAt.toDate() : new Date();
                    const totalDays = key.days || Math.ceil((exp - activatedAt) / (1000 * 60 * 60 * 24));
                    
                    const expiredMs = now - exp;
                    const expiredDays = Math.floor(expiredMs / (1000 * 60 * 60 * 24));
                    let expiredText = expiredDays > 0 ? `${expiredDays} gün önce` : 'Bugün';
                    
                    let packageLabel = totalDays >= 365 ? 'Sınırsız' : `${totalDays} Günlük`;
                    const keyCode = key.keyCode || key.code || '***';
                    const gameName = key.game || 'Mobile Legends';
                    const cheatName = key.cheat || 'TheBestML';
                    
                    // Expired key için gerçek index bulmak için aktif key sayısını ekle
                    const realIndex = activeKeys.length + index;
                    
                    html += `
                        <div style="background: rgba(244,67,54,0.1); border: 1px solid rgba(244,67,54,0.3); border-radius: 10px; padding: 12px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: bold; color: #f44336;">${packageLabel}</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 11px; color: #888;">⏰ ${expiredText} bitti</span>
                                    ${isOwner() ? `<button onclick="adminDeleteUserKey('${userId}', ${realIndex}, '${keyCode}', 'expired')" style="background: #ff5722; border: none; color: #fff; padding: 3px 8px; border-radius: 5px; font-size: 10px; cursor: pointer;" title="Key'i Sil">🗑️</button>` : ''}
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 6px;">🎮 ${gameName} • 🛡️ ${cheatName}</div>
                            <code style="font-size: 11px; color: #888; word-break: break-all;">${keyCode}</code>
                            <div style="font-size: 10px; color: #666; margin-top: 6px;">📅 Bitti: ${exp.toLocaleDateString('tr-TR')}</div>
                        </div>
                    `;
                });
            }
            
            // Key yoksa
            if (keys.length === 0) {
                html += `
                    <div style="text-align: center; padding: 30px; color: #888;">
                        <div style="font-size: 40px; margin-bottom: 10px;">🔑</div>
                        <div>Bu üyenin henüz key'i yok</div>
                    </div>
                `;
            }
            
            // Üyenin siparişlerini göster
            const ordersSnapshot = await db.collection('orders').where('userId', '==', userId).get();
            
            if (!ordersSnapshot.empty) {
                let orderList = [];
                ordersSnapshot.forEach(doc => orderList.push({ id: doc.id, ...doc.data() }));
                orderList.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
                
                html += `
                    <div style="font-size: 14px; font-weight: bold; color: #FF9800; margin: 15px 0 10px 0; display: flex; align-items: center; gap: 8px;">
                        <span>📦 Siparişler</span>
                        <span style="background: #FF9800; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${orderList.length}</span>
                    </div>
                `;
                
                orderList.forEach(order => {
                    const date = order.createdAt.toDate().toLocaleDateString('tr-TR');
                    let statusText = '', statusColor = '';
                    
                    if (order.status === 'pending') {
                        statusText = '⏳ Beklemede';
                        statusColor = '#FF9800';
                    } else if (order.status === 'approved') {
                        statusText = '✅ Onaylandı';
                        statusColor = '#4CAF50';
                    } else {
                        statusText = '❌ Reddedildi';
                        statusColor = '#f44336';
                    }
                    
                    html += `
                        <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px; margin-bottom: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 12px; color: #fff;">${order.packageName}</div>
                                    <div style="font-size: 11px; color: #888;">📅 ${date}</div>
                                </div>
                                <span style="color: ${statusColor}; font-size: 11px;">${statusText}</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Aktivite Logları (Silinen Keyler vs)
            const activityLog = user.activityLog || [];
            if (activityLog.length > 0) {
                // Tarihe göre sırala (en yeni en üstte)
                activityLog.sort((a, b) => {
                    const dateA = a.deletedAt ? a.deletedAt.toDate() : new Date(0);
                    const dateB = b.deletedAt ? b.deletedAt.toDate() : new Date(0);
                    return dateB - dateA;
                });
                
                html += `
                    <div style="font-size: 14px; font-weight: bold; color: #9C27B0; margin: 15px 0 10px 0; display: flex; align-items: center; gap: 8px;">
                        <span>📋 Aktivite Geçmişi</span>
                        <span style="background: #9C27B0; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${activityLog.length}</span>
                    </div>
                `;
                
                activityLog.forEach(activity => {
                    if (activity.type === 'key_deleted') {
                        const deletedAt = activity.deletedAt ? activity.deletedAt.toDate().toLocaleString('tr-TR') : 'Bilinmiyor';
                        const deletedByText = activity.deletedBy === 'user' ? '👤 Üye tarafından silindi' : '👑 Admin tarafından silindi';
                        const packageLabel = activity.days >= 365 ? 'Sınırsız' : `${activity.days} Günlük`;
                        
                        html += `
                            <div style="background: rgba(156,39,176,0.1); border: 1px solid rgba(156,39,176,0.3); border-radius: 10px; padding: 12px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px;">🗑️</span>
                                        <span style="font-weight: bold; color: #9C27B0;">${packageLabel} Key Silindi</span>
                                    </div>
                                    <span style="background: rgba(156,39,176,0.3); color: #CE93D8; padding: 2px 8px; border-radius: 8px; font-size: 10px;">${deletedByText}</span>
                                </div>
                                <div style="font-size: 11px; color: #888; margin-bottom: 6px;">
                                    🎮 ${activity.game || 'Mobile Legends'} • 🛡️ ${activity.cheat || 'TheBestML'}
                                </div>
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">
                                    🔑 <code style="color: #9C27B0;">${activity.keyCode || '***'}</code>
                                </div>
                                <div style="font-size: 10px; color: #666;">
                                    📅 Silinme: ${deletedAt}
                                </div>
                                ${activity.reason ? `<div style="font-size: 10px; color: #888; margin-top: 4px; font-style: italic;">💬 ${activity.reason}</div>` : ''}
                            </div>
                        `;
                    }
                });
            }
            
            content.innerHTML = html;
        } catch(e) {
            console.error('Üye detay hatası:', e);
            content.innerHTML = `<div style="color: #f44336; text-align: center; padding: 20px;">Hata: ${e.message}</div>`;
        }
    }
    
    // ==================== SİPARİŞ YÖNETİMİ ====================
    
    async function loadPendingOrders() {
        if (!isAdmin()) return;
        
        // Chat listesini de yükle (destek yetkisi olanlar için)
        if (hasPermission('support')) {
            loadAdminChats();
        }
        
        // Sipariş yetkisi yoksa erken dön
        if (!hasPermission('orders')) {
            document.getElementById('pendingOrders').innerHTML = '<div style="text-align: center; padding: 20px; color: #aaa;">Sipariş görüntüleme yetkiniz yok</div>';
            return;
        }
        
        const container = document.getElementById('pendingOrders');
        const countEl = document.getElementById('orderCount');
        try {
            const orders = await db.collection('orders').where('status', '==', 'pending').get();
            countEl.textContent = orders.size;
            
            if (orders.empty) {
                container.innerHTML = '<div style="text-align: center; padding: 20px;">✅ Bekleyen sipariş yok</div>';
                return;
            }
            
            // Client-side sıralama
            let orderList = [];
            orders.forEach(doc => {
                orderList.push({ id: doc.id, ...doc.data() });
            });
            orderList.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
            
            let html = '';
            orderList.forEach(o => {
                const date = o.createdAt.toDate().toLocaleString('tr-TR');
                html += `<div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer;" onclick="showOrderDetail('${o.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; color: #4CAF50;">${o.email}</div>
                            <div style="font-size: 13px; margin-top: 5px;">📦 ${o.packageName} - <span style="color: #FFD700;">${o.price}</span></div>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;">📅 ${date}</div>
                        </div>
                        <div style="font-size: 24px;">📋</div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        } catch(e) {
            container.innerHTML = 'Hata: ' + e.message;
        }
    }
    
    let currentOrderId = null;
    let currentOrderData = null;
    
    async function showOrderDetail(orderId) {
        if (!hasPermission('orders')) {
            showToast('❌ Sipariş görüntüleme yetkiniz yok');
            return;
        }
        currentOrderId = orderId;
        const doc = await db.collection('orders').doc(orderId).get();
        currentOrderData = doc.data();
        
        // Email alanı - farklı isimlerle kaydedilmiş olabilir
        const userEmail = currentOrderData.email || currentOrderData.userEmail || 'Bilinmiyor';
        currentOrderData.resolvedEmail = userEmail; // Sonra kullanmak için sakla
        
        const date = currentOrderData.createdAt.toDate().toLocaleString('tr-TR');
        
        // Süre uzatma siparişi mi kontrol et
        const isExtension = currentOrderData.type === 'extension';
        
        let html = `
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                <div style="font-size: 12px; color: #aaa;">Kullanıcı</div>
                <div style="font-weight: bold; font-size: 16px;">${userEmail}</div>
            </div>
        `;
        
        if (isExtension) {
            // Süre uzatma siparişi için özel görünüm
            const currentExp = currentOrderData.currentExpiry?.toDate ? 
                currentOrderData.currentExpiry.toDate().toLocaleDateString('tr-TR') : '-';
            const newExp = currentOrderData.newExpiry?.toDate ? 
                currentOrderData.newExpiry.toDate().toLocaleDateString('tr-TR') : '-';
            
            html += `
                <div style="background: rgba(255,152,0,0.15); border: 1px solid #FF9800; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 24px;">⏰</span>
                        <span style="font-size: 16px; font-weight: bold; color: #FF9800;">Süre Uzatma Talebi</span>
                    </div>
                    <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #aaa; font-size: 12px;">🎮 Oyun</span>
                            <span style="color: #fff; font-size: 12px;">${currentOrderData.game || '-'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #aaa; font-size: 12px;">🛡️ Hile</span>
                            <span style="color: #FFD700; font-size: 12px;">${currentOrderData.cheat || '-'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #aaa; font-size: 12px;">🔑 Mevcut Key</span>
                            <code style="color: #4CAF50; font-size: 12px;">${currentOrderData.keyCode || '-'}</code>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #aaa; font-size: 12px;">📅 Mevcut Bitiş</span>
                            <span style="color: #f44336; font-size: 12px;">${currentExp}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #aaa; font-size: 12px;">➕ Eklenen Süre</span>
                            <span style="color: #FF9800; font-weight: bold; font-size: 12px;">${currentOrderData.package || '-'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #aaa; font-size: 12px;">📅 Yeni Bitiş</span>
                            <span style="color: #4CAF50; font-weight: bold; font-size: 12px;">${newExp}</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px;">
                        <div style="font-size: 11px; color: #aaa;">Paket</div>
                        <div style="font-weight: bold;">${currentOrderData.packageName || '-'}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px;">
                        <div style="font-size: 11px; color: #aaa;">Tutar</div>
                        <div style="font-weight: bold; color: #4CAF50;">${currentOrderData.price || '-'}</div>
                    </div>
                </div>
            `;
        } else {
            // Normal sipariş görünümü
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px;">
                        <div style="font-size: 11px; color: #aaa;">Paket</div>
                        <div style="font-weight: bold;">${currentOrderData.packageName || currentOrderData.label || '-'}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px;">
                        <div style="font-size: 11px; color: #aaa;">Tutar</div>
                        <div style="font-weight: bold; color: #4CAF50;">${currentOrderData.price || '-'}</div>
                    </div>
                </div>
            `;
        }
        
        html += `<div style="font-size: 12px; color: #aaa; margin-bottom: 8px;">📅 ${date}</div>`;
        
        if (currentOrderData.dekont) {
            html += `
                <div style="font-size: 13px; font-weight: bold; margin: 15px 0 10px;">📸 Dekont:</div>
                <img src="${currentOrderData.dekont}" style="width: 100%; border-radius: 10px; margin-bottom: 15px;">
            `;
        }
        
        if (isExtension) {
            // Süre uzatma için basit onay/red butonları
            html += `
                <div style="background: rgba(76,175,80,0.1); border: 2px solid #4CAF50; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <div style="font-size: 13px; color: #aaa; margin-bottom: 8px;">⚠️ Bu sipariş onaylandığında kullanıcının mevcut key'ine otomatik olarak süre eklenecektir.</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-primary btn-small" onclick="approveExtensionOrder()">✅ Süre Uzat</button>
                    <button class="btn btn-small" style="background: rgba(244,67,54,0.3); color: #f44336;" onclick="rejectOrder()">❌ Reddet</button>
                </div>
            `;
        } else {
            // Normal sipariş için key üretme
            html += `
                <div style="background: rgba(255,152,0,0.1); border: 2px solid #FF9800; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <div style="font-size: 13px; font-weight: bold; margin-bottom: 10px;">🔑 Key Üretimi</div>
                    <button onclick="window.open('https://newthebestmod.xyz/app/user/cheat/order', '_blank')" style="background: linear-gradient(135deg, #FF9800, #F57C00); border: none; color: #fff; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px;">🔗 Paneli Aç (Key Üret)</button>
                    <input type="text" id="manualKeyInput" class="auth-input" placeholder="Panelden aldığın key'i yapıştır" style="margin-bottom: 0;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-primary btn-small" onclick="approveOrderWithKey()">✅ Onayla</button>
                    <button class="btn btn-small" style="background: rgba(244,67,54,0.3); color: #f44336;" onclick="rejectOrder()">❌ Reddet</button>
                </div>
            `;
        }
        
        document.getElementById('orderDetailContent').innerHTML = html;
        openModal('orderDetailModal');
    }
    
    async function approveOrder() {
        // Eski fonksiyon - artık kullanılmıyor
    }
    
    async function approveOrderWithKey() {
        if (!requirePermission('orders', 'siparişi onaylamak')) return;
        if (!currentOrderId || !currentOrderData) return;
        
        const keyCode = document.getElementById('manualKeyInput').value.trim();
        if (!keyCode) {
            showToast('❌ Key kodu girin!');
            return;
        }
        
        // Email alanını al
        const userEmail = currentOrderData.resolvedEmail || currentOrderData.email || currentOrderData.userEmail;
        if (!userEmail || userEmail === 'Bilinmiyor') {
            showToast('❌ Kullanıcı email bulunamadı!');
            return;
        }
        
        // Paket süresini belirle
        let days = 30;
        const pkg = currentOrderData.package || currentOrderData.days;
        if (pkg === '1gun' || pkg === 1) days = 1;
        else if (pkg === '30gun' || pkg === 30) days = 30;
        else if (pkg === '60gun' || pkg === 60) days = 60;
        else if (pkg === '90gun' || pkg === 90) days = 90;
        else if (pkg === 'sinirsiz' || pkg === 365 || pkg === 0 || pkg === 'unlimited') days = 365;
        
        try {
            // Kullanıcıyı bul
            const users = await db.collection('users').where('email', '==', userEmail).get();
            if (users.empty) {
                showToast('❌ Kullanıcı bulunamadı: ' + userEmail);
                return;
            }
            
            const userDoc = users.docs[0];
            const expiresAt = new Date();
            expiresAt.setDate(expiresAt.getDate() + days);
            
            // Key ekle - Oyun ve Hile bilgisi ile
            const userData = userDoc.data();
            // Oyun ve hile bilgisini al (dinamik siparişler için)
            const gameName = currentOrderData.game || 'Mobile Legends';
            const cheatName = currentOrderData.cheat || 'TheBestML IMGUI';
            
            const keys = userData.keys || [];
            keys.push({
                keyCode: keyCode,
                code: keyCode,
                orderId: currentOrderId,
                activatedAt: new Date(),
                expiresAt: expiresAt,
                days: days,
                game: gameName,
                cheat: cheatName,
                activatedBy: currentUser.email
            });
            
            await db.collection('users').doc(userDoc.id).update({ keys });
            
            // Siparişi onayla
            await db.collection('orders').doc(currentOrderId).update({
                status: 'approved',
                keyCode: keyCode,
                game: gameName,
                cheat: cheatName,
                approvedAt: new Date(),
                approvedBy: currentUser.email
            });
            
            // Kullanıcıya bildirim gönder
            const packageNames = {
                '1gun': '1 Günlük',
                '30gun': '30 Günlük',
                '60gun': '60 Günlük',
                '90gun': '90 Günlük',
                'sinirsiz': 'Sınırsız'
            };
            const pkgName = packageNames[currentOrderData.package] || currentOrderData.packageName || currentOrderData.label || `${days} Günlük`;
            await sendOrderApprovalNotification(
                userEmail, 
                keyCode, 
                pkgName
            );
            
            // Başarılı popup
            closeModal('orderDetailModal');
            showKeyCodePopup(keyCode, userEmail, days);
            loadPendingOrders();
        } catch(e) {
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Süre uzatma siparişini onayla
    async function approveExtensionOrder() {
        if (!currentOrderId || !currentOrderData) return;
        
        const userEmail = currentOrderData.resolvedEmail || currentOrderData.email || currentOrderData.userEmail;
        if (!userEmail || userEmail === 'Bilinmiyor') {
            showToast('❌ Kullanıcı email bulunamadı!');
            return;
        }
        
        const keyCode = currentOrderData.keyCode;
        if (!keyCode) {
            showToast('❌ Key kodu bulunamadı!');
            return;
        }
        
        try {
            // Kullanıcıyı bul
            const users = await db.collection('users').where('email', '==', userEmail).get();
            if (users.empty) {
                showToast('❌ Kullanıcı bulunamadı: ' + userEmail);
                return;
            }
            
            const userDoc = users.docs[0];
            const userData = userDoc.data();
            const keys = userData.keys || [];
            
            // Mevcut key'i bul
            const keyIndex = keys.findIndex(k => k.keyCode === keyCode || k.code === keyCode);
            if (keyIndex === -1) {
                showToast('❌ Key bulunamadı: ' + keyCode);
                return;
            }
            
            // Yeni bitiş tarihini hesapla (siparişteki newExpiry)
            const newExpiry = currentOrderData.newExpiry?.toDate ? 
                currentOrderData.newExpiry.toDate() : 
                new Date(currentOrderData.newExpiry);
            
            // Key'in süresini güncelle
            keys[keyIndex].expiresAt = newExpiry;
            keys[keyIndex].extendedAt = new Date();
            keys[keyIndex].extendedBy = currentUser.email;
            
            await db.collection('users').doc(userDoc.id).update({ keys });
            
            // Siparişi onayla
            await db.collection('orders').doc(currentOrderId).update({
                status: 'approved',
                approvedAt: new Date(),
                approvedBy: currentUser.email
            });
            
            // Kullanıcıya bildirim gönder (Firestore)
            const normalizedEmail = userEmail.toLowerCase().trim();
            await db.collection('notifications').add({
                targetType: normalizedEmail,
                targetEmail: normalizedEmail,
                userId: userEmail,
                email: userEmail,
                title: '⏰ Süre Uzatma Onaylandı!',
                message: `${currentOrderData.game} - ${currentOrderData.cheat} için ${currentOrderData.package} süre eklendi. Yeni bitiş: ${newExpiry.toLocaleDateString('tr-TR')}`,
                type: 'order',
                keyCode: keyCode,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                notifiedAt: new Date().toISOString()
            });
            
            // Native push notification gönder (kullanıcının FCM token'ı varsa)
            try {
                const userDocs = await db.collection('users').where('email', '==', userEmail).get();
                if (!userDocs.empty) {
                    const userData = userDocs.docs[0].data();
                    if (userData.fcmToken) {
                        // Gerçek push notification gönder (Vercel sunucu üzerinden)
                        await sendPushNotification(
                            userData.fcmToken,
                            '⏰ Süre Uzatma Onaylandı!',
                            `${currentOrderData.game} - ${currentOrderData.cheat} için süre eklendi. Yeni bitiş: ${newExpiry.toLocaleDateString('tr-TR')}`,
                            { type: 'extension_approved', orderId: currentOrderId }
                        );
                    }
                }
            } catch(pushErr) {
                console.log('Push bildirim gönderilemedi:', pushErr);
            }
            
            closeModal('orderDetailModal');
            showToast('✅ Süre uzatma onaylandı!');
            
            // Başarılı popup göster
            document.getElementById('orderSuccessContent').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 60px; margin-bottom: 20px;">⏰</div>
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">Süre Uzatıldı!</div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin: 15px 0;">
                        <div style="color: #aaa; font-size: 12px; margin-bottom: 5px;">Kullanıcı</div>
                        <div style="font-weight: bold;">${userEmail}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin: 15px 0;">
                        <div style="color: #aaa; font-size: 12px; margin-bottom: 5px;">Key</div>
                        <code style="font-size: 14px; color: #4CAF50;">${keyCode}</code>
                    </div>
                    <div style="background: rgba(76,175,80,0.2); border-radius: 10px; padding: 15px; margin: 15px 0;">
                        <div style="color: #aaa; font-size: 12px; margin-bottom: 5px;">Yeni Bitiş Tarihi</div>
                        <div style="font-weight: bold; font-size: 18px; color: #4CAF50;">${newExpiry.toLocaleDateString('tr-TR')}</div>
                    </div>
                    <button class="success-btn" onclick="closeOrderSuccessModal()" style="margin-top: 15px;">Tamam</button>
                </div>
            `;
            showOrderSuccessModal();
            loadPendingOrders();
        } catch(e) {
            showToast('❌ Hata: ' + e.message);
            console.error(e);
        }
    }
    
    // Rastgele key kodu üret
    function generateKeyCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = '';
        for (let i = 0; i < 4; i++) {
            for (let j = 0; j < 4; j++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            if (i < 3) code += '-';
        }
        return code;
    }
    
    // Key kodu popup göster
    function showKeyCodePopup(code, email, days) {
        const html = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; padding: 30px; max-width: 400px; text-align: center; border: 2px solid #4CAF50;" onclick="event.stopPropagation()">
                    <div style="font-size: 50px; margin-bottom: 15px;">✅</div>
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">Key Üretildi!</div>
                    <div style="color: #aaa; font-size: 13px; margin-bottom: 20px;">${email}</div>
                    
                    <div style="background: rgba(76,175,80,0.2); border: 2px solid #4CAF50; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 12px; color: #aaa; margin-bottom: 8px;">Key Kodu (${days} Gün)</div>
                        <div id="generatedKeyCode" style="font-size: 24px; font-weight: bold; font-family: monospace; letter-spacing: 2px; color: #4CAF50;">${code}</div>
                    </div>
                    
                    <button onclick="copyKeyCode('${code}')" style="background: linear-gradient(135deg, #4CAF50, #45a049); border: none; color: #fff; padding: 15px 30px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px;">📋 Kodu Kopyala</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.1); border: none; color: #aaa; padding: 12px; border-radius: 10px; cursor: pointer; width: 100%;">Kapat</button>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
    }
    
    function copyKeyCode(code) {
        navigator.clipboard.writeText(code).then(() => {
            showToast('📋 Key kodu kopyalandı!');
        }).catch(() => {
            // Fallback
            const input = document.createElement('input');
            input.value = code;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            showToast('📋 Key kodu kopyalandı!');
        });
    }
    
    async function rejectOrder() {
        if (!requirePermission('orders', 'siparişi reddetmek')) return;
        if (!currentOrderId) return;
        
        if (!confirm('Bu siparişi reddetmek istediğinize emin misiniz?')) return;
        
        try {
            await db.collection('orders').doc(currentOrderId).update({
                status: 'rejected',
                rejectedAt: new Date(),
                rejectedBy: currentUser.email
            });
            
            showToast('❌ Sipariş reddedildi');
            closeModal('orderDetailModal');
            loadPendingOrders();
        } catch(e) {
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Key Kodu Oluştur (Admin)
    async function createKeyCode() {
        if (!requirePermission('keys_add', 'key kodu oluşturmak')) return;
        
        const code = document.getElementById('adminKeyCode').value.trim().toUpperCase();
        const days = parseInt(document.getElementById('adminKeyDays').value);
        
        if (!code) { showToast('❌ Key kodu girin'); return; }
        
        try {
            await db.collection('keyCodes').doc(code).set({
                days: days,
                used: false,
                createdAt: new Date(),
                createdBy: currentUser.email
            });
            showToast('✅ Key kodu eklendi: ' + code);
            document.getElementById('adminKeyCode').value = '';
        } catch(e) {
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Key Kodu Kullan (Kullanıcı)
    async function redeemKey() {
        if (!currentUser) { showToast('❌ Önce giriş yapın'); return; }
        
        const code = document.getElementById('redeemKeyInput').value.trim().toUpperCase();
        if (!code) { showToast('❌ Key kodu girin'); return; }
        
        try {
            showToast('⏳ Kontrol ediliyor...');
            const keyDoc = await db.collection('keyCodes').doc(code).get();
            
            if (!keyDoc.exists) {
                showToast('❌ Geçersiz key kodu');
                return;
            }
            
            const keyData = keyDoc.data();
            if (keyData.used) {
                showToast('❌ Bu key zaten kullanılmış');
                return;
            }
            
            // Key'i kullanıldı olarak işaretle
            await db.collection('keyCodes').doc(code).update({
                used: true,
                usedBy: currentUser.email,
                usedAt: new Date()
            });
            
            // Kullanıcıya key ekle
            const expiresAt = new Date();
            expiresAt.setDate(expiresAt.getDate() + keyData.days);
            
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            const keys = userData.keys || [];
            keys.push({
                code: code,
                activatedAt: new Date(),
                expiresAt: expiresAt,
                days: keyData.days
            });
            
            await db.collection('users').doc(currentUser.uid).update({ keys });
            
            showToast('✅ Key aktifleştirildi! ' + keyData.days + ' gün');
            closeModal('redeemKeyModal');
            document.getElementById('redeemKeyInput').value = '';
            loadUserData();
        } catch(e) {
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Sayfa yüklendiğinde
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('[APP] DOMContentLoaded başladı');
        
        // Profil butonunu sağa sabitle (CSS override güvenliği)
        const profileBtn = document.getElementById('profileToggleBtn');
        if (profileBtn) {
            profileBtn.style.cssText = 'position: fixed !important; top: calc(15px + env(safe-area-inset-top, 0px)) !important; right: 15px !important; left: auto !important; z-index: 999;';
        }
        
        // Bildirim kanallarını HEMEN oluştur (Android için önemli)
        try {
            await createNotificationChannel();
            await requestNotificationPermission();
            console.log('[APP] Bildirim kanalları hazır');
        } catch(e) {
            console.log('[APP] Bildirim kanal hatası:', e);
        }
        
        try {
            try {
                const savedConfig = localStorage.getItem('cheatstore_config');
                if (savedConfig) {
                    appConfig = { ...appConfig, ...JSON.parse(savedConfig) };
                }
            } catch (e) {}
            
            localStorage.setItem('cheatstore_app_version', APP_VERSION);
            var verEl = document.getElementById('currentVersion');
            if (verEl) verEl.textContent = APP_VERSION;
            
            // Buton sürümünü de güncelle
            const versionBtn = document.getElementById('currentVersionBtn');
            if (versionBtn) versionBtn.textContent = APP_VERSION;
            
            // Firebase kontrolü
            if (typeof firebase === 'undefined') {
                console.error('[APP] Firebase SDK yüklenemedi!');
                showToast('❌ Firebase bağlantı hatası');
                return;
            }
            
            if (!firebaseReady) {
                console.error('[APP] Firebase başlatılamadı!');
                showToast('❌ Firebase başlatılamadı');
                return;
            }
            
            console.log('[APP] Firebase OK');
            
            // Admin listesini yükle
            try {
                await loadAdminList();
                console.log('[APP] Admin listesi OK');
            } catch(e) {
                console.error('[APP] Admin hatası:', e.message);
            }
            
            // GitHub token'ı yükle
            try {
                await loadGithubToken();
                console.log('[APP] GitHub token OK');
            } catch(e) {
                console.error('[APP] GitHub token hatası:', e.message);
            }
            
            // Ödeme ayarlarını yükle
            try {
                await loadPaymentSettings();
                console.log('[APP] Ödeme ayarları OK');
            } catch(e) {
                console.error('[APP] Ödeme hatası:', e.message);
            }
            
            // Oyunları yükle (ana sayfa için)
            try {
                await loadGamesAndCheats();
                console.log('[APP] Oyunlar OK');
            } catch(e) {
                console.error('[APP] Oyunlar hatası:', e.message);
            }
            
            // Kurulum modallarını yükle
            try {
                await loadSetupModals();
                console.log('[APP] Kurulum modalları OK');
            } catch(e) {
                console.error('[APP] Kurulum modalları hatası:', e.message);
            }
            
            // Uygulama ayarlarını yükle
            try {
                await loadAppSettings();
                console.log('[APP] Uygulama ayarları OK');
            } catch(e) {
                console.error('[APP] Uygulama ayarları hatası:', e.message);
            }
            
            // Hatırlanan giriş bilgilerini doldur
            loadRememberedCredentials();
            
            // Hoşgeldin mesajı - HER ZAMAN APP_VERSION kullan
            setTimeout(() => {
                showToast('✅ BestOfShop v' + APP_VERSION);
            }, 1000);
            
            // Otomatik güncelleme kontrolü başlat (30 saniyede bir)
            startAutoUpdateCheck();
            
            console.log('[APP] Başlatma tamamlandı');
            
        } catch (initError) {
            console.error('[APP] Init hatası:', initError);
            alert('Başlatma hatası: ' + initError.message);
        }
    });
    
    // Otomatik güncelleme kontrolü
    let autoUpdateInterval = null;
    let uiRefreshInterval = null;
    let notificationCheckInterval = null;
    let lastCheckedVersion = APP_VERSION;
    
    function startAutoUpdateCheck() {
        // İlk sessiz kontrol 5 saniye sonra
        setTimeout(checkUpdateSilently, 5000);
        
        // Güncelleme popup kontrolü 15 saniye sonra
        setTimeout(checkForUpdates, 15000);
        
        // Sonra her 2 dakikada bir kontrol
        autoUpdateInterval = setInterval(checkForUpdates, 120000);
        
        // UI REFRESH - HER 1 SANİYEDE BİR
        startUIRefresh();
        
        // BİLDİRİM KONTROLÜ - HER 3 SANİYEDE BİR
        startNotificationPolling();
        
        // Sayfa görünür olduğunda kontrol et
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                checkUpdateSilently();
                refreshUIBadges();
                checkNewNotificationsNow();
            }
        });
    }
    
    // Sürekli UI Refresh (Her 1 saniye)
    function startUIRefresh() {
        if (uiRefreshInterval) clearInterval(uiRefreshInterval);
        
        uiRefreshInterval = setInterval(() => {
            refreshUIBadges();
        }, 1000); // Her 1 saniye
        
        console.log('🔄 UI refresh başlatıldı (1 saniye)');
    }
    
    // UI Badge'leri yenile
    function refreshUIBadges() {
        try {
            updateNotificationBadge();
            updateProfileNotifBadge();
            updateSidebarBadges();
        } catch(e) {
            // Sessizce devam et
        }
    }
    
    // Bildirim Polling (Her 3 saniye)
    function startNotificationPolling() {
        if (notificationCheckInterval) clearInterval(notificationCheckInterval);
        
        notificationCheckInterval = setInterval(() => {
            if (currentUser) {
                checkNewNotificationsNow();
            }
        }, 3000); // Her 3 saniye
        
        console.log('🔔 Bildirim polling başlatıldı (3 saniye)');
    }
    
    // Anlık bildirim kontrolü (polling)
    async function checkNewNotificationsNow() {
        if (!currentUser) return;
        
        try {
            const userEmail = currentUser.email.toLowerCase().trim();
            const notifiedIds = JSON.parse(localStorage.getItem('notifiedNotifications') || '[]');
            const readNotifs = JSON.parse(localStorage.getItem('readNotifications') || '[]');
            
            // Son 5 dakikadaki bildirimleri kontrol et
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
            
            // Kullanıcıya özel bildirimleri çek
            const userNotifs = await db.collection('notifications')
                .where('targetType', '==', userEmail)
                .limit(10)
                .get();
            
            userNotifs.forEach(doc => {
                const notif = { id: doc.id, ...doc.data() };
                
                // Bu bildirim daha önce gösterildi mi?
                if (notifiedIds.includes(notif.id)) return;
                
                // Okundu mu?
                if (readNotifs.includes(notif.id)) return;
                
                // Bildirim tarihi kontrolü
                let notifDate = null;
                if (notif.createdAt && notif.createdAt.toDate) {
                    notifDate = notif.createdAt.toDate();
                } else if (notif.notifiedAt) {
                    notifDate = new Date(notif.notifiedAt);
                }
                
                // Son 5 dakika içinde mi?
                if (notifDate && notifDate > fiveMinutesAgo) {
                    console.log('🆕 Yeni bildirim tespit edildi (polling):', notif.title);
                    
                    // Bildirim işle
                    processNewNotification(notif);
                    
                    // ID'yi kaydet
                    notifiedIds.push(notif.id);
                    localStorage.setItem('notifiedNotifications', JSON.stringify([...new Set(notifiedIds)]));
                }
            });
            
        } catch(e) {
            // Sessizce devam et - bağlantı sorunu olabilir
        }
    }
    
    // Yeni bildirimi işle (popup, ses, native)
    function processNewNotification(notif) {
        // Listede zaten var mı?
        const existingIndex = userNotifications.findIndex(n => n.id === notif.id);
        if (existingIndex === -1) {
            userNotifications.push(notif);
        }
        
        // Sipariş onayı ise özel popup
        if (notif.type === 'order' && notif.keyCode) {
            showOrderApprovalPopup(notif);
        } else {
            showNotificationPopup(notif);
        }
        
        // Ses çal
        playNotificationSound();
        
        // Native push notification
        sendNativeNotification(
            notif.title || 'Bildirim',
            notif.message || '',
            { type: notif.type, keyCode: notif.keyCode }
        );
        
        // Badge güncelle
        updateProfileNotifBadge();
        updateNotificationBadge();
        
        // Titreşim (sipariş ise daha uzun)
        if (navigator.vibrate) {
            if (notif.type === 'order') {
                navigator.vibrate([200, 100, 200, 100, 200, 100, 400]);
            } else {
                navigator.vibrate([200, 100, 200]);
            }
        }
    }
    
    // Semantik versiyon karşılaştırma fonksiyonu
    function compareVersions(v1, v2) {
        // v1 > v2 ise 1, v1 < v2 ise -1, eşitse 0 döner
        const parts1 = v1.split('.').map(Number);
        const parts2 = v2.split('.').map(Number);
        
        for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
            const num1 = parts1[i] || 0;
            const num2 = parts2[i] || 0;
            
            if (num1 > num2) return 1;
            if (num1 < num2) return -1;
        }
        return 0;
    }
    
    async function checkForUpdates() {
        try {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(7);
            
            // SADECE GitHub'dan kontrol et - Firestore kullanılmıyor
            let manifest = null;
            
            try {
                const manifestUrl = `https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/manifest.json?_t=${timestamp}&_r=${random}`;
                const response = await fetch(manifestUrl, { 
                    cache: 'no-store',
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                if (response.ok) {
                    manifest = await response.json();
                    console.log('🐙 GitHub manifest:', manifest.version);
                }
            } catch(e) {
                console.log('GitHub manifest kontrolü başarısız:', e.message);
            }
            
            if (!manifest) return;
            
            // Yeni versiyon kontrolü - sadece APP_VERSION ile karşılaştır
            const versionCompare = compareVersions(manifest.version, APP_VERSION);
            
            if (versionCompare > 0 && manifest.version !== lastCheckedVersion) {
                lastCheckedVersion = manifest.version;
                
                console.log('🆕 Yeni versiyon bulundu:', manifest.version, '(Gösterilen:', currentDisplayedVersion + ')');
                
                // Zorunlu güncelleme kontrolü
                if (manifest.required || manifest.forceUpdate) {
                    showForceUpdateScreen(manifest);
                } else {
                    // Kullanıcıya sor
                    showUpdateNotification(manifest);
                }
            } else if (versionCompare <= 0) {
                console.log('✅ Uygulama güncel (v' + currentDisplayedVersion + ')');
            }
        } catch (e) {
            console.log('Güncelleme kontrolü başarısız:', e.message);
        }
    }
    
    // Zorunlu güncelleme ekranı
    function showForceUpdateScreen(manifest) {
        const hasChangelog = manifest.changelog && manifest.changelog.length > 0 && manifest.changelog.some(c => c.trim());
        const changelogHtml = hasChangelog ? `
                    <div style="background: rgba(76,175,80,0.1); border: 1px solid #4CAF50; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: left;">
                        <div style="color: #4CAF50; font-weight: bold; margin-bottom: 10px;">📋 Yenilikler:</div>
                        <div style="color: #ccc; font-size: 13px; line-height: 1.8;">• ${manifest.changelog.join('<br>• ')}</div>
                    </div>` : '';
        
        document.body.innerHTML = `
            <div style="min-height: 100vh; background: linear-gradient(135deg, #1a1a2e, #16213e); display: flex; align-items: center; justify-content: center; padding: 20px;">
                <div style="text-align: center; max-width: 400px;">
                    <div style="font-size: 80px; margin-bottom: 20px;">🚀</div>
                    <h1 style="color: #fff; margin-bottom: 10px;">Güncelleme Gerekli</h1>
                    <div style="color: #4CAF50; font-size: 24px; font-weight: bold; margin-bottom: 15px;">v${manifest.version}</div>
                    <p style="color: #aaa; font-size: 14px; line-height: 1.6; margin-bottom: 20px;">
                        Uygulamayı kullanmaya devam etmek için güncelleme yapmanız gerekmektedir.
                    </p>
                    ${changelogHtml}
                    <button onclick="applyUpdate()" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: #fff; border: none; padding: 15px 40px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;">
                        🔄 Şimdi Güncelle
                    </button>
                </div>
            </div>
        `;
    }
    
    function showUpdateNotification(manifest) {
        // Güncelleme bildirimi göster
        const hasChangelog = manifest.changelog && manifest.changelog.length > 0 && manifest.changelog.some(c => c.trim());
        const changelogText = hasChangelog ? `<div style="font-size: 11px; opacity: 0.9; margin-top: 2px;">• ${manifest.changelog.join(' • ')}</div>` : '';
        
        const updateBanner = document.createElement('div');
        updateBanner.id = 'updateBanner';
        updateBanner.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #4CAF50, #45a049); padding: calc(12px + env(safe-area-inset-top, 0px)) 15px 12px 15px; z-index: 10000; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                <div style="flex: 1;">
                    <div style="font-weight: bold; font-size: 14px;">🆕 Yeni Güncelleme: v${manifest.version}</div>
                    ${changelogText}
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="applyUpdate()" style="background: #fff; color: #4CAF50; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; font-size: 12px; cursor: pointer;">Güncelle</button>
                    <button onclick="dismissUpdate()" style="background: rgba(255,255,255,0.2); color: #fff; border: none; padding: 8px 12px; border-radius: 8px; font-size: 12px; cursor: pointer;">✕</button>
                </div>
            </div>
        `;
        
        // Eski banner varsa kaldır
        const oldBanner = document.getElementById('updateBanner');
        if (oldBanner) oldBanner.remove();
        
        document.body.appendChild(updateBanner);
    }
    
    async function applyUpdate() {
        showToast('🔄 Güncelleme uygulanıyor...');
        
        // Banner'ı kaldır
        const banner = document.getElementById('updateBanner');
        if (banner) banner.remove();
        
        try {
            // GitHub'dan güncel app.html'i çek
            const timestamp = Date.now();
            const appUrl = `https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/app.html?t=${timestamp}`;
            const response = await fetch(appUrl, { cache: 'no-store' });
            const appHtml = await response.text();
            
            // İçerik kontrolü
            if (appHtml.length < 5000 || appHtml.indexOf('APP_VERSION') === -1) {
                throw new Error('Geçersiz güncelleme içeriği');
            }
            
            // Sürüm çıkar
            const match = appHtml.match(/APP_VERSION\s*=\s*['"]([^'"]+)['"]/);
            const downloadedVersion = match ? match[1] : 'Bilinmiyor';
            
            // OTA cache'e kaydet
            localStorage.setItem('ota_app_html', appHtml);
            localStorage.setItem('ota_app_version', downloadedVersion);
            
            showToast('✅ v' + downloadedVersion + ' başarıyla güncellendi!');
            
            // Güncellemeyi uygula - index.html'e yönlendir
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1500);
            
        } catch(e) {
            console.error('Güncelleme hatası:', e);
            showToast('❌ Güncelleme hatası: ' + e.message);
        }
    }
    
    function dismissUpdate() {
        const banner = document.getElementById('updateBanner');
        if (banner) banner.remove();
    }
    
    // Uygulamayı Yenile - Zorla güncelle
    async function refreshApp() {
        showToast('🔄 Güncelleme kontrol ediliyor...');

        try {
            // Önce manifest'i kontrol et
            const manifestUrl = 'https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/manifest.json?t=' + Date.now();
            const manifestRes = await fetch(manifestUrl, { cache: 'no-store' });
            const manifest = await manifestRes.json();
            
            console.log('[OTA] Manifest sürümü:', manifest.version);
            console.log('[OTA] Mevcut APP_VERSION:', APP_VERSION);
            
            // Yeni sürüm var veya ZORLA güncelle
            if (manifest.version !== APP_VERSION || true) {  // true = her zaman güncelle
                // Yeni sürüm var - OTA güncelleme
                showToast('🆕 Yeni sürüm: v' + manifest.version + ' - İndiriliyor...');
                
                // app.html'i indir
                const appUrl = 'https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/app.html?t=' + Date.now();
                const appRes = await fetch(appUrl, { cache: 'no-store' });
                const appHtml = await appRes.text();
                
                // İçerik kontrolü
                if (appHtml.length < 5000 || appHtml.indexOf('APP_VERSION') === -1) {
                    throw new Error('Geçersiz güncelleme içeriği');
                }
                
                // Sürüm çıkar
                const match = appHtml.match(/APP_VERSION\s*=\s*['"]([^'"]+)['"]/);
                const downloadedVersion = match ? match[1] : manifest.version;
                
                // OTA cache'e kaydet
                localStorage.setItem('ota_app_html', appHtml);
                localStorage.setItem('ota_app_version', downloadedVersion);
                
                showToast('✅ v' + downloadedVersion + ' yüklendi! Yeniden başlatılıyor...');
                
                // Güncellemeyi uygula - index.html'e yönlendir (o cache'den yükler)
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            }
            
        } catch(e) {
            console.error('Güncelleme hatası:', e);
            showToast('❌ Güncelleme hatası: ' + e.message);
        }
    }
    
    // Otomatik güncelleme kontrolü (arka planda)
    async function checkUpdateSilently() {
        try {
            const manifestUrl = 'https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/manifest.json?t=' + Date.now();
            const res = await fetch(manifestUrl, { cache: 'no-store' });
            const manifest = await res.json();
            
            // Versiyon karşılaştırma - sadece manifest daha yeniyse göster
            const currentParts = APP_VERSION.split('.').map(Number);
            const manifestParts = manifest.version.split('.').map(Number);
            
            let isNewer = false;
            for (let i = 0; i < Math.max(currentParts.length, manifestParts.length); i++) {
                const current = currentParts[i] || 0;
                const remote = manifestParts[i] || 0;
                if (remote > current) {
                    isNewer = true;
                    break;
                } else if (remote < current) {
                    break;
                }
            }
            
            if (isNewer) {
                // Güncelleme butonu badge'i göster
                const updateBtn = document.querySelector('[onclick="refreshApp()"]');
                if (updateBtn) {
                    updateBtn.innerHTML = '🆕 GÜNCELLEME MEVCUT<span class="btn-subtext">v' + APP_VERSION + ' → v' + manifest.version + '</span>';
                    updateBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                    updateBtn.style.animation = 'pulse 2s infinite';
                }
                console.log('[OTA] Yeni sürüm mevcut: v' + manifest.version);
            } else {
                console.log('[OTA] Güncel sürümdesiniz: v' + APP_VERSION);
            }
        } catch(e) {
            console.log('[OTA] Sessiz kontrol hatası:', e.message);
        }
    }

    // Navigasyon geçmişi
    let navigationHistory = ['homePage'];
    let currentPageId = 'homePage';
    
    // Sayfa göster (history'siz)
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        currentPageId = pageId;
        window.scrollTo(0, 0);
        
        // Admin sayfasına geçildiğinde
        if (pageId === 'adminPage' && isAdmin()) {
            loadGamesAndCheats();
            loadGameCheatList();
            loadPaymentSettingsAdmin();
            loadSetupModalsList();
            
            // Yetki bazlı bölüm gösterme
            updateAdminPanelPermissions();
        }
    }
    
    // Admin bölümü açma/kapama
    function toggleAdminSection(headerEl) {
        const section = headerEl.parentElement;
        section.classList.toggle('open');
        
        // LocalStorage'a kaydet
        const sectionId = section.id;
        const openSections = JSON.parse(localStorage.getItem('adminOpenSections') || '{}');
        openSections[sectionId] = section.classList.contains('open');
        localStorage.setItem('adminOpenSections', JSON.stringify(openSections));
    }
    
    // Kayıtlı açık bölümleri yükle
    function loadOpenAdminSections() {
        const openSections = JSON.parse(localStorage.getItem('adminOpenSections') || '{}');
        Object.entries(openSections).forEach(([sectionId, isOpen]) => {
            const section = document.getElementById(sectionId);
            if (section && isOpen) {
                section.classList.add('open');
            }
        });
    }
    
    // Admin panelinde yetki bazlı bölüm gizleme/gösterme
    function updateAdminPanelPermissions() {
        // Tüm permission-section bölümlerini data-permission'a göre gizle/göster
        document.querySelectorAll('.permission-section').forEach(section => {
            const permission = section.dataset.permission;
            if (permission) {
                section.style.display = hasPermission(permission) ? 'block' : 'none';
            }
        });
        
        // Kayıtlı açık bölümleri yükle
        loadOpenAdminSections();
        
        // Kurulum modalları listesini yükle
        if (hasPermission('modals')) {
            loadSetupModalsList();
        }
        
        // Uygulama ayarları bilgisini yükle
        if (hasPermission('app_settings')) {
            loadAppSettings();
        }
        
        // Kurucu değilse panel başlığını değiştir ve yetkileri göster
        const panelSubtitle = document.querySelector('#adminPage .subtitle');
        const myPermsBadge = document.getElementById('myPermissionsBadge');
        
        if (panelSubtitle) {
            if (isOwner()) {
                panelSubtitle.textContent = 'Tam Yetki (Kurucu)';
                if (myPermsBadge) myPermsBadge.innerHTML = '👑 Tüm yetkiler aktif';
            } else {
                const myPerms = getAdminPermissions(currentUser?.email || '');
                const permCount = myPerms.length;
                panelSubtitle.textContent = `${permCount} Yetki (Admin)`;
                
                // Yetki rozetlerini göster
                if (myPermsBadge) {
                    const permHtml = myPerms.map(p => {
                        const info = PERMISSIONS[p];
                        return `<span style="background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 10px; margin: 2px; font-size: 11px; display: inline-block;">${info?.icon || '❓'} ${info?.name || p}</span>`;
                    }).join('');
                    myPermsBadge.innerHTML = permHtml || '<span style="color: #f44336;">Yetki yok</span>';
                }
            }
        }
        
        // Permission badge'larını gizle (kurucu için)
        document.querySelectorAll('.permission-badge').forEach(badge => {
            badge.style.display = isOwner() ? 'none' : 'inline';
        });
        
        // Kurucu ise admin listesini yükle
        if (isOwner()) {
            loadAdminListUI();
        }
        
        console.log('Admin yetkileri güncellendi:', isOwner() ? 'Kurucu' : 'Admin');
    }
    
    // Admin listesi UI'ını yükle
    function loadAdminListUI() {
        const container = document.getElementById('adminListContainer');
        if (!container) return;
        
        // Admin yönetimi yetkisi yoksa gösterme
        if (!hasPermission('admin_management')) {
            container.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #888;">
                    <div style="font-size: 30px; margin-bottom: 10px;">🔒</div>
                    <div>Admin yönetimi yetkiniz yok</div>
                </div>
            `;
            return;
        }
        
        if (adminList.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #888;">
                    <div style="font-size: 30px; margin-bottom: 10px;">👮</div>
                    <div>Henüz admin eklenmedi</div>
                    <div style="font-size: 11px; margin-top: 5px;">➕ Ekle butonuna tıklayarak admin ekleyebilirsiniz</div>
                </div>
            `;
            return;
        }
        
        let html = '';
        adminList.forEach((admin, index) => {
            const permissions = admin.permissions || [];
            const permCount = permissions.length;
            const permIcons = permissions.slice(0, 4).map(p => PERMISSIONS[p]?.icon || '❓').join('');
            const moreCount = permCount > 4 ? ` +${permCount - 4}` : '';
            
            html += `
                <div style="background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 12px; margin-bottom: 10px; overflow: hidden;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #FF9800, #F57C00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">👤</div>
                            <div>
                                <div style="font-size: 14px; font-weight: bold;">${admin.email}</div>
                                <div style="font-size: 11px; color: #FF9800; margin-top: 2px;">
                                    ${permCount} Yetki: ${permIcons}${moreCount}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="openPermissionModal('${admin.email}')" style="background: linear-gradient(135deg, #2196F3, #1976D2); border: none; color: white; padding: 8px 12px; border-radius: 8px; font-size: 12px; cursor: pointer;">⚙️</button>
                            <button onclick="removeAdmin('${admin.email}')" style="background: rgba(244,67,54,0.2); border: 1px solid #f44336; color: #f44336; padding: 8px 12px; border-radius: 8px; font-size: 12px; cursor: pointer;">❌</button>
                        </div>
                    </div>
                    
                    <!-- Yetki Detayları (Açılır) -->
                    <div id="adminPerms_${index}" style="display: none; padding: 12px; background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,152,0,0.2);">
                        <div style="font-size: 11px; color: #aaa; margin-bottom: 8px;">Aktif Yetkiler:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${permissions.map(p => `
                                <span style="background: rgba(255,152,0,0.2); border: 1px solid rgba(255,152,0,0.4); padding: 4px 10px; border-radius: 15px; font-size: 11px;">
                                    ${PERMISSIONS[p]?.icon || '❓'} ${PERMISSIONS[p]?.name || p}
                                </span>
                            `).join('')}
                            ${permissions.length === 0 ? '<span style="color: #888; font-size: 11px;">Yetki verilmemiş</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // Admin ekle modal'ını aç
    function openAddAdminModal() {
        if (!hasPermission('admin_management')) {
            showToast('❌ Admin yönetimi yetkiniz yok');
            return;
        }
        
        const emailInput = document.getElementById('newAdminEmail');
        const email = emailInput?.value?.trim() || '';
        
        document.getElementById('addAdminEmailInput').value = email;
        
        // Yetki checkbox'larını oluştur
        const container = document.getElementById('newAdminPermissionsCheckboxList');
        let html = '';
        
        const defaultPerms = ['orders', 'support', 'members_view']; // Varsayılan yetkiler
        
        Object.entries(PERMISSIONS).forEach(([key, perm]) => {
            const isDefault = defaultPerms.includes(key);
            html += `
                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="newAdminPerm_${key}" ${isDefault ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #4CAF50;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 14px;">${perm.icon} ${perm.name}</div>
                        <div style="font-size: 11px; color: #888; margin-top: 2px;">${perm.desc}</div>
                    </div>
                </label>
            `;
        });
        
        container.innerHTML = html;
        openModal('addAdminModal');
    }
    
    // Yetki modal'ını aç
    function openPermissionModal(email) {
        if (!hasPermission('admin_management')) {
            showToast('❌ Admin yönetimi yetkiniz yok');
            return;
        }
        
        const admin = adminList.find(a => a.email === email);
        if (!admin) {
            showToast('❌ Admin bulunamadı');
            return;
        }
        
        document.getElementById('permissionAdminEmail').value = email;
        document.getElementById('permissionAdminEmailDisplay').textContent = email;
        document.getElementById('permissionAdminName').textContent = email.split('@')[0];
        
        // Yetki checkbox'larını oluştur
        const container = document.getElementById('permissionsCheckboxList');
        const currentPerms = admin.permissions || [];
        
        let html = '';
        Object.entries(PERMISSIONS).forEach(([key, perm]) => {
            const isChecked = currentPerms.includes(key);
            html += `
                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${isChecked ? 'rgba(76,175,80,0.1)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${isChecked ? 'rgba(76,175,80,0.3)' : 'rgba(255,255,255,0.1)'}; border-radius: 10px; margin-bottom: 8px; cursor: pointer;" onclick="this.style.background = this.querySelector('input').checked ? 'rgba(255,255,255,0.05)' : 'rgba(76,175,80,0.1)';">
                    <input type="checkbox" id="perm_${key}" ${isChecked ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #4CAF50;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 14px;">${perm.icon} ${perm.name}</div>
                        <div style="font-size: 11px; color: #888; margin-top: 2px;">${perm.desc}</div>
                    </div>
                </label>
            `;
        });
        
        container.innerHTML = html;
        openModal('adminPermissionModal');
    }
    
    // Admin yetkilerini kaydet (modal'dan)
    async function saveAdminPermissions() {
        const email = document.getElementById('permissionAdminEmail').value;
        
        // Seçili yetkileri topla
        const selectedPerms = [];
        Object.keys(PERMISSIONS).forEach(key => {
            const checkbox = document.getElementById(`perm_${key}`);
            if (checkbox && checkbox.checked) {
                selectedPerms.push(key);
            }
        });
        
        const success = await updateAdminPermissions(email, selectedPerms);
        if (success) {
            closeModal('adminPermissionModal');
            loadAdminListUI();
        }
    }
    
    // Yetkilerle birlikte admin ekle
    async function addAdminWithPermissions() {
        const email = document.getElementById('addAdminEmailInput').value.trim();
        
        if (!email || !email.includes('@')) {
            showToast('❌ Geçerli e-posta girin');
            return;
        }
        
        // Seçili yetkileri topla
        const selectedPerms = [];
        Object.keys(PERMISSIONS).forEach(key => {
            const checkbox = document.getElementById(`newAdminPerm_${key}`);
            if (checkbox && checkbox.checked) {
                selectedPerms.push(key);
            }
        });
        
        const success = await addAdmin(email, selectedPerms);
        if (success) {
            closeModal('addAdminModal');
            document.getElementById('newAdminEmail').value = '';
            loadAdminListUI();
        }
    }
    
    // Eski fonksiyon (geriye uyumluluk)
    async function addAdminFromInput() {
        openAddAdminModal();
    }
    
    // Sayfa için üyelik kontrolü
    async function checkMembershipForPage(cheatName) {
        // Önce kullanıcı verilerini yükle (eğer aktif key yoksa)
        if (currentUser && userActiveKeys.length === 0) {
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    const keys = data.keys || [];
                    const now = new Date();
                    userActiveKeys = keys.filter(k => k.expiresAt && k.expiresAt.toDate() > now);
                }
            } catch(e) {
                console.log('Üyelik kontrolü hatası:', e);
            }
        }
        
        const now = new Date();
        
        // Bu hile için aktif key var mı kontrol et
        const hasActiveKey = userActiveKeys.some(key => {
            const keyCheat = key.cheat || 'TheBestML';
            return keyCheat.toLowerCase().includes(cheatName.toLowerCase()) || 
                   cheatName.toLowerCase().includes(keyCheat.toLowerCase()) ||
                   keyCheat === 'TheBestML'; // Mobile Legends için
        });
        
        console.log('Üyelik kontrolü:', cheatName, 'Aktif key var mı:', hasActiveKey, 'Toplam key:', userActiveKeys.length);
        
        // Element'leri al
        const setupLocked = document.getElementById('setupInstructionsLocked');
        const setupUnlocked = document.getElementById('setupInstructionsUnlocked');
        const pricesLocked = document.getElementById('pricesSectionLocked');
        const activeMembership = document.getElementById('activeMembershipSection');
        const membershipInfo = document.getElementById('activeMembershipInfo');
        
        if (hasActiveKey) {
            // Aktif üyelik var - kurulum talimatlarını göster
            if (setupLocked) setupLocked.style.display = 'none';
            if (setupUnlocked) setupUnlocked.style.display = 'block';
            if (pricesLocked) pricesLocked.style.display = 'none';
            if (activeMembership) activeMembership.style.display = 'block';
            
            // Aktif key bilgisini göster
            if (membershipInfo && userActiveKeys.length > 0) {
                const key = userActiveKeys.find(k => (k.cheat || 'TheBestML').toLowerCase().includes(cheatName.toLowerCase())) || userActiveKeys[0];
                const exp = key.expiresAt.toDate();
                const remainingDays = Math.ceil((exp - now) / (1000 * 60 * 60 * 24));
                const keyCode = key.keyCode || key.code || '***';
                
                membershipInfo.innerHTML = `
                    <div style="margin-bottom: 8px;">🔑 Key: <code style="color: #4CAF50;">${keyCode}</code></div>
                    <div>⏱️ Kalan Süre: <strong style="color: #4CAF50;">${remainingDays} gün</strong></div>
                `;
            }
        } else {
            // Aktif üyelik yok - kurulum kilitli, fiyatları göster
            if (setupLocked) setupLocked.style.display = 'block';
            if (setupUnlocked) setupUnlocked.style.display = 'none';
            if (pricesLocked) pricesLocked.style.display = 'block';
            if (activeMembership) activeMembership.style.display = 'none';
        }
    }
    
    // Hesabım butonuna tıklayınca ana sayfaya git ve kullanıcı kartına scroll et
    function goToAccount() {
        navigateTo('homePage');
        setTimeout(() => {
            const loggedInCard = document.getElementById('loggedInCard');
            if (loggedInCard) {
                loggedInCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Kısa bir highlight efekti
                loggedInCard.style.boxShadow = '0 0 20px rgba(76,175,80,0.5)';
                setTimeout(() => {
                    loggedInCard.style.boxShadow = '';
                }, 2000);
            }
        }, 100);
    }
    
    // Navigasyon ile sayfa geçişi
    function navigateTo(pageId) {
        if (currentPageId !== pageId) {
            navigationHistory.push(pageId);
            history.pushState({ page: pageId }, '', '');
        }
        showPage(pageId);
    }
    
    // Geri git
    function navigateBack() {
        if (navigationHistory.length > 1) {
            navigationHistory.pop();
            const prevPage = navigationHistory[navigationHistory.length - 1];
            showPage(prevPage);
        }
    }
    
    // Açık modal var mı kontrol et ve kapat
    function closeOpenModal() {
        const modals = document.querySelectorAll('.modal-overlay.show');
        if (modals.length > 0) {
            modals.forEach(modal => {
                modal.classList.remove('show');
            });
            document.body.style.overflow = 'auto';
            return true; // Modal kapatıldı
        }
        return false; // Açık modal yok
    }
    
    // Android geri tuşu desteği
    window.addEventListener('popstate', function(event) {
        // Önce açık modal var mı kontrol et
        if (closeOpenModal()) {
            // Modal kapatıldı, history'yi geri al
            history.pushState({ page: navigationHistory[navigationHistory.length - 1] }, '', '');
            return;
        }
        
        if (navigationHistory.length > 1) {
            navigationHistory.pop();
            const prevPage = navigationHistory[navigationHistory.length - 1];
            showPage(prevPage);
        } else {
            // Ana sayfadaysa uygulama kapansın
            history.back();
        }
    });
    
    // Başlangıçta history state ekle
    history.replaceState({ page: 'homePage' }, '', '');

    // Modal aç/kapat
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('show');
        document.body.style.overflow = 'hidden';
        // Geri tuşu için history state ekle
        history.pushState({ modal: modalId }, '', '');
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
        document.body.style.overflow = 'auto';
        const video = document.getElementById('certVideo');
        if (video) video.pause();
        
        // Chat modal kapatılıyorsa interval'ı durdur
        if (modalId === 'userChatModal') {
            stopChatRefreshInterval();
        }
    }
    
    function closeModalOutside(event, modalId) {
        if (event.target.classList.contains('modal-overlay')) {
            closeModal(modalId);
        }
    }
    
    // Sipariş başarılı modalını göster
    function showOrderSuccessModal() {
        document.getElementById('orderSuccessModal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }
    
    // Sipariş başarılı modalını kapat
    function closeOrderSuccessModal() {
        document.getElementById('orderSuccessModal').classList.remove('show');
        document.body.style.overflow = 'auto';
    }
    
    // Oyun seçim modalını aç
    function openGameSelectModal() {
        const gameList = document.getElementById('gameSelectList');
        
        // Oyunları listele
        let html = '';
        
        // Mobile Legends (sabit)
        html += `
            <button onclick="selectGameForPurchase('mobile_legends', 'Mobile Legends')" class="payment-method-btn">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/mobile-legends-icon.jpg" 
                         style="width: 50px; height: 50px; border-radius: 12px;" 
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%234CAF50%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2240%22>ML</text></svg>'">
                    <div style="text-align: left;">
                        <div style="font-weight: bold; font-size: 16px;">Mobile Legends</div>
                        <div style="font-size: 12px; color: #aaa;">Bang Bang</div>
                    </div>
                </div>
                <div style="font-size: 20px; color: #4CAF50;">›</div>
            </button>
        `;
        
        // Dinamik oyunları da ekle (gamesData'dan)
        if (gamesData) {
            Object.entries(gamesData).forEach(([gameId, game]) => {
                if (gameId !== 'mobile_legends' && game.name) {
                    html += `
                        <button onclick="selectGameForPurchase('${gameId}', '${game.name}')" class="payment-method-btn">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <img src="${game.icon || ''}" 
                                     style="width: 50px; height: 50px; border-radius: 12px;" 
                                     onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23673AB7%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2230%22>🎮</text></svg>'">
                                <div style="text-align: left;">
                                    <div style="font-weight: bold; font-size: 16px;">${game.name}</div>
                                    <div style="font-size: 12px; color: #aaa;">${game.description || ''}</div>
                                </div>
                            </div>
                            <div style="font-size: 20px; color: #4CAF50;">›</div>
                        </button>
                    `;
                }
            });
        }
        
        gameList.innerHTML = html;
        openModal('gameSelectModal');
    }
    
    // Seçilen oyun için geçici değişken
    let selectedGameForPurchase = null;
    
    // Oyun seçildi - hile seçim modalını aç
    function selectGameForPurchase(gameId, gameName) {
        selectedGameForPurchase = { id: gameId, name: gameName };
        closeModal('gameSelectModal');
        
        const cheatList = document.getElementById('cheatSelectList');
        let html = '';
        
        if (gameId === 'mobile_legends') {
            // TheBestML (sabit hile)
            html += `
                <button onclick="selectCheatForPurchase('thebestml', 'TheBestML IMGUI', 'thebestmlPage')" class="payment-method-btn">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img src="https://raw.githubusercontent.com/bestofexpertopera-bit/yourapp-updates/main/thebestml-icon.jpg" 
                             style="width: 50px; height: 50px; border-radius: 12px;" 
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%234CAF50%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2240%22>ML</text></svg>'">
                        <div style="text-align: left;">
                            <div style="font-weight: bold; font-size: 16px;">TheBestML IMGUI</div>
                            <div style="font-size: 12px; color: #aaa;">ESP, Map Hack ve daha fazlası</div>
                        </div>
                    </div>
                    <div style="font-size: 20px; color: #4CAF50;">›</div>
                </button>
            `;
            
            // Dinamik ML hileleri
            if (gamesData.mobile_legends?.cheats) {
                Object.entries(gamesData.mobile_legends.cheats).forEach(([cheatId, cheat]) => {
                    if (cheatId !== 'thebestml' && cheat.name) {
                        html += `
                            <button onclick="openDynamicCheatFromSelect('mobile_legends', '${cheatId}')" class="payment-method-btn">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <img src="${cheat.icon || ''}" 
                                         style="width: 50px; height: 50px; border-radius: 12px;" 
                                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23FF9800%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2230%22>🗡</text></svg>'">
                                    <div style="text-align: left;">
                                        <div style="font-weight: bold; font-size: 16px;">${cheat.name}</div>
                                        <div style="font-size: 12px; color: #aaa;">${cheat.description || ''}</div>
                                    </div>
                                </div>
                                <div style="font-size: 20px; color: #4CAF50;">›</div>
                            </button>
                        `;
                    }
                });
            }
        } else {
            // Diğer oyunların hileleri
            const gameData = gamesData[gameId];
            if (gameData?.cheats) {
                Object.entries(gameData.cheats).forEach(([cheatId, cheat]) => {
                    if (cheat.name) {
                        html += `
                            <button onclick="openDynamicCheatFromSelect('${gameId}', '${cheatId}')" class="payment-method-btn">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <img src="${cheat.icon || ''}" 
                                         style="width: 50px; height: 50px; border-radius: 12px;" 
                                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23FF9800%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2230%22>🗡</text></svg>'">
                                    <div style="text-align: left;">
                                        <div style="font-weight: bold; font-size: 16px;">${cheat.name}</div>
                                        <div style="font-size: 12px; color: #aaa;">${cheat.description || ''}</div>
                                    </div>
                                </div>
                                <div style="font-size: 20px; color: #4CAF50;">›</div>
                            </button>
                        `;
                    }
                });
            }
        }
        
        if (!html) {
            html = `<div style="text-align: center; padding: 30px; color: #aaa;">Bu oyun için henüz hile eklenmemiş.</div>`;
        }
        
        cheatList.innerHTML = html;
        openModal('cheatSelectModal');
    }
    
    // Hile seçildi - sayfaya yönlendir
    function selectCheatForPurchase(cheatId, cheatName, pageId) {
        closeModal('cheatSelectModal');
        navigateTo(pageId);
    }
    
    // Dinamik hile seçildi - dinamik hile sayfasını aç
    function openDynamicCheatFromSelect(gameId, cheatId) {
        closeModal('cheatSelectModal');
        openDynamicCheatPage(gameId, cheatId);
    }

    // APK İndir
    function downloadAPK() {
        showToast('📥 İndirme başlatılıyor...');
        window.open(appConfig.apkUrl, '_blank');
    }
    
    // Play Store
    function openPlayStore() {
        window.open(appConfig.playStoreUrl, '_blank');
    }
    
    // Fiyat seçimi
    let selectedPriceData = null;
    
    function selectPrice(id, label, price) {
        // Giriş kontrolü
        if (!requireLogin('satın alma işlemi yapmak')) return;
        
        // Önceki seçimi kaldır
        document.querySelectorAll('.price-btn').forEach(btn => btn.classList.remove('selected'));
        
        // Yeni seçimi işaretle
        event.target.closest('.price-btn').classList.add('selected');
        
        // Verileri kaydet
        selectedPriceData = { id, label, price };
        
        // Kartı güncelle ve göster
        const card = document.getElementById('selectedPriceCard');
        const labelEl = document.getElementById('selectedPriceLabel');
        const valueEl = document.getElementById('selectedPriceValue');
        
        labelEl.textContent = label + ' Paket';
        valueEl.textContent = price;
        
        // Premium için özel stil
        if (id === 'sinirsiz') {
            card.classList.add('premium');
        } else {
            card.classList.remove('premium');
        }
        
        card.style.display = 'flex';
    }
    
    function buyWithTelegram() {
        if (!selectedPriceData) return;
        openTelegramSupport();
    }
    
    // Ödeme modal'ını aç (Merkezi sistemi kullan)
    function openPaymentModal() {
        if (!requireLogin('satın alma işlemi yapmak')) return;
        
        if (!selectedPriceData) {
            showToast('❌ Önce bir paket seçin');
            return;
        }
        
        // Günleri belirle
        let days = 30;
        if (selectedPriceData.id === '1gun') days = 1;
        else if (selectedPriceData.id === '30gun') days = 30;
        else if (selectedPriceData.id === '60gun') days = 60;
        else if (selectedPriceData.id === '90gun') days = 90;
        else if (selectedPriceData.id === 'sinirsiz') days = 365;
        
        // Merkezi ödeme sistemini kullan
        openUnifiedPaymentModal({
            type: 'purchase',
            game: 'Mobile Legends',
            cheat: 'TheBestML IMGUI',
            package: selectedPriceData.id,
            packageName: selectedPriceData.label,
            price: selectedPriceData.price,
            days: days
        });
    }
    
    // Ödeme yöntemi seç (eski - geriye uyumluluk)
    function selectPaymentMethod(method) {
        closeModal('paymentModal');
        
        if (method === 'shopier') {
            // Kredi kartı geçici olarak devre dışı
            showToast('⚠️ Kredi kartı ile ödeme yakında aktif olacak!');
            return;
        } else if (method === 'havale') {
            // TheBestML siparişi olduğunu işaretle
            window.isDynamicOrder = false;
            
            // Havale modal'ını aç
            document.getElementById('havalePackageInfo').textContent = selectedPriceData.label + ' Paket';
            document.getElementById('havaleAmount').textContent = selectedPriceData.price;
            openModal('havaleModal');
        }
    }
    
    // Dekont önizleme
    function previewDekont(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('dekontImg').src = e.target.result;
                document.getElementById('dekontPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }
    
    function startPurchase() {
        // Eski fonksiyon - artık openPaymentModal kullanılıyor
        openPaymentModal();
    }
    
    function payWithCard() {
        showToast('💳 Kredi kartı yakında!');
    }
    
    // TheBestML Pro fiyat seçimi
    let selectedProPriceData = null;
    
    function selectProPrice(id, label, price) {
        // Giriş kontrolü
        if (!requireLogin('satın alma işlemi yapmak')) return;
        
        // Önceki seçimi kaldır
        document.querySelectorAll('#proPricesSectionLocked .price-btn').forEach(btn => btn.classList.remove('selected'));
        
        // Yeni seçimi işaretle
        event.target.closest('.price-btn').classList.add('selected');
        
        // Verileri kaydet
        selectedProPriceData = { id, label, price };
        
        // Kartı güncelle ve göster
        const card = document.getElementById('selectedProPriceCard');
        const labelEl = document.getElementById('selectedProPriceLabel');
        const valueEl = document.getElementById('selectedProPriceValue');
        
        labelEl.textContent = label + ' Paket';
        valueEl.textContent = price;
        
        // Premium için özel stil
        if (id === 'sinirsiz') {
            card.classList.add('premium');
        } else {
            card.classList.remove('premium');
        }
        
        card.style.display = 'flex';
    }
    
    function openProPaymentModal() {
        if (!requireLogin('satın alma işlemi yapmak')) return;
        
        if (!selectedProPriceData) {
            showToast('❌ Önce bir paket seçin');
            return;
        }
        
        // Günleri belirle
        let days = 30;
        if (selectedProPriceData.id === '1gun') days = 1;
        else if (selectedProPriceData.id === '30gun') days = 30;
        else if (selectedProPriceData.id === '60gun') days = 60;
        else if (selectedProPriceData.id === '90gun') days = 90;
        else if (selectedProPriceData.id === 'sinirsiz') days = 365;
        
        // Merkezi ödeme sistemini kullan
        openUnifiedPaymentModal({
            type: 'purchase',
            game: 'Mobile Legends',
            cheat: 'TheBestML Pro',
            package: selectedProPriceData.id,
            packageName: selectedProPriceData.label,
            price: selectedProPriceData.price,
            days: days
        });
    }
    
    async function payWithTransfer() {
        // Artık kullanılmıyor
    }
    
    // Dekont önizleme
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            const fileInput = document.getElementById('dekontFile');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('dekontImg').src = e.target.result;
                            document.getElementById('dekontPreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }, 1000);
    });
    
    // Sipariş gönder
    async function submitOrder() {
        if (!currentUser) { showToast('❌ Önce giriş yapın'); return; }
        
        // Dinamik sipariş mi yoksa TheBestML siparişi mi kontrol et
        const isDynamic = window.isDynamicOrder && window.pendingDynamicOrder;
        const orderData = isDynamic ? window.pendingDynamicOrder : selectedPriceData;
        
        if (!orderData) { 
            showToast('❌ Paket seçin'); 
            return; 
        }
        
        const fileInput = document.getElementById('dekontFile');
        if (!fileInput.files[0]) { showToast('❌ Dekont fotoğrafı seçin'); return; }
        
        showToast('⏳ Gönderiliyor...');
        
        try {
            // Dekont'u base64'e çevir
            const file = fileInput.files[0];
            
            // Promise ile FileReader kullan
            const dekontBase64 = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Dosya okunamadı'));
                reader.readAsDataURL(file);
            });
            
            // Siparişi kaydet
            if (isDynamic) {
                // Dinamik sipariş
                await db.collection('orders').add({
                    userId: currentUser.uid,
                    email: currentUser.email,
                    userEmail: currentUser.email,
                    game: orderData.game,
                    gameId: orderData.gameId,
                    cheat: orderData.cheat,
                    cheatId: orderData.cheatId,
                    days: orderData.days,
                    package: orderData.days + 'gun',
                    packageName: `${orderData.cheat} - ${orderData.label}`,
                    price: orderData.price,
                    dekont: dekontBase64,
                    paymentMethod: 'havale',
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                // TheBestML siparişi
                await db.collection('orders').add({
                    userId: currentUser.uid,
                    email: currentUser.email,
                    userEmail: currentUser.email,
                    game: 'Mobile Legends',
                    cheat: 'TheBestML IMGUI',
                    package: orderData.id,
                    packageName: orderData.label,
                    price: orderData.price,
                    dekont: dekontBase64,
                    paymentMethod: 'havale',
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            // Modal'ları kapat
            closeModal('havaleModal');
            closeModal('paymentModal');
            
            // Formu sıfırla
            const selectedCard = document.getElementById('selectedPriceCard');
            if (selectedCard) selectedCard.style.display = 'none';
            
            const dekontFileInput = document.getElementById('dekontFile');
            if (dekontFileInput) dekontFileInput.value = '';
            
            const dekontPreview = document.getElementById('dekontPreview');
            if (dekontPreview) dekontPreview.style.display = 'none';
            
            document.querySelectorAll('.price-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('#dynamicCheatPrices .price-card').forEach(card => card.classList.remove('selected'));
            
            // Değişkenleri sıfırla
            selectedPriceData = null;
            window.isDynamicOrder = false;
            window.pendingDynamicOrder = null;
            selectedDynamicPrice = null;
            
            const dynamicSelectedPrice = document.getElementById('dynamicSelectedPrice');
            if (dynamicSelectedPrice) dynamicSelectedPrice.textContent = 'Fiyat seçin';
            
            // Sipariş badge'ini güncelle
            updateOrderBadge();
            
            // Başarı modalını göster
            showOrderSuccessModal();
            
        } catch(e) {
            console.error('Sipariş hatası:', e);
            showToast('❌ Hata: ' + e.message);
        }
    }
    
    // Telegram
    function openTelegram() {
        const telegramUrl = 'https://t.me/CheatsStoreTR';
        showToast('📩 Telegram açılıyor...');
        
        const startTime = Date.now();
        window.location.href = 'tg://resolve?domain=CheatsStoreTR';
        
        setTimeout(() => {
            if (Date.now() - startTime < 2500) {
                if (confirm('📱 Telegram uygulaması bulunamadı!\n\nTelegram\'ı Play Store\'dan indirmek ister misiniz?')) {
                    window.open('https://play.google.com/store/apps/details?id=org.telegram.messenger', '_blank');
                } else {
                    window.open(telegramUrl, '_blank');
                }
            }
        }, 2000);
    }
    
    // Sertifika ayarları
    async function openSecuritySettings() {
        showToast('🔒 Ayarlar açılıyor...');
        
        let opened = false;
        if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.CertificateManager) {
            try {
                await window.Capacitor.Plugins.CertificateManager.openTrustedCredentials();
                opened = true;
                showToast('✅ Sertifika ayarları açıldı!');
            } catch (e) {}
        }
        
        if (!opened) {
            alert(`📍 Sertifika ayarlarını manuel açın:

1️⃣ Telefonunuzun AYARLAR'ını açın
2️⃣ "Güvenlik" veya "Güvenlik ve gizlilik" bulun
3️⃣ "Şifreleme ve kimlik bilgileri" tıklayın
4️⃣ "Güvenilen kimlik bilgileri" tıklayın
5️⃣ "SİSTEM" sekmesine geçin

⚠️ GlobalSign NV-SA AÇIK kalmalı!`);
        }
    }
    
    // ŞİFRE DEĞİŞTİRME FONKSİYONLARI
    function openChangePasswordModal() {
        if (!currentUser) {
            showLoginRequiredModal('şifre değiştirmek');
            return;
        }
        
        // Input alanlarını temizle
        document.getElementById('currentPasswordInput').value = '';
        document.getElementById('newPasswordInput').value = '';
        document.getElementById('confirmNewPasswordInput').value = '';
        document.getElementById('passwordChangeError').style.display = 'none';
        
        openModal('changePasswordModal');
    }
    
    async function changePassword() {
        const currentPassword = document.getElementById('currentPasswordInput').value.trim();
        const newPassword = document.getElementById('newPasswordInput').value.trim();
        const confirmPassword = document.getElementById('confirmNewPasswordInput').value.trim();
        const errorDiv = document.getElementById('passwordChangeError');
        
        // Validasyon
        if (!currentPassword) {
            errorDiv.textContent = '❌ Lütfen mevcut şifrenizi girin.';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!newPassword) {
            errorDiv.textContent = '❌ Lütfen yeni şifrenizi girin.';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (newPassword.length < 6) {
            errorDiv.textContent = '❌ Yeni şifre en az 6 karakter olmalıdır.';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (newPassword !== confirmPassword) {
            errorDiv.textContent = '❌ Yeni şifreler eşleşmiyor.';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (currentPassword === newPassword) {
            errorDiv.textContent = '❌ Yeni şifre mevcut şifreden farklı olmalıdır.';
            errorDiv.style.display = 'block';
            return;
        }
        
        try {
            errorDiv.style.display = 'none';
            showToast('🔄 Şifre değiştiriliyor...');
            
            const user = firebase.auth().currentUser;
            
            if (!user || !user.email) {
                errorDiv.textContent = '❌ Oturum bilgisi alınamadı. Lütfen tekrar giriş yapın.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Önce mevcut şifreyle yeniden kimlik doğrulama yap
            const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
            
            await user.reauthenticateWithCredential(credential);
            
            // Şifreyi güncelle
            await user.updatePassword(newPassword);
            
            // Başarılı
            closeModal('changePasswordModal');
            showToast('✅ Şifreniz başarıyla değiştirildi!');
            
            // Güvenlik için Firestore'a log kaydı (isteğe bağlı)
            try {
                await db.collection('users').doc(user.uid).update({
                    lastPasswordChange: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) {
                // Log kaydı başarısız olsa bile devam et
                console.log('Password change log failed:', e);
            }
            
        } catch (error) {
            console.error('Password change error:', error);
            
            // Hata mesajlarını Türkçeleştir
            let errorMessage = '❌ Şifre değiştirilemedi.';
            
            switch (error.code) {
                case 'auth/wrong-password':
                    errorMessage = '❌ Mevcut şifre yanlış. Lütfen kontrol edin.';
                    break;
                case 'auth/weak-password':
                    errorMessage = '❌ Yeni şifre çok zayıf. Daha güçlü bir şifre seçin.';
                    break;
                case 'auth/requires-recent-login':
                    errorMessage = '❌ Bu işlem için yakın zamanda giriş yapmanız gerekiyor. Lütfen çıkış yapıp tekrar girin.';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = '❌ Çok fazla deneme yaptınız. Lütfen birkaç dakika bekleyin.';
                    break;
                case 'auth/network-request-failed':
                    errorMessage = '❌ İnternet bağlantınızı kontrol edin.';
                    break;
                case 'auth/invalid-credential':
                    errorMessage = '❌ Mevcut şifre yanlış. Lütfen kontrol edin.';
                    break;
                default:
                    errorMessage = `❌ Hata: ${error.message}`;
            }
            
            errorDiv.textContent = errorMessage;
            errorDiv.style.display = 'block';
        }
    }
    
    // Toast
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
</script>

<!-- DESTEK BUTONU (SAĞ ALT) -->
<div class="support-fab" onclick="openFloatingSupport()">
    💬
</div>

<script>
// Sağ alttaki destek butonuna tıklayınca
function openFloatingSupport() {
    if (currentUser) {
        // Giriş yapmışsa destek mesaj modalnı aç
        openUserChatModal();
    } else {
        // Giriş yapmamışsa giriş yapmasını iste
        showLoginRequiredModal('destek almak');
    }
}
</script>

<style>
.support-fab {
    position: fixed;
    bottom: calc(20px + env(safe-area-inset-bottom, 0px));
    right: 20px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #0088cc, #0077b5);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    box-shadow: 0 4px 15px rgba(0, 136, 204, 0.4);
    cursor: pointer;
    z-index: 999;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.support-fab:active {
    transform: scale(0.95);
}
</style>

</body>
</html>


